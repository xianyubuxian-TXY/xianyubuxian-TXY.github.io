<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xianyubuxian-txy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一、Kafka介绍 Kafka 是一款分布式、高吞吐量、高可靠性的分布式事件流平台（原定位为：分布式消息队列），基于发布&#x2F;订阅模式，主要用于处理实时数据管道、流处理、数据集成等场景，能够高效地收集、存储和分发大规模的实时数据流。   1.应用场景  * 消息队列：替代传统消息队列（如 RabbitMQ），实现服务间的异步通信、解耦和削峰填谷（如秒杀场景的流量缓冲）。  * 实时数据管道：在分布式系">
<meta property="og:type" content="article">
<meta property="og:title" content="kafka使用教程">
<meta property="og:url" content="https://xianyubuxian-txy.github.io/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="Xianyu">
<meta property="og:description" content="一、Kafka介绍 Kafka 是一款分布式、高吞吐量、高可靠性的分布式事件流平台（原定位为：分布式消息队列），基于发布&#x2F;订阅模式，主要用于处理实时数据管道、流处理、数据集成等场景，能够高效地收集、存储和分发大规模的实时数据流。   1.应用场景  * 消息队列：替代传统消息队列（如 RabbitMQ），实现服务间的异步通信、解耦和削峰填谷（如秒杀场景的流量缓冲）。  * 实时数据管道：在分布式系">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115205205304.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115161939911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115161159031.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115163026489.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115164615280.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115164736803.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115204712186.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115213709054.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115213729718.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116100012806.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116161810771.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116161420955.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116211851723.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116110908752.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116224028039.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116203247930.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116205721363.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116221010502.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116144249346.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116144611415.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116153411714.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116151134440.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116151233728.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116154712623.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116155332043.png">
<meta property="article:published_time" content="2026-01-15T07:56:39.000Z">
<meta property="article:modified_time" content="2026-01-16T16:15:45.586Z">
<meta property="article:author" content="咸鱼">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115205205304.png">


<link rel="canonical" href="https://xianyubuxian-txy.github.io/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://xianyubuxian-txy.github.io/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/","path":"2026/01/15/C++/C++后端开发常用库/kafka使用教程/","title":"kafka使用教程"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kafka使用教程 | Xianyu</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  




<link rel="dns-prefetch" href="https://waline-beta-black.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Xianyu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">一、Kafka介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.应用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-kafka%E4%BD%9C%E4%B8%BA%E2%80%9C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E2%80%9D"><span class="nav-text">2.kafka作为“消息队列”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81kafka%EF%BC%8C%E5%AE%83%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">（1）为什么需要kafka，它的作用是什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%9B%BE%E5%AF%B9%E6%AF%94"><span class="nav-text">&lt;1&gt;工作流程图对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%AE%8C%E6%95%B4%E7%9A%84%E6%B5%81%E7%A8%8B%E5%AF%B9%E6%AF%94%EF%BC%88%E5%9C%BA%E6%99%AF%EF%BC%9A%E7%94%A8%E6%88%B7%E6%B3%A8%E5%86%8C%EF%BC%89"><span class="nav-text">&lt;2&gt;完整的流程对比（场景：用户注册）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%89%8D%E6%99%AF%E7%9F%A5%E8%AF%86%E4%BB%8B%E7%BB%8D"><span class="nav-text">1）前景知识介绍</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%B2%A1%E6%9C%89Kafka%EF%BC%88%E4%BC%A0%E7%BB%9F%E5%90%8C%E6%AD%A5%EF%BC%89"><span class="nav-text">2)没有Kafka（传统同步）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E6%9C%89-Kafka%EF%BC%88%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6%EF%BC%89"><span class="nav-text">3)有 Kafka（异步解耦）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%81kafka%E3%80%81%E5%90%8E%E5%8F%B0%E4%BB%BB%E5%8A%A1%E6%9C%8D%E5%8A%A1-%E4%B8%89%E8%80%85%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">&lt;3&gt;后台服务器、kafka、后台任务服务 三者的关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E2%80%9Ckafka%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E2%80%9D-vs-%E2%80%9C%E8%BF%9B%E7%A8%8B%E6%B1%A0-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E2%80%9D"><span class="nav-text">&lt;4&gt;“kafka消息队列” vs “进程池&#x2F;线程池”</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">二、kafka 核心概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">三、librdkafka的使用（C++ 2.13.0）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Producer-%E4%B8%8E-Consumer-%E4%BD%BF%E7%94%A8%E6%A6%82%E8%BF%B0"><span class="nav-text">1.Producer 与 Consumer 使用概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Producer%E3%80%81kafka%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%81Consumer%E4%B8%89%E8%80%85%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">（1）Producer、kafka服务器、Consumer三者的关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E7%B1%BB%E5%B1%82%E6%AC%A1%E6%80%BB%E8%A7%88"><span class="nav-text">（1）类层次总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Producer%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-text">（2）Producer的使用流程图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Consumer%E7%9A%84%E4%BD%BF%E7%94%A8%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-text">（3）Consumer的使用流程图</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Conf%E7%B1%BB%EF%BC%88%E9%85%8D%E7%BD%AE%E7%B1%BB%EF%BC%89"><span class="nav-text">2.Conf类（配置类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Conf%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（1）Conf类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Conf%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">（2）Conf类的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA-RdKafka-Conf"><span class="nav-text">&lt;1&gt;创建 RdKafka::Conf</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E4%BD%BF%E7%94%A8%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E7%9B%B4%E6%8E%A5%E5%88%9B%E5%BB%BA"><span class="nav-text">1）使用智能指针直接创建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E5%B0%81%E8%A3%85%E4%B8%BA%E5%B7%A5%E5%8E%82%E5%87%BD%E6%95%B0"><span class="nav-text">2）封装为工厂函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%EF%BC%89%E4%B8%8D%E4%BD%BF%E7%94%A8%E2%80%9C%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88%E2%80%9D%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%81%EF%BC%89"><span class="nav-text">3）不使用“智能指针”（不推荐！）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%AE%BE%E7%BD%AE-RdKafka-Conf"><span class="nav-text">&lt;2&gt;设置 RdKafka::Conf</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E7%94%9F%E4%BA%A7%E8%80%85%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">1）生产者常用配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E6%B6%88%E8%B4%B9%E8%80%85%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">2）消费者常用配置</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-TopicPartition%E7%B1%BB%EF%BC%88%E4%B8%BB%E9%A2%98%E5%88%86%E5%8C%BA%E7%B1%BB%EF%BC%89"><span class="nav-text">3.TopicPartition类（主题分区类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0"><span class="nav-text">（1）概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%9C%E7%94%A8"><span class="nav-text">&lt;1&gt;作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%BD%8D"><span class="nav-text">&lt;2&gt;核心定位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89TopicPartition%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）TopicPartition类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%85%B8%E5%9E%8B%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%88%E7%BB%93%E5%90%88%E6%A0%B8%E5%BF%83-API%EF%BC%89"><span class="nav-text">（3）典型使用场景（结合核心 API）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%89%8B%E5%8A%A8%E5%88%86%E9%85%8D%E5%88%86%E5%8C%BA"><span class="nav-text">&lt;1&gt; 手动分配分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%8C%87%E5%AE%9A%E5%81%8F%E7%A7%BB%E9%87%8F%E6%B6%88%E8%B4%B9"><span class="nav-text">&lt;2&gt;指定偏移量消费</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4%E6%8C%87%E5%AE%9A-offset"><span class="nav-text">&lt;3&gt;手动提交指定 offset</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%89%80%E6%9C%89%E5%88%86%E5%8C%BA"><span class="nav-text">&lt;4&gt;批量操作所有分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-destroy-%E7%9A%84%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;5&gt;destroy() 的使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%EF%BC%88%E6%A0%B8%E5%BF%83%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%89"><span class="nav-text">（4）内存管理（核心注意事项）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%A0%B8%E5%BF%83%E6%98%93%E9%94%99%E7%82%B9%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">（5）核心易错点与最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%98%93%E9%94%99%E7%82%B9"><span class="nav-text">&lt;1&gt;易错点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Headers%E7%B1%BB%EF%BC%88%E6%B6%88%E6%81%AF%E5%A4%B4%E7%B1%BB%EF%BC%89"><span class="nav-text">4.Headers类（消息头类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0-2"><span class="nav-text">（1）概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%9C%E7%94%A8-2"><span class="nav-text">&lt;1&gt;作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%BD%8D-2"><span class="nav-text">&lt;2&gt;核心定位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Headers%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Headers类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">（3）使用示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E7%94%9F%E4%BA%A7%E8%80%85%E5%86%99%E5%85%A5-Headers-%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;1&gt;生产者写入 Headers 示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%B6%88%E8%B4%B9%E8%80%85%E8%AF%BB%E5%8F%96-Headers-%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;2&gt;消费者读取 Headers 示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%A0%B8%E5%BF%83%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">（4）核心注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Handle%E7%B1%BB%EF%BC%88%E5%8F%A5%E6%9F%84%E5%9F%BA%E7%B1%BB%EF%BC%89"><span class="nav-text">5.Handle类（句柄基类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0-3"><span class="nav-text">（1）概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%9C%E7%94%A8-3"><span class="nav-text">&lt;1&gt;作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%BD%8D-3"><span class="nav-text">&lt;2&gt;核心定位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Handle-%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Handle 类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">（3）核心特性与注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Producer%E7%B1%BB%EF%BC%88%E7%94%9F%E4%BA%A7%E8%80%85%E7%B1%BB%EF%BC%89"><span class="nav-text">6.Producer类（生产者类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0-4"><span class="nav-text">（1）概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%9C%E7%94%A8-4"><span class="nav-text">&lt;1&gt;作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%BD%8D-4"><span class="nav-text">&lt;2&gt;核心定位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-text">&lt;3&gt;继承关系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Producer%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Producer类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-text">（3）使用示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81%E7%A4%BA%E4%BE%8B%EF%BC%88%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%A6%96%E9%80%89%EF%BC%89"><span class="nav-text">&lt;1&gt;异步发送示例（生产环境首选）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%90%8C%E6%AD%A5%E5%8F%91%E9%80%81%E7%A4%BA%E4%BE%8B%EF%BC%88%E7%89%B9%E6%AE%8A%E5%9C%BA%E6%99%AF%E4%BD%BF%E7%94%A8%EF%BC%89"><span class="nav-text">&lt;2&gt;同步发送示例（特殊场景使用）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%85%B3%E9%94%AE%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">（4）关键注意事项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-RdKafka-xxxCb%E5%9B%9E%E8%B0%83%E7%B1%BB"><span class="nav-text">3.RdKafka::xxxCb回调类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89DeliveryReportCb%EF%BC%88%E7%94%9F%E4%BA%A7%E8%80%85%E6%8A%95%E9%80%92%E7%BB%93%E6%9E%9C%E5%9B%9E%E8%B0%83%EF%BC%89"><span class="nav-text">（1）DeliveryReportCb（生产者投递结果回调）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AE%9A%E4%B9%89"><span class="nav-text">&lt;1&gt;定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89EventCb%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%95%E5%B1%82%E4%BA%8B%E4%BB%B6%E5%9B%9E%E8%B0%83%EF%BC%89"><span class="nav-text">（2）EventCb（客户端底层事件回调）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AE%9A%E4%B9%89-2"><span class="nav-text">&lt;1&gt;定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89RebalanceCb%EF%BC%88%E6%B6%88%E8%B4%B9%E8%80%85%E9%87%8D%E5%B9%B3%E8%A1%A1%E5%9B%9E%E8%B0%83%EF%BC%89"><span class="nav-text">（3）RebalanceCb（消费者重平衡回调）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AE%9A%E4%B9%89-3"><span class="nav-text">&lt;1&gt;定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89OffsetCommitCb%EF%BC%88%E6%B6%88%E8%B4%B9%E8%80%85-Offset-%E6%8F%90%E4%BA%A4%E7%BB%93%E6%9E%9C%E5%9B%9E%E8%B0%83%EF%BC%89"><span class="nav-text">（4）OffsetCommitCb（消费者 Offset 提交结果回调）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%AE%9A%E4%B9%89-4"><span class="nav-text">&lt;1&gt;定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-4"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%9B%9E%E8%B0%83%E7%B1%BB%E9%80%9A%E7%94%A8%E8%A7%84%E5%88%99%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">（5）回调类通用规则与注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%A0%B8%E5%BF%83%E9%80%9A%E7%94%A8%E8%A7%84%E5%88%99"><span class="nav-text">&lt;1&gt;核心通用规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E9%AB%98%E9%A2%91%E6%98%93%E9%94%99%E7%82%B9"><span class="nav-text">&lt;2&gt;高频易错点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-RdKafka-Message%E7%B1%BB%EF%BC%88%E6%B6%88%E6%81%AF%E7%B1%BB%EF%BC%89"><span class="nav-text">4.RdKafka::Message类（消息类）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%A6%82%E8%BF%B0-5"><span class="nav-text">（1）概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%9C%E7%94%A8-5"><span class="nav-text">&lt;1&gt;作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%BD%8D-5"><span class="nav-text">&lt;2&gt;核心定位</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Message%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Message类的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E7%A0%81-ErrorCode"><span class="nav-text">（3）常见错误码 ErrorCode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">（4）使用示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%B6%88%E8%B4%B9%E8%80%85%E6%8E%A5%E6%94%B6%E5%B9%B6%E5%A4%84%E7%90%86%E6%B6%88%E6%81%AF%EF%BC%88%E6%A0%B8%E5%BF%83%E5%9C%BA%E6%99%AF%EF%BC%89"><span class="nav-text">&lt;1&gt;消费者接收并处理消息（核心场景）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%94%9F%E4%BA%A7%E8%80%85%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E5%90%8E%E5%A4%84%E7%90%86%E5%9B%9E%E8%B0%83%EF%BC%88%E5%BC%82%E6%AD%A5%E5%8F%91%E9%80%81%EF%BC%89"><span class="nav-text">&lt;2&gt;生产者发送消息后处理回调（异步发送）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">（4）核心特性与注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%A0%B8%E5%BF%83%E7%89%B9%E5%BE%81"><span class="nav-text">&lt;1&gt;核心特征</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%98%93%E9%94%99%E7%82%B9%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-text">&lt;2&gt;易错点与最佳实践</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link"><span class="nav-text">附录1：常用配置项</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Global%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE%EF%BC%88%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E5%85%B1%E7%94%A8%EF%BC%89"><span class="nav-text">1.Global通用配置（生产者&#x2F;消费者共用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%94%9F%E4%BA%A7%E8%80%85%E4%B8%93%E7%94%A8"><span class="nav-text">2.生产者专用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%B6%88%E8%B4%B9%E8%80%85%E4%B8%93%E7%94%A8"><span class="nav-text">3.消费者专用</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="咸鱼"
      src="/images/xianyu.jpg">
  <p class="site-author-name" itemprop="name">咸鱼</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">29</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xianyubuxian-TXY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xianyubuxian-TXY" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xianyubuxian-txy.github.io/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xianyu.jpg">
      <meta itemprop="name" content="咸鱼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xianyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="kafka使用教程 | Xianyu">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kafka使用教程
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-15 15:56:39" itemprop="dateCreated datePublished" datetime="2026-01-15T15:56:39+08:00">2026-01-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-17 00:15:45" itemprop="dateModified" datetime="2026-01-17T00:15:45+08:00">2026-01-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">C++后端开发库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/Kafka/" itemprop="url" rel="index"><span itemprop="name">Kafka</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>48 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1>一、Kafka介绍</h1>
<p>Kafka 是一款分布式、高吞吐量、高可靠性的<strong>分布式事件流平台</strong>（原定位为：<strong>分布式消息队列</strong>），基于<strong>发布/订阅模式</strong>，主要用于处理实时数据管道、流处理、数据集成等场景，能够高效地收集、存储和分发大规模的实时数据流。<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115205205304.png" alt=""></p>
<h2 id="1-应用场景">1.应用场景</h2>
<ul>
<li><strong>消息队列</strong>：替代传统消息队列（如 RabbitMQ），实现服务间的异步通信、解耦和削峰填谷（如秒杀场景的流量缓冲）。</li>
<li><strong>实时数据管道</strong>：在分布式系统间构建数据传输通道，实现不同系统（如数据库、缓存、业务系统）之间的实时数据同步。</li>
<li><strong>日志收集</strong>：集中收集分布式系统的日志数据（如 ELK 架构中的日志传输环节），便于日志分析和故障排查。</li>
<li><strong>流处理</strong>：作为流处理框架（如 Flink、Spark Streaming）的数据源和数据Sink，支撑实时计算场景（如实时监控、实时报表、风控预警）。</li>
<li><strong>事件溯源</strong>：记录系统中的关键事件，支持业务状态回溯和历史数据审计。</li>
</ul>
<h2 id="2-kafka作为“消息队列”">2.kafka作为“消息队列”</h2>
<h3 id="（1）为什么需要kafka，它的作用是什么？">（1）为什么需要kafka，它的作用是什么？</h3>
<p>下面我将以“<strong>用户注册场景</strong>”为例，简要讲解为什么要引入kafka作为消息队列，它作为工作流程的哪一个环节，如何使用。</p>
<h4 id="1-工作流程图对比">&lt;1&gt;工作流程图对比</h4>
<ul>
<li>
<p><strong>1.没有使用Kafka或任何任务队列的传统同步处理流程图</strong><br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115161939911.png" alt=""></p>
</li>
<li>
<p><strong>2.使用kafka的异步处理流程图</strong><br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115161159031.png" alt=""></p>
</li>
</ul>
<p><strong>看到这，敏锐的人可能想到：“不使用kafka，用多线程异步处理不是也可以吗？” 是的，也是可以的，但使用kafka有很多优势，这个之后在介绍。</strong></p>
<h4 id="2-完整的流程对比（场景：用户注册）">&lt;2&gt;完整的流程对比（场景：用户注册）</h4>
<h5 id="1）前景知识介绍">1）前景知识介绍</h5>
<ul>
<li><strong>用户注册的“核心业务”</strong>：
<ul>
<li>向数据库中插入新注册的用户信息（这里其实就“注册成功了！”）</li>
</ul>
</li>
<li><strong>用户注册的“附加业务”</strong>：
<ul>
<li>发送邮件到注册用户的邮箱提示注册成功</li>
<li>注册成功后，返回后台数据用于渲染前端页面（如：现实中你注册成功时，显示“3s 跳转页面”，就是前端在等待后端数据进行渲染）</li>
<li>给你一些“信息提示”（如：在购物平台，提示你有优惠券可领）</li>
<li>…</li>
</ul>
</li>
<li>不同平台/软件用户注册的“附加业务”各有不同，单“核心业务”都是在“向数据库插入新注册用户的信息”，插入成功其实就代表“注册成功”了，“附加业务”即使没有也可以。</li>
</ul>
<h5 id="2-没有Kafka（传统同步）">2)没有Kafka（传统同步）</h5>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115163026489.png" alt=""><br>
<strong>问题</strong>：</p>
<ul>
<li>❌ 用户等待 3+ 秒才看到响应（延迟高）</li>
<li>❌ 任一个环节出现问题（如：邮件服务挂了），注册失败（可靠性较低）</li>
<li>❌ 高并发时，线程全部阻塞“附加业务”上，“附加业务”是主要的“性能瓶颈”</li>
</ul>
<p><strong>再次提示</strong>：这里虽然也可以将“附加业务”再次用异步线程处理，但我们先不讨论它。</p>
<h5 id="3-有-Kafka（异步解耦）">3)有 Kafka（异步解耦）</h5>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115164615280.png" alt=""><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115164736803.png" alt=""></p>
<p><a id="P1"></a></p>
<h4 id="3-后台服务器、kafka、后台任务服务-三者的关系">&lt;3&gt;后台服务器、kafka、后台任务服务 三者的关系</h4>
<ul>
<li><strong>类比进程池</strong>：
<ul>
<li><strong>后台服务器</strong> ——&gt; <strong>master进程</strong></li>
<li><strong>kafka</strong>	——&gt; <strong>任务队列</strong></li>
<li><strong>后台任务服务</strong> ——&gt; <strong>worker工作进程</strong></li>
</ul>
</li>
<li>客户端发送请求到达“后台服务器”（类比master进程）时，后台服务器完成“核心业务”（如：将新用户数据插入数据库），并将“附加业务”请求（高耗时）发送到kafka消息队列（类比任务队列）中，然后立即向前端回复执行结果。“后台任务服务”（类比worker进程）则不断从kafka的消息队列中取出“附加业务”请求进行处理
<ul>
<li><strong>解耦了“核心业务”与“附加业务”，从而使“后台服务器”可以快速响应前端请求</strong></li>
</ul>
</li>
</ul>
<h4 id="4-“kafka消息队列”-vs-“进程池-线程池”">&lt;4&gt;“kafka消息队列” vs “进程池/线程池”</h4>
<p>从前面可以知道，使用kafka的模式与Reactor模式很像，但kafka模式有很多优点：<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115204712186.png" alt=""></p>
<h1>二、kafka 核心概念</h1>
<p><strong>推荐阅读《Apache Kafka实战》了解详情</strong><br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115213709054.png" alt=""><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260115213729718.png" alt=""></p>
<p><strong>message格式</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌───────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                            消息头部 (message header)                      │</span><br><span class="line">├────────┬──────┬──────┬──────────┬──────────┬─────────┬──────────┬─────────┤</span><br><span class="line">│ CRC    │版本号 │ 属性 │ 时间戳   │ Key 长度 │ Key     │ Value 长度│ Value   │</span><br><span class="line">│ 4B     │ 1B   │ 1B   │ 8B       │ 4B       │ k bytes │ 4B       │ v bytes │</span><br><span class="line">└────────┴──────┴──────┴──────────┴──────────┴─────────┴──────────┴─────────┘</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>key</strong>：消息键，在对消息进行partition时使用 ——&gt;决定消息被存储在 该 Topic 的哪个 Partition。</li>
<li><strong>Value</strong>：消息体，消息的实际数据。</li>
<li><strong>Timestamp</strong>：消息发送时间戳。</li>
<li>每个消息由 <strong>&lt;topic,partition,offset&gt;三元组 唯一标识</strong></li>
</ul>
<h1>三、librdkafka的使用（C++ 2.13.0）</h1>
<h2 id="1-Producer-与-Consumer-使用概述">1.Producer 与 Consumer 使用概述</h2>
<h3 id="（1）Producer、kafka服务器、Consumer三者的关系">（1）Producer、kafka服务器、Consumer三者的关系</h3>
<ul>
<li><strong>Producer</strong>（消息生产者）：
<ul>
<li><strong>后台服务器</strong> 连接 kafka服务器的句柄 ——&gt;根据 “topic,partition” 向kafka服务器中写入消息</li>
</ul>
</li>
<li><strong>Consumer</strong>（消息消费者）：
<ul>
<li><strong>后台任务服务</strong> 连接 kafka服务器的句柄 ——&gt; 根据 “&lt;topic,partition,offset&gt;” 从kafka中消费消息</li>
</ul>
</li>
<li>无论是<strong>Producer</strong>还是<strong>Consumer</strong>，都是<strong>kafka的客户端</strong>，kafka的服务器是两者的中介</li>
</ul>
<p><strong>如果对“后台服务器”、“后台任务服务”不了解</strong>，参考<a href="#P1">后台服务器、kafka、后台任务服务 三者的关系</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          Kafka 架构角色                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────┐                         ┌─────────────────┐      │</span><br><span class="line">│   │    Producer     │                         │    Consumer     │      │</span><br><span class="line">│   │   (消息生产者)   │                         │   (消息消费者)   │      │</span><br><span class="line">│   │                 │                         │                 │      │</span><br><span class="line">│   │  后台服务器     │                         │  后台任务服务    │      │</span><br><span class="line">│   │  连接 Kafka 句柄 │                         │  连接 Kafka 句柄 │      │</span><br><span class="line">│   └────────┬────────┘                         └────────▲────────┘      │</span><br><span class="line">│            │                                           │               │</span><br><span class="line">│            │  写入消息                        消费消息  │               │</span><br><span class="line">│            │  &lt;topic, partition&gt;    &lt;topic, partition, offset&gt;         │</span><br><span class="line">│            │                                           │               │</span><br><span class="line">│            ▼                                           │               │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────┐      │</span><br><span class="line">│   │                      Kafka Server                           │      │</span><br><span class="line">│   │                       (中介/Broker)                          │      │</span><br><span class="line">│   │                                                             │      │</span><br><span class="line">│   │    ┌─────────┐    ┌─────────┐    ┌─────────┐               │      │</span><br><span class="line">│   │    │ Topic A │    │ Topic B │    │ Topic C │    ...        │      │</span><br><span class="line">│   │    │ ┌─────┐ │    │ ┌─────┐ │    │ ┌─────┐ │               │      │</span><br><span class="line">│   │    │ │ P0  │ │    │ │ P0  │ │    │ │ P0  │ │               │      │</span><br><span class="line">│   │    │ │ P1  │ │    │ │ P1  │ │    │ │ P1  │ │               │      │</span><br><span class="line">│   │    │ │ P2  │ │    │ │ P2  │ │    │ │ P2  │ │               │      │</span><br><span class="line">│   │    │ └─────┘ │    │ └─────┘ │    │ └─────┘ │               │      │</span><br><span class="line">│   │    └─────────┘    └─────────┘    └─────────┘               │      │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────┘      │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ※ Producer 和 Consumer 都是 Kafka 的客户端                           │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐         ┌──────────────┐         ┌──────────────┐</span><br><span class="line">│   Producer   │  ────►  │    Kafka     │  ────►  │   Consumer   │</span><br><span class="line">│  (后台服务器) │  写入    │   Server     │  消费    │ (后台任务服务) │</span><br><span class="line">└──────────────┘         │   (Broker)   │         └──────────────┘</span><br><span class="line">                         └──────────────┘</span><br><span class="line">                         </span><br><span class="line">写入定位：topic + partition</span><br><span class="line">消费定位：topic + partition + offset</span><br></pre></td></tr></table></figure>
<h3 id="（1）类层次总览">（1）类层次总览</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        librdkafka C++ 类层次结构                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                         基础配置层                                   │   │</span><br><span class="line">│  │   ┌────────┐    ┌────────────────┐    ┌──────────────────────┐     │   │</span><br><span class="line">│  │   │  Conf  │    │  TopicPartition │    │      Headers        │     │   │</span><br><span class="line">│  │   └────────┘    └────────────────┘    └──────────────────────┘     │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                    │                                        │</span><br><span class="line">│                                    ▼                                        │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                          核心句柄层                                  │   │</span><br><span class="line">│  │                      ┌──────────────┐                               │   │</span><br><span class="line">│  │                      │    Handle    │ (抽象基类)                    │   │</span><br><span class="line">│  │                      └──────┬───────┘                               │   │</span><br><span class="line">│  │               ┌─────────────┴─────────────┐                         │   │</span><br><span class="line">│  │               ▼                           ▼                         │   │</span><br><span class="line">│  │        ┌──────────────┐           ┌───────────────┐                 │   │</span><br><span class="line">│  │        │   Producer   │           │ KafkaConsumer │                 │   │</span><br><span class="line">│  │        └──────────────┘           └───────────────┘                 │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                    │                                        │</span><br><span class="line">│                                    ▼                                        │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                          消息数据层                                  │   │</span><br><span class="line">│  │   ┌──────────┐    ┌──────────────────┐    ┌────────────────────┐   │   │</span><br><span class="line">│  │   │ Message  │    │ MessageTimestamp │    │       Error        │   │   │</span><br><span class="line">│  │   └──────────┘    └──────────────────┘    └────────────────────┘   │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                    │                                        │</span><br><span class="line">│                                    ▼                                        │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                          回调接口层                                  │   │</span><br><span class="line">│  │  ┌─────────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────┐ │   │</span><br><span class="line">│  │  │DeliveryReportCb │ │ RebalanceCb │ │OffsetCommit │ │  EventCb  │ │   │</span><br><span class="line">│  │  │                 │ │             │ │     Cb      │ │           │ │   │</span><br><span class="line">│  │  └─────────────────┘ └─────────────┘ └─────────────┘ └───────────┘ │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                    │                                        │</span><br><span class="line">│                                    ▼                                        │</span><br><span class="line">│  ┌─────────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│  │                          高级功能层                                  │   │</span><br><span class="line">│  │   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌─────────────┐  │   │</span><br><span class="line">│  │   │ Metadata │    │  Queue   │    │  Topic   │    │ AdminClient │  │   │</span><br><span class="line">│  │   └──────────┘    └──────────┘    └──────────┘    └─────────────┘  │   │</span><br><span class="line">│  └─────────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h3 id="（2）Producer的使用流程图">（2）Producer的使用流程图</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         初始化阶段                                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐    ┌───────────────────┐    ┌────────────────┐ │</span><br><span class="line">│   │    创建 Conf      │───→│    设置参数       │───→│   注册回调     │ │</span><br><span class="line">│   │   (全局配置)      │    │  bootstrap.servers│    │                │ │</span><br><span class="line">│   │                   │    │  acks, retries 等 │    │ DeliveryReport │ │</span><br><span class="line">│   │ ┌───────────────┐ │    └───────────────────┘    │      Cb        │ │</span><br><span class="line">│   │ │  <span class="built_in">Conf</span> (GLOBAL)│ │                             │    EventCb     │ │</span><br><span class="line">│   │ └───────────────┘ │                             └───────┬────────┘ │</span><br><span class="line">│   └───────────────────┘                                     │          │</span><br><span class="line">│                                                             ▼          │</span><br><span class="line">│                                                 ┌───────────────────┐  │</span><br><span class="line">│                                                 │  创建 Producer    │  │</span><br><span class="line">│                                                 │ Producer::<span class="built_in">create</span>()│  │</span><br><span class="line">│                                                 │                   │  │</span><br><span class="line">│                                                 │ ┌───────────────┐ │  │</span><br><span class="line">│                                                 │ │   Producer    │ │  │</span><br><span class="line">│                                                 │ └───────────────┘ │  │</span><br><span class="line">│                                                 └─────────┬─────────┘  │</span><br><span class="line">└───────────────────────────────────────────────────────────┼─────────────┘</span><br><span class="line">                                                            │</span><br><span class="line">                                                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         生产阶段（循环）                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐    ┌───────────────────┐    ┌────────────────┐ │</span><br><span class="line">│   │    构造消息       │───→│    <span class="built_in">produce</span>()      │───→│    <span class="built_in">poll</span>()      │ │</span><br><span class="line">│   │  topic/key/value  │    │   放入内部队列    │    │   触发回调     │ │</span><br><span class="line">│   │                   │    │                   │    │   处理事件     │ │</span><br><span class="line">│   │ ┌───────────────┐ │    │ ┌───────────────┐ │    └───────┬────────┘ │</span><br><span class="line">│   │ │    Topic      │ │    │ │   Producer    │ │            │        ◄─┐</span><br><span class="line">│   │ │    Headers    │ │    │ │   ::<span class="built_in">produce</span>() │ │            │          │</span><br><span class="line">│   │ └───────────────┘ │    │ └───────────────┘ │            │          │</span><br><span class="line">│   └───────────────────┘    └───────────────────┘            │          │</span><br><span class="line">│                                                             │          │</span><br><span class="line">│            ┌────────────────────────────────────────────────┘          │</span><br><span class="line">│            │                                                           │</span><br><span class="line">│            │    ┌─────────────────────────────────────────┐            │</span><br><span class="line">│            │    │  回调触发时涉及的类：                    │            │</span><br><span class="line">│            │    │  ┌─────────┐  ┌─────────┐  ┌─────────┐  │            │</span><br><span class="line">│            │    │  │ Message │  │  Event  │  │ErrorCode│  │            │</span><br><span class="line">│            │    │  └─────────┘  └─────────┘  └─────────┘  │            │</span><br><span class="line">│            │    └─────────────────────────────────────────┘            │</span><br><span class="line">│            │                                                           │</span><br><span class="line">│            └───────────────────────────────────────────────────────────┘</span><br><span class="line">│                                            (持续生产则循环)              │</span><br><span class="line">└───────────────────────────────────────────────────────────┬─────────────┘</span><br><span class="line">                                                            │</span><br><span class="line">                                                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         清理阶段                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐         ┌───────────────────┐                  │</span><br><span class="line">│   │     <span class="built_in">flush</span>()       │────────→│  <span class="keyword">delete</span> producer  │                  │</span><br><span class="line">│   │   等待队列清空    │         │                   │                  │</span><br><span class="line">│   │                   │         │ ┌───────────────┐ │                  │</span><br><span class="line">│   │ ┌───────────────┐ │         │ │   Producer    │ │                  │</span><br><span class="line">│   │ │   Producer    │ │         │ │   (销毁)      │ │                  │</span><br><span class="line">│   │ │   ::<span class="built_in">flush</span>()   │ │         │ └───────────────┘ │                  │</span><br><span class="line">│   │ └───────────────┘ │         └───────────────────┘                  │</span><br><span class="line">│   └───────────────────┘                                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="（3）Consumer的使用流程图">（3）Consumer的使用流程图</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         初始化阶段                                       │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐    ┌───────────────────┐    ┌────────────────┐ │</span><br><span class="line">│   │    创建 Conf      │───→│    设置参数       │───→│   注册回调     │ │</span><br><span class="line">│   │   (全局配置)      │    │  bootstrap.servers│    │                │ │</span><br><span class="line">│   │                   │    │  group.<span class="built_in">id</span> (必需)  │    │  RebalanceCb   │ │</span><br><span class="line">│   │ ┌───────────────┐ │    │  <span class="keyword">auto</span>.offset.reset│    │OffsetCommitCb  │ │</span><br><span class="line">│   │ │  <span class="built_in">Conf</span> (GLOBAL)│ │    │  enable.<span class="keyword">auto</span>.     │    │    EventCb     │ │</span><br><span class="line">│   │ └───────────────┘ │    │      commit 等    │    └───────┬────────┘ │</span><br><span class="line">│   └───────────────────┘    └───────────────────┘            │          │</span><br><span class="line">│                                                             ▼          │</span><br><span class="line">│                                                 ┌───────────────────┐  │</span><br><span class="line">│                                                 │ 创建 KafkaConsumer│  │</span><br><span class="line">│                                                 │ KafkaConsumer::   │  │</span><br><span class="line">│                                                 │    <span class="built_in">create</span>()       │  │</span><br><span class="line">│                                                 │ ┌───────────────┐ │  │</span><br><span class="line">│                                                 │ │ KafkaConsumer │ │  │</span><br><span class="line">│                                                 │ └───────────────┘ │  │</span><br><span class="line">│                                                 └─────────┬─────────┘  │</span><br><span class="line">└───────────────────────────────────────────────────────────┼─────────────┘</span><br><span class="line">                                                            │</span><br><span class="line">                                                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         订阅阶段                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│   │                       两种订阅方式（二选一）                      |  |</span><br><span class="line">    |               用于确定从哪个（topic，partition）获取消息           │  │</span><br><span class="line">│   ├─────────────────────────────────┬───────────────────────────────┤  │</span><br><span class="line">│   │                                 │                               │  │</span><br><span class="line">│   │   ┌───────────────────────┐     │     ┌───────────────────────┐ │  │</span><br><span class="line">│   │   │    <span class="built_in">subscribe</span>()        │     │     │    <span class="built_in">assign</span>()           │ │  │</span><br><span class="line">│   │   │    订阅主题列表       │     │     │    手动分配分区       │ │  │</span><br><span class="line">│   │   │                       │     │     │                       │ │  │</span><br><span class="line">│   │   │ ┌───────────────────┐ │     │     │ ┌───────────────────┐ │ │  │</span><br><span class="line">│   │   │ │ vector&lt;string&gt;    │ │     │     │ │ TopicPartition    │ │ │  │</span><br><span class="line">│   │   │ │ &#123;<span class="string">&quot;topic1&quot;</span>,<span class="string">&quot;topic2&quot;</span>&#125;│ │     │     │ │ (topic, partition)│ │ │  │</span><br><span class="line">│   │   │ └───────────────────┘ │     │     │ └───────────────────┘ │ │  │</span><br><span class="line">│   │   │                       │     │     │                       │ │  │</span><br><span class="line">│   │   │ ✓ 自动负载均衡       │     │     │ ✗ 无自动负载均衡     │ │  │</span><br><span class="line">│   │   │ ✓ 触发 RebalanceCb   │     │     │ ✗ 不触发 RebalanceCb │ │  │</span><br><span class="line">│   │   └───────────────────────┘     │     └───────────────────────┘ │  │</span><br><span class="line">│   │                                 │                               │  │</span><br><span class="line">│   └─────────────────────────────────┴───────────────────────────────┘  │</span><br><span class="line">│                                                                         │</span><br><span class="line">└───────────────────────────────────────────────────────────┬─────────────┘</span><br><span class="line">                                                            │</span><br><span class="line">                                                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         消费阶段（循环）                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐    ┌───────────────────┐    ┌────────────────┐ │</span><br><span class="line">│   │    <span class="built_in">consume</span>()      │───→│    处理消息       │───→│   提交 offset  │ │</span><br><span class="line">│   │   拉取消息(阻塞)  │    │   业务逻辑处理    │    │  (可选手动)    │ │</span><br><span class="line">│   │                   │    │                   │    │ 用于确定下次读取的位置│ │</span><br><span class="line">│   │ ┌───────────────┐ │    │ ┌───────────────┐ │    │ ┌────────────┐ │ │</span><br><span class="line">│   │ │ KafkaConsumer │ │    │ │    Message    │ │    │ │<span class="built_in">commitSync</span>()│ │ │</span><br><span class="line">│   │ │  ::<span class="built_in">consume</span>()  │ │    │ │  (返回消息)   │ │    │ │   或       │ │ │</span><br><span class="line">│   │ └───────────────┘ │    │ └───────────────┘ │    │ │commitAsync│ │ │</span><br><span class="line">│   └───────────────────┘    └───────────────────┘    │ └────────────┘ │ │</span><br><span class="line">│            ▲                                        └───────┬────────┘ │</span><br><span class="line">│            │                                                │          │</span><br><span class="line">│            │         ┌──────────────────────────────────────┘          │</span><br><span class="line">│            │         │                                                 │</span><br><span class="line">│            │         ▼                                                 │</span><br><span class="line">│            │    ┌─────────────────────────────────────────────────┐   │</span><br><span class="line">│            │    │  消费过程中涉及的类：                             │   │</span><br><span class="line">│            │    │  ┌─────────┐  ┌───────────────┐  ┌───────────┐  │   │</span><br><span class="line">│            │    │  │ Message │  │TopicPartition │  │  Headers  │  │   │</span><br><span class="line">│            │    │  │ payload │  │ offset 管理   │  │ (消息头)  │  │   │</span><br><span class="line">│            │    │  │ key     │  └───────────────┘  └───────────┘  │   │</span><br><span class="line">│            │    │  │ offset  │                                    │   │</span><br><span class="line">│            │    │  └─────────┘                                    │   │</span><br><span class="line">│            │    └─────────────────────────────────────────────────┘   │</span><br><span class="line">│            │                                                           │</span><br><span class="line">│            └───────────────────────────────────────────────────────────┘</span><br><span class="line">│                                            (持续消费则循环)              │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────┐  │</span><br><span class="line">│   │                    重平衡触发时                                   │  │</span><br><span class="line">│   │                                                                  │  │</span><br><span class="line">│   │   消费者加入/离开组 ───→ RebalanceCb 触发 ───→ 重新分配分区     │  │</span><br><span class="line">│   │                                                                  │  │</span><br><span class="line">│   │   ┌─────────────────────────────────────────────────────────┐   │  │</span><br><span class="line">│   │   │  ERR__ASSIGN_PARTITIONS  →  <span class="built_in">assign</span>() / incremental_assign│   │  │</span><br><span class="line">│   │   │  ERR__REVOKE_PARTITIONS  →  <span class="built_in">unassign</span>() / incremental_    │   │  │</span><br><span class="line">│   │   │                             <span class="built_in">unassign</span>()                   │   │  │</span><br><span class="line">│   │   └─────────────────────────────────────────────────────────┘   │  │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────┘  │</span><br><span class="line">│                                                                         │</span><br><span class="line">└───────────────────────────────────────────────────────────────────────┬─┘</span><br><span class="line">                                                                        │</span><br><span class="line">                                                                        ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         清理阶段                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────┐         ┌───────────────────┐                  │</span><br><span class="line">│   │     <span class="built_in">close</span>()       │────────→│ <span class="keyword">delete</span> consumer   │                  │</span><br><span class="line">│   │   关闭消费者      │         │                   │                  │</span><br><span class="line">│   │                   │         │ ┌───────────────┐ │                  │</span><br><span class="line">│   │ ┌───────────────┐ │         │ │ KafkaConsumer │ │                  │</span><br><span class="line">│   │ │ KafkaConsumer │ │         │ │   (销毁)      │ │                  │</span><br><span class="line">│   │ │   ::<span class="built_in">close</span>()   │ │         │ └───────────────┘ │                  │</span><br><span class="line">│   │ └───────────────┘ │         └───────────────────┘                  │</span><br><span class="line">│   │                   │                                                │</span><br><span class="line">│   │ • 提交最终offset  │                                                │</span><br><span class="line">│   │ • 离开消费者组    │                                                │</span><br><span class="line">│   │ • 触发重平衡      │                                                │</span><br><span class="line">│   └───────────────────┘                                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="2-Conf类（配置类）">2.Conf类（配置类）</h2>
<p>dKafka::Conf 是 librdkafka 中<strong>配置管理的核心类</strong>，用于统一管理 Kafka 客户端（生产者 / 消费者）的<strong>全局配置</strong>、<strong>主题级配置</strong>，是创建生产者 / 消费者实例的基础。<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116100012806.png" alt=""></p>
<h3 id="（1）Conf类的定义">（1）Conf类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> Conf &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 配置类型</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">ConfType</span> &#123;</span><br><span class="line">        CONF_GLOBAL, <span class="comment">// 全局配置</span></span><br><span class="line">        CONF_TOPIC   <span class="comment">// Topic配置</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// set() 返回码</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">ConfResult</span> &#123;</span><br><span class="line">        CONF_UNKNOWN = <span class="number">-2</span>, <span class="comment">// 未知属性</span></span><br><span class="line">        CONF_INVALID = <span class="number">-1</span>, <span class="comment">// 无效值</span></span><br><span class="line">        CONF_OK      = <span class="number">0</span>   <span class="comment">// 成功</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建配置对象</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Conf *<span class="title">create</span><span class="params">(ConfType type)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Conf</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * @brief 设置字符串类型的配置属性</span></span><br><span class="line"><span class="comment">       * @param name 配置属性名称</span></span><br><span class="line"><span class="comment">       * @param value 配置值</span></span><br><span class="line"><span class="comment">       * @param errstr 错误时返回的错误描述</span></span><br><span class="line"><span class="comment">       * @return 配置结果码</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> std::string &amp;value,</span></span></span><br><span class="line"><span class="params"><span class="function">                           std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认 Topic 配置 (name = &quot;default_topic_conf&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, <span class="type">const</span> Conf *topic_conf, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================================== 设置回调函数配置 =================================================</span></span><br><span class="line">    <span class="comment">/*    1.参数：</span></span><br><span class="line"><span class="comment">            - name：配置名（固定）</span></span><br><span class="line"><span class="comment">                - 特征很明显，如DeliveryReportCb *dr_cb ——&gt; name：&quot;dr_cb&quot;</span></span><br><span class="line"><span class="comment">            - xxxCb：回调对象（成员函数：回调函数）</span></span><br><span class="line"><span class="comment">            - errstr：错误时返回的错误描述</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        2.返回值：</span></span><br><span class="line"><span class="comment">            - ConfResult：配置结果码（见上）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  1.DeliveryReportCb - 消息投递报告回调（⭐⭐⭐⭐⭐ 极高（生产者常用））</span></span><br><span class="line"><span class="comment">               - 功能：生产者发送消息后，通知消息是否成功投递到 Broker </span></span><br><span class="line"><span class="comment">            - 使用场景：确认消息发送成功/失败，处理发送失败的重试逻辑*/</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, DeliveryReportCb *dr_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 2.EventCb - 事件回调（⭐⭐⭐⭐⭐ 极高（生产者/消费者都常用））</span></span><br><span class="line"><span class="comment">            - 功能：接收 Kafka 客户端的各种事件（错误、统计信息、日志、限流等）</span></span><br><span class="line"><span class="comment">            - 使用场景：监控连接状态、记录错误日志、获取统计数据*/</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, EventCb *event_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*    3.RebalanceCb - 消费者重平衡回调</span></span><br><span class="line"><span class="comment">            - 功能：消费者组发生分区重新分配时触发（成员加入/离开）（⭐⭐⭐⭐ 高（消费者组常用））</span></span><br><span class="line"><span class="comment">            - 使用场景：在重平衡前保存 offset、释放资源；重平衡后初始化状态*/</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, RebalanceCb *rebalance_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*    4.OffsetCommitCb - 偏移量提交回调（⭐⭐⭐ 中等（需要精确控制 offset 时使用））</span></span><br><span class="line"><span class="comment">            - 功能：offset 提交完成后的通知（成功或失败）</span></span><br><span class="line"><span class="comment">            - 使用场景：确认 offset 提交状态，处理提交失败</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, OffsetCommitCb *cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*    5.PartitionerCb - 自定义分区器回调（⭐⭐⭐ 中等（默认分区器够用时不需要））</span></span><br><span class="line"><span class="comment">            - 功能：自定义消息路由到哪个分区的逻辑</span></span><br><span class="line"><span class="comment">            - 使用场景：需要特殊分区策略（如按业务 ID 分区、地理位置分区）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, PartitionerCb *partitioner_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*    6.ConsumeCb - 消息消费回调（⭐⭐⭐ 中等（通常直接用 poll() 更常见））</span></span><br><span class="line"><span class="comment">        - 功能：消费到消息时的回调处理</span></span><br><span class="line"><span class="comment">        - 使用场景：回调式消费模式（替代 poll 循环）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, ConsumeCb *consume_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面使用频率较低，就不详细注释了</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, OAuthBearerTokenRefreshCb *cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>; <span class="comment">//令牌刷新回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, SslCertificateVerifyCb *cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>; <span class="comment">//SSL 证书验证回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, SocketCb *socket_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>; <span class="comment">//Socket 创建回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, OpenCb *open_cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>; <span class="comment">//文件打开回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set</span><span class="params">(<span class="type">const</span> std::string &amp;name, PartitionerKeyPointerCb *cb, std::string &amp;errstr)</span> </span>= <span class="number">0</span>; <span class="comment">// 键指针分区器回调</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 SSL 证书/密钥</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set_ssl_cert</span><span class="params">(RdKafka::CertificateType cert_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    RdKafka::CertificateEncoding cert_enc,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> <span class="type">void</span> *buffer, <span class="type">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询字符串配置值</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(<span class="type">const</span> std::string &amp;name, std::string &amp;value)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 获取回调函数 ==========</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(DeliveryReportCb *&amp;dr_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(OAuthBearerTokenRefreshCb *&amp;cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(EventCb *&amp;event_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(PartitionerCb *&amp;partitioner_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(PartitionerKeyPointerCb *&amp;cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(SocketCb *&amp;socket_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(OpenCb *&amp;open_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(RebalanceCb *&amp;rebalance_cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(OffsetCommitCb *&amp;cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">get</span><span class="params">(SslCertificateVerifyCb *&amp;cb)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 导出所有配置 (name, value) 列表</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::list&lt;std::string&gt; *<span class="title">dump</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取底层 C 句柄（不推荐直接使用）</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">struct</span> <span class="title class_">rd_kafka_conf_s</span> *<span class="built_in">c_ptr_global</span>() = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">struct</span> <span class="title class_">rd_kafka_topic_conf_s</span> *<span class="built_in">c_ptr_topic</span>() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 SSL 引擎回调数据</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">set_engine_callback_data</span><span class="params">(<span class="type">void</span> *value, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启用 SASL 专用队列</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ConfResult <span class="title">enable_sasl_queue</span><span class="params">(<span class="type">bool</span> enable, std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="（2）Conf类的使用">（2）Conf类的使用</h3>
<h4 id="1-创建-RdKafka-Conf">&lt;1&gt;创建 RdKafka::Conf</h4>
<ul>
<li>RdKafka::Conf 的创建非常简单，使用<strong>静态工厂方法 create()</strong></li>
<li><strong>推荐</strong>：使用“智能指针”自动管理内存，避免手动 delete</li>
</ul>
<h5 id="1）使用智能指针直接创建">1）使用智能指针直接创建</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;librdkafka/rdkafkacpp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ==================== 1. 使用 unique_ptr 创建全局配置 ====================</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;RdKafka::Conf&gt; <span class="title">global_conf</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        RdKafka::Conf::create(RdKafka::Conf::CONF_GLOBAL)</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!global_conf) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;创建全局配置失败!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;全局配置创建成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 2. 使用 unique_ptr 创建 Topic 配置 ====================</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;RdKafka::Conf&gt; <span class="title">topic_conf</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        RdKafka::Conf::create(RdKafka::Conf::CONF_TOPIC)</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!topic_conf) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;创建 Topic 配置失败!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Topic 配置创建成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2）封装为工厂函数">2）封装为工厂函数</h5>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;librdkafka/rdkafkacpp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 工厂函数：创建全局配置</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;RdKafka::Conf&gt; <span class="title">createGlobalConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;RdKafka::Conf&gt;(</span><br><span class="line">        RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工厂函数：创建 Topic 配置</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;RdKafka::Conf&gt; <span class="title">createTopicConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;RdKafka::Conf&gt;(</span><br><span class="line">        RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_TOPIC)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> global_conf = <span class="built_in">createGlobalConf</span>();</span><br><span class="line">    <span class="keyword">auto</span> topic_conf = <span class="built_in">createTopicConf</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!global_conf || !topic_conf) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;配置创建失败!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;配置创建并设置成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="3）不使用“智能指针”（不推荐！）">3）不使用“智能指针”（不推荐！）</h5>
<p>在“RdKafka::Conf类的结构”部分可知：create返回 “裸指针”，所以需要“<strong>手动释放资源</strong>”</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;librdkafka/rdkafkacpp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string errstr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 1. 创建配置（裸指针） ====================</span></span><br><span class="line">    RdKafka::Conf *global_conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line">    RdKafka::Conf *topic_conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_TOPIC);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 必须检查是否创建成功</span></span><br><span class="line">    <span class="keyword">if</span> (!global_conf || !topic_conf) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;配置创建失败!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// ⚠️ 问题1：如果一个成功一个失败，需要处理部分释放</span></span><br><span class="line">        <span class="keyword">delete</span> global_conf;  <span class="comment">// 可能是 nullptr，但 delete nullptr 是安全的</span></span><br><span class="line">        <span class="keyword">delete</span> topic_conf;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-设置-RdKafka-Conf">&lt;2&gt;设置 RdKafka::Conf</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Producer 最小配置</span></span><br><span class="line">RdKafka::Conf *conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>, errstr);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;acks&quot;</span>, <span class="string">&quot;all&quot;</span>, errstr);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;dr_cb&quot;</span>, &amp;delivery_cb, errstr);  <span class="comment">// 投递回调</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Consumer 最小配置</span></span><br><span class="line">RdKafka::Conf *conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>, errstr);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;my-consumer-group&quot;</span>, errstr);</span><br><span class="line">conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;enable.auto.commit&quot;</span>, <span class="string">&quot;false&quot;</span>, errstr);</span><br></pre></td></tr></table></figure>
<p><strong>“回调类”参考</strong>：<a href="#cb">回调类</a></p>
<h5 id="1）生产者常用配置">1）生产者常用配置</h5>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116161810771.png" alt=""></p>
<h5 id="2）消费者常用配置">2）消费者常用配置</h5>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116161420955.png" alt=""></p>
<p>想了解更多配置项，<strong>参考</strong>：<a href="#config">附录1：常用配置项</a></p>
<h2 id="3-TopicPartition类（主题分区类）">3.TopicPartition类（主题分区类）</h2>
<h3 id="（1）概述">（1）概述</h3>
<h4 id="1-作用">&lt;1&gt;作用</h4>
<ul>
<li>封装**&lt;topic, partition, offset&gt;**三元组的核心类</li>
<li>客户端与 Kafka 集群交互「<strong>分区级操作</strong>」的基础载体</li>
<li>所有和「<strong>指定分区、控制消费位置、提交偏移量</strong>」相关的操作都依赖该类</li>
</ul>
<h4 id="2-核心定位">&lt;2&gt;核心定位</h4>
<ul>
<li><strong>元数据载体</strong>：
<ul>
<li>本质是存储「主题名（string）、分区号（int）、偏移量（int64_t）」的轻量级类，仅记录 “要操作的目标分区 + 位置”，<strong>不包含任何集群交互逻辑</strong>；</li>
</ul>
</li>
<li><strong>操作桥梁</strong>：
<ul>
<li>作为 assign()（手动分配分区）、commitSync()/commitAsync()（提交 offset）、seek()（重置消费位置）等核心 API 的入参 / 返回值，是<strong>客户端向 Kafka 传递 “分区操作指令” 的标准化格式</strong>；</li>
</ul>
</li>
<li><strong>无状态特性</strong>：
<ul>
<li>该类对象仅存储静态元数据，不关联 Kafka 连接状态，<strong>修改对象属性（如 offset）仅影响本地，需调用 API 才能同步到集群</strong>。</li>
</ul>
</li>
</ul>
<h3 id="（2）TopicPartition类的定义">（2）TopicPartition类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> TopicPartition &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//==================== 高频使用（必用） ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 创建 topic+partition 关联对象（无 offset）</span></span><br><span class="line"><span class="comment">     * 需使用 delete 释放</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> TopicPartition *<span class="title">create</span><span class="params">(<span class="type">const</span> std::string &amp;topic, <span class="type">int</span> partition)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 创建 topic+partition+offset 关联对象</span></span><br><span class="line"><span class="comment">     * 需使用 delete 释放</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> TopicPartition *<span class="title">create</span><span class="params">(<span class="type">const</span> std::string &amp;topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">int</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">int64_t</span> offset)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> std::string &amp;<span class="title">topic</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;    <span class="comment">// 获取 topic 名</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">partition</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;               <span class="comment">// 获取分区 ID</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">offset</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;              <span class="comment">// 获取 offset</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//==================== 中频使用（常用） ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">destroy</span><span class="params">(std::vector&lt;TopicPartition *&gt; &amp;partitions)</span></span>;  <span class="comment">// 批量销毁</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">err</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;               <span class="comment">// 获取错误码</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set_offset</span><span class="params">(<span class="type">int64_t</span> offset)</span> </span>= <span class="number">0</span>;     <span class="comment">// 设置 offset</span></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">TopicPartition</span>() = <span class="number">0</span>;                   <span class="comment">// 析构函数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//==================== 低频使用（高级场景） ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">get_leader_epoch</span><span class="params">()</span> </span>= <span class="number">0</span>;          <span class="comment">// 获取 leader epoch</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set_leader_epoch</span><span class="params">(<span class="type">int32_t</span> leader_epoch)</span> </span>= <span class="number">0</span>;  <span class="comment">//设置 leader epoch</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//==================== 极少使用（特殊场景） ====================</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::vector&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; <span class="title">get_metadata</span><span class="params">()</span> </span>= <span class="number">0</span>;  <span class="comment">// 获取分区元数据</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">set_metadata</span><span class="params">(std::vector&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt; &amp;metadata)</span> </span>= <span class="number">0</span>; <span class="comment">// 设置分区元数据</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 特殊 offset 常量（按使用频率）</span></span><br><span class="line"><span class="type">const</span> <span class="type">int64_t</span> OFFSET_STORED    = <span class="number">-1000</span>; <span class="comment">// ★★★ 最常用：从上次提交位置继续</span></span><br><span class="line"><span class="type">const</span> <span class="type">int64_t</span> OFFSET_END       = <span class="number">-1</span>;    <span class="comment">// ★★  常用：只消费新消息</span></span><br><span class="line"><span class="type">const</span> <span class="type">int64_t</span> OFFSET_BEGINNING = <span class="number">-2</span>;    <span class="comment">// ★★  常用：从头消费所有消息</span></span><br><span class="line"><span class="type">const</span> <span class="type">int64_t</span> OFFSET_INVALID   = <span class="number">-1001</span>; <span class="comment">// ★   少用：表示无效状态</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116211851723.png" alt=""></p>
<h3 id="（3）典型使用场景（结合核心-API）">（3）典型使用场景（结合核心 API）</h3>
<h4 id="1-手动分配分区">&lt;1&gt; 手动分配分区</h4>
<p>无需指定偏移量，仅关联「主题 + 分区」，依赖 auto.offset.reset 配置确定消费位置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;RdKafka::TopicPartition*&gt; partitions;</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>));</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">1</span>));</span><br><span class="line">consumer-&gt;<span class="built_in">assign</span>(partitions); <span class="comment">// 仅指定要消费的分区</span></span><br></pre></td></tr></table></figure>
<h4 id="2-指定偏移量消费">&lt;2&gt;指定偏移量消费</h4>
<p>创建时指定偏移量，重置消费位置：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 topic1-0 分区的第 100 条消息开始消费</span></span><br><span class="line">RdKafka::TopicPartition *tp = RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">consumer-&gt;<span class="built_in">seek</span>(tp, <span class="number">5000</span>); <span class="comment">// 5000ms 超时时间</span></span><br><span class="line"><span class="keyword">delete</span> tp;</span><br></pre></td></tr></table></figure>
<h4 id="3-手动提交指定-offset">&lt;3&gt;手动提交指定 offset</h4>
<p>修改对象偏移量后提交，实现精准的 offset 管理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;RdKafka::TopicPartition*&gt; partitions;</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>));</span><br><span class="line">partitions[<span class="number">0</span>]-&gt;<span class="built_in">set_offset</span>(<span class="number">200</span>); <span class="comment">// 提交 topic1-0 的 offset=200</span></span><br><span class="line">consumer-&gt;<span class="built_in">commitSync</span>(partitions); <span class="comment">// 同步提交</span></span><br></pre></td></tr></table></figure>
<h4 id="4-批量操作所有分区">&lt;4&gt;批量操作所有分区</h4>
<p>使用 partition=-1 代表主题的所有分区：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 提交 topic1 所有分区的 offset=300</span></span><br><span class="line">RdKafka::TopicPartition *tp = RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">-1</span>, <span class="number">300</span>);</span><br><span class="line">consumer-&gt;<span class="built_in">commitSync</span>(&#123;tp&#125;);</span><br><span class="line"><span class="keyword">delete</span> tp;</span><br></pre></td></tr></table></figure>
<h4 id="5-destroy-的使用示例">&lt;5&gt;destroy() 的使用示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量创建</span></span><br><span class="line">std::vector&lt;RdKafka::TopicPartition*&gt; partitions;</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>));</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">1</span>));</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic2&quot;</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">consumer-&gt;<span class="built_in">assign</span>(partitions);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 使用完毕后 ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1：手动逐个删除</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> p : partitions) </span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">partitions.<span class="built_in">clear</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：使用 destroy() 一次性销毁并清空（推荐）</span></span><br><span class="line">RdKafka::TopicPartition::<span class="built_in">destroy</span>(partitions);  <span class="comment">// 删除所有元素 + 清空 vector</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="（4）内存管理（核心注意事项）">（4）内存管理（核心注意事项）</h3>
<p><strong>必须释放资源</strong>：</p>
<ul>
<li>create 方法返回的是动态分配的裸指针，未释放会导致内存泄漏，推荐两种方式：
<ul>
<li>手动 delete（基础方式）</li>
<li>封装智能指针（生产环境推荐）</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//手动 delete</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> p : partitions) &#123;</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">    p = <span class="literal">nullptr</span>; <span class="comment">// 避免野指针</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用智能指针</span></span><br><span class="line"><span class="keyword">using</span> TopicPartitionPtr = std::unique_ptr&lt;RdKafka::TopicPartition&gt;;</span><br><span class="line"><span class="function">TopicPartitionPtr <span class="title">tp</span><span class="params">(RdKafka::TopicPartition::create(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>))</span></span>;</span><br><span class="line"><span class="comment">// 自动释放，无需手动 delete</span></span><br></pre></td></tr></table></figure>
<h3 id="（5）核心易错点与最佳实践">（5）核心易错点与最佳实践</h3>
<h4 id="1-易错点">&lt;1&gt;易错点</h4>
<ul>
<li><strong>混淆「客户端对象创建」和「集群物理创建」</strong>：
<ul>
<li>TopicPartition::create 仅创建<strong>本地对象</strong>，不会在 Kafka 集群创建主题 / 分区；</li>
</ul>
</li>
<li><strong>忽略内存释放</strong>：
<ul>
<li>生产环境需严格管理 TopicPartition 指针，<strong>建议封装智能指针</strong>；</li>
</ul>
</li>
<li><strong>偏移量设置后未调用 API</strong>：
<ul>
<li><strong>修改 offset 仅改本地值</strong>，需调用 commitSync()/seek() 等 API 才能同步到集群；</li>
</ul>
</li>
<li><strong>分区号越界</strong>：
<ul>
<li>指定的分区号超出主题实际分区数，会导致 assign()/commitSync() 返回 ERR_UNKNOWN_PARTITION 错误。</li>
</ul>
</li>
</ul>
<h2 id="4-Headers类（消息头类）">4.Headers类（消息头类）</h2>
<h3 id="（1）概述-2">（1）概述</h3>
<h4 id="1-作用-2">&lt;1&gt;作用</h4>
<ul>
<li>RdKafka::Headers 是 librdkafka 中<strong>封装 Kafka 消息头（Header）的核心类</strong>
<ul>
<li>用于为消息附<strong>加键值对</strong>形式的元数据（如业务标识、追踪 ID、消息类型等）</li>
<li>是消息内容之外的 “<strong>辅助信息载体</strong>”，不影响消息的分区路由，仅用于业务侧的消息溯源、过滤、扩展。</li>
</ul>
</li>
</ul>
<h4 id="2-核心定位-2">&lt;2&gt;核心定位</h4>
<ul>
<li><strong>元数据扩展</strong>：
<ul>
<li><strong>弥补 Kafka 消息 Key/Value 仅能存储业务数据的不足</strong></li>
<li>支持附加多组键值对元数据（如 trace-id: 123456、msg-type: order）；</li>
</ul>
</li>
<li><strong>可写 / 只读特性</strong>：
<ul>
<li>生产者侧可创建并写入 Headers</li>
<li>消费者侧仅能读取 Headers（<strong>消息一旦发送，Headers 不可修改</strong>）；</li>
</ul>
</li>
<li><strong>轻量级设计</strong>：
<ul>
<li>Headers 存储的是字符串键值对，<strong>建议仅存放轻量元数据</strong>（避免增大消息体积）。</li>
</ul>
</li>
<li><strong>跨系统兼容</strong>：
<ul>
<li>消息头是 Kafka 协议标准特性，可与其他 Kafka 客户端（如 Java、Python）互通，便于多语言系统协作；</li>
</ul>
</li>
</ul>
<h3 id="（2）Headers类的定义">（2）Headers类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> Headers &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Headers</span>() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 单个 Header 对象（键值对 + 错误码）</span></span><br><span class="line"><span class="comment">     * @remark 不支持动态分配（new）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Header</span> &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @brief 构造 Header</span></span><br><span class="line"><span class="comment">         * @param key    Header 的键（字符串）</span></span><br><span class="line"><span class="comment">         * @param value  Header 的值（二进制，可为 NULL）</span></span><br><span class="line"><span class="comment">         * @param value_size  值的字节长度</span></span><br><span class="line"><span class="comment">         * @remark key 和 value 会被复制</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">Header</span>(<span class="type">const</span> std::string &amp;key, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> value_size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @brief 构造 Header（带错误码）</span></span><br><span class="line"><span class="comment">         * @param key    Header 的键</span></span><br><span class="line"><span class="comment">         * @param value  Header 的值</span></span><br><span class="line"><span class="comment">         * @param value_size  值的字节长度</span></span><br><span class="line"><span class="comment">         * @param err    错误码（用于 get_last() 内部构造失败结果）</span></span><br><span class="line"><span class="comment">         * @remark 若 err != ERR_NO_ERROR，value 和 value_size 字段未定义</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">Header</span>(<span class="type">const</span> std::string &amp;key, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> value_size, </span><br><span class="line">               <span class="type">const</span> RdKafka::ErrorCode err);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Header</span>(<span class="type">const</span> Header &amp;other);              <span class="comment">// 拷贝构造</span></span><br><span class="line">        Header &amp;<span class="keyword">operator</span>=(<span class="type">const</span> Header &amp;other);   <span class="comment">// 赋值运算符</span></span><br><span class="line">        ~<span class="built_in">Header</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function">std::string <span class="title">key</span><span class="params">()</span> <span class="type">const</span></span>;                  <span class="comment">// 获取键名</span></span><br><span class="line">        <span class="function"><span class="type">const</span> <span class="type">void</span> *<span class="title">value</span><span class="params">()</span> <span class="type">const</span></span>;                <span class="comment">// 获取二进制值（可能为 NULL）</span></span><br><span class="line">        <span class="function"><span class="type">const</span> <span class="type">char</span> *<span class="title">value_string</span><span class="params">()</span> <span class="type">const</span></span>;         <span class="comment">// 获取值并转为 C 字符串（可能为 NULL）</span></span><br><span class="line">        <span class="function"><span class="type">size_t</span> <span class="title">value_size</span><span class="params">()</span> <span class="type">const</span></span>;                <span class="comment">// 获取值的字节长度</span></span><br><span class="line">        <span class="function">RdKafka::ErrorCode <span class="title">err</span><span class="params">()</span> <span class="type">const</span></span>;           <span class="comment">// 获取错误码（通常为 ERR_NO_ERROR）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="function"><span class="type">char</span> *<span class="title">copy_value</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> value_size)</span></span>;</span><br><span class="line">        std::string key_;</span><br><span class="line">        RdKafka::ErrorCode err_;</span><br><span class="line">        <span class="type">char</span> *value_;</span><br><span class="line">        <span class="type">size_t</span> value_size_;</span><br><span class="line">        <span class="function"><span class="type">void</span> *<span class="keyword">operator</span> <span class="title">new</span><span class="params">(<span class="type">size_t</span>)</span></span>;               <span class="comment">// 禁止动态分配</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 创建空的 Headers 对象</span></span><br><span class="line"><span class="comment">     * @returns 空 Headers 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Headers *<span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 从 std::vector 创建 Headers 对象</span></span><br><span class="line"><span class="comment">     * @param headers  Header 向量（会被复制，非引用）</span></span><br><span class="line"><span class="comment">     * @returns Headers 列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Headers *<span class="title">create</span><span class="params">(<span class="type">const</span> std::vector&lt;Header&gt; &amp;headers)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加 Header（二进制值）</span></span><br><span class="line"><span class="comment">     * @param key    键名</span></span><br><span class="line"><span class="comment">     * @param value  二进制值（可为 NULL）</span></span><br><span class="line"><span class="comment">     * @param value_size  值的字节长度</span></span><br><span class="line"><span class="comment">     * @returns 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">add</span><span class="params">(<span class="type">const</span> std::string &amp;key, <span class="type">const</span> <span class="type">void</span> *value, <span class="type">size_t</span> value_size)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加 Header（字符串值，便捷方法）</span></span><br><span class="line"><span class="comment">     * @param key    键名</span></span><br><span class="line"><span class="comment">     * @param value  字符串值</span></span><br><span class="line"><span class="comment">     * @returns 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">add</span><span class="params">(<span class="type">const</span> std::string &amp;key, <span class="type">const</span> std::string &amp;value)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 添加 Header（复制已有 Header 对象）</span></span><br><span class="line"><span class="comment">     * @param header  要复制的 Header</span></span><br><span class="line"><span class="comment">     * @returns 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">add</span><span class="params">(<span class="type">const</span> Header &amp;header)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 移除指定 key 的所有 Header</span></span><br><span class="line"><span class="comment">     * @param key  要移除的键名</span></span><br><span class="line"><span class="comment">     * @returns 错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">remove</span><span class="params">(<span class="type">const</span> std::string &amp;key)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取指定 key 的所有 Header</span></span><br><span class="line"><span class="comment">     * @param key  键名</span></span><br><span class="line"><span class="comment">     * @returns 包含所有匹配 Header 的向量（支持重复 key）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::vector&lt;Header&gt; <span class="title">get</span><span class="params">(<span class="type">const</span> std::string &amp;key)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取指定 key 的最后一个 Header</span></span><br><span class="line"><span class="comment">     * @param key  键名</span></span><br><span class="line"><span class="comment">     * @returns 找到则返回 Header，未找到则返回 err=ERR__NOENT 的 Header</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Header <span class="title">get_last</span><span class="params">(<span class="type">const</span> std::string &amp;key)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取所有 Header</span></span><br><span class="line"><span class="comment">     * @returns 包含所有 Header 的向量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::vector&lt;Header&gt; <span class="title">get_all</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取 Header 数量</span></span><br><span class="line"><span class="comment">     * @returns Header 个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="（3）使用示例">（3）使用示例</h3>
<h4 id="1-生产者写入-Headers-示例">&lt;1&gt;生产者写入 Headers 示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 创建 Headers 对象</span></span><br><span class="line">RdKafka::Headers *headers = RdKafka::Headers::<span class="built_in">create</span>();</span><br><span class="line"><span class="keyword">if</span> (!headers) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;创建 Headers 失败&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 添加键值对（支持多组）</span></span><br><span class="line">headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;trace-id&quot;</span>, <span class="string">&quot;trace-789012&quot;</span>);              <span class="comment">// 字符串重载（推荐）</span></span><br><span class="line">headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;msg-type&quot;</span>, <span class="string">&quot;payment&quot;</span>);                   <span class="comment">// 字符串重载</span></span><br><span class="line">headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;timestamp&quot;</span>, std::<span class="built_in">to_string</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>)));  <span class="comment">// 字符串重载</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用二进制形式</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* binary_data = <span class="string">&quot;binary-value&quot;</span>;</span><br><span class="line">headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;binary-key&quot;</span>, binary_data, <span class="built_in">strlen</span>(binary_data));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 发送消息时附加 Headers</span></span><br><span class="line">RdKafka::ErrorCode err = producer-&gt;<span class="built_in">produce</span>(</span><br><span class="line">    <span class="string">&quot;my-topic&quot;</span>,</span><br><span class="line">    RdKafka::Topic::PARTITION_UA,</span><br><span class="line">    RdKafka::Producer::RK_MSG_COPY,</span><br><span class="line">    <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(<span class="string">&quot;order-payload&quot;</span>), <span class="number">13</span>,</span><br><span class="line">    <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(<span class="string">&quot;order-key&quot;</span>), <span class="number">9</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    headers,    <span class="comment">// 附加消息头</span></span><br><span class="line">    <span class="literal">nullptr</span>     <span class="comment">// opaque</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;发送失败：&quot;</span> &lt;&lt; RdKafka::<span class="built_in">err2str</span>(err) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">delete</span> headers;  <span class="comment">// ⚠️ produce() 失败时需手动释放</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// ⚠️ produce() 成功后，headers 所有权转移给 librdkafka，无需手动 delete</span></span><br></pre></td></tr></table></figure>
<h4 id="2-消费者读取-Headers-示例">&lt;2&gt;消费者读取 Headers 示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费消息并读取 Headers</span></span><br><span class="line">RdKafka::Message *msg = consumer-&gt;<span class="built_in">consume</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">if</span> (!msg || msg-&gt;<span class="built_in">err</span>() != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">    <span class="keyword">delete</span> msg;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 获取消息的 Headers 对象（无 Headers 则返回 nullptr）</span></span><br><span class="line">RdKafka::Headers *headers = msg-&gt;<span class="built_in">headers</span>();</span><br><span class="line"><span class="keyword">if</span> (headers) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;消息头数量：&quot;</span> &lt;&lt; headers-&gt;<span class="built_in">size</span>() &lt;&lt; std::endl;  <span class="comment">// ✅ 用 size()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 读取指定 key 的所有值（支持重复 key）</span></span><br><span class="line">    std::vector&lt;RdKafka::Headers::Header&gt; trace_headers = headers-&gt;<span class="built_in">get</span>(<span class="string">&quot;trace-id&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; h : trace_headers) &#123;</span><br><span class="line">        <span class="keyword">if</span> (h.<span class="built_in">err</span>() == RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;trace-id：&quot;</span> &lt;&lt; h.<span class="built_in">value_string</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 读取指定 key 的最后一个值</span></span><br><span class="line">    RdKafka::Headers::Header last_trace = headers-&gt;<span class="built_in">get_last</span>(<span class="string">&quot;trace-id&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (last_trace.<span class="built_in">err</span>() == RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;最后一个 trace-id：&quot;</span> &lt;&lt; last_trace.<span class="built_in">value_string</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;未找到 trace-id&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 遍历所有 Headers</span></span><br><span class="line">    std::vector&lt;RdKafka::Headers::Header&gt; all_headers = headers-&gt;<span class="built_in">get_all</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; all_headers.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="type">const</span> <span class="keyword">auto</span>&amp; h = all_headers[i];</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Header[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]：&quot;</span> &lt;&lt; h.<span class="built_in">key</span>() &lt;&lt; <span class="string">&quot; = &quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (h.<span class="built_in">value</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; h.<span class="built_in">value_string</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;(null)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;该消息无消息头&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> msg;</span><br></pre></td></tr></table></figure>
<h3 id="（4）核心注意事项">（4）核心注意事项</h3>
<ul>
<li><strong>内存管理</strong>：
<ul>
<li><strong>生产者侧</strong>：create() 创建的 Headers
<ul>
<li>若 produce() <strong>成功</strong>：则所有权转移给 librdkafka，<strong>无需手动释放</strong>；</li>
<li>若 produce() <strong>失败</strong>：则<strong>需手动 delete</strong>；</li>
</ul>
</li>
<li><strong>消费者</strong>侧从 msg-&gt;headers() 获取的 Headers 由 Message 对象管理
<ul>
<li><strong>无需手动释放</strong>（释放 Message 时自动释放）；</li>
</ul>
</li>
</ul>
</li>
<li><strong>空值处理</strong>：
<ul>
<li>Header 的 Value 可以为空（value=nullptr，value_len=0），需在读取时判断 val 是否为 nullptr；</li>
</ul>
</li>
<li><strong>get_last() 错误处理</strong>：
<ul>
<li>未找到时返回 err=ERR__NOENT 的 Header，需检查 h.err() 后再使用 value()；</li>
</ul>
</li>
<li><strong>性能影响</strong>：
<ul>
<li>Headers 会增加消息体积，建议单条消息的 Headers 总大小不超过 1KB，避免影响吞吐量。</li>
</ul>
</li>
</ul>
<h2 id="5-Handle类（句柄基类）">5.Handle类（句柄基类）</h2>
<h3 id="（1）概述-3">（1）概述</h3>
<h4 id="1-作用-3">&lt;1&gt;作用</h4>
<ul>
<li>RdKafka::Handle 是 librdkafka 中<strong>生产者和消费者客户端</strong>（Producer / Consumer / KafkaConsumer）<strong>的抽象基类</strong>
<ul>
<li><strong>定义了客户端的通用能力</strong>（事件轮询（poll）、元数据/偏移量查询、流控（pause/resume）、集群信息获取等），是整个 librdkafka 客户端的 “基础骨架”</li>
<li><strong>生产者和消费者客户端</strong>（如 Producer、Consumer、KafkaConsumer）均继承自 Handle，因此<strong>具备统一的基础行为</strong>。</li>
</ul>
</li>
</ul>
<h4 id="2-核心定位-3">&lt;2&gt;核心定位</h4>
<ul>
<li><strong>抽象通用能力</strong>：
<ul>
<li>提取生产者、消费者的共性操作（如配置获取、错误码转换、资源销毁），避免代码冗余；</li>
</ul>
</li>
<li><strong>生命周期管理</strong>：
<ul>
<li>定义客户端的创建 / 销毁规范，统一管理与 Kafka 集群的连接资源；</li>
</ul>
</li>
<li><strong>状态与配置统一</strong>：
<ul>
<li>提供全局的配置查询、错误处理、日志相关接口，保证不同客户端的使用体验一致；</li>
</ul>
</li>
<li><strong>纯抽象类特性</strong>：
<ul>
<li>Handle 包含纯虚函数，无法直接实例化，仅能通过子类（Producer/Consumer/KafkaConsumer）使用其接口。</li>
</ul>
</li>
</ul>
<h3 id="（2）Handle-类的定义">（2）Handle 类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> Handle &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Handle</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第一梯队】几乎每个应用都会用到</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 轮询事件</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 超时时间（毫秒），0=非阻塞，-1=无限等待</span></span><br><span class="line"><span class="comment">     * @returns 处理的事件数量</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 触发已注册的回调函数（如 DeliveryCb、EventCb）</span></span><br><span class="line"><span class="comment">     * @warning 禁止在 KafkaConsumer 中使用，应使用 consume() 代替</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取客户端名称</span></span><br><span class="line"><span class="comment">     * @returns 客户端名称字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取待发送/待确认的消息队列长度</span></span><br><span class="line"><span class="comment">     * @returns 队列中的消息数量</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 常用于优雅关闭时等待所有消息发送完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int</span> <span class="title">outq_len</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第二梯队】元数据与偏移量查询（常用）</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 从 Broker 请求元数据</span></span><br><span class="line"><span class="comment">     * @param all_topics   true=请求所有 Topic，false=仅本地已知 Topic</span></span><br><span class="line"><span class="comment">     * @param only_rkt     仅请求指定 Topic 的元数据（可为 NULL）</span></span><br><span class="line"><span class="comment">     * @param metadatap    [out] 元数据结果指针，需用 delete 释放</span></span><br><span class="line"><span class="comment">     * @param timeout_ms   超时时间（毫秒）</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功，ERR__TIMED_OUT 超时，其他为错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">metadata</span><span class="params">(<span class="type">bool</span> all_topics,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">const</span> Topic *only_rkt,</span></span></span><br><span class="line"><span class="params"><span class="function">                               Metadata **metadatap,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 查询分区的水位偏移量（从 Broker 实时查询）</span></span><br><span class="line"><span class="comment">     * @param topic      Topic 名称</span></span><br><span class="line"><span class="comment">     * @param partition  分区号</span></span><br><span class="line"><span class="comment">     * @param low        [out] 最低偏移量（最早消息）</span></span><br><span class="line"><span class="comment">     * @param high       [out] 最高偏移量（最新消息）</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 超时时间</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功，其他为错误码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">query_watermark_offsets</span><span class="params">(<span class="type">const</span> std::string &amp;topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">int64_t</span> *low,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">int64_t</span> *high,</span></span></span><br><span class="line"><span class="params"><span class="function">                                              <span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取缓存的分区水位偏移量（本地缓存，不请求 Broker）</span></span><br><span class="line"><span class="comment">     * @param topic      Topic 名称</span></span><br><span class="line"><span class="comment">     * @param partition  分区号</span></span><br><span class="line"><span class="comment">     * @param low        [out] 最低偏移量</span></span><br><span class="line"><span class="comment">     * @param high       [out] 最高偏移量</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功，其他为错误码</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 仅适用于活跃的消费者实例</span></span><br><span class="line"><span class="comment">     * @remark 无缓存时返回 OFFSET_INVALID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">get_watermark_offsets</span><span class="params">(<span class="type">const</span> std::string &amp;topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">int64_t</span> *low,</span></span></span><br><span class="line"><span class="params"><span class="function">                                            <span class="type">int64_t</span> *high)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 根据时间戳查找偏移量</span></span><br><span class="line"><span class="comment">     * @param offsets    [in/out] TopicPartition 列表，输入 offset 字段为时间戳，</span></span><br><span class="line"><span class="comment">     *                   输出 offset 字段为对应偏移量</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 超时时间</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功（可能有部分分区失败，需检查各分区的 err()）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 时间戳为毫秒级 Unix 时间戳（UTC）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">offsetsForTimes</span><span class="params">(std::vector&lt;TopicPartition *&gt; &amp;offsets,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第三梯队】流控与集群信息</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 暂停指定分区的生产/消费</span></span><br><span class="line"><span class="comment">     * @param partitions 分区列表，每个分区的结果会写入其 err() 字段</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">pause</span><span class="params">(std::vector&lt;TopicPartition *&gt; &amp;partitions)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 恢复指定分区的生产/消费</span></span><br><span class="line"><span class="comment">     * @param partitions 分区列表，每个分区的结果会写入其 err() 字段</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">resume</span><span class="params">(std::vector&lt;TopicPartition *&gt; &amp;partitions)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取 Kafka 集群 ID</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 无缓存时的最大等待时间，0=非阻塞</span></span><br><span class="line"><span class="comment">     * @returns 集群 ID 字符串，失败返回空字符串</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 要求 Broker 版本 &gt;= 0.10.0 且 api.version.request=true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">clusterid</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取当前 Controller Broker 的 ID</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 无缓存时的最大等待时间</span></span><br><span class="line"><span class="comment">     * @returns Controller ID，失败返回 -1</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 要求 Broker 版本 &gt;= 0.10.0 且 api.version.request=true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">controllerid</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取消费者的组成员 ID</span></span><br><span class="line"><span class="comment">     * @returns 成员 ID，非组成员时返回空字符串</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 仅适用于高级消费者（KafkaConsumer）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">memberid</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第四梯队】队列管理与回调控制</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取指定分区的 Fetch 队列</span></span><br><span class="line"><span class="comment">     * @param partition 分区对象</span></span><br><span class="line"><span class="comment">     * @returns 队列指针，失败返回 NULL</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 仅适用于消费者</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Queue *<span class="title">get_partition_queue</span><span class="params">(<span class="type">const</span> TopicPartition *partition)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 将日志转发到指定队列</span></span><br><span class="line"><span class="comment">     * @param queue 目标队列，NULL 表示转发到主队列</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 需同时设置配置项 log.queue=true</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">set_log_queue</span><span class="params">(Queue *queue)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取后台线程队列</span></span><br><span class="line"><span class="comment">     * @returns 后台队列指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Queue *<span class="title">get_background_queue</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 取消当前的回调分发（立即从 poll/consume 返回）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 只能在 librdkafka 回调函数内部调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">yield</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第五梯队】错误处理与认证（特定场景）</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取首个致命错误</span></span><br><span class="line"><span class="comment">     * @param errstr [out] 错误描述字符串</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 表示无致命错误，其他为错误码</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 主要用于幂等生产者的错误检测</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">fatal_error</span><span class="params">(std::string &amp;errstr)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 设置 SASL PLAIN/SCRAM 认证凭据</span></span><br><span class="line"><span class="comment">     * @param username 用户名</span></span><br><span class="line"><span class="comment">     * @param password 密码</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 新凭据在下次认证时生效，不会断开现有连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">sasl_set_credentials</span><span class="params">(<span class="type">const</span> std::string &amp;username,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="type">const</span> std::string &amp;password)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 设置 SASL/OAUTHBEARER Token</span></span><br><span class="line"><span class="comment">     * @param token_value      Token 值（通常为 JWS 格式）</span></span><br><span class="line"><span class="comment">     * @param md_lifetime_ms   Token 过期时间（毫秒级 Unix 时间戳）</span></span><br><span class="line"><span class="comment">     * @param md_principal_name Kafka Principal 名称</span></span><br><span class="line"><span class="comment">     * @param extensions       扩展键值对列表（key1, value1, key2, value2...）</span></span><br><span class="line"><span class="comment">     * @param errstr           [out] 错误描述</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功，ERR__INVALID_ARG 参数错误，</span></span><br><span class="line"><span class="comment">     *          ERR__NOT_IMPLEMENTED 不支持，ERR__STATE 未配置 OAUTHBEARER</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">oauthbearer_set_token</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::string &amp;token_value,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int64_t</span> md_lifetime_ms,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::string &amp;md_principal_name,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::list&lt;std::string&gt; &amp;extensions,</span></span></span><br><span class="line"><span class="params"><span class="function">        std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 标记 SASL/OAUTHBEARER Token 刷新失败</span></span><br><span class="line"><span class="comment">     * @param errstr 失败原因描述</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">oauthbearer_set_token_failure</span><span class="params">(<span class="type">const</span> std::string &amp;errstr)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 在后台线程启用 SASL OAUTHBEARER 刷新回调</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 适用于不定期调用 poll() 的应用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">sasl_background_callbacks_enable</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取 SASL 回调队列</span></span><br><span class="line"><span class="comment">     * @returns 队列指针，未启用时返回 NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Queue *<span class="title">get_sasl_queue</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第六梯队】底层操作（高级用法）</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 获取底层 C 语言句柄</span></span><br><span class="line"><span class="comment">     * @returns rd_kafka_t* 指针</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @warning 不推荐直接调用 C API，无官方支持</span></span><br><span class="line"><span class="comment">     * @remark 需在 rdkafkacpp.h 之前包含 rdkafka.h</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="keyword">struct</span> <span class="title class_">rd_kafka_s</span> *<span class="built_in">c_ptr</span>() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 使用 librdkafka 的分配器申请内存</span></span><br><span class="line"><span class="comment">     * @param size 字节数</span></span><br><span class="line"><span class="comment">     * @returns 内存指针</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 必须使用 mem_free() 释放</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> *<span class="title">mem_malloc</span><span class="params">(<span class="type">size_t</span> size)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 释放 librdkafka 返回的内存</span></span><br><span class="line"><span class="comment">     * @param ptr 内存指针</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 仅用于 API 明确说明需使用此函数释放的指针</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">mem_free</span><span class="params">(<span class="type">void</span> *ptr)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="（3）核心特性与注意事项">（3）核心特性与注意事项</h3>
<ul>
<li><strong>继承关系</strong>：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RdKafka::Handle（抽象基类）</span><br><span class="line">├─ RdKafka::Producer          <span class="comment">// 生产者</span></span><br><span class="line">├─ RdKafka::Consumer          <span class="comment">// 低级消费者（Simple Consumer，很少用）</span></span><br><span class="line">└─ RdKafka::KafkaConsumer     <span class="comment">// 高级消费者（High-Level Consumer，90%+用它）</span></span><br><span class="line"></span><br><span class="line">RdKafka::AdminClient          <span class="comment">// 管理客户端（独立，不继承 Handle）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><strong>资源管理</strong>：</p>
<ul>
<li>客户端实例由 Conf::create() + Producer/KafkaConsumer::create() 创建</li>
<li>必须通过 delete 释放</li>
</ul>
</li>
<li>
<p>Handle 内部管理与 Broker 的连接池、IO 线程、定时器，销毁时会自动清理所有资源，避免内存泄漏。</p>
</li>
<li>
<p><strong>线程模型</strong>：</p>
<ul>
<li>Handle 子类会启动内部 IO 线程（默认 1 个，可通过 io_threads 配置），处理网络通信、消息发送 / 接收；</li>
<li>业务线程调用 poll()/produce() 等 API 时，仅触发逻辑调度，核心 IO 由内部线程处理。</li>
</ul>
</li>
</ul>
<h2 id="6-Producer类（生产者类）">6.Producer类（生产者类）</h2>
<h3 id="（1）概述-4">（1）概述</h3>
<h4 id="1-作用-4">&lt;1&gt;作用</h4>
<ul>
<li>RdKafka::Producer 是 librdkafka 中实现 Kafka <strong>“消息生产逻辑”的核心类</strong>，继承自 RdKafka::Handle 抽象基类</li>
<li>封装了消息异步发送、分区路由、回调通知、资源管理等全量生产能力，是<strong>客户端向 Kafka 集群发送消息的唯一入口</strong>。</li>
</ul>
<h4 id="2-核心定位-4">&lt;2&gt;核心定位</h4>
<ul>
<li><strong>异步发送</strong>：
<ul>
<li>默认采用 “<strong>异步非阻塞</strong>” 模式，<strong>produce()</strong> 仅将消息放入<strong>本地队列</strong>，由内部 IO 线程发送至 Broker</li>
<li>仅 flush()/ 同步发送会阻塞</li>
</ul>
</li>
<li><strong>回调驱动</strong>：
<ul>
<li>通过 <strong>DeliveryReportCb</strong> “<strong>异步通知</strong>”消息发送结果（成功 / 失败）</li>
</ul>
</li>
<li><strong>分区路由</strong>：
<ul>
<li>支持<strong>内置分区器</strong>（按 Key 哈希 / 随机）或<strong>自定义分区器</strong>（PartitionerCb）</li>
</ul>
</li>
<li><strong>资源管理</strong>：
<ul>
<li>继承 Handle 基类的生命周期管理能力，通过 <strong>delete</strong> 或 <strong>flush() + delete</strong> 安全释放连接、线程、队列等资源</li>
</ul>
</li>
<li><strong>高可用设计</strong>：
<ul>
<li>支持<strong>消息重试</strong>、<strong>批量发送</strong>、<strong>压缩</strong>（gzip/snappy/lz4），提升吞吐量和可靠性</li>
</ul>
</li>
<li><strong>可靠性</strong>：
<ul>
<li>支持消息重试（retries）、ACK 确认（acks）、幂等 / 事务（需配置）；</li>
</ul>
</li>
<li><strong>高性能</strong>：
<ul>
<li>支持批量发送（batch.size）、异步 IO，减少网络请求次数；</li>
</ul>
</li>
</ul>
<h4 id="3-继承关系">&lt;3&gt;继承关系</h4>
<ul>
<li>Producer 继承自 Handle 抽象基类，因此具备以下 Handle 通用能力：
<ul>
<li><strong>poll()</strong>：轮询事件，触发回调（<strong>生产者必须定期调用</strong>）</li>
<li><strong>name()</strong>：获取客户端名称</li>
<li><strong>outq_len()</strong>：获取待发送消息队列长度</li>
<li>元数据查询、流控等其他 Handle 方法</li>
</ul>
</li>
</ul>
<h3 id="（2）Producer类的定义">（2）Producer类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> Producer : <span class="keyword">public</span> <span class="keyword">virtual</span> Handle &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第一梯队】几乎每个生产者应用都会用到</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 创建 Kafka 生产者实例</span></span><br><span class="line"><span class="comment">     * @param conf 配置对象（可选），不传则使用默认配置；配置对象可复用</span></span><br><span class="line"><span class="comment">     * @param errstr [out] 错误描述字符串</span></span><br><span class="line"><span class="comment">     * @returns 成功返回生产者实例，失败返回 NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Producer *<span class="title">create</span><span class="params">(<span class="type">const</span> Conf *conf, std::string &amp;errstr)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Producer</span>() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 消息标志位（用于 produce() 的 msgflags 参数）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        RK_MSG_FREE  = <span class="number">0x1</span>,  <span class="comment">/**&lt; librdkafka 使用完 payload 后会自动 free()</span></span><br><span class="line"><span class="comment">                              *   与 RK_MSG_COPY 互斥 */</span></span><br><span class="line">        RK_MSG_COPY  = <span class="number">0x2</span>,  <span class="comment">/**&lt; librdkafka 会复制 payload 数据，</span></span><br><span class="line"><span class="comment">                              *   调用返回后不再使用原指针</span></span><br><span class="line"><span class="comment">                              *   与 RK_MSG_FREE 互斥 */</span></span><br><span class="line">        RK_MSG_BLOCK = <span class="number">0x4</span>   <span class="comment">/**&lt; 当消息队列满时阻塞 produce() 调用</span></span><br><span class="line"><span class="comment">                              *   警告：使用时必须在另一个线程调用 poll()</span></span><br><span class="line"><span class="comment">                              *   否则会导致无限阻塞 */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 生产并发送单条消息到 Broker（异步非阻塞）</span></span><br><span class="line"><span class="comment">     * @param topic      Topic 对象</span></span><br><span class="line"><span class="comment">     * @param partition  目标分区：PARTITION_UA 自动分区，或 0..N 指定分区</span></span><br><span class="line"><span class="comment">     * @param msgflags   消息标志：RK_MSG_FREE / RK_MSG_COPY / RK_MSG_BLOCK</span></span><br><span class="line"><span class="comment">     * @param payload    消息内容指针</span></span><br><span class="line"><span class="comment">     * @param len        消息长度（字节）</span></span><br><span class="line"><span class="comment">     * @param key        消息 Key（可选），用于分区选择和传递给消费者</span></span><br><span class="line"><span class="comment">     * @param msg_opaque 用户自定义指针，会在投递回调中返回</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功入队</span></span><br><span class="line"><span class="comment">     *          ERR__QUEUE_FULL 队列满</span></span><br><span class="line"><span class="comment">     *          ERR_MSG_SIZE_TOO_LARGE 消息过大</span></span><br><span class="line"><span class="comment">     *          ERR__UNKNOWN_PARTITION / ERR__UNKNOWN_TOPIC 未知分区/Topic</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 若返回错误且使用了 RK_MSG_FREE，调用方仍需负责释放 payload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">produce</span><span class="params">(Topic *topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int</span> msgflags,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *payload,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> std::string *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *msg_opaque)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief produce() 重载：Key 使用指针+长度形式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">produce</span><span class="params">(Topic *topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int</span> msgflags,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *payload,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> <span class="type">void</span> *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> key_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *msg_opaque)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief produce() 重载：Topic 使用字符串，支持指定时间戳（推荐）</span></span><br><span class="line"><span class="comment">     * @param topic_name Topic 名称（无需创建 Topic 对象）</span></span><br><span class="line"><span class="comment">     * @param timestamp  消息时间戳（毫秒级 Unix 时间戳，UTC）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">produce</span><span class="params">(<span class="type">const</span> std::string topic_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int</span> msgflags,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *payload,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> <span class="type">void</span> *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> key_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int64_t</span> timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *msg_opaque)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief produce() 重载：支持消息头（Headers）</span></span><br><span class="line"><span class="comment">     * @param headers 消息头对象，成功时会被释放，失败时保持不变</span></span><br><span class="line"><span class="comment">     * @warning 成功调用后 headers 会被自动释放，失败时需调用方处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">produce</span><span class="params">(<span class="type">const</span> std::string topic_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int</span> msgflags,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *payload,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> <span class="type">void</span> *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">size_t</span> key_len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int64_t</span> timestamp,</span></span></span><br><span class="line"><span class="params"><span class="function">                              RdKafka::Headers *headers,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *msg_opaque)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief produce() 重载：使用 vector 传递 key 和 payload（自动复制）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">produce</span><span class="params">(Topic *topic,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">int32_t</span> partition,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> std::vector&lt;<span class="type">char</span>&gt; *payload,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> std::vector&lt;<span class="type">char</span>&gt; *key,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">void</span> *msg_opaque)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 等待所有待发送消息完成（刷新）</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 超时时间（毫秒）</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 全部完成，ERR__TIMED_OUT 超时</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 销毁生产者前应调用此方法，确保所有消息发送完成</span></span><br><span class="line"><span class="comment">     * @remark 会忽略 linger.ms 配置，立即发送队列中的消息</span></span><br><span class="line"><span class="comment">     * @remark 内部会调用 poll()，因此会触发回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">flush</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第二梯队】特殊场景使用</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 清除生产者当前处理的消息</span></span><br><span class="line"><span class="comment">     * @param purge_flags 清除标志</span></span><br><span class="line"><span class="comment">     * @returns ERR_NO_ERROR 成功</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 清除后需调用 poll() 或 flush() 处理投递报告回调</span></span><br><span class="line"><span class="comment">     * @remark 队列中的消息会收到 ERR__PURGE_QUEUE 错误</span></span><br><span class="line"><span class="comment">     * @remark 传输中的消息会收到 ERR__PURGE_INFLIGHT 错误</span></span><br><span class="line"><span class="comment">     * @warning 清除传输中消息会导致无法确认消息是否成功，可能产生重复</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">purge</span><span class="params">(<span class="type">int</span> purge_flags)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 清除标志位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">enum</span> &#123;</span><br><span class="line">        PURGE_QUEUE        = <span class="number">0x1</span>,  <span class="comment">/**&lt; 清除内部队列中的消息 */</span></span><br><span class="line">        PURGE_INFLIGHT     = <span class="number">0x2</span>,  <span class="comment">/**&lt; 清除传输中的消息（可能导致重复） */</span></span><br><span class="line">        PURGE_NON_BLOCKING = <span class="number">0x4</span>   <span class="comment">/**&lt; 不等待后台队列清除完成 */</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line">    <span class="comment">// 【第三梯队】事务 API（需要 Broker &gt;= 0.11.0）</span></span><br><span class="line">    <span class="comment">//=============================================================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 初始化事务</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 最大阻塞时间，超时后可在后台继续，允许重试</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象（需 delete）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 使用事务前必须先调用此方法（仅需一次）</span></span><br><span class="line"><span class="comment">     * @remark 通过 Error::is_retriable() 判断是否可重试</span></span><br><span class="line"><span class="comment">     * @remark 通过 Error::is_fatal() 判断是否为致命错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">init_transactions</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 开始新事务</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象（需 delete）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 必须先调用 init_transactions() 成功后才能使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">begin_transaction</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 提交当前事务</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 最大阻塞时间，-1 表示使用剩余事务超时时间（推荐）</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象（需 delete）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 强烈建议 timeout_ms 传 -1</span></span><br><span class="line"><span class="comment">     * @remark 提交前会自动 flush 所有待发送消息</span></span><br><span class="line"><span class="comment">     * @remark 通过 Error::txn_requires_abort() 判断是否需要中止事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">commit_transaction</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 中止当前事务</span></span><br><span class="line"><span class="comment">     * @param timeout_ms 最大阻塞时间，-1 表示使用剩余事务超时时间（推荐）</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象（需 delete）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 用于从可中止的事务错误中恢复</span></span><br><span class="line"><span class="comment">     * @remark 会清除所有待发送消息，触发 ERR__PURGE_INFLIGHT/QUEUE</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">abort_transaction</span><span class="params">(<span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @brief 发送消费偏移量到事务（Consume-Transform-Produce 模式）</span></span><br><span class="line"><span class="comment">     * @param offsets        要提交的偏移量列表（应为下一条要消费的偏移量）</span></span><br><span class="line"><span class="comment">     * @param group_metadata 消费者组元数据（从 KafkaConsumer::groupMetadata() 获取）</span></span><br><span class="line"><span class="comment">     * @param timeout_ms     最大阻塞时间</span></span><br><span class="line"><span class="comment">     * @returns NULL 成功，否则返回 Error 对象（需 delete）</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * @remark 必须在生产者实例上调用，不是消费者</span></span><br><span class="line"><span class="comment">     * @remark 消费者必须禁用自动提交（enable.auto.commit=false）</span></span><br><span class="line"><span class="comment">     * @remark 在 commit_transaction() 之前调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">send_offsets_to_transaction</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::vector&lt;TopicPartition *&gt; &amp;offsets,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ConsumerGroupMetadata *group_metadata,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> timeout_ms)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="（3）使用示例-2">（3）使用示例</h3>
<h4 id="1-异步发送示例（生产环境首选）">&lt;1&gt;异步发送示例（生产环境首选）</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;librdkafka/rdkafkacpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;csignal&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局标志：控制生产者退出</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">sig_atomic_t</span> run = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义投递结果回调（继承 DeliveryReportCb）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDeliveryReportCb</span> : <span class="keyword">public</span> RdKafka::DeliveryReportCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dr_cb</span><span class="params">(RdKafka::Message &amp;msg)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理消息发送结果</span></span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="built_in">err</span>() != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            <span class="comment">// 发送失败</span></span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[发送失败] Topic：&quot;</span> &lt;&lt; msg.<span class="built_in">topic</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; msg.<span class="built_in">partition</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 错误：&quot;</span> &lt;&lt; msg.<span class="built_in">errstr</span>() &lt;&lt; std::endl;</span><br><span class="line">            <span class="comment">// 可选：获取失败消息的 Key/内容（需设置 RK_MSG_COPY）</span></span><br><span class="line">            <span class="type">const</span> <span class="type">char</span> *key = msg.<span class="built_in">key</span>() ? <span class="built_in">static_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(msg.<span class="built_in">key</span>()) : <span class="string">&quot;无Key&quot;</span>;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;  Key：&quot;</span> &lt;&lt; key &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 发送成功</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[发送成功] Topic：&quot;</span> &lt;&lt; msg.<span class="built_in">topic</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; msg.<span class="built_in">partition</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 偏移量：&quot;</span> &lt;&lt; msg.<span class="built_in">offset</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 信号处理：优雅退出</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigterm</span><span class="params">(<span class="type">int</span> sig)</span> </span>&#123;</span><br><span class="line">    run = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ========== 1. 初始化配置 ==========</span></span><br><span class="line">    std::string errstr;</span><br><span class="line">    <span class="comment">// 创建全局配置（CONF_GLOBAL）</span></span><br><span class="line">    RdKafka::Conf *global_conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line">    <span class="comment">// 创建主题配置（CONF_TOPIC，可选）</span></span><br><span class="line">    RdKafka::Conf *topic_conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_TOPIC);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置核心参数</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>, errstr); <span class="comment">// 必填</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;client.id&quot;</span>, <span class="string">&quot;order-producer-01&quot;</span>, errstr);      <span class="comment">// 生产者标识</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;acks&quot;</span>, <span class="string">&quot;1&quot;</span>, errstr);                           <span class="comment">// ACK级别：Leader确认</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;retries&quot;</span>, <span class="string">&quot;3&quot;</span>, errstr);                        <span class="comment">// 重试3次</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;batch.size&quot;</span>, <span class="string">&quot;16384&quot;</span>, errstr);                 <span class="comment">// 批量大小16KB</span></span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;linger.ms&quot;</span>, <span class="string">&quot;5&quot;</span>, errstr);                      <span class="comment">// 延迟5ms发送（批量）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定投递回调（核心：异步获取发送结果）</span></span><br><span class="line">    MyDeliveryReportCb dr_cb;</span><br><span class="line">    global_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;dr_cb&quot;</span>, &amp;dr_cb, errstr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 2. 创建生产者实例 ==========</span></span><br><span class="line">    RdKafka::Producer *producer = RdKafka::Producer::<span class="built_in">create</span>(global_conf, errstr);</span><br><span class="line">    <span class="keyword">if</span> (!producer) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;创建生产者失败：&quot;</span> &lt;&lt; errstr &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> global_conf;</span><br><span class="line">        <span class="keyword">delete</span> topic_conf;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放配置对象（生产者创建后，配置已拷贝，可释放）</span></span><br><span class="line">    <span class="keyword">delete</span> global_conf;</span><br><span class="line">    <span class="keyword">delete</span> topic_conf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 3. 注册信号处理（优雅退出） ==========</span></span><br><span class="line">    <span class="built_in">signal</span>(SIGINT, sigterm);</span><br><span class="line">    <span class="built_in">signal</span>(SIGTERM, sigterm);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 4. 循环发送消息 ==========</span></span><br><span class="line">    <span class="type">int</span> msg_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (run &amp;&amp; msg_count &lt; <span class="number">10</span>) &#123; <span class="comment">// 发送10条测试消息</span></span><br><span class="line">        std::string msg_payload = <span class="string">&quot;order_&quot;</span> + std::<span class="built_in">to_string</span>(msg_count); <span class="comment">// 消息内容</span></span><br><span class="line">        std::string msg_key = <span class="string">&quot;user_1001&quot;</span>;                              <span class="comment">// 消息Key（用于分区路由）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建消息头（可选，附加元数据）</span></span><br><span class="line">        RdKafka::Headers *headers = RdKafka::Headers::<span class="built_in">create</span>();</span><br><span class="line">        std::string trace_id = <span class="string">&quot;trace_789012&quot;</span>;</span><br><span class="line">        std::string msg_type = <span class="string">&quot;order_create&quot;</span>;</span><br><span class="line">        headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;trace-id&quot;</span>, trace_id.<span class="built_in">c_str</span>(), trace_id.<span class="built_in">size</span>());</span><br><span class="line">        headers-&gt;<span class="built_in">add</span>(<span class="string">&quot;msg-type&quot;</span>, msg_type.<span class="built_in">c_str</span>(), msg_type.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步发送消息</span></span><br><span class="line">        <span class="comment">// 参数说明：</span></span><br><span class="line">        <span class="comment">// - &quot;order_topic&quot;：目标Topic</span></span><br><span class="line">        <span class="comment">// - RdKafka::PARTITION_UA（-1）：自动分配分区（由分区器决定）</span></span><br><span class="line">        <span class="comment">// - RK_MSG_COPY：拷贝消息内容（避免本地内存释放导致问题）</span></span><br><span class="line">        <span class="comment">// - payload/len：消息内容及长度</span></span><br><span class="line">        <span class="comment">// - key/key_len：消息Key及长度</span></span><br><span class="line">        <span class="comment">// - 0：自定义时间戳（0=使用Broker时间）</span></span><br><span class="line">        <span class="comment">// - headers：消息头</span></span><br><span class="line">        <span class="comment">// - nullptr：透传上下文（msg_opaque）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步发送消息</span></span><br><span class="line">        RdKafka::ErrorCode err = producer-&gt;<span class="built_in">produce</span>(</span><br><span class="line">            <span class="string">&quot;order_topic&quot;</span>,</span><br><span class="line">            RdKafka::Topic::PARTITION_UA,</span><br><span class="line">            RdKafka::Producer::RK_MSG_COPY,</span><br><span class="line">            <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(msg_payload.<span class="built_in">c_str</span>()), msg_payload.<span class="built_in">size</span>(),</span><br><span class="line">            <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(msg_key.<span class="built_in">c_str</span>()), msg_key.<span class="built_in">size</span>(),</span><br><span class="line">            <span class="number">0</span>,       <span class="comment">// 时间戳</span></span><br><span class="line">            headers, <span class="comment">// 消息头</span></span><br><span class="line">            <span class="literal">nullptr</span>  <span class="comment">// msg_opaque</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ⚠️ produce成功调用后 headers 会被自动释放，失败时需手动释放</span></span><br><span class="line">        <span class="keyword">if</span> (err != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;发送消息失败（即时）：&quot;</span> &lt;&lt; RdKafka::<span class="built_in">err2str</span>(err) &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">delete</span> headers;  <span class="comment">// produce 失败时需手动释放 headers</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 队列满时，等待并重试</span></span><br><span class="line">            <span class="keyword">if</span> (err == RdKafka::ERR__QUEUE_FULL) &#123;</span><br><span class="line">                producer-&gt;<span class="built_in">poll</span>(<span class="number">100</span>); <span class="comment">// 处理内部事件，腾出队列空间</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定期调用poll：驱动回调执行、处理重试（核心！异步发送必须调用）</span></span><br><span class="line">        producer-&gt;<span class="built_in">poll</span>(<span class="number">0</span>); <span class="comment">// 0ms超时：非阻塞处理</span></span><br><span class="line"></span><br><span class="line">        msg_count++;</span><br><span class="line">        <span class="comment">// 模拟业务延迟</span></span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">100000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 5. 优雅关闭生产者 ==========</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;等待所有消息发送完成...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// flush：阻塞等待所有未发送的消息完成（超时5秒）</span></span><br><span class="line">    producer-&gt;<span class="built_in">flush</span>(<span class="number">5000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否有未发送完成的消息</span></span><br><span class="line">    <span class="keyword">if</span> (producer-&gt;<span class="built_in">outq_len</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;仍有 &quot;</span> &lt;&lt; producer-&gt;<span class="built_in">outq_len</span>() &lt;&lt; <span class="string">&quot; 条消息未发送完成&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 6. 释放资源 ==========</span></span><br><span class="line">    <span class="keyword">delete</span> producer; <span class="comment">// 释放生产者资源</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-同步发送示例（特殊场景使用）">&lt;2&gt;同步发送示例（特殊场景使用）</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同步发送：通过 msg_opaque 阻塞等待结果</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sync_produce</span><span class="params">(RdKafka::Producer *producer, <span class="type">const</span> std::string &amp;topic, <span class="type">const</span> std::string &amp;payload)</span> </span>&#123;</span><br><span class="line">    std::string errstr;</span><br><span class="line">    RdKafka::ErrorCode err;</span><br><span class="line">    <span class="comment">// 用于阻塞的信号量</span></span><br><span class="line">    <span class="type">bool</span> done = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息（msg_opaque 传递上下文）</span></span><br><span class="line">    err = producer-&gt;<span class="built_in">produce</span>(</span><br><span class="line">        topic,</span><br><span class="line">        RdKafka::PARTITION_UA,</span><br><span class="line">        RdKafka::Producer::RK_MSG_COPY,</span><br><span class="line">        <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(payload.<span class="built_in">c_str</span>()), payload.<span class="built_in">size</span>(),</span><br><span class="line">        <span class="literal">nullptr</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>, &amp;done, <span class="literal">nullptr</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (err != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;同步发送失败：&quot;</span> &lt;&lt; producer-&gt;<span class="built_in">err2str</span>(err) &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待发送结果（轮询+sleep）</span></span><br><span class="line">    <span class="type">int</span> timeout = <span class="number">5000</span>; <span class="comment">// 5秒超时</span></span><br><span class="line">    <span class="type">int</span> poll_interval = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span> (!done &amp;&amp; timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        producer-&gt;<span class="built_in">poll</span>(poll_interval);</span><br><span class="line">        timeout -= poll_interval;</span><br><span class="line">        <span class="built_in">usleep</span>(poll_interval * <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;同步发送超时&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需修改投递回调，设置 done 标志：</span></span><br><span class="line"><span class="comment">// void dr_cb(RdKafka::Message &amp;msg) override &#123;</span></span><br><span class="line"><span class="comment">//     bool *done = static_cast&lt;bool*&gt;(msg.opaque());</span></span><br><span class="line"><span class="comment">//     *done = true;</span></span><br><span class="line"><span class="comment">//     // ... 原有逻辑</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="（4）关键注意事项">（4）关键注意事项</h3>
<ul>
<li>
<p><strong>异步发送</strong>：</p>
<ul>
<li>produce() <strong>仅</strong>将消息写入<strong>本地环形队列</strong>，内部 IO 线程异步发送</li>
<li>返回 ERR_NO_ERROR <strong>仅代表 “入队成功”</strong>，<strong>不代表 “发送成功”</strong></li>
</ul>
</li>
<li>
<p><strong>poll () 必须调用</strong>：</p>
<ul>
<li>异步发送时，poll() 是<strong>驱动回调执行、处理重试、清理队列</strong>的核心，需定期调用（建议每次 produce() 后或定时调用）；</li>
<li>若不调用 poll()，<strong>回调不会执行，消息重试也会停滞</strong>，最终导致发送队列满（ERR__QUEUE_FULL）</li>
</ul>
</li>
<li>
<p><strong>消息可靠性</strong>：</p>
<ul>
<li>关闭生产者前必须调用 flush()，否则队列中的消息会丢失；</li>
<li>acks=all + retries=N 是最高可靠性配置，但会降低吞吐量；</li>
<li>启用 enable.idempotence=true 可避免重复发送（幂等性）；</li>
</ul>
</li>
<li>
<p><strong>分区策略</strong>：</p>
<ul>
<li>指定 partition 数值：直接发送到该分区；</li>
<li>PARTITION_UA（-1）：按 key 哈希分区（无 key 则随机）；</li>
<li>自定义 PartitionerCb：按业务规则路由（如用户 ID 取模）；</li>
</ul>
</li>
<li>
<p><strong>消息重试</strong>：</p>
<ul>
<li>配置 retries（重试次数）、<a target="_blank" rel="noopener" href="http://retry.backoff.ms">retry.backoff.ms</a>（重试间隔），处理网络抖动导致的发送失败；</li>
</ul>
</li>
<li>
<p><strong>压缩配置</strong>：</p>
<ul>
<li>通过 compression.type 配置（gzip/snappy/lz4），降低网络传输量。</li>
</ul>
</li>
</ul>
<p><a id="cb"></a></p>
<h2 id="3-RdKafka-xxxCb回调类">3.RdKafka::xxxCb回调类</h2>
<ul>
<li>RdKafka::xxxCb 是 librdkafka 中一组<strong>抽象回调基类</strong>的统称，用于实现客户端与 Kafka 集群交互的 “<strong>异步事件通知” 机制</strong>
<ul>
<li>客户端通过继承这些回调类并实现纯虚函数，<strong>可监听生产 / 消费过程中的关键事件</strong></li>
<li>如:消息发送结果、消费错误、重平衡、日志输出等，是实现<strong>异步化、定制化业务</strong>逻辑的核心。</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116110908752.png" alt=""></p>
<h3 id="（1）DeliveryReportCb（生产者投递结果回调）">（1）DeliveryReportCb（生产者投递结果回调）</h3>
<ul>
<li><strong>作用</strong>：
<ul>
<li>生产者<strong>异步发送消息（produce()）<strong>后，通过该回调获取最终发送结果，是</strong>处理消息发送失败</strong>的核心入口；</li>
</ul>
</li>
<li><strong>注意</strong>：
<ul>
<li><strong>仅异步发送生效</strong>，同步发送（produce()+flush()）无需该回调；</li>
</ul>
</li>
</ul>
<h4 id="1-定义">&lt;1&gt;定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> DeliveryReportCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// @brief 消息投递报告回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">dr_cb</span><span class="params">(Message &amp;message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">DeliveryReportCb</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-使用示例">&lt;2&gt;使用示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 自定义投递结果回调类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDeliveryReportCb</span> : <span class="keyword">public</span> RdKafka::DeliveryReportCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dr_cb</span><span class="params">(RdKafka::Message &amp;msg)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="built_in">err</span>() != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[发送失败] 主题：&quot;</span> &lt;&lt; msg.<span class="built_in">topic_name</span>()</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; msg.<span class="built_in">partition</span>() </span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 错误：&quot;</span> &lt;&lt; msg.<span class="built_in">errstr</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[发送成功] 主题：&quot;</span> &lt;&lt; msg.<span class="built_in">topic_name</span>() </span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; msg.<span class="built_in">partition</span>() </span><br><span class="line">                      &lt;&lt; <span class="string">&quot; 偏移量：&quot;</span> &lt;&lt; msg.<span class="built_in">offset</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 绑定到生产者配置</span></span><br><span class="line">MyDeliveryReportCb dr_cb;</span><br><span class="line">producer_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;dr_cb&quot;</span>, &amp;dr_cb, errstr);</span><br></pre></td></tr></table></figure>
<h3 id="（2）EventCb（客户端底层事件回调）">（2）EventCb（客户端底层事件回调）</h3>
<ul>
<li><strong>作用</strong>：
<ul>
<li>监听 librdkafka 底层核心事件（如 Broker 连接 / 断开、元数据更新、分区 Leader 切换、限流），是精细化监控客户端状态、调试底层问题的关键；</li>
</ul>
</li>
<li><strong>区别于 ErrorCb</strong>：
<ul>
<li>ErrorCb 仅监听 “错误事件”，EventCb 覆盖 “错误 + 正常事件”（如连接成功、元数据更新），粒度更细</li>
</ul>
</li>
<li><strong>事件类型</strong>：
<ul>
<li>通过 <strong>Event::type()</strong> 获取，核心类型包括：
<ul>
<li><strong>EVENT_ERROR</strong>：错误事件（等价于 ErrorCb）；</li>
<li><strong>EVENT_REBALANCE</strong>：重平衡事件（等价于 RebalanceCb）；</li>
<li><strong>EVENT_LOG</strong>：日志事件（等价于 LogCb）；</li>
<li><strong>EVENT_THROTTLE</strong>：限流事件（等价于 ThrottleCb）；</li>
<li><strong>EVENT_CONNECT</strong>：Broker 连接成功；</li>
<li><strong>EVENT_DISCONNECT</strong>：Broker 连接断开；</li>
<li><strong>EVENT_METADATA_UPDATED</strong>：元数据更新（如 Topic 分区变化）；</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="1-定义-2">&lt;1&gt;定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> EventCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// @brief 事件回调</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">event_cb</span><span class="params">(Event &amp;event)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">EventCb</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-使用示例-2">&lt;2&gt;使用示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 自定义底层事件回调类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyEventCb</span> : <span class="keyword">public</span> RdKafka::EventCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 纯虚函数实现：event=事件对象（包含事件类型、详情、关联的 Broker/分区）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">event_cb</span><span class="params">(RdKafka::Event &amp;event)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据事件类型分类处理</span></span><br><span class="line">        <span class="keyword">switch</span> (event.<span class="built_in">type</span>()) &#123;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_CONNECT:</span><br><span class="line">                <span class="comment">// Broker 连接成功</span></span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;[事件] 连接 Broker 成功：&quot;</span> &lt;&lt; event.<span class="built_in">broker_name</span>() &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_DISCONNECT:</span><br><span class="line">                <span class="comment">// Broker 连接断开</span></span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;[事件] 断开 Broker 连接：&quot;</span> &lt;&lt; event.<span class="built_in">broker_name</span>() &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_METADATA_UPDATED:</span><br><span class="line">                <span class="comment">// 元数据更新（如 Topic 分区数变化、Leader 切换）</span></span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;[事件] 元数据更新：&quot;</span> &lt;&lt; event.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_THROTTLE:</span><br><span class="line">                <span class="comment">// 被 Broker 限流（等价于 ThrottleCb）</span></span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;[事件] 被 Broker 限流：&quot;</span> &lt;&lt; event.<span class="built_in">broker_name</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 限流时长：&quot;</span> &lt;&lt; event.<span class="built_in">throttle_time_ms</span>() &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_ERROR:</span><br><span class="line">                <span class="comment">// 错误事件（等价于 ErrorCb）</span></span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;[事件] 错误：&quot;</span> &lt;&lt; event.<span class="built_in">str</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 是否致命：&quot;</span> &lt;&lt; (event.<span class="built_in">fatal</span>() ? <span class="string">&quot;是&quot;</span> : <span class="string">&quot;否&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RdKafka::Event::EVENT_REBALANCE:</span><br><span class="line">                <span class="comment">// 重平衡事件（等价于 RebalanceCb）</span></span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;[事件] 重平衡：&quot;</span> &lt;&lt; event.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">// 其他事件（如日志、统计）</span></span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;[事件] 未知类型：&quot;</span> &lt;&lt; event.<span class="built_in">type</span>() &lt;&lt; <span class="string">&quot; 详情：&quot;</span> &lt;&lt; event.<span class="built_in">str</span>() &lt;&lt; std::endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 绑定到全局配置（生产者/消费者均可）</span></span><br><span class="line">MyEventCb event_cb;</span><br><span class="line">RdKafka::Conf *conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line"><span class="keyword">if</span> (conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;event_cb&quot;</span>, &amp;event_cb, errstr) != RdKafka::CONF_OK) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;绑定底层事件回调失败：&quot;</span> &lt;&lt; errstr &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="（3）RebalanceCb（消费者重平衡回调）">（3）RebalanceCb（消费者重平衡回调）</h3>
<ul>
<li><strong>作用</strong>：
<ul>
<li>消费者组发生“<strong>重平衡</strong>”时触发，是保证消费不丢数据、清理分区资源的关键；</li>
</ul>
</li>
<li><strong>重平衡场景</strong>：
<ul>
<li>消费者加入 / 退出组、Topic 分区数调整、Broker 重选举；</li>
</ul>
</li>
</ul>
<h4 id="1-定义-3">&lt;1&gt;定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> RebalanceCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief 消费者组重平衡回调，配合 RdKafka::KafkaConsumer 使用</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 注册 rebalance_cb 后，librdkafka 将关闭自动分区分配/撤销机制，</span></span><br><span class="line"><span class="comment">  * 改由应用程序的 rebalance_cb 全权负责。</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 重平衡回调需要根据两种事件更新 librdkafka 的分区分配集合：</span></span><br><span class="line"><span class="comment">  * - RdKafka::ERR__ASSIGN_PARTITIONS（分配分区）</span></span><br><span class="line"><span class="comment">  * - RdKafka::ERR__REVOKE_PARTITIONS（撤销分区）</span></span><br><span class="line"><span class="comment">  * 同时也要能处理其他任意的重平衡错误（err 不是上述两种的情况）。</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * @remark 对于其他错误情况，应用程序必须调用 unassign() 来同步状态。</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 【Eager 全量分配策略】（如 range、roundrobin）：</span></span><br><span class="line"><span class="comment">  *   - 分配时调用 assign() 设置全部分区</span></span><br><span class="line"><span class="comment">  *   - 撤销时调用 unassign() 清空全部分区</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 【Cooperative 增量分配策略】（如 cooperative-sticky）：</span></span><br><span class="line"><span class="comment">  *   - 分配时调用 incremental_assign() 增量添加分区</span></span><br><span class="line"><span class="comment">  *   - 撤销时调用 incremental_unassign() 增量移除分区</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 不注册回调时，librdkafka 会自动完成上述操作。</span></span><br><span class="line"><span class="comment">  * 注册回调后，应用程序可以在分配/撤销时执行额外操作，例如：</span></span><br><span class="line"><span class="comment">  *   - 分配时：从外部存储加载自定义 offset</span></span><br><span class="line"><span class="comment">  *   - 撤销时：手动提交 offset（当 auto.commit.enable=false 时）</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * @sa RdKafka::KafkaConsumer::assign()</span></span><br><span class="line"><span class="comment">  * @sa RdKafka::KafkaConsumer::incremental_assign()</span></span><br><span class="line"><span class="comment">  * @sa RdKafka::KafkaConsumer::incremental_unassign()</span></span><br><span class="line"><span class="comment">  * @sa RdKafka::KafkaConsumer::assignment_lost()</span></span><br><span class="line"><span class="comment">  * @sa RdKafka::KafkaConsumer::rebalance_protocol()</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">rebalance_cb</span><span class="params">(RdKafka::KafkaConsumer *consumer,</span></span></span><br><span class="line"><span class="params"><span class="function">                           RdKafka::ErrorCode err,</span></span></span><br><span class="line"><span class="params"><span class="function">                           std::vector&lt;TopicPartition *&gt; &amp;partitions)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">virtual</span> ~<span class="built_in">RebalanceCb</span>() &#123;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-使用示例-3">&lt;2&gt;使用示例</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyRebalanceCb</span> : <span class="keyword">public</span> RdKafka::RebalanceCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">rebalance_cb</span><span class="params">(RdKafka::KafkaConsumer *consumer,</span></span></span><br><span class="line"><span class="params"><span class="function">                      RdKafka::ErrorCode err,</span></span></span><br><span class="line"><span class="params"><span class="function">                      std::vector&lt;RdKafka::TopicPartition*&gt; &amp;partitions)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err == RdKafka::ERR__ASSIGN_PARTITIONS) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[重平衡] 分配分区数：&quot;</span> &lt;&lt; partitions.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> tp : partitions) &#123;</span><br><span class="line">                tp-&gt;<span class="built_in">set_offset</span>(RdKafka::Topic::OFFSET_STORED);</span><br><span class="line">            &#125;</span><br><span class="line">            consumer-&gt;<span class="built_in">assign</span>(partitions);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err == RdKafka::ERR__REVOKE_PARTITIONS) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[重平衡] 回收分区数：&quot;</span> &lt;&lt; partitions.<span class="built_in">size</span>() &lt;&lt; std::endl;</span><br><span class="line">            consumer-&gt;<span class="built_in">commitSync</span>();  <span class="comment">// 提交当前 offset</span></span><br><span class="line">            consumer-&gt;<span class="built_in">unassign</span>();   <span class="comment">//取消分区分配</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[重平衡失败] 错误：&quot;</span> &lt;&lt; RdKafka::<span class="built_in">err2str</span>(err) &lt;&lt; std::endl;</span><br><span class="line">            consumer-&gt;<span class="built_in">unassign</span>();   <span class="comment">//取消分区分配</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定到消费者配置</span></span><br><span class="line">MyRebalanceCb rebalance_cb;</span><br><span class="line">consumer_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;rebalance_cb&quot;</span>, &amp;rebalance_cb, errstr);</span><br></pre></td></tr></table></figure>
<h3 id="（4）OffsetCommitCb（消费者-Offset-提交结果回调）">（4）OffsetCommitCb（消费者 Offset 提交结果回调）</h3>
<ul>
<li><strong>作用</strong>：
<ul>
<li>消费者<strong>异步提交 offset</strong>（commitAsync()）后，通过该回调获取提交结果；</li>
<li>同步提交（commitSync()）无需此回调，可直接通过返回值判断结果；</li>
</ul>
</li>
<li><strong>关键场景</strong>：
<ul>
<li>异步提交 offset 是生产环境首选（非阻塞），该回调是监控 offset 提交失败的核心入口，避免因提交失败导致重复消费；</li>
</ul>
</li>
</ul>
<h4 id="1-定义-4">&lt;1&gt;定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> OffsetCommitCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * @brief 设置 offset 提交回调，用于消费者组</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 自动提交或手动提交 offset 的结果会被调度到此回调，</span></span><br><span class="line"><span class="comment">  * 并通过 RdKafka::KafkaConsumer::consume() 触发执行。</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * 如果没有分区有有效的 offset 可提交，此回调会以 err == ERR__NO_OFFSET 被调用，</span></span><br><span class="line"><span class="comment">  * 这不应被视为错误。</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * offsets 列表包含每个分区的信息：</span></span><br><span class="line"><span class="comment">  *   - topic      提交的 Topic 名称</span></span><br><span class="line"><span class="comment">  *   - partition  提交的分区号</span></span><br><span class="line"><span class="comment">  *   - offset     已提交的 offset（尝试提交的值）</span></span><br><span class="line"><span class="comment">  *   - err        提交错误码</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">offset_commit_cb</span><span class="params">(RdKafka::ErrorCode err,</span></span></span><br><span class="line"><span class="params"><span class="function">                               std::vector&lt;TopicPartition *&gt; &amp;offsets)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">virtual</span> ~<span class="built_in">OffsetCommitCb</span>() &#123;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-使用示例-4">&lt;2&gt;使用示例</h4>
<p><strong>自动/手动提交 offset 完成后触发</strong></p>
<ul>
<li>提交重试、消费进度监控、lag 告警</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 自定义 Offset 提交结果回调类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyOffsetCommitCb</span> : <span class="keyword">public</span> RdKafka::OffsetCommitCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 纯虚函数实现：</span></span><br><span class="line">    <span class="comment">// err=整体提交错误码，partitions=提交的分区列表（含每个分区的提交结果）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">offset_commit_cb</span><span class="params">(RdKafka::ErrorCode err,</span></span></span><br><span class="line"><span class="params"><span class="function">                          std::vector&lt;RdKafka::TopicPartition*&gt; &amp;partitions)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            <span class="comment">// 整体提交失败（如网络异常、无权限）</span></span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[Offset 提交失败] 整体错误：&quot;</span> &lt;&lt; RdKafka::<span class="built_in">err2str</span>(err) &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历分区，检查每个分区的提交结果（精细化处理）</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> tp : partitions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tp-&gt;<span class="built_in">err</span>() != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">                <span class="comment">// 单个分区提交失败</span></span><br><span class="line">                std::cerr &lt;&lt; <span class="string">&quot;[Offset 提交失败] 主题：&quot;</span> &lt;&lt; tp-&gt;<span class="built_in">topic</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; tp-&gt;<span class="built_in">partition</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 错误：&quot;</span> &lt;&lt; RdKafka::<span class="built_in">err2str</span>(tp-&gt;<span class="built_in">err</span>()) &lt;&lt; std::endl;</span><br><span class="line">                <span class="comment">// 业务逻辑：记录失败的 offset、触发重试、告警</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 单个分区提交成功</span></span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;[Offset 提交成功] 主题：&quot;</span> &lt;&lt; tp-&gt;<span class="built_in">topic</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 分区：&quot;</span> &lt;&lt; tp-&gt;<span class="built_in">partition</span>()</span><br><span class="line">                          &lt;&lt; <span class="string">&quot; 提交的 offset：&quot;</span> &lt;&lt; tp-&gt;<span class="built_in">offset</span>() &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 绑定到消费者配置</span></span><br><span class="line">MyOffsetCommitCb offset_commit_cb;</span><br><span class="line">std::string errstr;</span><br><span class="line">RdKafka::Conf *consumer_conf = RdKafka::Conf::<span class="built_in">create</span>(RdKafka::Conf::CONF_GLOBAL);</span><br><span class="line"><span class="comment">// 关键：将回调对象绑定到 &quot;offset_commit_cb&quot; 配置项</span></span><br><span class="line"><span class="keyword">if</span> (consumer_conf-&gt;<span class="built_in">set</span>(<span class="string">&quot;offset_commit_cb&quot;</span>, &amp;offset_commit_cb, errstr) != RdKafka::CONF_OK) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;绑定 Offset 提交回调失败：&quot;</span> &lt;&lt; errstr &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 异步提交 Offset（触发回调）</span></span><br><span class="line">std::vector&lt;RdKafka::TopicPartition*&gt; partitions;</span><br><span class="line">partitions.<span class="built_in">push_back</span>(RdKafka::TopicPartition::<span class="built_in">create</span>(<span class="string">&quot;topic1&quot;</span>, <span class="number">0</span>));</span><br><span class="line">partitions[<span class="number">0</span>]-&gt;<span class="built_in">set_offset</span>(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">// 异步提交：非阻塞，结果通过 OffsetCommitCb 返回</span></span><br><span class="line">consumer-&gt;<span class="built_in">commitAsync</span>(partitions, <span class="literal">nullptr</span>); <span class="comment">// 第二个参数为 opaque（透传上下文）</span></span><br></pre></td></tr></table></figure>
<h3 id="（5）回调类通用规则与注意事项">（5）回调类通用规则与注意事项</h3>
<h4 id="1-核心通用规则">&lt;1&gt;核心通用规则</h4>
<ul>
<li><strong>抽象类特性</strong>：
<ul>
<li>所有 xxxCb 类均包含纯虚函数，必须实现所有纯虚函数才能实例化（未实现会编译失败）；</li>
</ul>
</li>
<li><strong>线程安全</strong>：
<ul>
<li>回调函数由 librdkafka 内部线程调用（<strong>非业务线程</strong>），需保证：
<ul>
<li>回调内操作（如写日志、更新变量）需<strong>加锁</strong>（std::mutex）；</li>
<li><strong>避免</strong>在回调内执行<strong>耗时操作</strong>（如网络请求、磁盘 IO），会阻塞客户端核心逻辑；</li>
</ul>
</li>
</ul>
</li>
<li><strong>生命周期管理</strong>：
<ul>
<li><strong>回调对象的生命周期必须 ≥ 客户端对象（生产者 / 消费者）</strong>，否则会导致野指针崩溃；</li>
<li><strong>禁止</strong>在回调内销毁客户端对象（如 delete consumer）；</li>
</ul>
</li>
<li><strong>配置项命名</strong>：
<ul>
<li>绑定回调时的配置项名与回调类名对应（如 DeliveryReportCb → dr_cb，RebalanceCb → rebalance_cb），需严格匹配 librdkafka 规范。</li>
</ul>
</li>
</ul>
<h4 id="2-高频易错点">&lt;2&gt;高频易错点</h4>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116224028039.png" alt=""></p>
<h2 id="4-RdKafka-Message类（消息类）">4.RdKafka::Message类（消息类）</h2>
<h3 id="（1）概述-5">（1）概述</h3>
<h4 id="1-作用-5">&lt;1&gt;作用</h4>
<ul>
<li>RdKafka::Message 是 librdkafka 中<strong>消息的核心载体类</strong>,承载消息的元数据、状态（如错误码）等关键信息，用于：
<ul>
<li>生产者端：在 DeliveryReportCb 回调中获取投递结果</li>
<li>消费者端：通过 consume() 获取拉取到的消息</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Message 使用场景                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   Producer                              Consumer                │</span><br><span class="line">│      │                                      │                   │</span><br><span class="line">│      │ <span class="built_in">produce</span>()                            │ <span class="built_in">consume</span>()         │</span><br><span class="line">│      ▼                                      ▼                   │</span><br><span class="line">│   ┌──────────┐                        ┌──────────┐             │</span><br><span class="line">│   │ 内部队列 │                        │ Message  │◄── 拉取结果  │</span><br><span class="line">│   └────┬─────┘                        └──────────┘             │</span><br><span class="line">│        │ 发送完成                                               │</span><br><span class="line">│        ▼                                                       │</span><br><span class="line">│   ┌────────────────┐                                           │</span><br><span class="line">│   │DeliveryReportCb│                                           │</span><br><span class="line">│   │   <span class="built_in">dr_cb</span>()      │                                           │</span><br><span class="line">│   │  ┌──────────┐  │                                           │</span><br><span class="line">│   │  │ Message  │◄─┼── 投递结果                                 │</span><br><span class="line">│   │  └──────────┘  │                                           │</span><br><span class="line">│   └────────────────┘                                           │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116203247930.png" alt=""></p>
<h4 id="2-核心定位-5">&lt;2&gt;核心定位</h4>
<ul>
<li><strong>消息数据载体</strong>：
<ul>
<li>存储消息的「<strong>内容、Key、分区、偏移量</strong>」等“核心业务数据”，是生产者 / 消费者处理消息的直接对象；</li>
</ul>
</li>
<li><strong>元数据容器</strong>：
<ul>
<li>附带消息的「<strong>主题名、时间戳、生产 / 消费状态、错误码</strong>」等“元数据”，支撑消息溯源、异常排查；</li>
</ul>
</li>
<li><strong>状态标识</strong>：
<ul>
<li>不仅封装正常消息，也可表示 “空消息”“错误消息”（如消费超时、分区 EOF），是 API 反馈操作结果的重要形式；</li>
</ul>
</li>
</ul>
<h3 id="（2）Message类的定义">（2）Message类的定义</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RD_EXPORT</span> Message &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ================================= 错误相关 =================================</span></span><br><span class="line">    <span class="comment">/** @returns 如果对象表示错误事件则返回错误字符串，否则返回空字符串。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">errstr</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @returns 如果对象表示错误事件则返回错误码，否则返回 ERR_NO_ERROR（0）。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ErrorCode <span class="title">err</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ================================= 位置信息 =================================</span></span><br><span class="line">    <span class="comment">/** @returns 消息对应的 RdKafka::Topic 对象（如果适用），</span></span><br><span class="line"><span class="comment">    *           如果没有通过 RdKafka::Topic::create() 显式创建对应的</span></span><br><span class="line"><span class="comment">    *           RdKafka::Topic 对象则返回 NULL。</span></span><br><span class="line"><span class="comment">    *           在这种情况下请改用 topic_name()。 */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Topic *<span class="title">topic</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @returns 主题名称（如果适用，否则返回空字符串） */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">topic_name</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @returns 分区号（如果适用） */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">partition</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @returns 消息或错误的偏移量（如果适用） */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">offset</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================= 消息内容 =================================</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> *<span class="title">payload</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;           <span class="comment">// 消息体指针（二进制数据，消息体指针，需转换类型）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">len</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;              <span class="comment">// 消息体长度</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> std::string *<span class="title">key</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;  <span class="comment">// 消息 Key（可能为 NULL）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">size_t</span> <span class="title">key_len</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;          <span class="comment">// Key 长度</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> <span class="type">void</span> *<span class="title">key_pointer</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>; <span class="comment">// Key 指针（二进制 Key）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================= 时间戳 =================================</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Timestamp <span class="title">timestamp</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;     <span class="comment">// 时间戳（含类型）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int64_t</span> <span class="title">latency</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;         <span class="comment">// 消息延迟（微秒，仅生产者）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ================================= 消息头 =================================</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Headers *<span class="title">headers</span><span class="params">()</span> </span>= <span class="number">0</span>;              <span class="comment">// 获取消息头（可修改）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Headers *<span class="title">headers</span><span class="params">(ErrorCode *err)</span> </span>= <span class="number">0</span>;<span class="comment">// 获取消息头，并返回错误码</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ================================= 其他 =================================</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">broker_id</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;       <span class="comment">// 处理该消息的 Broker ID</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * @brief 为已消费的消息存储 offset + 1。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 消息的 offset + 1 将根据 \c `auto.commit.interval.ms` 配置</span></span><br><span class="line"><span class="comment">    * 或手动无偏移量的 commit() 调用提交到 broker。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @warning 此方法只能对当前已分配的分区调用。</span></span><br><span class="line"><span class="comment">    *          对未分配的分区调用将失败并返回 ERR__STATE。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @warning 避免在调用 seek() 等方法后存储偏移量，</span></span><br><span class="line"><span class="comment">    *          因为这可能会干扰后续恢复暂停的分区，</span></span><br><span class="line"><span class="comment">    *          应在调用 seek 之前存储偏移量。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @remark 使用此 API 时必须将 \c `enable.auto.offset.store` 设置为 &quot;false&quot;。</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @returns 成功时返回 NULL，失败时返回错误对象。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Error *<span class="title">offset_store</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** @brief 消息持久化状态，应用程序可以用它来判断生产的消息是否已被持久化到主题日志中。 */</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Status</span> &#123;</span><br><span class="line">        <span class="comment">/** 消息从未发送到 broker，或者发送失败且错误表明消息未写入日志。</span></span><br><span class="line"><span class="comment">        *  应用程序重试可能导致乱序，但不会导致重复。 */</span></span><br><span class="line">        MSG_STATUS_NOT_PERSISTED = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 消息已发送到 broker，但未收到确认。</span></span><br><span class="line"><span class="comment">        *  应用程序重试可能导致乱序和重复。 */</span></span><br><span class="line">        MSG_STATUS_POSSIBLY_PERSISTED = <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 消息已写入日志并被完全确认。</span></span><br><span class="line"><span class="comment">        *  应用程序无需重试。</span></span><br><span class="line"><span class="comment">        *  注意：此值仅在 \c acks=all 时才可完全信任。 */</span></span><br><span class="line">        MSG_STATUS_PERSISTED = <span class="number">2</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@brief 返回消息在主题日志中的持久化状态。（生产者专用）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Status <span class="title">status</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Message</span>() = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Message 核心属性                          │</span><br><span class="line">├──────────────┬──────────────────────────────────────────────┤</span><br><span class="line">│   内容       │  <span class="built_in">payload</span>() + <span class="built_in">len</span>()  /  <span class="built_in">key</span>() + <span class="built_in">key_len</span>()     │</span><br><span class="line">├──────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│   位置       │  <span class="built_in">topic_name</span>() + <span class="built_in">partition</span>() + <span class="built_in">offset</span>()       │</span><br><span class="line">├──────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│   状态       │  <span class="built_in">err</span>() + <span class="built_in">errstr</span>() + <span class="built_in">status</span>()                 │</span><br><span class="line">├──────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│   元数据     │  <span class="built_in">timestamp</span>() + <span class="built_in">headers</span>() + <span class="built_in">broker_id</span>()       │</span><br><span class="line">└──────────────┴──────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h3 id="（3）常见错误码-ErrorCode">（3）常见错误码 ErrorCode</h3>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116205721363.png" alt=""></p>
<h3 id="（4）使用示例">（4）使用示例</h3>
<h4 id="1-消费者接收并处理消息（核心场景）">&lt;1&gt;消费者接收并处理消息（核心场景）</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (running) &#123;</span><br><span class="line">    <span class="comment">// consume() 方法返回 Message 对象，超时时间 1000ms</span></span><br><span class="line">    RdKafka::Message *msg = consumer-&gt;<span class="built_in">consume</span>(<span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过 err() 判断消息状态</span></span><br><span class="line">    <span class="keyword">switch</span> (msg-&gt;<span class="built_in">err</span>()) &#123;</span><br><span class="line">        <span class="keyword">case</span> RdKafka::ERR_NO_ERROR: &#123;</span><br><span class="line">            <span class="comment">// 正常消息</span></span><br><span class="line">            <span class="type">const</span> <span class="type">char</span> *payload = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(msg-&gt;<span class="built_in">payload</span>());</span><br><span class="line">            <span class="type">size_t</span> len = msg-&gt;<span class="built_in">len</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// key() 返回 const std::string*</span></span><br><span class="line">            <span class="type">const</span> std::string *key = msg-&gt;<span class="built_in">key</span>();</span><br><span class="line">            std::string key_str = key ? *key : <span class="string">&quot;无Key&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// timestamp() 返回 MessageTimestamp 结构体</span></span><br><span class="line">            RdKafka::MessageTimestamp ts = msg-&gt;<span class="built_in">timestamp</span>();</span><br><span class="line">            std::string ts_type = (ts.type == RdKafka::MessageTimestamp::MSG_TIMESTAMP_CREATE_TIME) </span><br><span class="line">                                  ? <span class="string">&quot;生产时间&quot;</span> : <span class="string">&quot;写入时间&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;收到消息：&quot;</span> &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  主题：&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">topic_name</span>() &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  分区：&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">partition</span>() &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  偏移量：&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">offset</span>() &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  Key：&quot;</span> &lt;&lt; key_str &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  内容：&quot;</span> &lt;&lt; std::<span class="built_in">string</span>(payload, len) &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  时间戳：&quot;</span> &lt;&lt; ts.timestamp &lt;&lt; <span class="string">&quot;（&quot;</span> &lt;&lt; ts_type &lt;&lt; <span class="string">&quot;）&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> RdKafka::ERR__TIMED_OUT:</span><br><span class="line">            <span class="comment">// 超时，无消息，继续</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> RdKafka::ERR__PARTITION_EOF:</span><br><span class="line">            <span class="comment">// 到达分区末尾</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;分区 EOF：&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">topic_name</span>() </span><br><span class="line">                      &lt;&lt; <span class="string">&quot;-&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">partition</span>() &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="comment">// 其他错误</span></span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;消费错误：&quot;</span> &lt;&lt; msg-&gt;<span class="built_in">errstr</span>() &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ⚠️ 必须释放（关键：避免内存泄漏）</span></span><br><span class="line">    <span class="keyword">delete</span> msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-生产者发送消息后处理回调（异步发送）">&lt;2&gt;生产者发送消息后处理回调（异步发送）</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyDeliveryReportCb</span> : <span class="keyword">public</span> RdKafka::DeliveryReportCb &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 参数是引用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dr_cb</span><span class="params">(RdKafka::Message &amp;msg)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="built_in">err</span>() != RdKafka::ERR_NO_ERROR) &#123;</span><br><span class="line">            <span class="comment">// 发送失败</span></span><br><span class="line">            <span class="type">const</span> std::string *key = msg.<span class="built_in">key</span>();</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;消息发送失败：&quot;</span> &lt;&lt; msg.<span class="built_in">errstr</span>() &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  Key：&quot;</span> &lt;&lt; (key ? *key : <span class="string">&quot;无Key&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 发送成功</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;消息发送成功：&quot;</span> &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  主题：&quot;</span> &lt;&lt; msg.<span class="built_in">topic_name</span>() &lt;&lt; std::endl  <span class="comment">// ✅ 用 . 不用 -&gt;</span></span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  分区：&quot;</span> &lt;&lt; msg.<span class="built_in">partition</span>() &lt;&lt; std::endl</span><br><span class="line">                      &lt;&lt; <span class="string">&quot;  偏移量：&quot;</span> &lt;&lt; msg.<span class="built_in">offset</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ⚠️ 回调中的 msg 由 librdkafka 管理，不要 delete</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="（4）核心特性与注意事项">（4）核心特性与注意事项</h3>
<h4 id="1-核心特征">&lt;1&gt;核心特征</h4>
<ul>
<li><strong>只读性</strong>：
<ul>
<li>消费者侧的 Message 对象所有属性均为只读；</li>
<li>生产者侧仅发送回调中的 Message 包含发送结果，无法修改消息内容；</li>
</ul>
</li>
<li><strong>分区号特殊值</strong>：
<ul>
<li>RdKafka::Topic::PARTITION_UA（等价于 -1）代表 “让 Kafka 自动分配分区”（生产者发送时使用）；</li>
</ul>
</li>
<li><strong>内存管理</strong>：
<ul>
<li><strong>消费者</strong> consume() 返回的 Message 指针<strong>需手动 delete，否则内存泄漏</strong>；</li>
<li><strong>生产者回调中</strong>的 Message 对象由 librdkafka 管理，<strong>无需手动释放</strong>；</li>
</ul>
</li>
<li><strong>错误消息判断</strong>：
<ul>
<li>consume() 始终返回 Message 对象（不会返回 nullptr）</li>
<li>通过 <strong>err()</strong> 判断状态：
<ul>
<li><strong>ERR_NO_ERROR</strong>：正常消息</li>
<li><strong>ERR__TIMED_OUT</strong>：超时，无可用消息</li>
<li><strong>ERR__PARTITION_EOF</strong>：到达分区末尾</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-易错点与最佳实践">&lt;2&gt;易错点与最佳实践</h4>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116221010502.png" alt=""></p>
<p><a id="config"></a></p>
<h1>附录1：常用配置项</h1>
<h2 id="1-Global通用配置（生产者-消费者共用）">1.Global通用配置（生产者/消费者共用）</h2>
<p><strong>关键配置</strong>：<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116144249346.png" alt=""><br>
<strong>网络与连接相关（网络优化）</strong>：<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116144611415.png" alt=""><br>
<strong>安全认证相关（生产环境）</strong>：<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116153411714.png" alt=""><br>
<strong>元数据相关</strong>：<br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116151134440.png" alt=""><br>
<img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116151233728.png" alt=""></p>
<h2 id="2-生产者专用">2.生产者专用</h2>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116154712623.png" alt=""></p>
<h2 id="3-消费者专用">3.消费者专用</h2>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260116155332043.png" alt=""></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="咸鱼 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="咸鱼 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>咸鱼
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://xianyubuxian-txy.github.io/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" title="kafka使用教程">https://xianyubuxian-txy.github.io/2026/01/15/C++/C++后端开发常用库/kafka使用教程/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/CMakeLists%E7%AC%94%E8%AE%B0/" rel="prev" title="CMakeLists笔记">
                  <i class="fa fa-angle-left"></i> CMakeLists笔记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/json%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="next" title="json的使用">
                  json的使用 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">咸鱼</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">122k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:45</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xianyubuxian-TXY" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-beta-black.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请文明评论呀","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2026/01/15/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/kafka%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
