<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xianyubuxian-txy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一、业务逻辑 1.双Token Token的使用（1）access_token  * 主要组成： * 是一个payload，内部包含加密、签名后的信息     * 包含用户信息，如：id、uuid、mobile等；同时也会包含过期时间expiration * 包含用户信息：方便服务端接收到时，从access_token中获取用户信息，方便对相应用户进行操作        * 包含过期时间expir">
<meta property="og:type" content="article">
<meta property="og:title" content="1.用户服务项目开发日志">
<meta property="og:url" content="https://xianyubuxian-txy.github.io/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/index.html">
<meta property="og:site_name" content="Xianyu">
<meta property="og:description" content="一、业务逻辑 1.双Token Token的使用（1）access_token  * 主要组成： * 是一个payload，内部包含加密、签名后的信息     * 包含用户信息，如：id、uuid、mobile等；同时也会包含过期时间expiration * 包含用户信息：方便服务端接收到时，从access_token中获取用户信息，方便对相应用户进行操作        * 包含过期时间expir">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203214435203.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203214452439.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203223314119.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203223314119.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203230506379.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203231758316.png">
<meta property="article:published_time" content="2026-01-26T08:13:57.000Z">
<meta property="article:modified_time" content="2026-02-03T15:19:49.591Z">
<meta property="article:author" content="咸鱼">
<meta property="article:tag" content="日志">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203214435203.png">


<link rel="canonical" href="https://xianyubuxian-txy.github.io/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://xianyubuxian-txy.github.io/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/","path":"2026/01/26/C++/项目开发日志/1-用户服务项目开发日志/","title":"1.用户服务项目开发日志"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>1.用户服务项目开发日志 | Xianyu</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  




<link rel="dns-prefetch" href="https://waline-beta-black.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Xianyu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="nav-text">一、业务逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%8F%8CToken"><span class="nav-text">1.双Token</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89access-token"><span class="nav-text">（1）access_token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89refresh-token"><span class="nav-text">（2）refresh_token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89token%E7%9A%84%E5%8F%91%E9%80%81"><span class="nav-text">（3）token的发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E5%8F%8C-Token-%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="nav-text">（4）双 Token 对比总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-text">2.验证码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text">（1）验证码的组成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E5%AD%98%E5%82%A8"><span class="nav-text">（2）验证码的存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9A%84%E6%A3%80%E9%AA%8C"><span class="nav-text">（3）验证码的检验</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81proto%E6%9C%8D%E5%8A%A1"><span class="nav-text">二、proto服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="nav-text">1.认证相关服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-text">（1）发送验证码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%B3%A8%E5%86%8C"><span class="nav-text">（2）注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-text">（3）密码登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-text">（4）验证码登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%88%B7%E6%96%B0-Token"><span class="nav-text">（5）刷新 Token</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E7%99%BB%E5%87%BA"><span class="nav-text">（6）登出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="nav-text">（7）重置密码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%85%B3%E6%9C%8D%E5%8A%A1"><span class="nav-text">2.用户操作相关服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89gRPC%E4%B8%ADaccess-token%E7%9A%84%E4%BC%A0%E9%80%81%E4%B8%8E%E8%A7%A3%E6%9E%90"><span class="nav-text">（1）gRPC中access_token的传送与解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7"><span class="nav-text">（2）获取当前用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="nav-text">（3）更新用户信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81"><span class="nav-text">（4）修改密码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%EF%BC%88%E6%B3%A8%E9%94%80%E8%B4%A6%E5%8F%B7%EF%BC%89"><span class="nav-text">（5）删除用户（注销账号）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%EF%BC%88%E7%AE%A1%E7%90%86%E5%91%98%E6%8E%A5%E5%8F%A3%EF%BC%89"><span class="nav-text">（6）获取指定用户（管理员接口）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8%EF%BC%88%E7%AE%A1%E7%90%86%E5%91%98%E6%8E%A5%E5%8F%A3%EF%BC%89"><span class="nav-text">（7）获取用户列表（管理员接口）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%94%99%E8%AF%AF%E7%A0%81"><span class="nav-text">2.错误码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1%E5%B1%82%E4%B8%8E%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="nav-text">三、基础服务层与业务层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="nav-text">1.基础服务层</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="nav-text">2.业务层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%B8%9A%E5%8A%A1%E5%B1%82%E4%B8%8Eproto%E5%AE%8C%E5%85%A8%E7%8B%AC%E7%AB%8B"><span class="nav-text">（1）业务层与proto完全独立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9E%9A%E4%B8%BE%E3%80%81%E5%AE%9E%E4%BD%93"><span class="nav-text">&lt;1&gt;自定义枚举、实体</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89proto"><span class="nav-text">1）proto</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="nav-text">2）业务层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%EF%BC%89%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="nav-text">3）转换函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E7%B1%BB%E7%8B%AC%E7%AB%8B"><span class="nav-text">&lt;2&gt;业务类独立</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89proto%E7%9A%84%E5%85%B7%E4%BD%93%E7%B1%BB"><span class="nav-text">1）proto的具体类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%B8%9A%E5%8A%A1%E7%B1%BB"><span class="nav-text">2）业务类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3%EF%BC%89%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-text">3）调用逻辑</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%AE%A4%E8%AF%81%E7%9B%B8%E5%85%B3%E4%B8%9A%E5%8A%A1%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="nav-text">（2）认证相关业务类实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="nav-text">&lt;1&gt;发送验证码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C"><span class="nav-text">&lt;2&gt;注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-text">&lt;3&gt;密码登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E7%99%BB%E5%BD%95"><span class="nav-text">&lt;4&gt;验证码登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81"><span class="nav-text">&lt;5&gt;重置密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%B7%E6%96%B0-Token"><span class="nav-text">&lt;6&gt;刷新 Token</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%99%BB%E5%87%BA%EF%BC%88%E5%8D%95%E8%AE%BE%E5%A4%87%EF%BC%89"><span class="nav-text">&lt;7&gt;登出（单设备）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%85%B3%E4%B8%9A%E5%8A%A1%E7%B1%BB%E5%AE%9E%E7%8E%B0"><span class="nav-text">（3）用户操作相关业务类实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7"><span class="nav-text">&lt;1&gt;获取当前用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="nav-text">&lt;2&gt;更新用户信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%EF%BC%88%E5%B7%B2%E7%99%BB%E5%BD%95%EF%BC%89"><span class="nav-text">&lt;3&gt;修改密码（已登录）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7%EF%BC%88%E6%B3%A8%E9%94%80%E8%B4%A6%E5%8F%B7%EF%BC%89"><span class="nav-text">&lt;4&gt;删除用户（注销账号）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%EF%BC%88%E7%AE%A1%E7%90%86%E5%91%98%EF%BC%89"><span class="nav-text">&lt;5&gt;获取指定用户（管理员）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8%EF%BC%88%E7%AE%A1%E7%90%86%E5%91%98%EF%BC%89"><span class="nav-text">&lt;6&gt;获取用户列表（管理员）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A6%81%E7%94%A8-%E5%90%AF%E7%94%A8%E7%94%A8%E6%88%B7%EF%BC%88%E7%AE%A1%E7%90%86%E5%91%98%EF%BC%89"><span class="nav-text">&lt;7&gt;禁用&#x2F;启用用户（管理员）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%94%99%E8%AF%AF%E7%A0%81%E8%AE%BE%E8%AE%A1"><span class="nav-text">3.错误码设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89proto%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E7%A0%81"><span class="nav-text">（1）proto定义错误码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E4%B8%9A%E5%8A%A1%E5%B1%82%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E7%A0%81"><span class="nav-text">（2）业务层定义错误码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%B8%A4%E8%80%85%E8%BD%AC%E6%8D%A2"><span class="nav-text">（3）两者转换</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%85%B3%E9%94%AE%E6%94%B6%E8%8E%B7%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-text">四、关键收获（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%89%E5%B1%82%E6%A8%A1%E5%9E%8B"><span class="nav-text">1.异常处理三层模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-gRPC-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="nav-text">2.gRPC 分层架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%8F%8C-Token-%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6"><span class="nav-text">3.双 Token 认证机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">4. 架构设计原则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%94%99%E8%AF%AF%E7%A0%81%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">5.错误码设计原则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E9%94%99%E8%AF%AF%E7%A0%81%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="nav-text">（1）错误码使用模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E8%AE%BE%E8%AE%A1%E8%A6%81%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-text">（2）设计要点总结</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="咸鱼"
      src="/images/xianyu.jpg">
  <p class="site-author-name" itemprop="name">咸鱼</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xianyubuxian-TXY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xianyubuxian-TXY" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xianyubuxian-txy.github.io/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xianyu.jpg">
      <meta itemprop="name" content="咸鱼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xianyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="1.用户服务项目开发日志 | Xianyu">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          1.用户服务项目开发日志
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-26 16:13:57" itemprop="dateCreated datePublished" datetime="2026-01-26T16:13:57+08:00">2026-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-02-03 23:19:49" itemprop="dateModified" datetime="2026-02-03T23:19:49+08:00">2026-02-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/" itemprop="url" rel="index"><span itemprop="name">项目开发日志</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/" itemprop="url" rel="index"><span itemprop="name">1.用户服务项目开发日志</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>36 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="一、业务逻辑"><a href="#一、业务逻辑" class="headerlink" title="一、业务逻辑"></a>一、业务逻辑</h1><h2 id="1-双Token"><a href="#1-双Token" class="headerlink" title="1.双Token"></a>1.双Token</h2><a href="/2026/01/29/C++/%E5%90%8E%E7%AB%AF%E4%B8%9A%E5%8A%A1%E6%A6%82%E5%BF%B5/token%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Token的使用">Token的使用</a>

<h3 id="（1）access-token"><a href="#（1）access-token" class="headerlink" title="（1）access_token"></a>（1）access_token</h3><ul>
<li><strong>主要组成</strong>：<ul>
<li>是一个<strong>payload</strong>，内部包含加密、签名后的信息</li>
<li>包含用户信息，如：id、uuid、mobile等；同时也会包含过期时间expiration<ul>
<li><strong>包含用户信息</strong>：方便服务端接收到时，从access_token中获取用户信息，方便对相应用户进行操作</li>
<li><strong>包含过期时间expiration</strong>：方便服务端检查是否过期，过期则无效，需重新获取</li>
</ul>
</li>
</ul>
</li>
<li><strong>主要功能</strong>：<ul>
<li>因为http是<strong>无状态的</strong>，故用户在登录（注册自动登录）后，会获得access_token和refresh_token,之后的所有请求（如：修改信息、修改密码等）都需要将access_token一起发送到后端，后端<strong>从access_token中解析出用户信息</strong>（如id、uuid、mobile等）作为参数，根据请求类型调用相应业务API即可</li>
</ul>
</li>
<li><strong>有效期</strong>：<ul>
<li>access_token的“有效期”比较<strong>短暂</strong>（如30分钟），服务端并不需要存储在数据库中，客户端将其存储在本地内存或缓存中，服务端接收后，从access_token解析出<strong>过期时间expiration</strong>检查是否过期，如果过期则拒绝请求。</li>
<li><strong>token会加密+签名，故几乎无法被修改或仿造</strong></li>
</ul>
</li>
<li><strong>过期处理</strong>：<ul>
<li>access_token过期后，服务端将拒绝请求，如果客户端还想获取服务端的请求，需要发送refresh_token到服务端进行刷新，服务端或重新生成一对Token（access_token、refresh_token）发送到客户端，客户端再用新生成的access_token去发起请求即可</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief 生成 Access Token（访问令牌）</span></span><br><span class="line"><span class="comment">/// @details</span></span><br><span class="line"><span class="comment">///   ┌────────────────────────────────────────────────────────────────┐</span></span><br><span class="line"><span class="comment">///   │  Access Token JWT Payload 结构                                 │</span></span><br><span class="line"><span class="comment">///   ├──────────┬─────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">///   │  字段    │  说明                                               │</span></span><br><span class="line"><span class="comment">///   ├──────────┼─────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">///   │  iss     │  签发者（Issuer），如 &quot;user-service&quot;                 │</span></span><br><span class="line"><span class="comment">///   │  sub     │  主题（Subject），固定为 &quot;access&quot; 标识令牌类型        │</span></span><br><span class="line"><span class="comment">///   │  id      │  用户数据库 ID（int64_t），用于内部快速查库           │</span></span><br><span class="line"><span class="comment">///   │  uid     │  用户 UUID，对外暴露的用户标识（API 返回用）          │</span></span><br><span class="line"><span class="comment">///   │  mobile  │  用户手机号，业务需要时可直接从令牌获取               │</span></span><br><span class="line"><span class="comment">///   │  iat     │  签发时间（Issued At），Unix 时间戳（秒）             │</span></span><br><span class="line"><span class="comment">///   │  exp     │  过期时间（Expiration），Unix 时间戳（秒）            │</span></span><br><span class="line"><span class="comment">///   │  jti     │  JWT ID，随机数，确保每次生成的令牌唯一               │</span></span><br><span class="line"><span class="comment">///   └──────────┴─────────────────────────────────────────────────────┘</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">///   示例 Payload（解码后）：</span></span><br><span class="line"><span class="comment">///   &#123;</span></span><br><span class="line"><span class="comment">///     &quot;iss&quot;: &quot;user-service&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;sub&quot;: &quot;access&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;id&quot;: &quot;12345&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;uid&quot;: &quot;550e8400-e29b-41d4-a716-446655440000&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;mobile&quot;: &quot;13800138000&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;iat&quot;: 1704067200,</span></span><br><span class="line"><span class="comment">///     &quot;exp&quot;: 1704074400,</span></span><br><span class="line"><span class="comment">///     &quot;jti&quot;: &quot;582943&quot;</span></span><br><span class="line"><span class="comment">///   &#125;</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// @param user_id 用户数据库 ID（字符串格式）</span></span><br><span class="line"><span class="comment">/// @param user_uuid 用户 UUID</span></span><br><span class="line"><span class="comment">/// @param mobile 用户手机号</span></span><br><span class="line"><span class="comment">/// @return JWT 格式的 Access Token 字符串</span></span><br><span class="line"><span class="function">std::string <span class="title">JwtService::GenerateAccessToken</span><span class="params">(<span class="type">const</span> UserEntity&amp; user)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> exp = now + std::chrono::<span class="built_in">seconds</span>(config_.access_token_ttl_seconds);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 随机数生成器（用于 jti 字段，确保令牌唯一性）</span></span><br><span class="line">    <span class="type">static</span> std::random_device rd;</span><br><span class="line">    <span class="function"><span class="type">static</span> std::mt19937 <span class="title">gen</span><span class="params">(rd())</span></span>;</span><br><span class="line">    <span class="type">static</span> std::uniform_int_distribution&lt;&gt; <span class="built_in">dis</span>(<span class="number">100000</span>, <span class="number">999999</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建 JWT Claims</span></span><br><span class="line">    std::map&lt;std::string, std::string&gt; claims;</span><br><span class="line">    claims[<span class="string">&quot;iss&quot;</span>] = config_.jwt_issuer;   <span class="comment">// 签发者</span></span><br><span class="line">    claims[<span class="string">&quot;sub&quot;</span>] = <span class="string">&quot;access&quot;</span>;              <span class="comment">// 令牌类型标识</span></span><br><span class="line">    claims[<span class="string">&quot;id&quot;</span>]  = std::<span class="built_in">to_string</span>(user.id);               <span class="comment">// 数据库用户 ID（内部使用）</span></span><br><span class="line">    claims[<span class="string">&quot;uid&quot;</span>] = user.uuid;             <span class="comment">// 用户 UUID（对外暴露）</span></span><br><span class="line">    claims[<span class="string">&quot;mobile&quot;</span>] = user.mobile;        <span class="comment">// 手机号</span></span><br><span class="line">    claims[<span class="string">&quot;role&quot;</span>] = <span class="built_in">UserRoleToString</span>(user.role);</span><br><span class="line">    claims[<span class="string">&quot;iat&quot;</span>] = std::<span class="built_in">to_string</span>(std::chrono::system_clock::<span class="built_in">to_time_t</span>(now));  <span class="comment">// 签发时间</span></span><br><span class="line">    claims[<span class="string">&quot;exp&quot;</span>] = std::<span class="built_in">to_string</span>(std::chrono::system_clock::<span class="built_in">to_time_t</span>(exp));  <span class="comment">// 过期时间</span></span><br><span class="line">    claims[<span class="string">&quot;jti&quot;</span>] = std::<span class="built_in">to_string</span>(<span class="built_in">dis</span>(gen));  <span class="comment">// JWT ID（6 位随机数）</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateJwt</span>(claims, config_.jwt_secret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）refresh-token"><a href="#（2）refresh-token" class="headerlink" title="（2）refresh_token"></a>（2）refresh_token</h3><ul>
<li><strong>主要组成</strong>：<ul>
<li>是一个<strong>payload</strong>，内部包含加密、签名后的信息</li>
<li>主要包含<strong>用户id，过期时间expiration</strong>等<ul>
<li>refresh_token主要在access_token过期时进行刷新生成新的双Token发送给客户端，所以不需要包含太多用户信息</li>
<li><strong>存储用户id</strong>：主要是为了在刷新时，通过用户id从数据库中获取用户信息，填充到access_token中</li>
</ul>
</li>
<li><strong>存储过期时间expiration</strong>：也是方便服务端检查是否过期，过期后无效，需要重新登录后获取新的refresh_token</li>
</ul>
</li>
<li><strong>主要功能</strong>：<ul>
<li>当access_token过期时，客户端发送refresh_token给服务端，服务端接收后检查如果未过期，会重新生成一对Token发送给客户端，客户端再用新生成的access_token发送请求</li>
</ul>
</li>
<li><strong>有效期</strong>：<ul>
<li>refresh_token的“有效期”<strong>较长</strong>（如7天），“服务端”需要将其<strong>存储到“数据库”中</strong>，客户端将其存储在本地内存或缓存中，服务端接收后，从refresh_token解析出<strong>过期时间expiration</strong>检查是否过期，如果过期则拒绝请求。</li>
</ul>
</li>
<li><strong>过期处理</strong>：<ul>
<li>refresh_token过期后，服务端将拒绝其刷新请求，要想重新获取，<strong>必须重新登录</strong></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief 生成 Refresh Token（刷新令牌）</span></span><br><span class="line"><span class="comment">/// @details</span></span><br><span class="line"><span class="comment">///   ┌────────────────────────────────────────────────────────────────┐</span></span><br><span class="line"><span class="comment">///   │  Refresh Token JWT Payload 结构                                │</span></span><br><span class="line"><span class="comment">///   ├──────────┬─────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">///   │  字段    │  说明                                               │</span></span><br><span class="line"><span class="comment">///   ├──────────┼─────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">///   │  iss     │  签发者（Issuer），如 &quot;user-service&quot;                 │</span></span><br><span class="line"><span class="comment">///   │  sub     │  主题（Subject），固定为 &quot;refresh&quot; 标识令牌类型       │</span></span><br><span class="line"><span class="comment">///   │  uid     │  用户数据库 ID，用于查库获取用户信息生成新令牌        │</span></span><br><span class="line"><span class="comment">///   │  iat     │  签发时间（Issued At），Unix 时间戳（秒）             │</span></span><br><span class="line"><span class="comment">///   │  exp     │  过期时间（Expiration），Unix 时间戳（秒）            │</span></span><br><span class="line"><span class="comment">///   │  jti     │  JWT ID，随机数，确保每次生成的令牌唯一               │</span></span><br><span class="line"><span class="comment">///   └──────────┴─────────────────────────────────────────────────────┘</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">///   示例 Payload（解码后）：</span></span><br><span class="line"><span class="comment">///   &#123;</span></span><br><span class="line"><span class="comment">///     &quot;iss&quot;: &quot;user-service&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;sub&quot;: &quot;refresh&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;uid&quot;: &quot;12345&quot;,</span></span><br><span class="line"><span class="comment">///     &quot;iat&quot;: 1704067200,</span></span><br><span class="line"><span class="comment">///     &quot;exp&quot;: 1704672000,</span></span><br><span class="line"><span class="comment">///     &quot;jti&quot;: &quot;847291&quot;</span></span><br><span class="line"><span class="comment">///   &#125;</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">///   与 Access Token 的区别：</span></span><br><span class="line"><span class="comment">///   1. sub = &quot;refresh&quot;（用于区分令牌类型）</span></span><br><span class="line"><span class="comment">///   2. 仅包含 uid（数据库 ID），不包含 uuid、mobile</span></span><br><span class="line"><span class="comment">///   3. 有效期更长（如 7 天 vs 2 小时）</span></span><br><span class="line"><span class="comment">///   4. 仅用于调用 RefreshToken 接口，不能用于业务鉴权</span></span><br><span class="line"><span class="comment">/// </span></span><br><span class="line"><span class="comment">/// @param user_id 用户数据库 ID（字符串格式）</span></span><br><span class="line"><span class="comment">/// @return JWT 格式的 Refresh Token 字符串</span></span><br><span class="line"><span class="function">std::string <span class="title">JwtService::GenerateRefreshToken</span><span class="params">(<span class="type">const</span> UserEntity&amp; user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">auto</span> exp = now + std::chrono::<span class="built_in">seconds</span>(config_.refresh_token_ttl_seconds);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 随机数生成器（确保同一秒内生成的 token 不同）</span></span><br><span class="line">    <span class="type">static</span> std::random_device rd;</span><br><span class="line">    <span class="function"><span class="type">static</span> std::mt19937 <span class="title">gen</span><span class="params">(rd())</span></span>;</span><br><span class="line">    <span class="type">static</span> std::uniform_int_distribution&lt;&gt; <span class="built_in">dis</span>(<span class="number">100000</span>, <span class="number">999999</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建 JWT Claims（最小化载荷）</span></span><br><span class="line">    std::map&lt;std::string, std::string&gt; claims;</span><br><span class="line">    claims[<span class="string">&quot;iss&quot;</span>] = config_.jwt_issuer;   <span class="comment">// 签发者</span></span><br><span class="line">    claims[<span class="string">&quot;sub&quot;</span>] = <span class="string">&quot;refresh&quot;</span>;             <span class="comment">// 令牌类型标识</span></span><br><span class="line">    claims[<span class="string">&quot;uid&quot;</span>] = std::<span class="built_in">to_string</span>(user.id);      <span class="comment">// 用户数据库 ID（注意：这里是数据库 ID，不是 UUID）</span></span><br><span class="line">    claims[<span class="string">&quot;iat&quot;</span>] = std::<span class="built_in">to_string</span>(std::chrono::system_clock::<span class="built_in">to_time_t</span>(now));  <span class="comment">// 签发时间</span></span><br><span class="line">    claims[<span class="string">&quot;exp&quot;</span>] = std::<span class="built_in">to_string</span>(std::chrono::system_clock::<span class="built_in">to_time_t</span>(exp));  <span class="comment">// 过期时间</span></span><br><span class="line">    claims[<span class="string">&quot;jti&quot;</span>] = std::<span class="built_in">to_string</span>(<span class="built_in">dis</span>(gen));  <span class="comment">// JWT ID（6 位随机数）</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CreateJwt</span>(claims, config_.jwt_secret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="（3）token的发送"><a href="#（3）token的发送" class="headerlink" title="（3）token的发送"></a>（3）token的发送</h3><ul>
<li>Token就是服务端加密+签名后的payload（字符串），通过网络发送给客户端<ul>
<li><strong>http协议</strong>：在<strong>首部header添加对应字段</strong>发送到客户端后，客户端进行解析即可</li>
<li>自定义协议：如 [字段长度][字段名][字段值]<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203214435203.png"></li>
</ul>
</li>
</ul>
<h3 id="（4）双-Token-对比总结"><a href="#（4）双-Token-对比总结" class="headerlink" title="（4）双 Token 对比总结"></a>（4）双 Token 对比总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203214452439.png"></p>
<h2 id="2-验证码"><a href="#2-验证码" class="headerlink" title="2.验证码"></a>2.验证码</h2><h3 id="（1）验证码的组成"><a href="#（1）验证码的组成" class="headerlink" title="（1）验证码的组成"></a>（1）验证码的组成</h3><ul>
<li>会有很多场景发送验证码，故需要用“业务类型+业务场景+手机号”进行存储，方便区分不同的业务与场景</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">作用：生成短信验证码本身的缓存 Key</span></span><br><span class="line"><span class="comment">存储值：实际的短信验证码（如682915）+ 过期时间（通常 5-10 分钟，验证码有效期）</span></span><br><span class="line"><span class="comment">绑定 scene 原因：同一个手机号在不同场景的验证码独立（比如登录发了682915，注册可同时发954278，不会覆盖）</span></span><br><span class="line"><span class="comment">典型 Key 示例：sms:code:login:13812345678、sms:code:find_pwd:13812345678</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">std::string <span class="title">SmsService::CaptchaKey</span><span class="params">(SmsScene scene, <span class="type">const</span> std::string&amp; mobile)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sms:code:&quot;</span>+<span class="built_in">SceneName</span>(scene)+<span class="string">&quot;:&quot;</span>+mobile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">作用：生成短信发送间隔的缓存 Key（防频繁发送）</span></span><br><span class="line"><span class="comment">存储值：最后一次发送短信的时间戳（如1735689600）</span></span><br><span class="line"><span class="comment">设计原因：基础限流规则 —— 无论哪个场景，同一个手机号短时间内不能反复发验证码（比如默认 60 秒内只能发 1 次），无需绑定 scene（全局间隔限制）</span></span><br><span class="line"><span class="comment">典型 Key 示例：sms:interval:13812345678</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">std::string <span class="title">SmsService::IntervalKey</span><span class="params">(<span class="type">const</span> std::string&amp; mobile)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sms:interval:&quot;</span>+mobile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">作用：生成单场景验证码验证失败次数的缓存 Key（防暴力破解）</span></span><br><span class="line"><span class="comment">存储值：该场景下，手机号累计验证验证码失败的次数（如2）</span></span><br><span class="line"><span class="comment">绑定 scene 原因：不同场景的验证失败次数独立（比如登录验证失败 2 次，不影响注册场景）</span></span><br><span class="line"><span class="comment">设计原因：防暴力破解验证码 —— 限制单场景下的失败次数（比如最多失败 3 次），超过则临时锁定该场景的短信发送 / 验证，避免攻击者枚举验证码</span></span><br><span class="line"><span class="comment">典型 Key 示例：sms:verify_count:login:13812345678</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">std::string <span class="title">SmsService::VerifyCountKey</span><span class="params">(SmsScene scene, <span class="type">const</span> std::string&amp; mobile)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sms:verify_count:&quot;</span>+<span class="built_in">SceneName</span>(scene)+<span class="string">&quot;:&quot;</span>+mobile;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">作用：生成单场景短信临时锁定的缓存 Key（风控兜底）</span></span><br><span class="line"><span class="comment">存储值：锁定状态（如1）+ 锁定过期时间（比如 10 分钟，自动解锁）</span></span><br><span class="line"><span class="comment">绑定 scene 原因：锁定仅针对当前场景（比如登录场景被锁，注册场景仍可正常使用）</span></span><br><span class="line"><span class="comment">设计原因：兜底风控 —— 当满足「验证失败次数超限」「发送间隔频繁突破」等风险条件时，临时锁定该场景的短信服务，避免进一步的恶意操作，且非全局锁定，不影响用户其他业务操作，兼顾风控和用户体验</span></span><br><span class="line"><span class="comment">典型 Key 示例：sms:lock:login:13812345678</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">std::string <span class="title">SmsService::LockKey</span><span class="params">(SmsScene scene, <span class="type">const</span> std::string&amp; mobile)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;sms:lock:&quot;</span>+<span class="built_in">SceneName</span>(scene)+<span class="string">&quot;:&quot;</span>+mobile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）验证码的存储"><a href="#（2）验证码的存储" class="headerlink" title="（2）验证码的存储"></a>（2）验证码的存储</h3><ul>
<li>验证码是短暂有效的，所有通过redis进行限时存储即可</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.生成验证码</span></span><br><span class="line">std::string code=<span class="built_in">GenerateCaptcha</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.存储到Redis（原子操作）</span></span><br><span class="line"><span class="comment">// 存储验证码（关键操作，必须成功）</span></span><br><span class="line"><span class="keyword">auto</span> set_code=redis_-&gt;<span class="built_in">SetPx</span>(<span class="built_in">CaptchaKey</span>(scene,mobile),code,</span><br><span class="line">                std::chrono::<span class="built_in">milliseconds</span>(config_.code_ttl_seconds*<span class="number">1000</span>));</span><br></pre></td></tr></table></figure>

<h3 id="（3）验证码的检验"><a href="#（3）验证码的检验" class="headerlink" title="（3）验证码的检验"></a>（3）验证码的检验</h3><ul>
<li>将业务场景scene、mobile、客户端收到的“验证码”<ul>
<li>服务端通过scene+mobile生成redis的“键”，获取之前发送时存储的“验证码”<ul>
<li>已经过期（获取失败），则验证失败</li>
<li>还未过期（获取成功），则与客户端传入的“验证码”进行对比即可</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证验证码</span></span><br><span class="line"><span class="function">Result&lt;<span class="type">void</span>&gt; <span class="title">SmsService::VerifyCaptcha</span><span class="params">(SmsScene scene,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> std::string&amp; input_code)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.获取正确的验证码</span></span><br><span class="line"><span class="keyword">auto</span> stored_code_result = redis_-&gt;<span class="built_in">Get</span>(<span class="built_in">CaptchaKey</span>(scene, mobile));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.获取正确的验证码</span></span><br><span class="line"><span class="keyword">auto</span> stored_code_result = redis_-&gt;<span class="built_in">Get</span>(<span class="built_in">CaptchaKey</span>(scene, mobile));</span><br><span class="line"><span class="keyword">if</span> (!stored_code_result.<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">    <span class="built_in">LOG_ERROR</span>(<span class="string">&quot;Redis error when getting code: &#123;&#125;&quot;</span>, stored_code_result.message);</span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="type">void</span>&gt;::<span class="built_in">Fail</span>(ErrorCode::ServiceUnavailable,</span><br><span class="line">                              <span class="string">&quot;服务暂时不可用，请稍后重试&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!stored_code_result.<span class="built_in">Value</span>().<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">    <span class="comment">// 未找到验证码</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="type">void</span>&gt;::<span class="built_in">Fail</span>(</span><br><span class="line">        ErrorCode::CaptchaExpired,</span><br><span class="line">        <span class="string">&quot;验证码已过期，请重新获取&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">const</span> std::string&amp; stored_code = stored_code_result.<span class="built_in">Value</span>().<span class="built_in">value</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.对比验证码</span></span><br><span class="line"><span class="keyword">if</span>(input_code!=stored_code)&#123;</span><br><span class="line">    <span class="comment">// 验证失败 ......</span></span><br><span class="line">    <span class="comment">// 验证码错误的返回</span></span><br><span class="line">    <span class="keyword">return</span> Result&lt;<span class="type">void</span>&gt;::<span class="built_in">Fail</span>(ErrorCode::CaptchaWrong, </span><br><span class="line">        fmt::format(<span class="string">&quot;验证码错误，还剩&#123;&#125;次机会&quot;</span>, </span><br><span class="line">                    config_.max_retry_count - count));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 验证成功，清理错误计数</span></span><br><span class="line"><span class="comment">/* 不删除验证码，如：</span></span><br><span class="line"><span class="comment">    验证码正确 → 创建用户（可能失败：用户名冲突、数据库异常）</span></span><br><span class="line"><span class="comment">             ↓ 失败</span></span><br><span class="line"><span class="comment">       用户想用同一个验证码重试</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">redis_-&gt;<span class="built_in">Del</span>(<span class="built_in">VerifyCountKey</span>(scene, mobile));</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="二、proto服务"><a href="#二、proto服务" class="headerlink" title="二、proto服务"></a>二、proto服务</h1><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203223314119.png"></p>
<h2 id="1-认证相关服务"><a href="#1-认证相关服务" class="headerlink" title="1.认证相关服务"></a>1.认证相关服务</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">service AuthService &#123;</span><br><span class="line">    <span class="comment">// 验证码</span></span><br><span class="line">    <span class="function">rpc <span class="title">SendVerifyCode</span><span class="params">(SendVerifyCodeRequest)</span> <span class="title">returns</span> <span class="params">(SendVerifyCodeResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    <span class="function">rpc <span class="title">Register</span><span class="params">(RegisterRequest)</span> <span class="title">returns</span> <span class="params">(RegisterResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录</span></span><br><span class="line">    <span class="function">rpc <span class="title">LoginByPassword</span><span class="params">(LoginByPasswordRequest)</span> <span class="title">returns</span> <span class="params">(LoginByPasswordResponse)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">LoginByCode</span><span class="params">(LoginByCodeRequest)</span> <span class="title">returns</span> <span class="params">(LoginByCodeResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Token管理</span></span><br><span class="line">    <span class="function">rpc <span class="title">RefreshToken</span><span class="params">(RefreshTokenRequest)</span> <span class="title">returns</span> <span class="params">(RefreshTokenResponse)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">Logout</span><span class="params">(LogoutRequest)</span> <span class="title">returns</span> <span class="params">(LogoutResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 密码重置</span></span><br><span class="line">    <span class="function">rpc <span class="title">ResetPassword</span><span class="params">(ResetPasswordRequest)</span> <span class="title">returns</span> <span class="params">(ResetPasswordResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内部服务Token验证（禁止客户端调用）</span></span><br><span class="line">    <span class="function">rpc <span class="title">ValidateToken</span><span class="params">(ValidateTokenRequest)</span> <span class="title">returns</span> <span class="params">(ValidateTokenResponse)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      认证服务核心流程                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  注册/登录                                                       │</span><br><span class="line">│  ────────                                                       │</span><br><span class="line">│  校验参数 → 验证身份(验证码) → 查询/创建用户 → 生成双Token → 存储Token   │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  刷新Token                                                       │</span><br><span class="line">│  ─────────                                                       │</span><br><span class="line">│  解析Token → 校验哈希 → 删除旧Token → 生成新Token → 存储新Token  │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  登出                                                            │</span><br><span class="line">│  ────                                                            │</span><br><span class="line">│  计算哈希 → 删除Token（幂等）                                    │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  密码登录安全                                                    │</span><br><span class="line">│  ───────────                                                     │</span><br><span class="line">│  检查失败次数 → 验证密码 → 成功清除/失败记录                     │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<ul>
<li><strong>注意</strong>：具体子类只进行参数校验等，<strong>不实现具体“业务逻辑”</strong>，“业务逻辑”在业务层实现，且与proto完全独立，只需在具体子类中调用对应的“业务逻辑”即可</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统一模式</span></span><br><span class="line">::<span class="function">grpc::Status <span class="title">Handler::Method</span><span class="params">(context, request, response)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Method: key_param=&#123;&#125;&quot;</span>, request-&gt;<span class="built_in">key_param</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 参数校验（快速失败）</span></span><br><span class="line">    std::string error;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValidXxx</span>(request-&gt;<span class="built_in">field</span>(), error)) &#123;</span><br><span class="line">        <span class="built_in">SetResultError</span>(response-&gt;<span class="built_in">mutable_result</span>(), ErrorCode::InvalidArgument, error);</span><br><span class="line">        <span class="keyword">return</span> ::grpc::Status::OK;  <span class="comment">// 业务错误不用 grpc 错误码</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 调用业务层</span></span><br><span class="line">    <span class="keyword">auto</span> result = service_-&gt;<span class="built_in">Method</span>(...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 设置响应</span></span><br><span class="line">    <span class="built_in">SetResultError</span>(response-&gt;<span class="built_in">mutable_result</span>(), result.code, result.message);</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">        <span class="built_in">ToProtoXxx</span>(result.<span class="built_in">Value</span>(), response-&gt;<span class="built_in">mutable_xxx</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ::grpc::Status::OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义具体服务类，实现具体方法</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pb_auth/auth.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;service/auth_service.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> user_service &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前向声明</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthHandler</span> <span class="keyword">final</span> : <span class="keyword">public</span> ::pb_auth::AuthService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">AuthHandler</span><span class="params">(std::shared_ptr&lt;AuthService&gt; auth_service)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">SendVerifyCode</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> ::pb_auth::SendVerifyCodeRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   ::pb_auth::SendVerifyCodeResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">Register</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> ::pb_auth::RegisterRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                            ::pb_auth::RegisterResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">LoginByPassword</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> ::pb_auth::LoginByPasswordRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                    ::pb_auth::LoginByPasswordResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">LoginByCode</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> ::pb_auth::LoginByCodeRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                ::pb_auth::LoginByCodeResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Token 管理</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">RefreshToken</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> ::pb_auth::RefreshTokenRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 ::pb_auth::RefreshTokenResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">Logout</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">const</span> ::pb_auth::LogoutRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                          ::pb_auth::LogoutResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 密码</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ResetPassword</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> ::pb_auth::ResetPasswordRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  ::pb_auth::ResetPasswordResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内部验证</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ValidateToken</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> ::pb_auth::ValidateTokenRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  ::pb_auth::ValidateTokenResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;AuthService&gt; auth_service_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace user_service</span></span><br></pre></td></tr></table></figure>


<h3 id="（1）发送验证码"><a href="#（1）发送验证码" class="headerlink" title="（1）发送验证码"></a>（1）发送验证码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SendVerifyCode</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: mobile, scene</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - 手机号格式</span><br><span class="line">       - scene 枚举有效性（转换为业务枚举）</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">SendVerifyCode</span>(mobile, scene)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 <span class="built_in">result</span> (code, message)</span><br><span class="line">       - 成功时设置 retry_after（重试间隔秒数）</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（2）注册"><a href="#（2）注册" class="headerlink" title="（2）注册"></a>（2）注册</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Register</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: mobile</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - 手机号格式</span><br><span class="line">       - 验证码格式</span><br><span class="line">       - 密码格式</span><br><span class="line">       - display_name（可选，有值则校验）</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">Register</span>(mobile, verify_code, password, display_name)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: <span class="built_in">ToProtoUserInfo</span>(user) + <span class="built_in">ToProtoTokenPair</span>(tokens)</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（3）密码登录"><a href="#（3）密码登录" class="headerlink" title="（3）密码登录"></a>（3）密码登录</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LoginByPassword</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: mobile</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - 手机号格式</span><br><span class="line">       - 密码非空</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">LoginByPassword</span>(mobile, password)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: ToProtoUserInfo + ToProtoTokenPair</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（4）验证码登录"><a href="#（4）验证码登录" class="headerlink" title="（4）验证码登录"></a>（4）验证码登录</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LoginByCode</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: mobile</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - 手机号格式</span><br><span class="line">       - 验证码格式</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">LoginByCode</span>(mobile, verify_code)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: ToProtoUserInfo + ToProtoTokenPair</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（5）刷新-Token"><a href="#（5）刷新-Token" class="headerlink" title="（5）刷新 Token"></a>（5）刷新 Token</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RefreshToken</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: DEBUG 级别</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - refresh_token 非空</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">RefreshToken</span>(refresh_token)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: ToProtoTokenPair</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（6）登出"><a href="#（6）登出" class="headerlink" title="（6）登出"></a>（6）登出</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Logout</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: INFO</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - refresh_token 非空</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">Logout</span>(refresh_token)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（7）重置密码"><a href="#（7）重置密码" class="headerlink" title="（7）重置密码"></a>（7）重置密码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ResetPassword</span>(request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: mobile</span><br><span class="line">    <span class="number">2.</span> 参数校验:</span><br><span class="line">       - 手机号格式</span><br><span class="line">       - 验证码格式</span><br><span class="line">       - 新密码格式</span><br><span class="line">    <span class="number">3.</span> 调用: auth_service_-&gt;<span class="built_in">ResetPassword</span>(mobile, verify_code, new_password)</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>


<h2 id="2-用户操作相关服务"><a href="#2-用户操作相关服务" class="headerlink" title="2.用户操作相关服务"></a>2.用户操作相关服务</h2><ul>
<li><strong>注</strong>：这类服务客户端需要将access_token一起发送给服务端，服务端从中解析出用户数据后将其作为参数调用对应接口</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">service UserService &#123;</span><br><span class="line">    <span class="comment">// 当前用户</span></span><br><span class="line">    <span class="function">rpc <span class="title">GetCurrentUser</span><span class="params">(GetCurrentUserRequest)</span> <span class="title">returns</span> <span class="params">(GetCurrentUserResponse)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">UpdateUser</span><span class="params">(UpdateUserRequest)</span> <span class="title">returns</span> <span class="params">(UpdateUserResponse)</span></span>;</span><br><span class="line">    <span class="comment">// 用户已登录，知道旧密码，想改成新密码</span></span><br><span class="line">    <span class="function">rpc <span class="title">ChangePassword</span><span class="params">(ChangePasswordRequest)</span> <span class="title">returns</span> <span class="params">(ChangePasswordResponse)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">DeleteUser</span><span class="params">(DeleteUserRequest)</span> <span class="title">returns</span> <span class="params">(DeleteUserResponse)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 管理员接口</span></span><br><span class="line">    <span class="function">rpc <span class="title">GetUser</span><span class="params">(GetUserRequest)</span> <span class="title">returns</span> <span class="params">(GetUserResponse)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">ListUsers</span><span class="params">(ListUsersRequest)</span> <span class="title">returns</span> <span class="params">(ListUsersResponse)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      用户服务核心流程                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  请求认证（所有需登录接口的前置步骤）                             │</span><br><span class="line">│  ────────────────────────────────                               │</span><br><span class="line">│  Header: Authorization: Bearer &lt;access_token&gt;                   │</span><br><span class="line">│       ↓                                                         │</span><br><span class="line">│  解析 access_token → 验证签名/过期 → 提取 AuthContext           │</span><br><span class="line">│       ↓                                                         │</span><br><span class="line">│  AuthContext &#123; user_id, user_uuid, mobile &#125;                     │</span><br><span class="line">│                                                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  普通用户操作                                                    │</span><br><span class="line">│  ────────────                                                   │</span><br><span class="line">│  GetCurrentUser : token → AuthContext.uuid → 查库 → 返回        │</span><br><span class="line">│  UpdateUser     : token → AuthContext.uuid + 字段 → 校验 → 更新 │</span><br><span class="line">│  ChangePassword : token → AuthContext.uuid + 旧密码 + 新密码    │</span><br><span class="line">│                   → 验证旧密码 → 更新                           │</span><br><span class="line">│  DeleteUser     : token → AuthContext.uuid + 验证码             │</span><br><span class="line">│                   → 验证 → 删Token → 软删除                     │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  管理员操作                                                      │</span><br><span class="line">│  ──────────                                                      │</span><br><span class="line">│  GetUser        : token → 验证管理员权限 → target_uuid → 查库   │</span><br><span class="line">│  ListUsers      : token → 验证管理员权限 → 条件 + 分页 → 查询   │</span><br><span class="line">│  SetUserDisabled: token → 验证管理员权限 → target_uuid + 状态   │</span><br><span class="line">│                   → 更新 → 禁用时删Token                        │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>注意</strong>：具体子类只进行参数校验等，<strong>不实现具体“业务逻辑”</strong>，“业务逻辑”在业务层实现，且与proto完全独立，只需在具体子类中调用对应的“业务逻辑”即可</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 普通用户接口模式</span></span><br><span class="line">::<span class="function">grpc::Status <span class="title">Handler::Method</span><span class="params">(context, request, response)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Method requested&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 认证（必须）</span></span><br><span class="line">    <span class="keyword">auto</span> auth = authenticator_-&gt;<span class="built_in">Authenticate</span>(context);</span><br><span class="line">    <span class="keyword">if</span> (!auth.<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">        <span class="built_in">SetResultError</span>(response-&gt;<span class="built_in">mutable_result</span>(), auth.code, auth.message);</span><br><span class="line">        <span class="keyword">return</span> ::grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValidXxx</span>(...)) &#123; ... &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 调用业务层（使用 auth.user_uuid，不信任客户端传的 user_id）</span></span><br><span class="line">    <span class="keyword">auto</span> result = service_-&gt;<span class="built_in">Method</span>(auth.<span class="built_in">Value</span>().user_uuid, ...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 返回</span></span><br><span class="line">    <span class="built_in">SetResultError</span>(...);</span><br><span class="line">    <span class="keyword">return</span> ::grpc::Status::OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 管理员接口模式</span></span><br><span class="line">::<span class="function">grpc::Status <span class="title">Handler::AdminMethod</span><span class="params">(context, request, response)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;AdminMethod requested&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 认证</span></span><br><span class="line">    <span class="keyword">auto</span> auth = authenticator_-&gt;<span class="built_in">Authenticate</span>(context);</span><br><span class="line">    <span class="keyword">if</span> (!auth.<span class="built_in">IsOk</span>()) &#123; ... &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 权限校验（管理员专属）</span></span><br><span class="line">    <span class="keyword">auto</span> admin_check = <span class="built_in">RequireAdmin</span>(auth.<span class="built_in">Value</span>());</span><br><span class="line">    <span class="keyword">if</span> (!admin_check.<span class="built_in">IsOk</span>()) &#123; ... &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 参数校验</span></span><br><span class="line">    <span class="comment">// 4. 调用业务层（可使用客户端传的 target_id）</span></span><br><span class="line">    <span class="comment">// 5. 返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>定义具体服务类，实现具体方法</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pb_user/user.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;service/user_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth/jwt_service.h&quot;</span>  <span class="comment">// 新增</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;jwt_authenticator.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> user_service &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserHandler</span> <span class="keyword">final</span> : <span class="keyword">public</span> ::pb_user::UserService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">UserHandler</span>(std::shared_ptr&lt;UserService&gt; user_service,</span><br><span class="line">        std::shared_ptr&lt;Authenticator&gt; authenticator);</span><br><span class="line"></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">GetCurrentUser</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> ::pb_user::GetCurrentUserRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   ::pb_user::GetCurrentUserResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">UpdateUser</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">const</span> ::pb_user::UpdateUserRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                               ::pb_user::UpdateUserResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ChangePassword</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> ::pb_user::ChangePasswordRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   ::pb_user::ChangePasswordResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">DeleteUser</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="type">const</span> ::pb_user::DeleteUserRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                               ::pb_user::DeleteUserResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">GetUser</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> ::pb_user::GetUserRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                            ::pb_user::GetUserResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ListUsers</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="type">const</span> ::pb_user::ListUsersRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                              ::pb_user::ListUsersResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;UserService&gt; user_service_;</span><br><span class="line">    std::shared_ptr&lt;Authenticator&gt; authenticator_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace user_service</span></span><br></pre></td></tr></table></figure>


<h3 id="（1）gRPC中access-token的传送与解析"><a href="#（1）gRPC中access-token的传送与解析" class="headerlink" title="（1）gRPC中access_token的传送与解析"></a>（1）gRPC中access_token的传送与解析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// gRPC 请求认证函数</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief 从 gRPC 上下文中验证 Token 并提取用户信息</span></span><br><span class="line"><span class="comment">/// @details</span></span><br><span class="line"><span class="comment">///   ┌────────────────────────────────────────────────────────────────┐</span></span><br><span class="line"><span class="comment">///   │  认证流程                                                      │</span></span><br><span class="line"><span class="comment">///   ├────────────────────────────────────────────────────────────────┤</span></span><br><span class="line"><span class="comment">///   │  Client Request                                                │</span></span><br><span class="line"><span class="comment">///   │       │                                                        │</span></span><br><span class="line"><span class="comment">///   │       ▼                                                        │</span></span><br><span class="line"><span class="comment">///   │  ┌─────────────────────────────────────────┐                   │</span></span><br><span class="line"><span class="comment">///   │  │ HTTP Header                             │                   │</span></span><br><span class="line"><span class="comment">///   │  │ Authorization: Bearer eyJhbGciOi...     │                   │</span></span><br><span class="line"><span class="comment">///   │  └─────────────────────────────────────────┘                   │</span></span><br><span class="line"><span class="comment">///   │       │                                                        │</span></span><br><span class="line"><span class="comment">///   │       ▼                                                        │</span></span><br><span class="line"><span class="comment">///   │  1. 提取 metadata 中的 &quot;authorization&quot;                         │</span></span><br><span class="line"><span class="comment">///   │       │                                                        │</span></span><br><span class="line"><span class="comment">///   │       ▼                                                        │</span></span><br><span class="line"><span class="comment">///   │  2. 验证格式：&quot;Bearer &quot; + token                                │</span></span><br><span class="line"><span class="comment">///   │       │                                                        │</span></span><br><span class="line"><span class="comment">///   │       ▼                                                        │</span></span><br><span class="line"><span class="comment">///   │  3. 调用 JwtService::VerifyAccessToken 验证签名和有效期        │</span></span><br><span class="line"><span class="comment">///   │       │                                                        │</span></span><br><span class="line"><span class="comment">///   │       ▼                                                        │</span></span><br><span class="line"><span class="comment">///   │  4. 返回 AuthContext（user_id, user_uuid, mobile）            │</span></span><br><span class="line"><span class="comment">///   └────────────────────────────────────────────────────────────────┘</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">///   gRPC Metadata 说明：</span></span><br><span class="line"><span class="comment">///   - gRPC 的 metadata 等同于 HTTP/2 的 headers</span></span><br><span class="line"><span class="comment">///   - 客户端设置：metadata.insert(&#123;&quot;authorization&quot;, &quot;Bearer xxx&quot;&#125;)</span></span><br><span class="line"><span class="comment">///   - 服务端读取：context-&gt;client_metadata()</span></span><br><span class="line"><span class="comment">///   - key 全部小写（gRPC 规范）</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="function">Result&lt;AuthContext&gt; <span class="title">Authenticate</span><span class="params">(::grpc::ServerContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> metadata = context-&gt;<span class="built_in">client_metadata</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = metadata.<span class="built_in">find</span>(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (it == metadata.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result&lt;AuthContext&gt;::<span class="built_in">Fail</span>(ErrorCode::Unauthenticated, <span class="string">&quot;缺少认证信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string <span class="title">auth_header</span><span class="params">(it-&gt;second.data(), it-&gt;second.size())</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> std::string prefix = <span class="string">&quot;Bearer &quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (auth_header.<span class="built_in">rfind</span>(prefix, <span class="number">0</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result&lt;AuthContext&gt;::<span class="built_in">Fail</span>(ErrorCode::Unauthenticated, <span class="string">&quot;认证格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::string token = auth_header.<span class="built_in">substr</span>(prefix.<span class="built_in">length</span>());</span><br><span class="line">    <span class="keyword">if</span> (token.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result&lt;AuthContext&gt;::<span class="built_in">Fail</span>(ErrorCode::Unauthenticated, <span class="string">&quot;Token 不能为空&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> verify_result = jwt_service_-&gt;<span class="built_in">VerifyAccessToken</span>(token);</span><br><span class="line">    <span class="keyword">if</span> (!verify_result.<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Result&lt;AuthContext&gt;::<span class="built_in">Fail</span>(verify_result.code, verify_result.message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span>&amp; payload = verify_result.<span class="built_in">Value</span>();</span><br><span class="line">    AuthContext auth_ctx;</span><br><span class="line">    auth_ctx.user_id = payload.user_id;</span><br><span class="line">    auth_ctx.user_uuid = payload.user_uuid;</span><br><span class="line">    auth_ctx.mobile = payload.mobile;</span><br><span class="line">    auth_ctx.role = payload.role;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Result&lt;AuthContext&gt;::<span class="built_in">Ok</span>(auth_ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）获取当前用户"><a href="#（2）获取当前用户" class="headerlink" title="（2）获取当前用户"></a>（2）获取当前用户</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetCurrentUser</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: DEBUG</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context) ——&gt; 从access_token中解析出用户信息</span><br><span class="line">       - 失败 → 返回错误</span><br><span class="line">    <span class="number">3.</span> 调用: user_service_-&gt;<span class="built_in">GetCurrentUser</span>(auth.user_uuid)</span><br><span class="line">       └─ user_uuid 来自 Token，非客户端传参</span><br><span class="line">    <span class="number">4.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: <span class="built_in">ToProtoUser</span>(user)</span><br><span class="line">    <span class="number">5.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（3）更新用户信息"><a href="#（3）更新用户信息" class="headerlink" title="（3）更新用户信息"></a>（3）更新用户信息</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UpdateUser</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: DEBUG</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context)</span><br><span class="line">    <span class="number">3.</span> 提取可选字段:</span><br><span class="line">       - request.<span class="built_in">has_display_name</span>() → display_name</span><br><span class="line">    <span class="number">4.</span> 调用: user_service_-&gt;<span class="built_in">UpdateUser</span>(auth.user_uuid, display_name)</span><br><span class="line">       └─ user_uuid 来自 Token</span><br><span class="line">    <span class="number">5.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: <span class="built_in">ToProtoUser</span>(user)</span><br><span class="line">    <span class="number">6.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（4）修改密码"><a href="#（4）修改密码" class="headerlink" title="（4）修改密码"></a>（4）修改密码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ChangePassword</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: INFO</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context)</span><br><span class="line">    <span class="number">3.</span> 参数校验:</span><br><span class="line">       - 旧密码非空</span><br><span class="line">       - 新密码非空</span><br><span class="line">       - 新密码格式校验</span><br><span class="line">    <span class="number">4.</span> 调用: user_service_-&gt;<span class="built_in">ChangePassword</span>(</span><br><span class="line">              auth.user_uuid,    ← 来自 Token</span><br><span class="line">              old_password,</span><br><span class="line">              new_password</span><br><span class="line">           )</span><br><span class="line">    <span class="number">5.</span> 响应: 设置 result</span><br><span class="line">    <span class="number">6.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（5）删除用户（注销账号）"><a href="#（5）删除用户（注销账号）" class="headerlink" title="（5）删除用户（注销账号）"></a>（5）删除用户（注销账号）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DeleteUser</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: INFO</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context)</span><br><span class="line">    <span class="number">3.</span> 参数校验:</span><br><span class="line">       - 验证码格式</span><br><span class="line">    <span class="number">4.</span> 调用: user_service_-&gt;<span class="built_in">DeleteUser</span>(</span><br><span class="line">              auth.user_uuid,    ← 来自 Token（只能删自己）</span><br><span class="line">              verify_code</span><br><span class="line">           )</span><br><span class="line">    <span class="number">5.</span> 响应: 设置 result</span><br><span class="line">    <span class="number">6.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（6）获取指定用户（管理员接口）"><a href="#（6）获取指定用户（管理员接口）" class="headerlink" title="（6）获取指定用户（管理员接口）"></a>（6）获取指定用户（管理员接口）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetUser</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: INFO, 打印 request.id</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context)</span><br><span class="line">    <span class="number">3.</span> 权限校验: <span class="built_in">RequireAdmin</span>(auth)</span><br><span class="line">       └─ 非管理员 → 返回<span class="string">&quot;需要管理员权限&quot;</span></span><br><span class="line">    <span class="number">4.</span> 参数校验:</span><br><span class="line">       - target_id 非空</span><br><span class="line">    <span class="number">5.</span> 调用: user_service_-&gt;<span class="built_in">GetUser</span>(request.id)</span><br><span class="line">       └─ 这里用客户端传的 id（管理员查任意用户）</span><br><span class="line">    <span class="number">6.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时: <span class="built_in">ToProtoUser</span>(user)</span><br><span class="line">    <span class="number">7.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h3 id="（7）获取用户列表（管理员接口）"><a href="#（7）获取用户列表（管理员接口）" class="headerlink" title="（7）获取用户列表（管理员接口）"></a>（7）获取用户列表（管理员接口）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ListUsers</span>(context, request, response):</span><br><span class="line">    <span class="number">1.</span> 日志: INFO</span><br><span class="line">    <span class="number">2.</span> 认证: authenticator_-&gt;<span class="built_in">Authenticate</span>(context)</span><br><span class="line">    <span class="number">3.</span> 权限校验: <span class="built_in">RequireAdmin</span>(auth)</span><br><span class="line">    <span class="number">4.</span> 提取参数:</span><br><span class="line">       - page = request.page.page ?? <span class="number">1</span></span><br><span class="line">       - page_size = request.page.page_size ?? <span class="number">20</span></span><br><span class="line">       - mobile_filter = request.mobile_filter（可选）</span><br><span class="line">       - disabled_filter = request.disabled_filter（可选）</span><br><span class="line">    <span class="number">5.</span> 调用: user_service_-&gt;<span class="built_in">ListUsers</span>(</span><br><span class="line">              mobile_filter,</span><br><span class="line">              disabled_filter,</span><br><span class="line">              page,</span><br><span class="line">              page_size</span><br><span class="line">           )</span><br><span class="line">    <span class="number">6.</span> 响应:</span><br><span class="line">       - 设置 result</span><br><span class="line">       - 成功时:</span><br><span class="line">         - 遍历 users → ToProtoUser → response.<span class="built_in">add_users</span>()</span><br><span class="line">         - 设置 <span class="built_in">page_info</span> (total_records, total_pages, page, page_size)</span><br><span class="line">    <span class="number">7.</span> <span class="keyword">return</span> grpc::Status::OK</span><br></pre></td></tr></table></figure>

<h2 id="2-错误码"><a href="#2-错误码" class="headerlink" title="2.错误码"></a>2.错误码</h2><ul>
<li>gRPC的错误码主要是用于网络等错误，而不是业务错误，所以我们需要自定义业务错误码<ul>
<li>gRPC错误主要与服务调用是否成功相关，与业务无关</li>
<li>业务错误码主要与业务相关</li>
</ul>
</li>
<li>只要gRPC服务调用成功，不管最后执行是否成功，都统一返回::grpc::Status::OK</li>
<li>在服务方法的返回值中增加result（错误码+错误信息），方便返回给客户端业务错误信息</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package pb_common;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误码 - 与内部 C++ ErrorCode 保持一致</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ErrorCode</span> &#123;</span><br><span class="line">    <span class="comment">// ========== 成功 ==========</span></span><br><span class="line">    OK = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 通用错误（100~999） ====================</span></span><br><span class="line">    <span class="comment">// 系统错误（1xx）</span></span><br><span class="line">    UNKNOWN             = <span class="number">100</span>;  <span class="comment">// 未知错误</span></span><br><span class="line">    INTERNAL            = <span class="number">101</span>;  <span class="comment">// 内部服务器异常</span></span><br><span class="line">    NOT_IMPLEMENTED     = <span class="number">102</span>;  <span class="comment">// 功能未实现</span></span><br><span class="line">    SERVICE_UNAVAILABLE = <span class="number">103</span>;  <span class="comment">// 服务不可用</span></span><br><span class="line">    TIMEOUT             = <span class="number">104</span>;  <span class="comment">// 请求超时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数错误（2xx）</span></span><br><span class="line">    INVALID_ARGUMENT    = <span class="number">200</span>;  <span class="comment">// 参数无效</span></span><br><span class="line">    INVALID_PAGE        = <span class="number">210</span>;  <span class="comment">// 无效的分页参数</span></span><br><span class="line">    INVALID_PAGE_SIZE   = <span class="number">211</span>;  <span class="comment">// 无效的分页大小</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限流（3xx）</span></span><br><span class="line">    RATE_LIMITED        = <span class="number">300</span>;  <span class="comment">// 请求过于频繁</span></span><br><span class="line">    QUOTA_EXCEEDED      = <span class="number">301</span>;  <span class="comment">// 配额超限</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 认证错误（1000~1999） ====================</span></span><br><span class="line">    <span class="comment">// Token 相关（100x）</span></span><br><span class="line">    UNAUTHENTICATED     = <span class="number">1000</span>; <span class="comment">// 未认证（通用）</span></span><br><span class="line">    TOKEN_MISSING       = <span class="number">1001</span>; <span class="comment">// Token 缺失</span></span><br><span class="line">    TOKEN_INVALID       = <span class="number">1002</span>; <span class="comment">// Token 无效</span></span><br><span class="line">    TOKEN_EXPIRED       = <span class="number">1003</span>; <span class="comment">// Token 已过期</span></span><br><span class="line">    TOKEN_REVOKED       = <span class="number">1004</span>; <span class="comment">// Token 已注销</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录相关（101x~102x）</span></span><br><span class="line">    LOGIN_FAILED        = <span class="number">1010</span>; <span class="comment">// 登录失败（通用）</span></span><br><span class="line">    WRONG_PASSWORD      = <span class="number">1011</span>; <span class="comment">// 密码错误</span></span><br><span class="line">    ACCOUNT_LOCKED      = <span class="number">1012</span>; <span class="comment">// 账号已锁定（多次密码错误）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码相关（102x）</span></span><br><span class="line">    CAPTCHA_WRONG       = <span class="number">1021</span>; <span class="comment">// 验证码错误</span></span><br><span class="line">    CAPTCHA_EXPIRED     = <span class="number">1022</span>; <span class="comment">// 验证码已过期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 用户错误（2000~2999） ====================</span></span><br><span class="line">    <span class="comment">// 用户查询（200x）</span></span><br><span class="line">    USER_NOT_FOUND      = <span class="number">2000</span>; <span class="comment">// 用户不存在</span></span><br><span class="line">    USER_DELETED        = <span class="number">2001</span>; <span class="comment">// 用户已删除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户创建（201x）</span></span><br><span class="line">    USER_ALREADY_EXISTS = <span class="number">2010</span>; <span class="comment">// 用户已存在（通用）</span></span><br><span class="line">    MOBILE_TAKEN        = <span class="number">2013</span>; <span class="comment">// 手机号已被占用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户状态（202x）</span></span><br><span class="line">    USER_DISABLED       = <span class="number">2020</span>; <span class="comment">// 用户已禁用</span></span><br><span class="line">    USER_NOT_VERIFIED   = <span class="number">2021</span>; <span class="comment">// 用户未验证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 权限错误（3000~3999） ====================</span></span><br><span class="line">    PERMISSION_DENIED   = <span class="number">3000</span>; <span class="comment">// 无权限（通用）</span></span><br><span class="line">    ADMIN_REQUIRED      = <span class="number">3001</span>; <span class="comment">// 需要管理员权限</span></span><br><span class="line">    OWNER_REQUIRED      = <span class="number">3002</span>; <span class="comment">// 需要是资源所有者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message Result &#123;</span><br><span class="line">    ErrorCode code              = <span class="number">1</span>;</span><br><span class="line">    string    msg               = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== 获取用户信息 ====================</span></span><br><span class="line"></span><br><span class="line">message GetCurrentUserRequest &#123;</span><br><span class="line">    <span class="comment">// 无参数，从 Token 中获取 user_id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message GetCurrentUserResponse &#123;</span><br><span class="line">    pb_common.Result result = <span class="number">1</span>;    <span class="comment">// ⚠️ 业务错误码+错误信息</span></span><br><span class="line">    User user = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message GetUserRequest &#123;</span><br><span class="line">    string id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message GetUserResponse &#123;</span><br><span class="line">    pb_common.Result result = <span class="number">1</span>;    <span class="comment">// ⚠️ 业务错误码+错误信息</span></span><br><span class="line">    User user = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="三、基础服务层与业务层"><a href="#三、基础服务层与业务层" class="headerlink" title="三、基础服务层与业务层"></a>三、基础服务层与业务层</h1><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203223314119.png"></p>
<h2 id="1-基础服务层"><a href="#1-基础服务层" class="headerlink" title="1.基础服务层"></a>1.基础服务层</h2><ul>
<li>对第三方库的业务封装，工具函数、工具类的定义等，使用的是<a href="/2026/01/19/C++/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93/%E5%BC%82%E5%B8%B8%E7%9A%84%E6%8A%9B%E5%87%BA%E4%B8%8E%E5%A4%84%E7%90%86/" title="异常的抛出与处理">异常处理三层模型</a><ul>
<li>捕捉异常后进行日志输出，尽量不在上抛异常</li>
<li>以Result作为返回值，代替异常的作用<br><strong>对redis++的封装</strong></li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sw/redis++/redis++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;config/config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common/result.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> user_service &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// Redis 客户端</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// 设计原则：</span></span><br><span class="line"><span class="comment">//   - 使用 Result&lt;T&gt; 区分&quot;执行失败&quot;与&quot;数据不存在&quot;</span></span><br><span class="line"><span class="comment">//   - 所有操作都是 noexcept，通过 Result 返回错误信息</span></span><br><span class="line"><span class="comment">//   - Result 成功 + optional 无值 = key 不存在（正常业务情况）</span></span><br><span class="line"><span class="comment">//   - Result 失败 = Redis 执行出错（网络/超时等）</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 使用示例：</span></span><br><span class="line"><span class="comment">//   auto result = redis-&gt;Get(&quot;user:123&quot;);</span></span><br><span class="line"><span class="comment">//   if (!result.IsOk()) &#123;</span></span><br><span class="line"><span class="comment">//       // Redis 执行失败</span></span><br><span class="line"><span class="comment">//       LOG_ERROR(&quot;Redis error: &#123;&#125;&quot;, result.message);</span></span><br><span class="line"><span class="comment">//   &#125; else if (result.Value().has_value()) &#123;</span></span><br><span class="line"><span class="comment">//       // Key 存在，获取到值</span></span><br><span class="line"><span class="comment">//       auto&amp; value = result.Value().value();</span></span><br><span class="line"><span class="comment">//   &#125; else &#123;</span></span><br><span class="line"><span class="comment">//       // Key 不存在（正常情况）</span></span><br><span class="line"><span class="comment">//   &#125;</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisClient</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">/// @brief 构造函数（详细参数版本）</span></span><br><span class="line">    <span class="built_in">RedisClient</span>(<span class="type">const</span> std::string&amp; host, <span class="type">int</span> port,</span><br><span class="line">                <span class="type">const</span> std::string&amp; password, <span class="type">int</span> db);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 构造函数（配置结构体版本）</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">RedisClient</span><span class="params">(<span class="type">const</span> RedisConfig&amp; config)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">RedisClient</span>()=<span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 字符串操作 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 设置键值对（无过期时间）</span></span><br><span class="line">    <span class="comment">/// @return 成功返回 Ok，失败返回错误信息</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">Set</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 设置键值对 + 过期时间（毫秒）</span></span><br><span class="line">    <span class="comment">/// @param ttl 过期时间（毫秒），必须 &gt; 0</span></span><br><span class="line">    <span class="comment">/// @return 成功返回 Ok，失败返回错误信息</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">SetPx</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value,</span></span></span><br><span class="line"><span class="params"><span class="function">                       std::chrono::milliseconds ttl)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 获取值</span></span><br><span class="line">    <span class="comment">/// @return 成功+有值=存在，成功+无值=不存在，失败=Redis错误</span></span><br><span class="line">    <span class="keyword">virtual</span> Result&lt;std::optional&lt;std::string&gt;&gt; <span class="built_in">Get</span>(<span class="type">const</span> std::string&amp; key) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 仅当 key 不存在时设置（分布式锁常用）</span></span><br><span class="line">    <span class="comment">/// @return 成功时 bool 表示是否设置成功（true=设置了，false=key已存在）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">SetNx</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief SETNX + PEXPIRE 原子操作（分布式锁推荐）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">SetNxPx</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value,</span></span></span><br><span class="line"><span class="params"><span class="function">                         std::chrono::milliseconds ttl)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 通用操作 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 判断键是否存在</span></span><br><span class="line">    <span class="comment">/// @return 成功时 bool 表示是否存在</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">Exists</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 删除键</span></span><br><span class="line">    <span class="comment">/// @return 成功时 bool 表示是否真的删除了（false=key本不存在）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">Del</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 设置键的过期时间（毫秒）</span></span><br><span class="line">    <span class="comment">/// @return 成功时 bool 表示是否设置成功（false=key不存在）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">PExpire</span><span class="params">(<span class="type">const</span> std::string&amp; key, std::chrono::milliseconds ttl)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 获取键的剩余过期时间（毫秒）</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回 int64_t：&gt;0=剩余毫秒，-1=无过期时间，-2=key不存在</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">int64_t</span>&gt; <span class="title">PTTL</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 获取匹配的所有 Key（KEYS 命令）——&gt;（开发调试）</span></span><br><span class="line">    <span class="comment">/// @param pattern 匹配模式，如 &quot;user:*&quot;、&quot;sms:code:*&quot; 等</span></span><br><span class="line">    <span class="comment">/// @warning 生产环境慎用！大数据量时会阻塞 Redis</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回匹配的 key 列表</span></span><br><span class="line">    <span class="keyword">virtual</span> Result&lt;std::vector&lt;std::string&gt;&gt; <span class="built_in">Keys</span>(<span class="type">const</span> std::string&amp; pattern) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 增量迭代获取 Key（SCAN 命令，推荐）</span></span><br><span class="line">    <span class="comment">/// @param pattern 匹配模式</span></span><br><span class="line">    <span class="comment">/// @param count 每次迭代建议返回的数量（仅为提示，实际可能不同）</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回匹配的 key 列表</span></span><br><span class="line">    <span class="keyword">virtual</span> Result&lt;std::vector&lt;std::string&gt;&gt; <span class="built_in">Scan</span>(<span class="type">const</span> std::string&amp; pattern, </span><br><span class="line">                                          <span class="type">int64_t</span> count = <span class="number">100</span>) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== Hash 操作 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 设置 Hash 字段</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">HSet</span><span class="params">(<span class="type">const</span> std::string&amp; key, </span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::string&amp; field,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::string&amp; value)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 批量设置 Hash 字段</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">HMSet</span><span class="params">(<span class="type">const</span> std::string&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> std::vector&lt;std::pair&lt;std::string, std::string&gt;&gt;&amp; fields)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 获取 Hash 字段值</span></span><br><span class="line">    <span class="comment">/// @return 成功+有值=存在，成功+无值=字段不存在</span></span><br><span class="line">    <span class="keyword">virtual</span> Result&lt;std::optional&lt;std::string&gt;&gt; <span class="built_in">HGet</span>(<span class="type">const</span> std::string&amp; key,</span><br><span class="line">                                            <span class="type">const</span> std::string&amp; field) <span class="keyword">noexcept</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 获取 Hash 所有字段</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回 map（key不存在时为空map，这是正常情况）</span></span><br><span class="line">    <span class="keyword">virtual</span> Result&lt;std::unordered_map&lt;std::string, std::string&gt;&gt; <span class="built_in">HGetAll</span>(<span class="type">const</span> std::string&amp; key) <span class="keyword">noexcept</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 删除 Hash 字段</span></span><br><span class="line">    <span class="comment">/// @return 成功时 bool 表示是否真的删除了</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">HDel</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; field)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 判断 Hash 字段是否存在</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">bool</span>&gt; <span class="title">HExists</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; field)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 原子操作 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 自增 1（key不存在时从0开始）</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回自增后的值</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">int64_t</span>&gt; <span class="title">Incr</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief 自增指定值（可为负数）</span></span><br><span class="line">    <span class="comment">/// @return 成功时返回自增后的值</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">int64_t</span>&gt; <span class="title">IncrBy</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">int64_t</span> increment)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 自减 1</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">int64_t</span>&gt; <span class="title">Decr</span><span class="params">(<span class="type">const</span> std::string&amp; key)</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 健康检查 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/// @brief Ping 测试连接</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">Ping</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;sw::redis::Redis&gt; redis_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace user_service</span></span><br></pre></td></tr></table></figure>

<h2 id="2-业务层"><a href="#2-业务层" class="headerlink" title="2.业务层"></a>2.业务层</h2><h3 id="（1）业务层与proto完全独立"><a href="#（1）业务层与proto完全独立" class="headerlink" title="（1）业务层与proto完全独立"></a>（1）业务层与proto完全独立</h3><ul>
<li>业务层应该与proto生成的一切完全独立，不依赖与proto生成的C++代码，避免紧耦合<ul>
<li>能够独立开发，且proto的变化不会影响业务层代码，代码结果更加清晰，易于维护</li>
</ul>
</li>
</ul>
<h4 id="自定义枚举、实体"><a href="#自定义枚举、实体" class="headerlink" title="&lt;1&gt;自定义枚举、实体"></a>&lt;1&gt;自定义枚举、实体</h4><ul>
<li>即使proto中定义了枚举、实体，业务层也不应该使用，应该自己独自定义类似的枚举与实体<ul>
<li>实现 proto实体 &lt;——&gt; 业务层实体  的转换函数即可</li>
</ul>
</li>
</ul>
<h5 id="1）proto"><a href="#1）proto" class="headerlink" title="1）proto"></a>1）proto</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 短信验证码使用场景</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">SmsScene</span> &#123;</span><br><span class="line">    SMS_SCENE_UNKNOWN = <span class="number">0</span>;       <span class="comment">// 未知场景（默认值，禁止业务使用）</span></span><br><span class="line">    SMS_SCENE_REGISTER = <span class="number">1</span>;      <span class="comment">// 注册场景</span></span><br><span class="line">    SMS_SCENE_LOGIN = <span class="number">2</span>;         <span class="comment">// 登录场景</span></span><br><span class="line">    SMS_SCENE_RESET_PASSWORD = <span class="number">3</span>;<span class="comment">// 重置密码</span></span><br><span class="line">    SMS_SCENE_DELETE_USER = <span class="number">4</span>;   <span class="comment">// 注销账号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户核心信息体</span></span><br><span class="line">message UserInfo &#123;</span><br><span class="line">    string id = <span class="number">1</span>;                              <span class="comment">// 用户UUID</span></span><br><span class="line">    string mobile = <span class="number">2</span>;                          <span class="comment">// 手机号</span></span><br><span class="line">    string display_name = <span class="number">3</span>;                    <span class="comment">// 昵称</span></span><br><span class="line">    UserRole role = <span class="number">4</span>;                          <span class="comment">// 用户角色（改为枚举类型）</span></span><br><span class="line">    <span class="type">bool</span> disabled = <span class="number">5</span>;                          <span class="comment">// 是否禁用</span></span><br><span class="line">    google.protobuf.Timestamp created_at = <span class="number">6</span>;   <span class="comment">// 创建时间</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2）业务层"><a href="#2）业务层" class="headerlink" title="2）业务层"></a>2）业务层</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief 验证码场景</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">SmsScene</span> &#123;</span><br><span class="line">    UnKnow = <span class="number">0</span>,         <span class="comment">// 未指定场景（默认值，用于参数校验，非法场景）</span></span><br><span class="line">    Register = <span class="number">1</span>,       <span class="comment">// 注册场景 - 新用户账号注册验证</span></span><br><span class="line">    Login = <span class="number">2</span>,          <span class="comment">// 登录场景 - 账号短信登录/验证登录</span></span><br><span class="line">    ResetPassword = <span class="number">3</span>,  <span class="comment">// 重置密码场景 - 忘记密码/账号密码重置</span></span><br><span class="line">    DeleteUser =<span class="number">4</span>       <span class="comment">// 删除用户</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">UserEntity</span> &#123;</span><br><span class="line">    <span class="type">int64_t</span> id = <span class="number">0</span>;</span><br><span class="line">    std::string uuid;</span><br><span class="line">    std::string mobile;</span><br><span class="line">    std::string display_name;</span><br><span class="line">    std::string password_hash;</span><br><span class="line">    UserRole role = UserRole::User;</span><br><span class="line">    <span class="type">bool</span> disabled = <span class="literal">false</span>;</span><br><span class="line">    std::string created_at;</span><br><span class="line">    std::string updated_at;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="3）转换函数"><a href="#3）转换函数" class="headerlink" title="3）转换函数"></a>3）转换函数</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// SmsScene 枚举转换</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief 业务层 SmsScene → Proto SmsScene</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> pb_auth::SmsScene <span class="title">ToProtoSmsScene</span><span class="params">(SmsScene scene)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (scene) &#123;</span><br><span class="line">        <span class="keyword">case</span> SmsScene::Register:      <span class="keyword">return</span> pb_auth::SmsScene::SMS_SCENE_REGISTER;</span><br><span class="line">        <span class="keyword">case</span> SmsScene::Login:         <span class="keyword">return</span> pb_auth::SmsScene::SMS_SCENE_LOGIN;</span><br><span class="line">        <span class="keyword">case</span> SmsScene::ResetPassword: <span class="keyword">return</span> pb_auth::SmsScene::SMS_SCENE_RESET_PASSWORD;</span><br><span class="line">        <span class="keyword">case</span> SmsScene::DeleteUser:    <span class="keyword">return</span> pb_auth::SmsScene::SMS_SCENE_DELETE_USER;</span><br><span class="line">        <span class="keyword">default</span>:                      <span class="keyword">return</span> pb_auth::SmsScene::SMS_SCENE_UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief Proto SmsScene → 业务层 SmsScene</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> SmsScene <span class="title">FromProtoSmsScene</span><span class="params">(pb_auth::SmsScene scene)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (scene) &#123;</span><br><span class="line">        <span class="keyword">case</span> pb_auth::SmsScene::SMS_SCENE_REGISTER:       <span class="keyword">return</span> SmsScene::Register;</span><br><span class="line">        <span class="keyword">case</span> pb_auth::SmsScene::SMS_SCENE_LOGIN:          <span class="keyword">return</span> SmsScene::Login;</span><br><span class="line">        <span class="keyword">case</span> pb_auth::SmsScene::SMS_SCENE_RESET_PASSWORD: <span class="keyword">return</span> SmsScene::ResetPassword;</span><br><span class="line">        <span class="keyword">case</span> pb_auth::SmsScene::SMS_SCENE_DELETE_USER:    <span class="keyword">return</span> SmsScene::DeleteUser;</span><br><span class="line">        <span class="keyword">default</span>:                                          <span class="keyword">return</span> SmsScene::UnKnow;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// UserEntity 转换</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief UserEntity → pb_auth::UserInfo（登录/注册返回用）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ToProtoUserInfo</span><span class="params">(<span class="type">const</span> UserEntity&amp; src, pb_auth::UserInfo* dst)</span> </span>&#123;</span><br><span class="line">    dst-&gt;<span class="built_in">set_id</span>(src.uuid);</span><br><span class="line">    dst-&gt;<span class="built_in">set_mobile</span>(src.mobile);</span><br><span class="line">    dst-&gt;<span class="built_in">set_display_name</span>(src.display_name);</span><br><span class="line">    dst-&gt;<span class="built_in">set_role</span>(<span class="built_in">ToProtoUserRole</span>(src.role));</span><br><span class="line">    dst-&gt;<span class="built_in">set_disabled</span>(src.disabled);</span><br><span class="line">    *dst-&gt;<span class="built_in">mutable_created_at</span>() = <span class="built_in">ToProtoTimestamp</span>(src.created_at);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief UserEntity → pb_user::User（完整用户信息）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ToProtoUser</span><span class="params">(<span class="type">const</span> UserEntity&amp; src, pb_user::User* dst)</span> </span>&#123;</span><br><span class="line">    dst-&gt;<span class="built_in">set_id</span>(src.uuid);</span><br><span class="line">    dst-&gt;<span class="built_in">set_mobile</span>(src.mobile);</span><br><span class="line">    dst-&gt;<span class="built_in">set_display_name</span>(src.display_name);</span><br><span class="line">    dst-&gt;<span class="built_in">set_role</span>(<span class="built_in">ToProtoUserRole</span>(src.role));</span><br><span class="line">    dst-&gt;<span class="built_in">set_disabled</span>(src.disabled);</span><br><span class="line">    *dst-&gt;<span class="built_in">mutable_created_at</span>() = <span class="built_in">ToProtoTimestamp</span>(src.created_at);</span><br><span class="line">    *dst-&gt;<span class="built_in">mutable_updated_at</span>() = <span class="built_in">ToProtoTimestamp</span>(src.updated_at);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief pb_user::User → UserEntity（部分字段，用于更新）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> UserEntity <span class="title">FromProtoUser</span><span class="params">(<span class="type">const</span> pb_user::User&amp; src)</span> </span>&#123;</span><br><span class="line">    UserEntity entity;</span><br><span class="line">    entity.uuid = src.<span class="built_in">id</span>();</span><br><span class="line">    entity.mobile = src.<span class="built_in">mobile</span>();</span><br><span class="line">    entity.display_name = src.<span class="built_in">display_name</span>();</span><br><span class="line">    entity.role = <span class="built_in">FromProtoUserRole</span>(src.<span class="built_in">role</span>());</span><br><span class="line">    entity.disabled = src.<span class="built_in">disabled</span>();</span><br><span class="line">    entity.created_at = <span class="built_in">FromProtoTimestamp</span>(src.<span class="built_in">created_at</span>());</span><br><span class="line">    entity.updated_at = <span class="built_in">FromProtoTimestamp</span>(src.<span class="built_in">updated_at</span>());</span><br><span class="line">    <span class="keyword">return</span> entity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="业务类独立"><a href="#业务类独立" class="headerlink" title="&lt;2&gt;业务类独立"></a>&lt;2&gt;业务类独立</h4><ul>
<li>在业务类实现proto中“服务的方法”功能，但要与proto完全独立，proto的具体类通过业务类调用对应的业务API处理业务</li>
</ul>
<h5 id="1）proto的具体类"><a href="#1）proto的具体类" class="headerlink" title="1）proto的具体类"></a>1）proto的具体类</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// auth_handler.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pb_auth/auth.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;service/auth_service.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> user_service &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前向声明</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthService</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthHandler</span> <span class="keyword">final</span> : <span class="keyword">public</span> ::pb_auth::AuthService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">AuthHandler</span><span class="params">(std::shared_ptr&lt;AuthService&gt; auth_service)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">SendVerifyCode</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">const</span> ::pb_auth::SendVerifyCodeRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                   ::pb_auth::SendVerifyCodeResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">Register</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> ::pb_auth::RegisterRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                            ::pb_auth::RegisterResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 登录</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">LoginByPassword</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> ::pb_auth::LoginByPasswordRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                    ::pb_auth::LoginByPasswordResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">LoginByCode</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> ::pb_auth::LoginByCodeRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                ::pb_auth::LoginByCodeResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Token 管理</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">RefreshToken</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="type">const</span> ::pb_auth::RefreshTokenRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                 ::pb_auth::RefreshTokenResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">Logout</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="type">const</span> ::pb_auth::LogoutRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                          ::pb_auth::LogoutResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 密码</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ResetPassword</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> ::pb_auth::ResetPasswordRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  ::pb_auth::ResetPasswordResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内部验证</span></span><br><span class="line">    ::<span class="function">grpc::Status <span class="title">ValidateToken</span><span class="params">(::grpc::ServerContext* context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> ::pb_auth::ValidateTokenRequest* request, </span></span></span><br><span class="line"><span class="params"><span class="function">                                  ::pb_auth::ValidateTokenResponse* response)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::shared_ptr&lt;AuthService&gt; auth_service_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace user_service</span></span><br></pre></td></tr></table></figure>

<h5 id="2）业务类"><a href="#2）业务类" class="headerlink" title="2）业务类"></a>2）业务类</h5><ul>
<li>使用的都是自定义的枚举、实体等</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//auth_service.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common/result.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;entity/user_entity.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;db/user_db.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth/token_repository.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth/jwt_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth/sms_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;common/auth_type.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cache/redis_client.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;config/config.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> user_service &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @brief 认证服务类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthService</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">AuthService</span>(std::shared_ptr&lt;Config&gt; config,</span><br><span class="line">                std::shared_ptr&lt;UserDB&gt; user_db,</span><br><span class="line">                std::shared_ptr&lt;RedisClient&gt; redis_cli,</span><br><span class="line">                std::shared_ptr&lt;TokenRepository&gt; token_repo,</span><br><span class="line">                std::shared_ptr&lt;JwtService&gt; jwt_srv,</span><br><span class="line">                std::shared_ptr&lt;SmsService&gt; sms_srv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">AuthService</span>()=<span class="keyword">default</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送验证码</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">int32_t</span>&gt; <span class="title">SendVerifyCode</span><span class="params">(<span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    SmsScene scene)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;AuthResult&gt; <span class="title">Register</span><span class="params">(<span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> std::string&amp; verify_code,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> std::string&amp; password,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> std::string&amp; display_name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;AuthResult&gt; <span class="title">LoginByPassword</span><span class="params">(<span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="type">const</span> std::string&amp; password)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;AuthResult&gt; <span class="title">LoginByCode</span><span class="params">(<span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> std::string&amp; verify_code)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重置密码</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">ResetPassword</span><span class="params">(<span class="type">const</span> std::string&amp; mobile,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> std::string&amp; verify_code,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">const</span> std::string&amp; new_password)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Token 管理</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;TokenPair&gt; <span class="title">RefreshToken</span><span class="params">(<span class="type">const</span> std::string&amp; refresh_token)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">Logout</span><span class="params">(<span class="type">const</span> std::string&amp; refresh_token)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;<span class="type">void</span>&gt; <span class="title">LogoutAll</span><span class="params">(<span class="type">const</span> std::string&amp; user_uuid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @brief 验证 Access Token 有效性（供其他微服务调用）</span></span><br><span class="line">    <span class="comment">/// @param access_token 待验证的访问令牌</span></span><br><span class="line">    <span class="comment">/// @return TokenValidation 包含有效性、用户ID、过期时间</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> Result&lt;TokenValidationResult&gt; <span class="title">ValidateAccessToken</span><span class="params">(<span class="type">const</span> std::string&amp; access_token)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 检查登录失败次数（超过最大次数将被锁定）</span></span><br><span class="line">    <span class="function">Result&lt;<span class="type">void</span>&gt; <span class="title">CheckLoginFailedAttempts</span><span class="params">(<span class="type">const</span> std::string&amp; mobile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录登录失败</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RecordLoginFailure</span><span class="params">(<span class="type">const</span> std::string&amp; mobile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除登录失败记录</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ClearLoginFailure</span><span class="params">(<span class="type">const</span> std::string&amp; mobile)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储Refress Token</span></span><br><span class="line">    <span class="function">Result&lt;<span class="type">void</span>&gt; <span class="title">StoreRefreshToken</span><span class="params">(<span class="type">int64_t</span> user_id, <span class="type">const</span> std::string&amp; refresh_token)</span></span>;</span><br><span class="line">    </span><br><span class="line">    std::shared_ptr&lt;Config&gt; config_;</span><br><span class="line"></span><br><span class="line">    std::shared_ptr&lt;UserDB&gt; user_db_;               <span class="comment">// user数据库操作句柄</span></span><br><span class="line">    std::shared_ptr&lt;RedisClient&gt; redis_cli_;        <span class="comment">// redis缓存句柄 </span></span><br><span class="line">    std::shared_ptr&lt;TokenRepository&gt; token_repo_;   <span class="comment">// token数据库操作句柄</span></span><br><span class="line">    std::shared_ptr&lt;JwtService&gt; jwt_srv_;           <span class="comment">// token服务句柄</span></span><br><span class="line">    std::shared_ptr&lt;SmsService&gt; sms_srv_;           <span class="comment">// Captcha服务句柄</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace user_service</span></span><br></pre></td></tr></table></figure>

<h5 id="3）调用逻辑"><a href="#3）调用逻辑" class="headerlink" title="3）调用逻辑"></a>3）调用逻辑</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统一模式</span></span><br><span class="line">::<span class="function">grpc::Status <span class="title">Handler::Method</span><span class="params">(context, request, response)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;Method: key_param=&#123;&#125;&quot;</span>, request-&gt;<span class="built_in">key_param</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 参数校验（快速失败）</span></span><br><span class="line">    std::string error;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IsValidXxx</span>(request-&gt;<span class="built_in">field</span>(), error)) &#123;</span><br><span class="line">        <span class="built_in">SetResultError</span>(response-&gt;<span class="built_in">mutable_result</span>(), ErrorCode::InvalidArgument, error);</span><br><span class="line">        <span class="keyword">return</span> ::grpc::Status::OK;  <span class="comment">// 业务错误不用 grpc 错误码</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. ⚠️调用业务层</span></span><br><span class="line">    <span class="keyword">auto</span> result = service_-&gt;<span class="built_in">Method</span>(...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 设置响应</span></span><br><span class="line">    <span class="built_in">SetResultError</span>(response-&gt;<span class="built_in">mutable_result</span>(), result.code, result.message);</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="built_in">IsOk</span>()) &#123;</span><br><span class="line">        <span class="built_in">ToProtoXxx</span>(result.<span class="built_in">Value</span>(), response-&gt;<span class="built_in">mutable_xxx</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ::grpc::Status::OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="（2）认证相关业务类实现"><a href="#（2）认证相关业务类实现" class="headerlink" title="（2）认证相关业务类实现"></a>（2）认证相关业务类实现</h3><h4 id="发送验证码"><a href="#发送验证码" class="headerlink" title="&lt;1&gt;发送验证码"></a>&lt;1&gt;发送验证码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SendVerifyCode</span>(mobile, scene):</span><br><span class="line">    <span class="number">1.</span> 校验手机号格式</span><br><span class="line">    <span class="number">2.</span> 业务场景校验:</span><br><span class="line">       - 注册场景: 手机号必须不存在</span><br><span class="line">       - 登录/重置密码/注销场景: 手机号必须已存在</span><br><span class="line">    <span class="number">3.</span> 调用短信服务发送验证码</span><br><span class="line">        - 发送后会将验证码通过redis进行限时存储，方便之后进行验证</span><br><span class="line">    <span class="number">4.</span> 返回“发送间隔”</span><br><span class="line">        - 方便前端渲染</span><br></pre></td></tr></table></figure>

<h4 id="注册"><a href="#注册" class="headerlink" title="&lt;2&gt;注册"></a>&lt;2&gt;注册</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Register</span>(mobile, verify_code, password, display_name):</span><br><span class="line">    <span class="number">1.</span> 参数校验: 手机号、密码、验证码、昵称</span><br><span class="line">        - 在注册前，客户端会先调用SendVerifyCode发送验证码，客户端需要传入收到的验证码进行校验</span><br><span class="line">    <span class="number">2.</span> 验证<span class="string">&quot;验证码&quot;</span>（场景=注册）</span><br><span class="line">        - 通过“scene+mobile”构造redis键，获取正确认证码，与客户端传入的verify_code进行对比</span><br><span class="line">    <span class="number">3.</span> 构建用户实体（密码哈希处理）</span><br><span class="line">    <span class="number">4.</span> 数据库创建用户</span><br><span class="line">    <span class="number">5.</span> 生成双 Token（Access + Refresh）</span><br><span class="line">    <span class="number">6.</span> 存储 Refresh Token 哈希到数据库</span><br><span class="line">    <span class="number">7.</span> 返回用户信息 + Token（清除密码字段）</span><br></pre></td></tr></table></figure>

<h4 id="密码登录"><a href="#密码登录" class="headerlink" title="&lt;3&gt;密码登录"></a>&lt;3&gt;密码登录</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LoginByPassword</span>(mobile, password):</span><br><span class="line">    <span class="number">1.</span> 参数校验: 手机号、密码格式</span><br><span class="line">    <span class="number">2.</span> 检查登录失败次数（防暴力破解）</span><br><span class="line">       - 超过上限 → 返回<span class="string">&quot;账号锁定&quot;</span></span><br><span class="line">    <span class="number">3.</span> 查询用户</span><br><span class="line">       - 用户不存在 → 记录失败 + 返回<span class="string">&quot;账号或密码错误&quot;</span></span><br><span class="line">    <span class="number">4.</span> 检查账号状态（是否禁用）</span><br><span class="line">    <span class="number">5.</span> 验证密码</span><br><span class="line">       - 失败 → 记录失败次数 + 返回<span class="string">&quot;账号或密码错误&quot;</span></span><br><span class="line">    <span class="number">6.</span> 登录成功，清除失败记录</span><br><span class="line">    <span class="number">7.</span> 生成双 Token</span><br><span class="line">    <span class="number">8.</span> 存储 Refresh Token 哈希</span><br><span class="line">    <span class="number">9.</span> 返回用户信息 + Token</span><br></pre></td></tr></table></figure>

<h4 id="验证码登录"><a href="#验证码登录" class="headerlink" title="&lt;4&gt;验证码登录"></a>&lt;4&gt;验证码登录</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LoginByCode</span>(mobile, verify_code):</span><br><span class="line">    <span class="number">1.</span> 参数校验: 手机号、验证码</span><br><span class="line">    <span class="number">2.</span> 验证<span class="string">&quot;验证码&quot;</span>（场景=登录）</span><br><span class="line">    <span class="number">3.</span> 查询用户</span><br><span class="line">       - 不存在 → 返回<span class="string">&quot;请先注册&quot;</span></span><br><span class="line">    <span class="number">4.</span> 检查账号状态（是否禁用）</span><br><span class="line">    <span class="number">5.</span> 清除登录失败记录</span><br><span class="line">    <span class="number">6.</span> 生成双 Token</span><br><span class="line">    <span class="number">7.</span> 存储 Refresh Token 哈希</span><br><span class="line">    <span class="number">8.</span> 返回用户信息 + Token</span><br></pre></td></tr></table></figure>

<h4 id="重置密码"><a href="#重置密码" class="headerlink" title="&lt;5&gt;重置密码"></a>&lt;5&gt;重置密码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ResetPassword</span>(mobile, verify_code, new_password):</span><br><span class="line">    <span class="number">1.</span> 参数校验: 手机号、验证码、新密码</span><br><span class="line">    <span class="number">2.</span> 验证<span class="string">&quot;验证码&quot;</span>（场景=重置密码）</span><br><span class="line">    <span class="number">3.</span> 查询用户</span><br><span class="line">    <span class="number">4.</span> 更新密码（哈希处理）</span><br><span class="line">    <span class="number">5.</span> 删除该用户所有 Refresh Token（强制重新登录）</span><br><span class="line">    <span class="number">6.</span> 清除登录失败记录</span><br><span class="line">    <span class="number">7.</span> 返回成功</span><br></pre></td></tr></table></figure>

<h4 id="刷新-Token"><a href="#刷新-Token" class="headerlink" title="&lt;6&gt;刷新 Token"></a>&lt;6&gt;刷新 Token</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">RefreshToken</span>(refresh_token):</span><br><span class="line">    <span class="number">1.</span> 参数校验: refresh_token 非空</span><br><span class="line">    <span class="number">2.</span> 解析 Refresh Token → 获取 user_id</span><br><span class="line">    <span class="number">3.</span> 查询用户 + 检查状态（是否禁用）</span><br><span class="line">    <span class="number">4.</span> 校验 Token 哈希是否在数据库中且有效</span><br><span class="line">       - 无效 → 返回<span class="string">&quot;Token 已失效&quot;</span></span><br><span class="line">    <span class="number">5.</span> 删除旧的 Token 哈希</span><br><span class="line">    <span class="number">6.</span> 生成新的双 Token</span><br><span class="line">    <span class="number">7.</span> 存储新的 Refresh Token 哈希</span><br><span class="line">    <span class="number">8.</span> 返回新 Token 对</span><br></pre></td></tr></table></figure>

<h4 id="登出（单设备）"><a href="#登出（单设备）" class="headerlink" title="&lt;7&gt;登出（单设备）"></a>&lt;7&gt;登出（单设备）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Logout</span>(refresh_token):</span><br><span class="line">    <span class="number">1.</span> 空 Token → 直接返回成功（幂等性）</span><br><span class="line">    <span class="number">2.</span> 计算 Token 哈希</span><br><span class="line">    <span class="number">3.</span> 从数据库删除该哈希（失败也返回成功，保证幂等）</span><br><span class="line">    <span class="number">4.</span> 返回成功</span><br></pre></td></tr></table></figure>

<h3 id="（3）用户操作相关业务类实现"><a href="#（3）用户操作相关业务类实现" class="headerlink" title="（3）用户操作相关业务类实现"></a>（3）用户操作相关业务类实现</h3><ul>
<li><strong>user_uuid通过解析access_token获取</strong></li>
</ul>
<h4 id="获取当前用户"><a href="#获取当前用户" class="headerlink" title="&lt;1&gt;获取当前用户"></a>&lt;1&gt;获取当前用户</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetCurrentUser</span>(user_uuid):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid 非空</span><br><span class="line">    <span class="number">2.</span> 查询用户</span><br><span class="line">    <span class="number">3.</span> 清除敏感信息（密码）</span><br><span class="line">    <span class="number">4.</span> 返回用户信息</span><br></pre></td></tr></table></figure>

<h4 id="更新用户信息"><a href="#更新用户信息" class="headerlink" title="&lt;2&gt;更新用户信息"></a>&lt;2&gt;更新用户信息</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UpdateUser</span>(user_uuid, display_name?):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid 非空</span><br><span class="line">    <span class="number">2.</span> 查询用户</span><br><span class="line">    <span class="number">3.</span> 检查账号状态（是否禁用）</span><br><span class="line">    <span class="number">4.</span> 更新字段:</span><br><span class="line">       - display_name 有值 → 校验格式 → 更新</span><br><span class="line">       - [扩展] avatar_url, email 等</span><br><span class="line">    <span class="number">5.</span> 无更新字段 → 直接返回当前用户</span><br><span class="line">    <span class="number">6.</span> 保存更新到数据库</span><br><span class="line">    <span class="number">7.</span> 返回用户信息（清除密码）</span><br></pre></td></tr></table></figure>

<h4 id="修改密码（已登录）"><a href="#修改密码（已登录）" class="headerlink" title="&lt;3&gt;修改密码（已登录）"></a>&lt;3&gt;修改密码（已登录）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ChangePassword</span>(user_uuid, old_password, new_password):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid、旧密码格式、新密码格式</span><br><span class="line">    <span class="number">2.</span> 校验新旧密码不能相同</span><br><span class="line">    <span class="number">3.</span> 查询用户</span><br><span class="line">    <span class="number">4.</span> 检查账号状态（是否禁用）</span><br><span class="line">    <span class="number">5.</span> 验证旧密码</span><br><span class="line">       - 失败 → 返回<span class="string">&quot;旧密码错误&quot;</span></span><br><span class="line">    <span class="number">6.</span> 更新密码（哈希处理后存储）</span><br><span class="line">    <span class="number">7.</span> [可选] 使其他设备 Token 失效</span><br><span class="line">    <span class="number">8.</span> 返回成功</span><br></pre></td></tr></table></figure>

<h4 id="删除用户（注销账号）"><a href="#删除用户（注销账号）" class="headerlink" title="&lt;4&gt;删除用户（注销账号）"></a>&lt;4&gt;删除用户（注销账号）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DeleteUser</span>(user_uuid, verify_code):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid、验证码格式</span><br><span class="line">    <span class="number">2.</span> 查询用户</span><br><span class="line">    <span class="number">3.</span> 验证<span class="string">&quot;验证码&quot;</span>（场景=注销）</span><br><span class="line">    <span class="number">4.</span> 删除该用户所有 Token（强制登出）</span><br><span class="line">    <span class="number">5.</span> 软删除用户:</span><br><span class="line">       - disabled = <span class="literal">true</span></span><br><span class="line">       - mobile = <span class="string">&quot;deleted_&quot;</span> + id + <span class="string">&quot;_&quot;</span> + mobile  <span class="comment">// 释放手机号</span></span><br><span class="line">    <span class="number">6.</span> 返回成功</span><br></pre></td></tr></table></figure>

<h4 id="获取指定用户（管理员）"><a href="#获取指定用户（管理员）" class="headerlink" title="&lt;5&gt;获取指定用户（管理员）"></a>&lt;5&gt;获取指定用户（管理员）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">GetUser</span>(user_uuid):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid 非空</span><br><span class="line">    <span class="number">2.</span> 查询用户</span><br><span class="line">    <span class="number">3.</span> 清除敏感信息（密码）</span><br><span class="line">    <span class="number">4.</span> 返回用户信息</span><br></pre></td></tr></table></figure>

<h4 id="获取用户列表（管理员）"><a href="#获取用户列表（管理员）" class="headerlink" title="&lt;6&gt;获取用户列表（管理员）"></a>&lt;6&gt;获取用户列表（管理员）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ListUsers</span>(mobile_filter?, disabled_filter?, page, page_size):</span><br><span class="line">    <span class="number">1.</span> 参数校验和默认值:</span><br><span class="line">       - page = <span class="built_in">max</span>(<span class="number">1</span>, page)</span><br><span class="line">       - page_size = <span class="built_in">clamp</span>(page_size, <span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="number">2.</span> 构建查询条件:</span><br><span class="line">       - mobile_like（模糊匹配）</span><br><span class="line">       - disabled（精确匹配）</span><br><span class="line">    <span class="number">3.</span> 查询总数</span><br><span class="line">    <span class="number">4.</span> 查询当前页列表</span><br><span class="line">    <span class="number">5.</span> 清除所有用户的敏感信息</span><br><span class="line">    <span class="number">6.</span> 构建分页结果:</span><br><span class="line">       - users, total_records, total_pages, page, page_size</span><br><span class="line">    <span class="number">7.</span> 返回结果</span><br></pre></td></tr></table></figure>

<h4 id="禁用-启用用户（管理员）"><a href="#禁用-启用用户（管理员）" class="headerlink" title="&lt;7&gt;禁用&#x2F;启用用户（管理员）"></a>&lt;7&gt;禁用&#x2F;启用用户（管理员）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SetUserDisabled</span>(user_uuid, disabled):</span><br><span class="line">    <span class="number">1.</span> 参数校验: uuid 非空</span><br><span class="line">    <span class="number">2.</span> 查询用户</span><br><span class="line">    <span class="number">3.</span> 状态相同 → 直接返回成功（幂等）</span><br><span class="line">    <span class="number">4.</span> 更新 disabled 状态</span><br><span class="line">    <span class="number">5.</span> 如果是禁用 → 删除该用户所有 Token（强制登出）</span><br><span class="line">    <span class="number">6.</span> 返回成功</span><br></pre></td></tr></table></figure>

<h2 id="3-错误码设计"><a href="#3-错误码设计" class="headerlink" title="3.错误码设计"></a>3.错误码设计</h2><ul>
<li>proto中定义错误码，在业务层也独自定义相应的错误码，但最好值相等，方便转换</li>
</ul>
<h3 id="（1）proto定义错误码"><a href="#（1）proto定义错误码" class="headerlink" title="（1）proto定义错误码"></a>（1）proto定义错误码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package pb_common;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误码 - 与内部 C++ ErrorCode 保持一致</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">ErrorCode</span> &#123;</span><br><span class="line">    <span class="comment">// ========== 成功 ==========</span></span><br><span class="line">    OK = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 通用错误（100~999） ====================</span></span><br><span class="line">    <span class="comment">// 系统错误（1xx）</span></span><br><span class="line">    UNKNOWN             = <span class="number">100</span>;  <span class="comment">// 未知错误</span></span><br><span class="line">    INTERNAL            = <span class="number">101</span>;  <span class="comment">// 内部服务器异常</span></span><br><span class="line">    NOT_IMPLEMENTED     = <span class="number">102</span>;  <span class="comment">// 功能未实现</span></span><br><span class="line">    SERVICE_UNAVAILABLE = <span class="number">103</span>;  <span class="comment">// 服务不可用</span></span><br><span class="line">    TIMEOUT             = <span class="number">104</span>;  <span class="comment">// 请求超时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数错误（2xx）</span></span><br><span class="line">    INVALID_ARGUMENT    = <span class="number">200</span>;  <span class="comment">// 参数无效</span></span><br><span class="line">    INVALID_PAGE        = <span class="number">210</span>;  <span class="comment">// 无效的分页参数</span></span><br><span class="line">    INVALID_PAGE_SIZE   = <span class="number">211</span>;  <span class="comment">// 无效的分页大小</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限流（3xx）</span></span><br><span class="line">    RATE_LIMITED        = <span class="number">300</span>;  <span class="comment">// 请求过于频繁</span></span><br><span class="line">    QUOTA_EXCEEDED      = <span class="number">301</span>;  <span class="comment">// 配额超限</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 认证错误（1000~1999） ====================</span></span><br><span class="line">    <span class="comment">// Token 相关（100x）</span></span><br><span class="line">    UNAUTHENTICATED     = <span class="number">1000</span>; <span class="comment">// 未认证（通用）</span></span><br><span class="line">    TOKEN_MISSING       = <span class="number">1001</span>; <span class="comment">// Token 缺失</span></span><br><span class="line">    TOKEN_INVALID       = <span class="number">1002</span>; <span class="comment">// Token 无效</span></span><br><span class="line">    TOKEN_EXPIRED       = <span class="number">1003</span>; <span class="comment">// Token 已过期</span></span><br><span class="line">    TOKEN_REVOKED       = <span class="number">1004</span>; <span class="comment">// Token 已注销</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录相关（101x~102x）</span></span><br><span class="line">    LOGIN_FAILED        = <span class="number">1010</span>; <span class="comment">// 登录失败（通用）</span></span><br><span class="line">    WRONG_PASSWORD      = <span class="number">1011</span>; <span class="comment">// 密码错误</span></span><br><span class="line">    ACCOUNT_LOCKED      = <span class="number">1012</span>; <span class="comment">// 账号已锁定（多次密码错误）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码相关（102x）</span></span><br><span class="line">    CAPTCHA_WRONG       = <span class="number">1021</span>; <span class="comment">// 验证码错误</span></span><br><span class="line">    CAPTCHA_EXPIRED     = <span class="number">1022</span>; <span class="comment">// 验证码已过期</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 用户错误（2000~2999） ====================</span></span><br><span class="line">    <span class="comment">// 用户查询（200x）</span></span><br><span class="line">    USER_NOT_FOUND      = <span class="number">2000</span>; <span class="comment">// 用户不存在</span></span><br><span class="line">    USER_DELETED        = <span class="number">2001</span>; <span class="comment">// 用户已删除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户创建（201x）</span></span><br><span class="line">    USER_ALREADY_EXISTS = <span class="number">2010</span>; <span class="comment">// 用户已存在（通用）</span></span><br><span class="line">    MOBILE_TAKEN        = <span class="number">2013</span>; <span class="comment">// 手机号已被占用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户状态（202x）</span></span><br><span class="line">    USER_DISABLED       = <span class="number">2020</span>; <span class="comment">// 用户已禁用</span></span><br><span class="line">    USER_NOT_VERIFIED   = <span class="number">2021</span>; <span class="comment">// 用户未验证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 权限错误（3000~3999） ====================</span></span><br><span class="line">    PERMISSION_DENIED   = <span class="number">3000</span>; <span class="comment">// 无权限（通用）</span></span><br><span class="line">    ADMIN_REQUIRED      = <span class="number">3001</span>; <span class="comment">// 需要管理员权限</span></span><br><span class="line">    OWNER_REQUIRED      = <span class="number">3002</span>; <span class="comment">// 需要是资源所有者</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">message Result &#123;</span><br><span class="line">    ErrorCode code              = <span class="number">1</span>;</span><br><span class="line">    string    msg               = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）业务层定义错误码"><a href="#（2）业务层定义错误码" class="headerlink" title="（2）业务层定义错误码"></a>（2）业务层定义错误码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">ErrorCode</span>&#123;</span><br><span class="line">    <span class="comment">// ========== 成功 ==========</span></span><br><span class="line">    Ok = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 通用错误（100~999） ====================</span></span><br><span class="line">    <span class="comment">// 系统错误（1xx）</span></span><br><span class="line">    Unknown             = <span class="number">100</span>,  <span class="comment">// 未知错误</span></span><br><span class="line">    Internal            = <span class="number">101</span>,  <span class="comment">// 内部服务器异常</span></span><br><span class="line">    NotImplemented      = <span class="number">102</span>,  <span class="comment">// 功能未实现</span></span><br><span class="line">    ServiceUnavailable  = <span class="number">103</span>,  <span class="comment">// 服务不可用</span></span><br><span class="line">    Timeout             = <span class="number">104</span>,  <span class="comment">// 请求超时</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数错误（2xx）</span></span><br><span class="line">    InvalidArgument     = <span class="number">200</span>,  <span class="comment">// 参数无效</span></span><br><span class="line">    InvalidPage         = <span class="number">210</span>,  <span class="comment">// 无效的分页参数</span></span><br><span class="line">    InvalidPageSize     = <span class="number">211</span>,  <span class="comment">// 无效的分页大小</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 限流（3xx）</span></span><br><span class="line">    RateLimited         = <span class="number">300</span>,  <span class="comment">// 请求过于频繁</span></span><br><span class="line">    QuotaExceeded       = <span class="number">301</span>,  <span class="comment">// 配额超限</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 认证错误（1000~1999） ====================</span></span><br><span class="line">    <span class="comment">// Token 相关（100x）</span></span><br><span class="line">    Unauthenticated     = <span class="number">1000</span>, <span class="comment">// 未认证（通用）</span></span><br><span class="line">    TokenMissing        = <span class="number">1001</span>, <span class="comment">// Token 缺失</span></span><br><span class="line">    TokenInvalid        = <span class="number">1002</span>, <span class="comment">// Token 无效</span></span><br><span class="line">    TokenExpired        = <span class="number">1003</span>, <span class="comment">// Token 已过期</span></span><br><span class="line">    TokenRevoked        = <span class="number">1004</span>, <span class="comment">// Token 已注销</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 登录相关（101x~102x）</span></span><br><span class="line">    LoginFailed         = <span class="number">1010</span>, <span class="comment">// 登录失败（通用）</span></span><br><span class="line">    WrongPassword       = <span class="number">1011</span>, <span class="comment">// 密码错误</span></span><br><span class="line">    AccountLocked       = <span class="number">1012</span>, <span class="comment">// 账号已锁定（多次密码错误）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证码相关</span></span><br><span class="line">    CaptchaWrong        = <span class="number">1021</span>, <span class="comment">// 验证码错误</span></span><br><span class="line">    CaptchaExpired      = <span class="number">1022</span>, <span class="comment">// 验证码已过期</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 用户错误（2000~2999） ====================</span></span><br><span class="line">    <span class="comment">// 用户查询（200x）</span></span><br><span class="line">    UserNotFound        = <span class="number">2000</span>, <span class="comment">// 用户不存在</span></span><br><span class="line">    UserDeleted         = <span class="number">2001</span>, <span class="comment">// 用户已删除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户创建（201x）</span></span><br><span class="line">    UserAlreadyExists   = <span class="number">2010</span>, <span class="comment">// 用户已存在（通用）</span></span><br><span class="line">    MobileTaken         = <span class="number">2013</span>, <span class="comment">// 手机号已被占用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户状态（202x）</span></span><br><span class="line">    UserDisabled        = <span class="number">2020</span>, <span class="comment">// 用户已禁用</span></span><br><span class="line">    UserNotVerified     = <span class="number">2021</span>, <span class="comment">// 用户未验证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ==================== 权限错误（3000~3999） ====================</span></span><br><span class="line">    PermissionDenied    = <span class="number">3000</span>, <span class="comment">// 无权限（通用）</span></span><br><span class="line">    AdminRequired       = <span class="number">3001</span>, <span class="comment">// 需要管理员权限</span></span><br><span class="line">    OwnerRequired       = <span class="number">3002</span>, <span class="comment">// 需要是资源所有者</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// 错误码工具函数</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取错误码对应的消息（用户友好）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> std::string <span class="title">GetErrorMessage</span><span class="params">(ErrorCode code)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::Ok:                  <span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通用错误</span></span><br><span class="line">        <span class="keyword">case</span> ErrorCode::Unknown:             <span class="keyword">return</span> <span class="string">&quot;未知错误&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::Internal:            <span class="keyword">return</span> <span class="string">&quot;服务器内部错误&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::NotImplemented:      <span class="keyword">return</span> <span class="string">&quot;功能暂未实现&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::ServiceUnavailable:  <span class="keyword">return</span> <span class="string">&quot;服务暂不可用&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::Timeout:             <span class="keyword">return</span> <span class="string">&quot;请求超时&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::InvalidArgument:     <span class="keyword">return</span> <span class="string">&quot;参数无效&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::InvalidPage:         <span class="keyword">return</span> <span class="string">&quot;无效的页码&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::InvalidPageSize:     <span class="keyword">return</span> <span class="string">&quot;无效的每页大小&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::RateLimited:         <span class="keyword">return</span> <span class="string">&quot;请求过于频繁，请稍后再试&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::QuotaExceeded:       <span class="keyword">return</span> <span class="string">&quot;配额已超限&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 认证错误</span></span><br><span class="line">        <span class="keyword">case</span> ErrorCode::Unauthenticated:     <span class="keyword">return</span> <span class="string">&quot;请先登录&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::TokenMissing:        <span class="keyword">return</span> <span class="string">&quot;缺少认证信息&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::TokenInvalid:        <span class="keyword">return</span> <span class="string">&quot;认证信息无效&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::TokenExpired:        <span class="keyword">return</span> <span class="string">&quot;登录已过期，请重新登录&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::TokenRevoked:        <span class="keyword">return</span> <span class="string">&quot;登录已失效&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::LoginFailed:         <span class="keyword">return</span> <span class="string">&quot;登录失败&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::WrongPassword:       <span class="keyword">return</span> <span class="string">&quot;用户名或密码错误&quot;</span>;  <span class="comment">// 故意模糊</span></span><br><span class="line">        <span class="keyword">case</span> ErrorCode::AccountLocked:       <span class="keyword">return</span> <span class="string">&quot;账号已锁定，请稍后再试&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::CaptchaWrong:        <span class="keyword">return</span> <span class="string">&quot;验证码错误&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::CaptchaExpired:      <span class="keyword">return</span> <span class="string">&quot;验证码已过期，请重新获取&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户错误</span></span><br><span class="line">        <span class="keyword">case</span> ErrorCode::UserNotFound:        <span class="keyword">return</span> <span class="string">&quot;用户不存在&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::UserDeleted:         <span class="keyword">return</span> <span class="string">&quot;用户已注销&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::UserAlreadyExists:   <span class="keyword">return</span> <span class="string">&quot;用户已存在&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::MobileTaken:         <span class="keyword">return</span> <span class="string">&quot;手机号已被使用&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::UserDisabled:        <span class="keyword">return</span> <span class="string">&quot;账号已被禁用&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::UserNotVerified:     <span class="keyword">return</span> <span class="string">&quot;账号未验证&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 权限错误</span></span><br><span class="line">        <span class="keyword">case</span> ErrorCode::PermissionDenied:    <span class="keyword">return</span> <span class="string">&quot;无权限执行此操作&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::AdminRequired:       <span class="keyword">return</span> <span class="string">&quot;需要管理员权限&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> ErrorCode::OwnerRequired:       <span class="keyword">return</span> <span class="string">&quot;只有所有者可执行此操作&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:                             <span class="keyword">return</span> <span class="string">&quot;未知错误&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）两者转换"><a href="#（3）两者转换" class="headerlink" title="（3）两者转换"></a>（3）两者转换</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"><span class="comment">// ErrorCode 转换函数</span></span><br><span class="line"><span class="comment">// ============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 业务层 ErrorCode → Proto ErrorCode</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> pb_common::ErrorCode <span class="title">ToProtoErrorCode</span><span class="params">(ErrorCode code)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 数值相同，直接转换</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;pb_common::ErrorCode&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(code));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Proto ErrorCode → 业务层 ErrorCode</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> ErrorCode <span class="title">FromProtoErrorCode</span><span class="params">(pb_common::ErrorCode code)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;ErrorCode&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(code));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、关键收获（重点）"><a href="#四、关键收获（重点）" class="headerlink" title="四、关键收获（重点）"></a>四、关键收获（重点）</h1><h2 id="1-异常处理三层模型"><a href="#1-异常处理三层模型" class="headerlink" title="1.异常处理三层模型"></a>1.异常处理三层模型</h2><a href="/2026/01/19/C++/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E6%80%9D%E8%80%83%E6%80%BB%E7%BB%93/%E5%BC%82%E5%B8%B8%E7%9A%84%E6%8A%9B%E5%87%BA%E4%B8%8E%E5%A4%84%E7%90%86/" title="异常的抛出与处理">异常处理三层模型</a>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      异常处理三层模型                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  第三方库层（Redis/MySQL/gRPC）                                  │</span><br><span class="line">│       │  抛出异常（如 sw::redis::Error）                        │</span><br><span class="line">│       ▼                                                         │</span><br><span class="line">│  基础服务层（RedisClient/UserDB）                                │</span><br><span class="line">│       │  捕获异常 → 日志记录 → 转换为 Result&lt;T&gt;                 │</span><br><span class="line">│       ▼                                                         │</span><br><span class="line">│  业务层（AuthService/UserService）                               │</span><br><span class="line">│       │  处理 Result&lt;T&gt;，编排业务逻辑                           │</span><br><span class="line">│       ▼                                                         │</span><br><span class="line">│  Handler层（AuthHandler/UserHandler）                            │</span><br><span class="line">│          处理 Result&lt;T&gt; → 转换为 Proto Response                 │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  原则：异常不上抛，统一用 Result&lt;T&gt; 传递错误                     │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>核心要点</strong>：</p>
<ul>
<li><strong>基础服务层</strong>：捕获所有第三方库异常，转换为 Result<T></li>
<li><strong>业务层&#x2F;Handler层</strong>：永远不抛异常，只处理 Result<T></li>
<li><strong>好处</strong>：错误处理显式化、调用链清晰、便于调试</li>
</ul>
<h2 id="2-gRPC-分层架构"><a href="#2-gRPC-分层架构" class="headerlink" title="2.gRPC 分层架构"></a>2.gRPC 分层架构</h2><ul>
<li>具体类只进行参数校验、参数解析等，不实现具体业务逻辑</li>
<li>业务层实现具体逻辑，且与proto完全独立</li>
<li>对于proto中定义的实体，业务层要单独定义</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      gRPC 分层架构                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │</span><br><span class="line">│  │   Proto     │     │   Handler   │     │   Service   │       │</span><br><span class="line">│  │   定义层    │ ──► │   协议适配层 │ ──► │   业务逻辑层 │       │</span><br><span class="line">│  └─────────────┘     └─────────────┘     └─────────────┘       │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  职责划分：                                                      │</span><br><span class="line">│  ─────────                                                      │</span><br><span class="line">│  Proto    : 定义接口契约（rpc + message）                       │</span><br><span class="line">│  Handler  : 参数校验、认证、proto ↔ 业务对象转换                │</span><br><span class="line">│  Service  : 纯业务逻辑，与 proto 完全解耦                       │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>隔离的好处</strong>：</p>
<ul>
<li>Proto 变化不影响业务逻辑</li>
<li>业务层可独立测试</li>
<li>代码职责清晰</li>
</ul>
<h2 id="3-双-Token-认证机制"><a href="#3-双-Token-认证机制" class="headerlink" title="3.双 Token 认证机制"></a>3.双 Token 认证机制</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      双 Token 认证流程                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  登录成功                                                        │</span><br><span class="line">│     │                                                           │</span><br><span class="line">│     ▼                                                           │</span><br><span class="line">│  生成 Access Token（短期，如<span class="number">30</span>分钟）+ Refresh Token（长期，如<span class="number">7</span>天）│</span><br><span class="line">│     │                                                           │</span><br><span class="line">│     ▼                                                           │</span><br><span class="line">│  Refresh Token 哈希存入数据库（用于撤销）                        │</span><br><span class="line">│     │                                                           │</span><br><span class="line">│     ▼                                                           │</span><br><span class="line">│  客户端存储两个 Token                                            │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ─────────────────────────────────────────────────────────────  │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  业务请求                                                        │</span><br><span class="line">│     │                                                           │</span><br><span class="line">│     ▼                                                           │</span><br><span class="line">│  携带 Access Token → 服务端验证签名+过期时间 → 提取用户信息      │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ─────────────────────────────────────────────────────────────  │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  Access Token 过期                                               │</span><br><span class="line">│     │                                                           │</span><br><span class="line">│     ▼                                                           │</span><br><span class="line">│  携带 Refresh Token → 验证+检查数据库 → 生成新的双 Token         │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203230506379.png"></p>
<h2 id="4-架构设计原则"><a href="#4-架构设计原则" class="headerlink" title="4. 架构设计原则"></a>4. 架构设计原则</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      核心设计原则                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">1.</span> 单一职责                                                     │</span><br><span class="line">│     Handler: 协议适配    Service: 业务编排    Repository: 数据   │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">2.</span> 依赖倒置                                                     │</span><br><span class="line">│     业务层定义接口 ← 基础服务层实现                              │</span><br><span class="line">│     Service 不依赖 Proto，Proto Handler 依赖 Service            │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">3.</span> 显式错误处理                                                 │</span><br><span class="line">│     用 Result&lt;T&gt; 替代异常，错误处理路径清晰可见                  │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">4.</span> 幂等性设计                                                   │</span><br><span class="line">│     Logout：Token 不存在也返回成功                               │</span><br><span class="line">│     SetDisabled：状态相同不执行更新                              │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">5.</span> 安全默认                                                     │</span><br><span class="line">│     用户标识来自 Token，非客户端传参                             │</span><br><span class="line">│     敏感字段（password_hash）返回前清除                          │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="5-错误码设计原则"><a href="#5-错误码设计原则" class="headerlink" title="5.错误码设计原则"></a>5.错误码设计原则</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      错误码设计原则                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">1.</span> 分层独立定义                                                 │</span><br><span class="line">│     ─────────────                                               │</span><br><span class="line">│     Proto 层：pb_common::ErrorCode（对外契约）                   │</span><br><span class="line">│     业务层：ErrorCode <span class="keyword">enum</span> <span class="title class_">class</span>（内部使用）                     │</span><br><span class="line">│     两者值相同，转换简单：<span class="keyword">static_cast</span> 即可                       │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">2.</span> 错误码分段设计                                               │</span><br><span class="line">│     ────────────                                                │</span><br><span class="line">│     <span class="number">0</span>         : 成功                                            │</span><br><span class="line">│     <span class="number">100</span>~<span class="number">999</span>   : 通用错误（系统、参数、限流）                     │</span><br><span class="line">│     <span class="number">1000</span>~<span class="number">1999</span> : 认证错误（Token、登录、验证码）                  │</span><br><span class="line">│     <span class="number">2000</span>~<span class="number">2999</span> : 用户错误（查询、创建、状态）                     │</span><br><span class="line">│     <span class="number">3000</span>~<span class="number">3999</span> : 权限错误                                        │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">3.</span> gRPC Status vs 业务错误码                                    │</span><br><span class="line">│     ──────────────────────                                      │</span><br><span class="line">│     gRPC Status：网络/协议层错误（连接失败、超时等）             │</span><br><span class="line">│     业务错误码：业务逻辑错误（用户不存在、密码错误等）           │</span><br><span class="line">│     原则：只要 gRPC 调用成功，返回 grpc::Status::OK              │</span><br><span class="line">│           业务错误通过 response.result 返回                      │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">4.</span> 错误信息设计                                                 │</span><br><span class="line">│     ────────────                                                │</span><br><span class="line">│     安全原则：不暴露系统细节（如<span class="string">&quot;密码错误&quot;</span>改为<span class="string">&quot;用户名或密码错误&quot;</span>）│</span><br><span class="line">│     用户友好：<span class="built_in">GetErrorMessage</span>() 返回可读文案                     │</span><br><span class="line">│     日志详细：内部日志记录完整错误信息                           │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（1）错误码使用模式"><a href="#（1）错误码使用模式" class="headerlink" title="（1）错误码使用模式"></a>（1）错误码使用模式</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handler 层统一处理</span></span><br><span class="line">::<span class="function">grpc::Status <span class="title">Handler::Method</span><span class="params">(...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> result = service_-&gt;<span class="built_in">Method</span>(...);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 业务层 ErrorCode → Proto ErrorCode</span></span><br><span class="line">    response-&gt;<span class="built_in">mutable_result</span>()-&gt;<span class="built_in">set_code</span>(<span class="built_in">ToProtoErrorCode</span>(result.code));</span><br><span class="line">    response-&gt;<span class="built_in">mutable_result</span>()-&gt;<span class="built_in">set_msg</span>(result.message);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// gRPC 层始终返回 OK（业务错误不用 gRPC 错误码）</span></span><br><span class="line">    <span class="keyword">return</span> ::grpc::Status::OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）设计要点总结"><a href="#（2）设计要点总结" class="headerlink" title="（2）设计要点总结"></a>（2）设计要点总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260203231758316.png"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="咸鱼 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="咸鱼 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>咸鱼
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://xianyubuxian-txy.github.io/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/" title="1.用户服务项目开发日志">https://xianyubuxian-txy.github.io/2026/01/26/C++/项目开发日志/1-用户服务项目开发日志/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E6%97%A5%E5%BF%97/" rel="tag"># 日志</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2026/01/25/C++/%E5%90%8E%E7%AB%AF%E4%B8%9A%E5%8A%A1%E6%A6%82%E5%BF%B5/uuid%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="prev" title="uuid的使用">
                  <i class="fa fa-angle-left"></i> uuid的使用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2026/01/26/C++/C++%E7%89%B9%E6%80%A7/C++11%E7%89%B9%E6%80%A7/noreturn-%E5%B1%9E%E6%80%A7/" rel="next" title="[[noreturn]]属性">
                  [[noreturn]]属性 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">咸鱼</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">229k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">12:44</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xianyubuxian-TXY" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-beta-black.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请文明评论呀","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2026/01/26/C++/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/1-%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
