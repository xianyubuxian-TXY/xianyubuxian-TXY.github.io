<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xianyubuxian-txy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="注！！：本文章主要聚焦于“Docker辅助开发模式”  一、Docker概述 1.Docker技术的用途（先有个印象即可） 在之后的章节你会学到Dockerfile与docker-compose，先明确：   * Dockerfile主要用于“部署阶段”，但它是学习docker-compose的基础  * docker-compose即可用于“辅助开发”，也用于“部署阶段”  （1）三种开发模式">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker的使用">
<meta property="og:url" content="https://xianyubuxian-txy.github.io/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Xianyu">
<meta property="og:description" content="注！！：本文章主要聚焦于“Docker辅助开发模式”  一、Docker概述 1.Docker技术的用途（先有个印象即可） 在之后的章节你会学到Dockerfile与docker-compose，先明确：   * Dockerfile主要用于“部署阶段”，但它是学习docker-compose的基础  * docker-compose即可用于“辅助开发”，也用于“部署阶段”  （1）三种开发模式">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124104624779.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123002543362.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123205543731.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210621239.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210811823.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210936559.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211135184.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211637207.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211754249.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211842531.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211926184.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212019696.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212115528.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212237431.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212321823.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124004027731.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123235236543.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123235306432.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124001233281.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124002125450.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124100614274.png">
<meta property="article:published_time" content="2026-01-22T15:20:59.000Z">
<meta property="article:modified_time" content="2026-01-25T01:08:29.305Z">
<meta property="article:author" content="咸鱼">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124104624779.png">


<link rel="canonical" href="https://xianyubuxian-txy.github.io/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://xianyubuxian-txy.github.io/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/","path":"2026/01/22/C++/C++后端开发常用库/Docker的使用/","title":"Docker的使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Docker的使用 | Xianyu</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  




<link rel="dns-prefetch" href="https://waline-beta-black.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Xianyu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81Docker%E6%A6%82%E8%BF%B0"><span class="nav-text">一、Docker概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Docker%E6%8A%80%E6%9C%AF%E7%9A%84%E7%94%A8%E9%80%94%EF%BC%88%E5%85%88%E6%9C%89%E4%B8%AA%E5%8D%B0%E8%B1%A1%E5%8D%B3%E5%8F%AF%EF%BC%89"><span class="nav-text">1.Docker技术的用途（先有个印象即可）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%B8%89%E7%A7%8D%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">（1）三种开发模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Docker%E8%BE%85%E5%8A%A9%E5%BC%80%E5%8F%91%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">（2）Docker辅助开发（推荐）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%85%A8Docker%E5%BC%80%E5%8F%91%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="nav-text">（3）全Docker开发（了解）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Docker%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">2.Docker是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Docker-%E4%B8%89%E5%A4%A7%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-text">3.Docker 三大核心概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Docker%E6%8A%80%E6%9C%AF%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-text">4.Docker技术的优势</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E7%9A%84%E2%80%9C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E2%80%9D"><span class="nav-text">（1）快速获取第三方服务的“服务端”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%EF%BC%8C%E4%B8%8D%E6%B1%A1%E6%9F%93%E4%B8%BB%E6%9C%BA"><span class="nav-text">（2）环境隔离，不污染主机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E6%8F%90%E9%AB%98%E7%A8%8B%E5%BA%8F%E5%8F%AF%E7%A7%BB%E6%A4%8D%E6%80%A7"><span class="nav-text">（3）提高程序可移植性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E4%B8%8E%E5%A4%9A%E7%89%88%E6%9C%AC%E5%85%B1%E5%AD%98"><span class="nav-text">（4）版本管理与多版本共存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%9B%9E%E6%BB%9A"><span class="nav-text">（5）快速部署与回滚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E8%B5%84%E6%BA%90%E5%88%A9%E7%94%A8%E7%8E%87%E9%AB%98"><span class="nav-text">（6）资源利用率高</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Docker%E7%9A%84%E5%B1%80%E9%99%90"><span class="nav-text">5.Docker的局限</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Docker%E5%9C%A8C-%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">二、Docker在C++中的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Docker%E5%9C%A8C-%E5%BC%80%E5%8F%91%E4%B8%AD%E7%9A%84%E4%BB%B7%E5%80%BC"><span class="nav-text">1.Docker在C++开发中的价值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Dockerfile%E8%AF%A6%E8%A7%A3%EF%BC%88C-%EF%BC%89"><span class="nav-text">2.Dockerfile详解（C++）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Dockerfile%E7%9A%84%E6%9E%84%E9%80%A0%E6%B5%81%E7%A8%8B%EF%BC%88%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E9%80%A0%EF%BC%89"><span class="nav-text">（1）Dockerfile的构造流程（多阶段构造）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E9%98%B6%E6%AE%B5%EF%BC%88%E7%AC%AC%E4%B8%80%E4%B8%AA-FROM%EF%BC%89"><span class="nav-text">&lt;1&gt; 构建阶段（第一个 FROM）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E9%98%B6%E6%AE%B5%EF%BC%88%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E7%9A%84%E7%AC%AC%E4%BA%8C%E4%B8%AA-FROM%EF%BC%8C%E4%BB%8D%E5%9C%A8-docker-build-%E6%97%B6%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="nav-text">&lt;2&gt;运行阶段（多阶段构建的第二个 FROM，仍在 docker build 时执行）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">&lt;3&gt;执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-build-%E4%B8%8E-docker-run-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">&lt;4&gt;docker build 与 docker run 的关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%84%E9%98%B6%E6%AE%B5%E9%9C%80%E8%A6%81%E7%9A%84%E5%86%85%E5%AE%B9%E5%AF%B9%E6%AF%94"><span class="nav-text">&lt;5&gt;各阶段需要的内容对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89C-%E9%80%9A%E7%94%A8Dockerfile%E6%A8%A1%E6%9D%BF"><span class="nav-text">（2）C++通用Dockerfile模板</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%A6%E7%BB%86%E7%89%88%EF%BC%88%E5%B8%A6%E7%B1%BB%E6%AF%94%E6%B3%A8%E9%87%8A%EF%BC%89"><span class="nav-text">&lt;1&gt;详细版（带类比注释）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E6%A8%A1%E6%9D%BF%EF%BC%88%E6%97%A0%E6%B3%A8%E9%87%8A%E7%89%88%EF%BC%89"><span class="nav-text">&lt;2&gt;完整模板（无注释版）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Dockerfile-%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3"><span class="nav-text">（3）Dockerfile 指令详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#FROM-%E6%8C%87%E5%AE%9A%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="nav-text">&lt;1&gt;FROM - 指定基础镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RUN-%E6%89%A7%E8%A1%8C%E6%9E%84%E5%BB%BA%E5%91%BD%E4%BB%A4"><span class="nav-text">&lt;2&gt;RUN - 执行构建命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#COPY-%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6%E5%88%B0%E9%95%9C%E5%83%8F"><span class="nav-text">&lt;3&gt;COPY - 复制文件到镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ADD-%E5%A4%8D%E5%88%B6-%E8%A7%A3%E5%8E%8B%EF%BC%88%E6%85%8E%E7%94%A8%EF%BC%89"><span class="nav-text">&lt;4&gt;ADD - 复制 + 解压（慎用）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WORKDIR-%E8%AE%BE%E7%BD%AE%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95"><span class="nav-text">&lt;5&gt;WORKDIR - 设置工作目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ENV-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">&lt;6&gt;ENV - 设置环境变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ARG-%E6%9E%84%E5%BB%BA%E6%97%B6%E5%8F%98%E9%87%8F"><span class="nav-text">&lt;7&gt;ARG - 构建时变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EXPOSE-%E5%A3%B0%E6%98%8E%E7%AB%AF%E5%8F%A3"><span class="nav-text">&lt;8&gt;EXPOSE - 声明端口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMD-%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">&lt;9&gt;CMD - 容器启动命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ENTRYPOINT-%E5%85%A5%E5%8F%A3%E7%82%B9"><span class="nav-text">&lt;10&gt;ENTRYPOINT - 入口点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#USER-%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7"><span class="nav-text">&lt;11&gt;USER - 切换用户</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81docker-compose-%E5%9C%A8C-%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">三、docker-compose 在C++中的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%A4%9A%E5%AE%B9%E5%99%A8%EF%BC%9F"><span class="nav-text">1.为什么需要多容器？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-docker-compose%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7"><span class="nav-text">2.docker-compose的必要性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-C-%E9%80%9A%E7%94%A8-docker-compose-yml-%E6%A8%A1%E6%9D%BF"><span class="nav-text">3.C++ 通用 docker-compose.yml 模板</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E8%AF%A6%E7%BB%86%E7%89%88%EF%BC%88%E5%B8%A6%E6%B3%A8%E9%87%8A%EF%BC%89"><span class="nav-text">（1）详细版（带注释）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%B2%BE%E7%AE%80%E7%89%88%EF%BC%88%E6%97%A0%E6%B3%A8%E9%87%8A%EF%BC%89"><span class="nav-text">（2）精简版（无注释）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%A2%9E%E5%8A%A0kafka%E3%80%81zookeeper-%E7%89%88"><span class="nav-text">（3）增加kafka、zookeeper 版</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-docker-compose-yml-%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%AF%A6%E8%A7%A3"><span class="nav-text">4.docker-compose.yml 配置项详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89build-vs-image"><span class="nav-text">（1）build vs image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89ports-%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="nav-text">（2）ports - 端口映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89volumes-%E7%9B%AE%E5%BD%95%E6%8C%82%E8%BD%BD"><span class="nav-text">（3）volumes - 目录挂载</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AA%E7%94%A8-COPY%EF%BC%88%E4%B8%8D%E6%8C%82%E8%BD%BD%EF%BC%89"><span class="nav-text">&lt;1&gt;只用 COPY（不挂载）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#COPY-volumes-%E8%A6%86%E7%9B%96%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="nav-text">&lt;2&gt;COPY + volumes 覆盖（推荐）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%E5%AF%B9%E6%AF%94"><span class="nav-text">&lt;3&gt;工作流程对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89environment-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="nav-text">（4）environment - 环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89depends-on-%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-text">（5）depends_on - 依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89networks-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="nav-text">（6）networks - 网络配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89healthcheck-%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="nav-text">（7）healthcheck - 健康检查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%9C%8D%E5%8A%A1%E7%9A%84-healthcheck-%E5%86%99%E6%B3%95"><span class="nav-text">&lt;1&gt; 常见服务的 healthcheck 写法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#healthcheck-%E4%B8%8E-depends-on-%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8"><span class="nav-text">&lt;2&gt;healthcheck 与 depends_on 配合使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-text">&lt;3&gt; 容器健康状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-docker-compose-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-text">5. docker-compose 常用命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%85%B8%E5%9E%8B-C-%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">6. 典型 C++ 项目结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E6%A8%A1%E6%9D%BF%E8%8E%B7%E5%8F%96%E9%80%94%E5%BE%84"><span class="nav-text">7.第三方服务官方镜像模板获取途径</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Docker-Hub%EF%BC%88%E4%B8%BB%E8%A6%81%E9%80%94%E5%BE%84%EF%BC%89"><span class="nav-text">（1）Docker Hub（主要途径）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%B8%B8%E7%94%A8%E5%AE%98%E6%96%B9%E9%95%9C%E5%83%8F%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="nav-text">（2）常用官方镜像速查表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E9%95%9C%E5%83%8F%E9%A1%B5%E9%9D%A2%E5%85%B3%E9%94%AE%E4%BF%A1%E6%81%AF%E4%BD%8D%E7%BD%AE"><span class="nav-text">（3）镜像页面关键信息位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BB%8E-Docker-Hub-%E6%8F%90%E5%8F%96-docker-compose-%E9%85%8D%E7%BD%AE"><span class="nav-text">（4）从 Docker Hub 提取 docker-compose 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BF%AB%E9%80%9F%E6%9F%A5%E7%9C%8B%E9%95%9C%E5%83%8F%E4%BF%A1%E6%81%AF"><span class="nav-text">（5）命令行快速查看镜像信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81-dockerignore-%E6%96%87%E4%BB%B6%E5%9C%A8C-%E4%B8%AD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">四、 .dockerignore 文件在C++中的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-dockerignore"><span class="nav-text">1.什么是 .dockerignore</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">2.工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">3.基本语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-C-%E9%A1%B9%E7%9B%AE-dockerignore-%E6%A8%A1%E6%9D%BF"><span class="nav-text">4.C++ 项目 .dockerignore 模板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-text">5.常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%BD%E7%95%A5-Dockerfile%EF%BC%9F"><span class="nav-text">（1）为什么忽略 Dockerfile？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%AA%8C%E8%AF%81-dockerignore-%E6%98%AF%E5%90%A6%E7%94%9F%E6%95%88"><span class="nav-text">（2）验证 .dockerignore 是否生效</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE"><span class="nav-text">6.文件位置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81Docker-%E8%BE%85%E5%8A%A9%E5%BC%80%E5%8F%91"><span class="nav-text">五、Docker 辅助开发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Docker%E7%9A%84%E4%B8%A4%E7%A7%8D%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.Docker的两种使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Docker%E8%BE%85%E5%8A%A9%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-text">2.Docker辅助开发流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8E%9F%E7%90%86"><span class="nav-text">（1）原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%B8%8B%E8%BD%BD%E2%80%9C%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%93%E2%80%9D"><span class="nav-text">（2）客户端下载“客户端库”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89docker-compse-dev-yml%E7%9A%84%E7%BC%96%E5%86%99%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="nav-text">（3）docker-compse.dev.yml的编写与使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%951%EF%BC%9AC-%E5%90%8E%E7%AB%AF%E5%B8%B8%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BA%93%E5%AE%89%E8%A3%85"><span class="nav-text">附录1：C++ 后端常用客户端库安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Ubuntu-Debian-%E5%AE%89%E8%A3%85%E5%91%BD%E4%BB%A4"><span class="nav-text">1.Ubuntu&#x2F;Debian 安装命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="nav-text">2.速查表</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="咸鱼"
      src="/images/xianyu.jpg">
  <p class="site-author-name" itemprop="name">咸鱼</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">68</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xianyubuxian-TXY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xianyubuxian-TXY" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xianyubuxian-txy.github.io/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xianyu.jpg">
      <meta itemprop="name" content="咸鱼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xianyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Docker的使用 | Xianyu">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Docker的使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-22 23:20:59" itemprop="dateCreated datePublished" datetime="2026-01-22T23:20:59+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-25 09:08:29" itemprop="dateModified" datetime="2026-01-25T09:08:29+08:00">2026-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">C++后端开发库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">Docker的使用</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>15k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>51 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><strong>注！！：本文章主要聚焦于“Docker辅助开发模式”</strong></p>
<h1 id="一、Docker概述"><a href="#一、Docker概述" class="headerlink" title="一、Docker概述"></a>一、Docker概述</h1><h2 id="1-Docker技术的用途（先有个印象即可）"><a href="#1-Docker技术的用途（先有个印象即可）" class="headerlink" title="1.Docker技术的用途（先有个印象即可）"></a>1.Docker技术的用途（先有个印象即可）</h2><p>在之后的章节你会学到<strong>Dockerfile</strong>与<strong>docker-compose</strong>，先明确：</p>
<ul>
<li>Dockerfile主要用于“<strong>部署阶段</strong>”，但它是学习docker-compose的基础</li>
<li>docker-compose即可用于“<strong>辅助开发</strong>”，也用于“<strong>部署阶段</strong>”</li>
</ul>
<h3 id="（1）三种开发模式"><a href="#（1）三种开发模式" class="headerlink" title="（1）三种开发模式"></a>（1）三种开发模式</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124104624779.png"></p>
<ul>
<li>宿主机开发就不介绍了，主要介绍一下<strong>Docker辅助开发</strong>、<strong>全Docker开发</strong></li>
</ul>
<h3 id="（2）Docker辅助开发（推荐）"><a href="#（2）Docker辅助开发（推荐）" class="headerlink" title="（2）Docker辅助开发（推荐）"></a>（2）Docker辅助开发（推荐）</h3><ul>
<li>我们还是像日常开发一样在宿主机上写项目代码、编译项目，但<strong>第三方服务端</strong>通过<strong>docker-compose</strong>一键编排安装启动，无需在宿主机手动配置服务环境；<ul>
<li>我们日常开发时如果要使用第三方服务（比如mysql、redis等），是不是要去下载对应的第三方库，进行安装编译，最终运行“<strong>服务端</strong>”为我们提供服务</li>
<li><strong>这个过程很麻烦耗时</strong></li>
</ul>
</li>
<li><strong>注意</strong>：我们<strong>还是要去下载第三方服务的“客户端”</strong><ul>
<li>因为我们要用到<strong>第三方服务客户端的“头文件”</strong>，编译时需要</li>
</ul>
</li>
<li><strong>疑惑</strong>：那不还是要去下载第三方库吗？<ul>
<li>第三方库的安装、编译主要是为了得到并运行第三方库的 <strong>服务端</strong> 程序（最耗时），但我们下载只需要 <strong>客户端头文件</strong> 就可以了啊</li>
<li>第三方库的<strong>客户端</strong>通过命令行很容易就可以获取了</li>
</ul>
</li>
<li><strong>一句话总结</strong>：<ul>
<li><strong>服务端安装是”大头”，Docker 帮你搞定大头；客户端开发库本来就是”小事”，apt 一下就完了。</strong></li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    关键区分：客户端 vs 服务端                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   第三方库 = 客户端开发库（头文件+.so） + 服务端程序                        │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌────────────────────────┐    ┌────────────────────────┐             │</span><br><span class="line">│   │   客户端开发库          │    │   服务端程序            │             │</span><br><span class="line">│   │   libmysqlclient-dev   │    │   MySQL Server         │             │</span><br><span class="line">│   ├────────────────────────┤    ├────────────────────────┤             │</span><br><span class="line">│   │   安装方式：            │    │   传统安装方式：        │             │</span><br><span class="line">│   │   apt install 一条命令  │    │   下载 → 配置 → 初始化  │             │</span><br><span class="line">│   │   耗时：几秒            │    │   → 启动 → 排查问题     │             │</span><br><span class="line">│   │   难度：★☆☆☆☆         │    │   耗时：几十分钟~几小时  │             │</span><br><span class="line">│   │                        │    │   难度：★★★★☆         │             │</span><br><span class="line">│   └────────────────────────┘    └────────────────────────┘             │</span><br><span class="line">│              ↑                               ↑                          │</span><br><span class="line">│         宿主机安装（简单）              Docker 代劳（省事！）              │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（3）全Docker开发（了解）"><a href="#（3）全Docker开发（了解）" class="headerlink" title="（3）全Docker开发（了解）"></a>（3）全Docker开发（了解）</h3><ul>
<li>从“代码编写、编译、运行到调试”的<strong>全流程均在Docker容器内完成</strong></li>
<li>宿主机仅负责存储代码、操作IDE界面，不直接参与编译环境的支撑</li>
<li>典型实现：VSCode Dev Container、JetBrains Gateway</li>
<li>宿主机需要安装什么？<ul>
<li>只需要：Docker、Docker Compose、代码编辑器（VSCode）</li>
<li>不需要：gcc、cmake、libmysqlclient-dev 等任何开发依赖</li>
</ul>
</li>
<li><strong>一句话总结</strong>：<ul>
<li>宿主机只当”显示器+键盘”，所有脏活累活都在容器里干。</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    全Docker开发 vs Docker辅助开发                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【Docker辅助开发】                    【全Docker开发】                  │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   宿主机                                宿主机                           │</span><br><span class="line">│   ┌──────────────────┐                 ┌──────────────────┐            │</span><br><span class="line">│   │ 源代码            │                 │ 源代码（挂载）    │            │</span><br><span class="line">│   │ gcc, cmake       │                 │ VSCode (界面)    │            │</span><br><span class="line">│   │ libmysqlclient-dev│                 │                  │            │</span><br><span class="line">│   │ 编译、调试        │                 │ 只负责编辑和显示   │            │</span><br><span class="line">│   └────────┬─────────┘                 └────────┬─────────┘            │</span><br><span class="line">│            │ 连接                                │ 挂载+远程连接         │</span><br><span class="line">│            ▼                                    ▼                       │</span><br><span class="line">│   Docker容器                            Docker容器                       │</span><br><span class="line">│   ┌──────────────────┐                 ┌──────────────────┐            │</span><br><span class="line">│   │ MySQL Server     │                 │ gcc, cmake       │            │</span><br><span class="line">│   │ Redis Server     │                 │ 所有 -dev 库     │            │</span><br><span class="line">│   │ Kafka Server     │                 │ MySQL/Redis 服务  │            │</span><br><span class="line">│   │ （只有服务端）    │                 │ 编译、运行、调试   │            │</span><br><span class="line">│   └──────────────────┘                 │ （全部在容器内）   │            │</span><br><span class="line">│                                        └──────────────────┘            │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         适用场景对比                                     │</span><br><span class="line">├────────────────────────────┬────────────────────────────────────────────┤</span><br><span class="line">│      Docker辅助开发         │         全Docker开发                       │</span><br><span class="line">├────────────────────────────┼────────────────────────────────────────────┤</span><br><span class="line">│  ✓ 个人开发、小团队         │  ✓ 团队强制环境一致                        │</span><br><span class="line">│  ✓ 追求调试速度             │  ✓ Windows/macOS 开发 Linux 程序           │</span><br><span class="line">│  ✓ 熟悉本地开发习惯         │  ✓ 多项目环境完全隔离                      │</span><br><span class="line">│  ✗ 环境需手动维护           │  ✗ 调试略慢，需学习成本                    │</span><br><span class="line">├────────────────────────────┴────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│  🌟 推荐：大多数 C++ 项目用【Docker辅助开发】即可                         │</span><br><span class="line">│     全Docker开发更适合团队协作或跨平台场景                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<h2 id="2-Docker是什么？"><a href="#2-Docker是什么？" class="headerlink" title="2.Docker是什么？"></a>2.Docker是什么？</h2><p><strong>Docker &#x3D; 把程序和它需要的环境打包在一起，走哪都能跑，用完即删不留垃圾</strong><br>Docker 是一个<strong>开源的容器化平台</strong>，通过<strong>操作系统级虚拟化技术</strong>，将应用及其依赖打包成轻量级、可移植的容器。</p>
<ul>
<li>Docker 容器<strong>共享宿主机的内核</strong>，只<strong>隔离用户空间</strong>（文件系统、进程、网络等），而不是虚拟化完整的操作系统。</li>
<li>Docker 容器使用<strong>基础镜像（如 Ubuntu 镜像）提供文件系统环境</strong>，然后将程序<strong>依赖的第三方服务（如 MySQL、Redis）以容器形式运行</strong>，你的程序就可以在这个隔离的环境中运行了。</li>
<li><strong>核心</strong>：<ul>
<li>通过容器技术，为程序打包并隔离出所需的运行环境（文件系统、依赖库、配置等），使程序在这个独立的环境中运行，与宿主机和其他容器互不干扰。</li>
<li><strong>注意</strong>：Docker 是<strong>容器化</strong>，不是虚拟化。它不虚拟化硬件或完整 OS，而是<strong>共享宿主机内核</strong>，只隔离用户空间</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Docker 核心                          │</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                        │</span><br><span class="line">│   你的程序 + 依赖 + 运行环境  ──→  打包成镜像            │</span><br><span class="line">│                                     │                  │</span><br><span class="line">│                                     ▼                  │</span><br><span class="line">│                              ┌─────────────┐           │</span><br><span class="line">│                              │   容器      │           │</span><br><span class="line">│                              │ (隔离环境)  │           │</span><br><span class="line">│                              └──────┬──────┘           │</span><br><span class="line">│                                     │                  │</span><br><span class="line">│                              共享宿主机内核             │</span><br><span class="line">│                                                        │</span><br><span class="line">│   关键词：打包、隔离、可移植、轻量                       │</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Docker 容器运行原理                          │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │                    Docker 容器                           │   │</span><br><span class="line">│   │  ┌─────────────────────────────────────────────────┐    │   │</span><br><span class="line">│   │  │              你的应用程序                         │    │   │</span><br><span class="line">│   │  ├─────────────────────────────────────────────────┤    │   │</span><br><span class="line">│   │  │         依赖库 (MySQL, Redis 客户端等)            │    │   │</span><br><span class="line">│   │  ├─────────────────────────────────────────────────┤    │   │</span><br><span class="line">│   │  │      基础镜像的文件系统 (如 Ubuntu 的 /bin, /lib) │    │   │</span><br><span class="line">│   │  └─────────────────────────────────────────────────┘    │   │</span><br><span class="line">│   │                    ↓ 共享内核 ↓                          │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘   │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │                   宿主机 Linux 内核                      │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘   │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │                      硬件                                │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="3-Docker-三大核心概念"><a href="#3-Docker-三大核心概念" class="headerlink" title="3.Docker 三大核心概念"></a>3.Docker 三大核心概念</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Docker 三要素                             │</span><br><span class="line">├──────────────┬──────────────────────────────────────────────┤</span><br><span class="line">│    镜像      │  只读模板，相当于<span class="string">&quot;安装包&quot;</span>                      │</span><br><span class="line">│   (Image)    │  例：ubuntu:<span class="number">22.04</span>, mysql:<span class="number">8.0</span>                 │</span><br><span class="line">├──────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│    容器      │  镜像的运行实例，相当于<span class="string">&quot;运行中的程序&quot;</span>          │</span><br><span class="line">│ (Container)  │  可以启动、停止、删除                         │</span><br><span class="line">├──────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│    仓库      │  存放镜像的地方                               │</span><br><span class="line">│ (Registry)   │  Docker Hub 是官方公共仓库                   │</span><br><span class="line">└──────────────┴──────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">类比理解：</span><br><span class="line">  镜像 = 类(Class)</span><br><span class="line">  容器 = 对象(Object/实例)</span><br><span class="line">  仓库 = GitHub（存代码） → Docker Hub（存镜像）</span><br></pre></td></tr></table></figure>
<p><strong>Docer工作流</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编写 Dockerfile → 构建镜像(build) → 运行容器(run)</span><br><span class="line">     ↓                 ↓                 ↓</span><br><span class="line">   <span class="string">&quot;菜谱&quot;</span>           <span class="string">&quot;做好的菜&quot;</span>        <span class="string">&quot;端上桌开吃&quot;</span></span><br></pre></td></tr></table></figure>


<h2 id="4-Docker技术的优势"><a href="#4-Docker技术的优势" class="headerlink" title="4.Docker技术的优势"></a>4.Docker技术的优势</h2><h3 id="（1）快速获取第三方服务的“服务端”"><a href="#（1）快速获取第三方服务的“服务端”" class="headerlink" title="（1）快速获取第三方服务的“服务端”"></a>（1）快速获取第三方服务的“服务端”</h3><ul>
<li>在前面我们提到：<ul>
<li><strong>第三方服务的“客户端”</strong>：我们可以通过命令行快速获取</li>
<li><strong>第三方服务的“服务端”</strong>：传统情况我们需要去下载、配置、编译、运行，这个过程繁琐费时，但<strong>通过Docker，配置好后，一键启动即可</strong>。</li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    开发效率对比                               │</span><br><span class="line">├────────────────────────┬─────────────────────────────────────┤</span><br><span class="line">│       传统方式          │            Docker 方式              │</span><br><span class="line">├────────────────────────┼─────────────────────────────────────┤</span><br><span class="line">│  MySQL: 下载→安装→配置  │  docker run mysql:8.0              │</span><br><span class="line">│  Redis: 下载→安装→配置  │  docker run redis:7                │</span><br><span class="line">│  Kafka: 下载→Java→ZK   │  docker compose up kafka           │</span><br><span class="line">├────────────────────────┼─────────────────────────────────────┤</span><br><span class="line">│  耗时：数小时           │  耗时：几分钟                       │</span><br><span class="line">└────────────────────────┴─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）环境隔离，不污染主机"><a href="#（2）环境隔离，不污染主机" class="headerlink" title="（2）环境隔离，不污染主机"></a>（2）环境隔离，不污染主机</h3><ul>
<li>通过 Docker 运行的服务都在容器内部，<strong>不会将软件安装到宿主机上</strong>，<strong>删除容器即可完全清理</strong>，不留任何残留。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   宿主机（保持干净）                          │</span><br><span class="line">│  ┌───────────────────────────────────────────────────────┐  │</span><br><span class="line">│  │                   Docker Engine                       │  │</span><br><span class="line">│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │  │</span><br><span class="line">│  │  │  MySQL  │  │  Redis  │  │  Nginx  │  │  Kafka  │  │  │</span><br><span class="line">│  │  │  容器   │  │  容器   │  │  容器   │  │  容器   │  │  │</span><br><span class="line">│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │  │</span><br><span class="line">│  │                                                       │  │</span><br><span class="line">│  │     ✓ 所有服务都在容器中，宿主机系统保持干净            │  │</span><br><span class="line">│  │     ✓ docker rm 删除容器，即可完全清理                 │  │</span><br><span class="line">│  └───────────────────────────────────────────────────────┘  │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（3）提高程序可移植性"><a href="#（3）提高程序可移植性" class="headerlink" title="（3）提高程序可移植性"></a>（3）提高程序可移植性</h3><ul>
<li>问题场景：<ul>
<li>我们在 Ubuntu 上开发的程序，拿到 CentOS 上运行，可能因为系统差异（库版本、路径不同等）导致运行失败</li>
<li>依赖的第三方服务（MySQL、Redis），每换一台电脑都要重新下载安装，还可能出现版本不匹配的问题<br>Docker 解决方案：</li>
<li>开发完通过<strong>Dockerfile进行部署</strong>，将程序和依赖<strong>打包成镜像</strong></li>
<li>在任何提供 <strong>Linux 内核环境</strong> 的机器上都能以相同方式运行<ul>
<li>Linux 服务器：直接运行（生产环境）</li>
<li>Windows (WSL2) &#x2F; macOS (Docker Desktop)：通过内置 Linux VM 运行（开发环境）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>注意：</strong><br>	- 因为Docker与所在主机<strong>共享内核</strong>，这也是限制Docker的因素之一</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                             │</span><br><span class="line">│   传统方式的问题：                                           │</span><br><span class="line">│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │</span><br><span class="line">│   │ 开发机    │    │ 测试机    │    │ 生产机    │             │</span><br><span class="line">│   │ Ubuntu   │    │ CentOS   │    │ Debian   │             │</span><br><span class="line">│   │ MySQL<span class="number">5.7</span> │    │ MySQL<span class="number">8.0</span> │    │ MySQL<span class="number">5.6</span> │             │</span><br><span class="line">│   └──────────┘    └──────────┘    └──────────┘             │</span><br><span class="line">│        ↓               ↓               ↓                    │</span><br><span class="line">│   <span class="string">&quot;我这能跑&quot;</span>      <span class="string">&quot;怎么报错了&quot;</span>    <span class="string">&quot;版本不兼容&quot;</span>               │</span><br><span class="line">│                                                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                             │</span><br><span class="line">│   Docker 方式：同一镜像，处处运行                             │</span><br><span class="line">│   ┌──────────┐    ┌──────────┐    ┌──────────┐             │</span><br><span class="line">│   │ 开发机    │    │ 测试机    │    │ 生产机    │             │</span><br><span class="line">│   │          │    │          │    │          │             │</span><br><span class="line">│   │ ┌──────┐ │    │ ┌──────┐ │    │ ┌──────┐ │             │</span><br><span class="line">│   │ │ 同一 │ │    │ │ 同一 │ │    │ │ 同一 │ │             │</span><br><span class="line">│   │ │ 镜像 │ │    │ │ 镜像 │ │    │ │ 镜像 │ │             │</span><br><span class="line">│   │ └──────┘ │    │ └──────┘ │    │ └──────┘ │             │</span><br><span class="line">│   └──────────┘    └──────────┘    └──────────┘             │</span><br><span class="line">│        ↓               ↓               ↓                    │</span><br><span class="line">│              环境完全一致，运行结果一致                       │</span><br><span class="line">│                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（4）版本管理与多版本共存"><a href="#（4）版本管理与多版本共存" class="headerlink" title="（4）版本管理与多版本共存"></a>（4）版本管理与多版本共存</h3><ul>
<li>我们可以创建多个 Docker 容器，运行不同版本的服务，互不干扰。而传统方式在同一台机器上安装多个版本的 MySQL 几乎无法实现。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 同一台机器同时运行 MySQL <span class="number">5.7</span> 和 MySQL <span class="number">8.0</span></span><br><span class="line">docker run -d --name mysql57 -p <span class="number">3306</span>:<span class="number">3306</span> mysql:<span class="number">5.7</span></span><br><span class="line">docker run -d --name mysql80 -p <span class="number">3307</span>:<span class="number">3306</span> mysql:<span class="number">8.0</span></span><br><span class="line"></span><br><span class="line"># 同一台机器同时运行 Redis <span class="number">6</span> 和 Redis <span class="number">7</span></span><br><span class="line">docker run -d --name redis6 -p <span class="number">6379</span>:<span class="number">6379</span> redis:<span class="number">6</span></span><br><span class="line">docker run -d --name redis7 -p <span class="number">6380</span>:<span class="number">6379</span> redis:<span class="number">7</span></span><br></pre></td></tr></table></figure>

<h3 id="（5）快速部署与回滚"><a href="#（5）快速部署与回滚" class="headerlink" title="（5）快速部署与回滚"></a>（5）快速部署与回滚</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 部署新版本</span><br><span class="line">docker stop myapp &amp;&amp; docker run -d myapp:v<span class="number">2.0</span></span><br><span class="line"></span><br><span class="line"># 发现问题？秒级回滚</span><br><span class="line">docker stop myapp &amp;&amp; docker run -d myapp:v<span class="number">1.0</span></span><br></pre></td></tr></table></figure>

<h3 id="（6）资源利用率高"><a href="#（6）资源利用率高" class="headerlink" title="（6）资源利用率高"></a>（6）资源利用率高</h3><ul>
<li>Docker 与虚拟机都是隔离技术，但原理完全不同：<ul>
<li><strong>虚拟机</strong>：需要虚拟化完整的硬件和操作系统，每个虚拟机都运行一个独立的 OS 内核</li>
<li><strong>Docker</strong>：共享宿主机内核，只隔离用户空间，因此更加轻量</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                         │</span><br><span class="line">│          传统虚拟机架构                      Docker 容器架构             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌───────────────────────────┐       ┌───────────────────────────┐    │</span><br><span class="line">│   │  App A │ App B │ App C    │       │  App A │ App B │ App C    │    │</span><br><span class="line">│   ├────────┼───────┼──────────┤       ├────────┴───────┴──────────┤    │</span><br><span class="line">│   │ Bins/  │ Bins/ │ Bins/    │       │       Bins/Libs           │    │</span><br><span class="line">│   │ Libs   │ Libs  │ Libs     │       ├───────────────────────────┤    │</span><br><span class="line">│   ├────────┼───────┼──────────┤       │      Docker Engine        │    │</span><br><span class="line">│   │Guest OS│Guest  │Guest OS  │       ├───────────────────────────┤    │</span><br><span class="line">│   │(完整)  │OS     │(完整)    │       │   <span class="function">Host <span class="title">OS</span> <span class="params">(共享内核)</span>       │    │</span></span><br><span class="line"><span class="function">│   ├────────┴───────┴──────────┤       ├───────────────────────────┤    │</span></span><br><span class="line"><span class="function">│   │        Hypervisor         │       │        Hardware           │    │</span></span><br><span class="line"><span class="function">│   ├───────────────────────────┤       └───────────────────────────┘    │</span></span><br><span class="line"><span class="function">│   │         Host OS           │                                        │</span></span><br><span class="line"><span class="function">│   ├───────────────────────────┤         ✓ 秒级启动                     │</span></span><br><span class="line"><span class="function">│   │        Hardware           │         ✓ MB 级资源占用                │</span></span><br><span class="line"><span class="function">│   └───────────────────────────┘         ✓ 共享内核，性能接近原生        │</span></span><br><span class="line"><span class="function">│                                                                         │</span></span><br><span class="line"><span class="function">│     ✗ 分钟级启动                                                        │</span></span><br><span class="line"><span class="function">│     ✗ GB 级资源占用                                                     │</span></span><br><span class="line"><span class="function">│     ✗ 每个VM都有完整OS开销                                              │</span></span><br><span class="line"><span class="function">│                                                                         │</span></span><br><span class="line"><span class="function">└─────────────────────────────────────────────────────────────────────────┘</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123002543362.png"></p>
<h2 id="5-Docker的局限"><a href="#5-Docker的局限" class="headerlink" title="5.Docker的局限"></a>5.Docker的局限</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Docker 的局限：                                            │</span><br><span class="line">│                                                            │</span><br><span class="line">│  【内核依赖】                                                │</span><br><span class="line">│  • Linux 容器只能跑 Linux 程序（共享内核的代价）             │</span><br><span class="line">│  • Windows/macOS 上跑 Docker 实际是通过 Linux VM           │</span><br><span class="line">│                                                            │</span><br><span class="line">│  【应用场景限制】                                            │</span><br><span class="line">│  • GUI 程序支持不好（主要面向服务端/后台程序）               │</span><br><span class="line">│  • 对内核版本有要求的程序可能有兼容问题                      │</span><br><span class="line">│                                                            │</span><br><span class="line">│  【学习成本】                                                │</span><br><span class="line">│  • 需要学习新的调试方式（容器内 GDB 需要特殊配置）           │</span><br><span class="line">│  • 网络、存储、日志等配置有学习曲线                          │</span><br><span class="line">│                                                            │</span><br><span class="line">│  【其他】                                                    │</span><br><span class="line">│  • 数据持久化需要额外配置（Volume）                          │</span><br><span class="line">│  • 容器间通信需要理解 Docker 网络模型                        │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h1 id="二、Docker在C-中的使用"><a href="#二、Docker在C-中的使用" class="headerlink" title="二、Docker在C++中的使用"></a>二、Docker在C++中的使用</h1><h2 id="1-Docker在C-开发中的价值"><a href="#1-Docker在C-开发中的价值" class="headerlink" title="1.Docker在C++开发中的价值"></a>1.Docker在C++开发中的价值</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    C++ 开发的痛点                                       │</span><br><span class="line">├────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                        │</span><br><span class="line">│  <span class="number">1.</span> 编译环境复杂：gcc版本、cmake版本、各种库的版本...                     │</span><br><span class="line">│  <span class="number">2.</span> 依赖安装麻烦：gRPC、Protobuf、MySQL客户端库、Redis客户端库...        │</span><br><span class="line">│  <span class="number">3.</span> 环境不一致：<span class="string">&quot;我电脑上能编译，你那怎么报错了？&quot;</span>                        │</span><br><span class="line">│  <span class="number">4.</span> 部署困难：编译好的程序换台机器就跑不起来（缺少动态库）                 │</span><br><span class="line">│                                                                        │</span><br><span class="line">├────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                    Docker 解决方案                                      │</span><br><span class="line">├────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                        │</span><br><span class="line">│  ✓ 统一构建环境：所有人用同一个 Docker 镜像编译                          │</span><br><span class="line">│  ✓ 依赖一次配置：Dockerfile 写好后，一条命令安装所有依赖                  │</span><br><span class="line">│  ✓ 环境完全一致：开发、测试、生产用同一个镜像                            │</span><br><span class="line">│  ✓ 部署简单：镜像包含所有运行时依赖，走哪都能跑                          │</span><br><span class="line">│                                                                        │</span><br><span class="line">└────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="2-Dockerfile详解（C-）"><a href="#2-Dockerfile详解（C-）" class="headerlink" title="2.Dockerfile详解（C++）"></a>2.Dockerfile详解（C++）</h2><ul>
<li><strong>Dockerfile的主要用途</strong>：<ul>
<li>在开发完项目过后，<strong>用于项目的部署</strong></li>
</ul>
</li>
<li>对于 <strong>“Docker辅助开发”模式</strong>：<ul>
<li>主要用 docker-compose 来启动第三方服务（MySQL、Redis等），Dockerfile 几乎不用</li>
<li><strong>但学习Dockerfile有助于学习docker-compose</strong></li>
</ul>
</li>
<li>对于 <strong>“全Docker开发”模式</strong>：<ul>
<li>可能会用到 Dockerfile 来构建开发环境镜像</li>
</ul>
</li>
<li><strong>阅读顺序建议</strong>：<ul>
<li><strong>（2）——&gt;（3）——&gt;（1）</strong></li>
</ul>
</li>
</ul>
<h3 id="（1）Dockerfile的构造流程（多阶段构造）"><a href="#（1）Dockerfile的构造流程（多阶段构造）" class="headerlink" title="（1）Dockerfile的构造流程（多阶段构造）"></a>（1）Dockerfile的构造流程（多阶段构造）</h3><ul>
<li><strong>Dockerfile &#x3D; 镜像的”配方”</strong>：<ul>
<li>告诉 Docker 如何一步步构建出你需要的<strong>镜像</strong></li>
</ul>
</li>
<li><strong>其实就和在宿主机上构建项目、编译项目、运行项目类似，只是指令与命令行指令不太一样</strong></li>
</ul>
<h4 id="构建阶段（第一个-FROM）"><a href="#构建阶段（第一个-FROM）" class="headerlink" title="&lt;1&gt; 构建阶段（第一个 FROM）"></a>&lt;1&gt; 构建阶段（第一个 FROM）</h4><ul>
<li><strong>目的</strong>：<ul>
<li><strong>在镜像中编译代码，生成可执行文件</strong></li>
</ul>
</li>
<li><strong>步骤</strong>：<ul>
<li>1.在镜像中搭建依赖的系统环境（From命令）</li>
<li>2.设置镜像中的环境变量（ENV命令）</li>
<li>3.设置镜像中的工作目录（WORKDIR命令）</li>
<li>4.切换到工作目录中<ul>
<li>之后的操作就在工作目录中进行了</li>
</ul>
</li>
<li>5.下载你项目所依赖的编译工具、第三方库到镜像中（RUN命令）</li>
<li>6.将你的项目文件复制到镜像中（COPY命令）<ul>
<li>你的项目文件、依赖的系统环境、编译工具、第三方库等都到了镜像中，那么就可以在镜像中编译你的项目了</li>
</ul>
</li>
<li>7.设置在镜像中的编译、链接命令（RUN命令）<ul>
<li>如：<strong>执行“CMake文件”</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="运行阶段（多阶段构建的第二个-FROM，仍在-docker-build-时执行）"><a href="#运行阶段（多阶段构建的第二个-FROM，仍在-docker-build-时执行）" class="headerlink" title="&lt;2&gt;运行阶段（多阶段构建的第二个 FROM，仍在 docker build 时执行）"></a>&lt;2&gt;运行阶段（多阶段构建的第二个 FROM，仍在 docker build 时执行）</h4><ul>
<li><strong>目的</strong>：<ul>
<li><strong>运行可执行文件，生成最终的轻量镜像</strong></li>
</ul>
</li>
<li><strong>步骤</strong>：<ul>
<li>1.在镜像中搭建依赖的系统环境（FROM命令）<ul>
<li>“构建阶段”得到的可执行文件才可以正常运行</li>
</ul>
</li>
<li>2.下载<strong>可执行文件</strong>运行时需要的动态库（RUN命令）<ul>
<li>在“构建阶段”，<strong>头文件</strong>（自定义、第三方库等）在预编译时就通过<code>#include</code>被插入到源文件中了，所以不再需要头文件了</li>
<li>对于<strong>静态库</strong>（自己生成、第三库等），静态库在链接时，就被与目标文件链接到一起生成可执行文件了</li>
<li>综上：<strong>只需要下载第三方库的动态库就可以了</strong><ul>
<li>我们自己生成的动态库已经有了</li>
<li>对于动态库，可执行文件执行时自己去找</li>
</ul>
</li>
</ul>
</li>
<li>3.从构建阶段复制可执行文件（COPY）</li>
<li>4.设置在镜像中执行可执行文件的命令（CMD命令）</li>
</ul>
</li>
</ul>
<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="&lt;3&gt;执行流程"></a>&lt;3&gt;执行流程</h4><ul>
<li><strong>docker build</strong>：执行 Dockerfile 中所有指令（包括两个阶段），<strong>生成最终镜像</strong></li>
<li><strong>docker run</strong>：基于镜像创建容器，执行 CMD 中记录的命令</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Dockerfile 工作流程                            │</span><br><span class="line">├──────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                  │</span><br><span class="line">│   Dockerfile          docker build           镜像 (Image)        │</span><br><span class="line">│   ┌──────────┐         ─────────→         ┌──────────────┐       │</span><br><span class="line">│   │ FROM ... │  ←─ 构建阶段               │ 可执行文件    │       │</span><br><span class="line">│   │ RUN ...  │                            │ + 运行时依赖  │       │</span><br><span class="line">│   │ FROM ... │  ←─ 运行阶段               └──────────────┘       │</span><br><span class="line">│   │ CMD ...  │                                    │              │</span><br><span class="line">│   └──────────┘                             docker run            │</span><br><span class="line">│                                                   ↓              │</span><br><span class="line">│                                            ┌──────────────┐      │</span><br><span class="line">│                                            │ 容器(执行CMD) │      │</span><br><span class="line">│                                            └──────────────┘      │</span><br><span class="line">└──────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="docker-build-与-docker-run-的关系"><a href="#docker-build-与-docker-run-的关系" class="headerlink" title="&lt;4&gt;docker build 与 docker run 的关系"></a>&lt;4&gt;docker build 与 docker run 的关系</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  docker build（构建镜像）                                        │</span><br><span class="line">│  ───────────────────────                                        │</span><br><span class="line">│  • 读取 Dockerfile，逐条执行指令                                 │</span><br><span class="line">│  • 每条指令生成一个镜像层                                        │</span><br><span class="line">│  • CMD 命令只是<span class="string">&quot;写入&quot;</span>镜像，此时不执行                            │</span><br><span class="line">│  • 最终输出：镜像文件                                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  docker run（运行容器）                                          │</span><br><span class="line">│  ──────────────────────                                         │</span><br><span class="line">│  • 基于镜像创建容器实例                                          │</span><br><span class="line">│  • 执行镜像中记录的 CMD 命令                                     │</span><br><span class="line">│  • 最终输出：运行中的容器                                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="各阶段需要的内容对比"><a href="#各阶段需要的内容对比" class="headerlink" title="&lt;5&gt;各阶段需要的内容对比"></a>&lt;5&gt;各阶段需要的内容对比</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────┬───────────────────────────────────┐</span><br><span class="line">│  构建阶段需要           │  运行阶段需要                      │</span><br><span class="line">├────────────────────────┼───────────────────────────────────┤</span><br><span class="line">│  ✓ 头文件 (.h)         │  ✗ 不需要（已预处理展开）          │</span><br><span class="line">│  ✓ 静态库 (.a)         │  ✗ 不需要（已链接进可执行文件）    │</span><br><span class="line">│  ✓ 编译器 (gcc)        │  ✗ 不需要                         │</span><br><span class="line">│  ✓ 构建工具 (cmake)    │  ✗ 不需要                         │</span><br><span class="line">│  ✓ 动态库 (.so)        │  ✓ 需要（运行时加载）              │</span><br><span class="line">│  ✓ 源代码              │  ✗ 不需要                         │</span><br><span class="line">│  ✗ 可执行文件          │  ✓ 需要（从构建阶段复制）          │</span><br><span class="line">└────────────────────────┴───────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）C-通用Dockerfile模板"><a href="#（2）C-通用Dockerfile模板" class="headerlink" title="（2）C++通用Dockerfile模板"></a>（2）C++通用Dockerfile模板</h3><h4 id="详细版（带类比注释）"><a href="#详细版（带类比注释）" class="headerlink" title="&lt;1&gt;详细版（带类比注释）"></a>&lt;1&gt;详细版（带类比注释）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                                                                         │</span><br><span class="line">│   你在自己电脑上编译 C++ 项目的步骤：                                      │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   <span class="number">1.</span> 装一个 Ubuntu 系统                                                  │</span><br><span class="line">│   <span class="number">2.</span> 打开终端，apt install 安装 gcc、cmake、各种库                        │</span><br><span class="line">│   <span class="number">3.</span> 把项目代码放到某个目录                                               │</span><br><span class="line">│   <span class="number">4.</span> cd 到那个目录                                                       │</span><br><span class="line">│   <span class="number">5.</span> mkdir build &amp;&amp; cd build &amp;&amp; cmake .. &amp;&amp; make                        │</span><br><span class="line">│   <span class="number">6.</span> 运行编译好的程序                                                    │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   Dockerfile 就是把这些步骤写下来，让 Docker 自动执行                      │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ╔═══════════════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="comment"># ║                        阶段一：构建阶段                                 ║</span></span><br><span class="line"><span class="comment"># ║     类比：你新装了一台电脑，要在上面配置编译环境、编译代码                  ║</span></span><br><span class="line"><span class="comment"># ╚═══════════════════════════════════════════════════════════════════════╝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># FROM = 我要基于什么系统来搭环境</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你去电脑城说：&quot;给我装个 Ubuntu 22.04&quot;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># AS builder 是给这个阶段起个名字，后面会用到</span></span><br><span class="line">FROM ubuntu:22.04 AS builder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># ENV = 设置环境变量</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你在 ~/.bashrc 里 export 一个变量</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># DEBIAN_FRONTEND=noninteractive 的作用：</span></span><br><span class="line"><span class="comment"># 正常 apt install 有时会弹出蓝色界面问你 yes/no</span></span><br><span class="line"><span class="comment"># 设置这个变量后，就不会弹窗，直接用默认选项（Docker 构建时没人能按键盘）</span></span><br><span class="line">ENV DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># RUN = 执行一条命令</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你打开终端，敲命令</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 下面这段等价于你在终端里敲：</span></span><br><span class="line"><span class="comment">#   sudo apt-get update</span></span><br><span class="line"><span class="comment">#   sudo apt-get install -y build-essential cmake git ...</span></span><br><span class="line"><span class="comment">#   sudo rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 为什么用 &amp;&amp; 连接而不是写多个 RUN？</span></span><br><span class="line"><span class="comment">#   每个 RUN 会创建一个&quot;镜像层&quot;，层越多镜像越大</span></span><br><span class="line"><span class="comment">#   用 &amp;&amp; 连接，所有命令在同一层执行，镜像更小</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    <span class="comment"># ┌─────────────────────────────────────────────────────────┐</span></span><br><span class="line">    <span class="comment"># │ 基础编译工具                                             │</span></span><br><span class="line">    <span class="comment"># │ 就像你编译 C++ 之前，肯定要先装 gcc 和 cmake             │</span></span><br><span class="line">    <span class="comment"># └─────────────────────────────────────────────────────────┘</span></span><br><span class="line">    build-essential \</span><br><span class="line">    <span class="comment"># ↑ 这个包包含 gcc, g++, make 等，装这一个就够了</span></span><br><span class="line">    cmake \</span><br><span class="line">    git \</span><br><span class="line">    pkg-config \</span><br><span class="line">    <span class="comment"># pkg-config 用来查找库的编译参数（比如 mysql 的头文件在哪）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ┌─────────────────────────────────────────────────────────┐</span></span><br><span class="line">    <span class="comment"># │ 项目依赖的第三方库（根据你的项目需求增删）                  │</span></span><br><span class="line">    <span class="comment"># │                                                         │</span></span><br><span class="line">    <span class="comment"># │ 注意：这里装的是 -dev 版本（开发版）                      │</span></span><br><span class="line">    <span class="comment"># │ -dev 版本包含头文件 .h，编译时需要                        │</span></span><br><span class="line">    <span class="comment"># │ 运行时只需要 .so 动态库，不需要头文件                      │</span></span><br><span class="line">    <span class="comment"># └─────────────────────────────────────────────────────────┘</span></span><br><span class="line">    libmysqlclient-dev \</span><br><span class="line">    <span class="comment"># ↑ MySQL 客户端库，编译时需要 mysql.h 头文件</span></span><br><span class="line">    libhiredis-dev \</span><br><span class="line">    <span class="comment"># ↑ Redis 客户端库（hiredis）</span></span><br><span class="line">    libgrpc++-dev \</span><br><span class="line">    libprotobuf-dev \</span><br><span class="line">    protobuf-compiler \</span><br><span class="line">    protobuf-compiler-grpc \</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ┌─────────────────────────────────────────────────────────┐</span></span><br><span class="line">    <span class="comment"># │ 清理 apt 缓存，减小镜像体积                               │</span></span><br><span class="line">    <span class="comment"># │ /var/lib/apt/lists/* 是 apt update 下载的软件包列表      │</span></span><br><span class="line">    <span class="comment"># │ 装完软件就没用了，删掉能省几十 MB                          │</span></span><br><span class="line">    <span class="comment"># └─────────────────────────────────────────────────────────┘</span></span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># WORKDIR = 切换工作目录</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你 cd /build</span></span><br><span class="line"><span class="comment">#        如果目录不存在，会自动 mkdir</span></span><br><span class="line"><span class="comment">#        之后的命令都在这个目录下执行</span></span><br><span class="line">WORKDIR /build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># COPY = 把文件从你的电脑复制到镜像里</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你用 U 盘把代码拷到新电脑上</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># COPY &lt;源路径&gt; &lt;目标路径&gt;</span></span><br><span class="line"><span class="comment"># COPY . . 的意思：</span></span><br><span class="line"><span class="comment">#   第一个 . = 当前目录（你执行 docker build 的目录，即&quot;构建上下文&quot;）</span></span><br><span class="line"><span class="comment">#   第二个 . = 镜像里的当前目录（刚才 WORKDIR 设置的 /build）</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 所以 COPY . . = 把项目目录下所有文件，复制到镜像的 /build 目录</span></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 编译项目</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你平时编译项目：</span></span><br><span class="line"><span class="comment">#   mkdir build</span></span><br><span class="line"><span class="comment">#   cd build  </span></span><br><span class="line"><span class="comment">#   cmake ..</span></span><br><span class="line"><span class="comment">#   make -j8</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># $(nproc) 会返回 CPU 核心数，比如 8 核就是 make -j8，并行编译更快</span></span><br><span class="line">RUN <span class="built_in">mkdir</span> -p build &amp;&amp; <span class="built_in">cd</span> build \</span><br><span class="line">    &amp;&amp; cmake .. -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">    &amp;&amp; make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ╔═══════════════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="comment"># ║                        阶段二：运行阶段                                 ║</span></span><br><span class="line"><span class="comment"># ║     类比：编译完了，你要把程序拷到另一台&quot;干净的服务器&quot;上运行               ║</span></span><br><span class="line"><span class="comment"># ║           那台服务器只需要能运行程序，不需要编译工具                      ║</span></span><br><span class="line"><span class="comment"># ╚═══════════════════════════════════════════════════════════════════════╝</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 【为什么要分两个阶段？】</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 构建阶段装了一堆东西：gcc、cmake、-dev 开发库、源代码... (可能 1GB+)</span></span><br><span class="line"><span class="comment"># 但运行程序时，这些都不需要！只需要：</span></span><br><span class="line"><span class="comment">#   1. 编译好的可执行文件</span></span><br><span class="line"><span class="comment">#   2. 程序依赖的 .so 动态库</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 所以我们新开一个&quot;干净的&quot;阶段，只装运行必需的东西</span></span><br><span class="line"><span class="comment"># 这样最终镜像可能只有 100-200MB</span></span><br><span class="line"></span><br><span class="line">FROM ubuntu:22.04</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 只安装【运行时库】</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【对比】</span></span><br><span class="line"><span class="comment">#   构建阶段装的：libmysqlclient-dev（包含头文件 + 动态库，约 50MB）</span></span><br><span class="line"><span class="comment">#   运行阶段装的：libmysqlclient21  （只有动态库，约 5MB）</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 头文件只在编译时用（#include &lt;mysql.h&gt;）</span></span><br><span class="line"><span class="comment"># 运行时程序只需要 .so 动态库</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    libmysqlclient21 \</span><br><span class="line">    libhiredis0.14 \</span><br><span class="line">    libgrpc++1 \</span><br><span class="line">    libprotobuf23 \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 设置运行目录</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># COPY --from=builder = 从构建阶段复制文件</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】编译完成后，你只把 build/my_server 这个可执行文件拷到服务器上</span></span><br><span class="line"><span class="comment">#        源代码、.o 文件、cmake 缓存...都不要了</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># --from=builder 指定从哪个阶段复制（就是上面 AS builder 起的名字）</span></span><br><span class="line"><span class="comment"># /build/build/my_server = 构建阶段里，编译产物的路径</span></span><br><span class="line"><span class="comment"># . = 当前目录（/app）</span></span><br><span class="line">COPY --from=builder /build/build/my_server .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># EXPOSE = 声明容器要用的端口</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【注意】这只是&quot;文档说明&quot;，告诉使用者这个容器会监听 8080 端口</span></span><br><span class="line"><span class="comment">#        它不会真的开放端口，真正开放端口要用 docker run -p</span></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># CMD = 容器启动时执行的命令</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】你把程序拷到服务器后，运行 ./my_server</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 写法：CMD [&quot;可执行文件&quot;, &quot;参数1&quot;, &quot;参数2&quot;]</span></span><br><span class="line"><span class="comment"># 例如：CMD [&quot;./my_server&quot;, &quot;--config&quot;, &quot;/app/config.yaml&quot;]</span></span><br><span class="line">CMD [<span class="string">&quot;./my_server&quot;</span>]</span><br></pre></td></tr></table></figure>
<h4 id="完整模板（无注释版）"><a href="#完整模板（无注释版）" class="headerlink" title="&lt;2&gt;完整模板（无注释版）"></a>&lt;2&gt;完整模板（无注释版）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># =====================================================</span></span><br><span class="line"><span class="comment"># 阶段一：构建阶段（编译代码）</span></span><br><span class="line"><span class="comment"># =====================================================</span></span><br><span class="line">FROM ubuntu:22.04 AS builder</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    build-essential \</span><br><span class="line">    cmake \</span><br><span class="line">    git \</span><br><span class="line">    pkg-config \</span><br><span class="line">    libmysqlclient-dev \</span><br><span class="line">    libhiredis-dev \</span><br><span class="line">    libgrpc++-dev \</span><br><span class="line">    libprotobuf-dev \</span><br><span class="line">    protobuf-compiler \</span><br><span class="line">    protobuf-compiler-grpc \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">WORKDIR /build</span><br><span class="line"></span><br><span class="line">COPY . .</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">mkdir</span> -p build &amp;&amp; <span class="built_in">cd</span> build \</span><br><span class="line">    &amp;&amp; cmake .. -DCMAKE_BUILD_TYPE=Release \</span><br><span class="line">    &amp;&amp; make -j$(<span class="built_in">nproc</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================================================</span></span><br><span class="line"><span class="comment"># 阶段二：运行阶段（只保留能跑的东西）</span></span><br><span class="line"><span class="comment"># =====================================================</span></span><br><span class="line">FROM ubuntu:22.04</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    libmysqlclient21 \</span><br><span class="line">    libhiredis0.14 \</span><br><span class="line">    libgrpc++1 \</span><br><span class="line">    libprotobuf23 \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">COPY --from=builder /build/build/my_server .</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;./my_server&quot;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123205543731.png"></p>
<h3 id="（3）Dockerfile-指令详解"><a href="#（3）Dockerfile-指令详解" class="headerlink" title="（3）Dockerfile 指令详解"></a>（3）Dockerfile 指令详解</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                    构建时 (docker build)                  │</span><br><span class="line">│  Dockerfile + 构建上下文(<span class="string">&quot;宿主机&quot;</span>文件) → 镜像 (Image)        │</span><br><span class="line">└──────────────────────────────────────────────────────────┘</span><br><span class="line">                           ↓</span><br><span class="line">┌──────────────────────────────────────────────────────────┐</span><br><span class="line">│                    运行时 (docker run)                    │</span><br><span class="line">│              镜像 (Image) → 容器 (Container)              │</span><br><span class="line">└──────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210621239.png"></p>
<h4 id="FROM-指定基础镜像"><a href="#FROM-指定基础镜像" class="headerlink" title="&lt;1&gt;FROM - 指定基础镜像"></a>&lt;1&gt;FROM - 指定基础镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM &lt;镜像名&gt;:&lt;标签&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210811823.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:22.04           <span class="comment"># 基于 Ubuntu 22.04</span></span><br><span class="line">FROM node:18-alpine         <span class="comment"># 基于 Node.js 18 (Alpine 轻量版)</span></span><br><span class="line">FROM scratch                <span class="comment"># 从零开始（无基础镜像）</span></span><br></pre></td></tr></table></figure>

<h4 id="RUN-执行构建命令"><a href="#RUN-执行构建命令" class="headerlink" title="&lt;2&gt;RUN - 执行构建命令"></a>&lt;2&gt;RUN - 执行构建命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RUN &lt;命令&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123210936559.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 每个 RUN 创建一个新层，建议合并减少层数</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y \</span><br><span class="line">    gcc \</span><br><span class="line">    make \</span><br><span class="line">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完成后，gcc/make 就&quot;烙印&quot;在镜像里了</span></span><br></pre></td></tr></table></figure>

<h4 id="COPY-复制文件到镜像"><a href="#COPY-复制文件到镜像" class="headerlink" title="&lt;3&gt;COPY - 复制文件到镜像"></a>&lt;3&gt;COPY - 复制文件到镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPY &lt;宿主机路径&gt; &lt;镜像内路径&gt;</span><br><span class="line">     └── src ──┘  └── dest ──┘</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211135184.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 宿主机 ./src 目录 → 镜像 /app/src 目录</span></span><br><span class="line">COPY ./src /app/src</span><br><span class="line">     ↑      ↑</span><br><span class="line">     │      └── 镜像内路径 (dest)</span><br><span class="line">     └── 宿主机路径 (src) ——&gt; <span class="string">&quot;.&quot;</span>就是执行docker build的目录!!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制单个文件</span></span><br><span class="line">COPY package.json /app/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制多个文件</span></span><br><span class="line">COPY *.cpp /app/src/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 带权限复制</span></span><br><span class="line">COPY --<span class="built_in">chown</span>=appuser:appuser ./configs /app/configs</span><br></pre></td></tr></table></figure>

<h4 id="ADD-复制-解压（慎用）"><a href="#ADD-复制-解压（慎用）" class="headerlink" title="&lt;4&gt;ADD - 复制 + 解压（慎用）"></a>&lt;4&gt;ADD - 复制 + 解压（慎用）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD &lt;宿主机路径/URL&gt; &lt;镜像内路径&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211637207.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动解压 tar 包</span></span><br><span class="line">ADD app.tar.gz /app/        <span class="comment"># 解压到 /app/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 URL 下载（不推荐，不如 RUN curl）</span></span><br><span class="line">ADD https://example.com/file.txt /app/</span><br></pre></td></tr></table></figure>

<h4 id="WORKDIR-设置工作目录"><a href="#WORKDIR-设置工作目录" class="headerlink" title="&lt;5&gt;WORKDIR - 设置工作目录"></a>&lt;5&gt;WORKDIR - 设置工作目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR &lt;镜像内路径&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211754249.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续指令都在 /app 下执行</span></span><br><span class="line">RUN <span class="built_in">pwd</span>                     <span class="comment"># 输出 /app</span></span><br><span class="line">COPY . .                    <span class="comment"># 相当于 COPY . /app/</span></span><br><span class="line">RUN make                    <span class="comment"># 在 /app 目录执行 make</span></span><br></pre></td></tr></table></figure>

<h4 id="ENV-设置环境变量"><a href="#ENV-设置环境变量" class="headerlink" title="&lt;6&gt;ENV - 设置环境变量"></a>&lt;6&gt;ENV - 设置环境变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENV &lt;变量名&gt;=&lt;值&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211842531.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENV APP_HOME=/app</span><br><span class="line">ENV PATH=<span class="variable">$APP_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">ENV NODE_ENV=production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续可以引用</span></span><br><span class="line">WORKDIR <span class="variable">$APP_HOME</span>           <span class="comment"># 等于 WORKDIR /app</span></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="variable">$NODE_ENV</span>          <span class="comment"># 输出 production</span></span><br></pre></td></tr></table></figure>

<h4 id="ARG-构建时变量"><a href="#ARG-构建时变量" class="headerlink" title="&lt;7&gt;ARG - 构建时变量"></a>&lt;7&gt;ARG - 构建时变量</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARG &lt;变量名&gt;=&lt;默认值&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123211926184.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARG VERSION=1.0</span><br><span class="line">ARG BASE_IMAGE=ubuntu:22.04</span><br><span class="line"></span><br><span class="line">FROM <span class="variable">$&#123;BASE_IMAGE&#125;</span></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">&quot;Building version <span class="variable">$&#123;VERSION&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建时传参</span></span><br><span class="line">docker build --build-arg VERSION=2.0 .</span><br></pre></td></tr></table></figure>

<h4 id="EXPOSE-声明端口"><a href="#EXPOSE-声明端口" class="headerlink" title="&lt;8&gt;EXPOSE - 声明端口"></a>&lt;8&gt;EXPOSE - 声明端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE &lt;端口号&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212019696.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPOSE 8080                 <span class="comment"># 声明 HTTP 端口</span></span><br><span class="line">EXPOSE 50051                <span class="comment"># 声明 gRPC 端口</span></span><br><span class="line">EXPOSE 3306/tcp             <span class="comment"># 指定协议</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EXPOSE 只是声明，真正映射需要 -p</span></span><br><span class="line">docker run -p 8080:8080 myimage</span><br></pre></td></tr></table></figure>

<h4 id="CMD-容器启动命令"><a href="#CMD-容器启动命令" class="headerlink" title="&lt;9&gt;CMD - 容器启动命令"></a>&lt;9&gt;CMD - 容器启动命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CMD [<span class="string">&quot;可执行文件&quot;</span>, <span class="string">&quot;参数1&quot;</span>, <span class="string">&quot;参数2&quot;</span>]</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212115528.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行时可覆盖</span></span><br><span class="line">docker run myimage ./other_command    <span class="comment"># 覆盖 CMD</span></span><br><span class="line">docker run myimage                     <span class="comment"># 使用默认 CMD</span></span><br></pre></td></tr></table></figure>

<h4 id="ENTRYPOINT-入口点"><a href="#ENTRYPOINT-入口点" class="headerlink" title="&lt;10&gt;ENTRYPOINT - 入口点"></a>&lt;10&gt;ENTRYPOINT - 入口点</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ENTRYPOINT [<span class="string">&quot;可执行文件&quot;</span>]</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212237431.png"></p>
<h4 id="USER-切换用户"><a href="#USER-切换用户" class="headerlink" title="&lt;11&gt;USER - 切换用户"></a>&lt;11&gt;USER - 切换用户</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USER &lt;用户名或UID&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123212321823.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建非 root 用户</span></span><br><span class="line">RUN useradd -m -s /bin/bash appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换用户</span></span><br><span class="line">USER appuser</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后续都以 appuser 身份执行</span></span><br><span class="line">RUN <span class="built_in">whoami</span>                  <span class="comment"># 输出 appuser</span></span><br><span class="line">CMD [<span class="string">&quot;./app&quot;</span>]               <span class="comment"># 以 appuser 运行</span></span><br></pre></td></tr></table></figure>

<h1 id="三、docker-compose-在C-中的使用"><a href="#三、docker-compose-在C-中的使用" class="headerlink" title="三、docker-compose 在C++中的使用"></a>三、docker-compose 在C++中的使用</h1><ul>
<li><strong>docker-compose &#x3D; 多容器编排工具</strong>，用一个 YAML 文件定义和<strong>管理多个容器</strong></li>
</ul>
<h2 id="1-为什么需要多容器？"><a href="#1-为什么需要多容器？" class="headerlink" title="1.为什么需要多容器？"></a>1.为什么需要多容器？</h2><ul>
<li>每个容器都运行着一个程序，我们通过 Dockerfile 构建镜像，再基于镜像创建容器来运行我们的程序</li>
<li>我们的程序用的是第三方服务（如 MySQL、Redis）的<strong>客户端库</strong>，必须连接第三方服务的<strong>服务端程序</strong>才能获得服务</li>
<li><strong>多容器</strong>：<ul>
<li>我们必须<strong>为每一个依赖的第三方服务的“服务端程序”都创建一个”容器”来运行它们</strong></li>
</ul>
</li>
</ul>
<p><strong>注：</strong></p>
<ul>
<li>对于 MySQL、Redis 这些第三方服务，不需要写 Dockerfile 来生成镜像，直接用<strong>官方镜像</strong>就行</li>
</ul>
<h2 id="2-docker-compose的必要性"><a href="#2-docker-compose的必要性" class="headerlink" title="2.docker-compose的必要性"></a>2.docker-compose的必要性</h2><ul>
<li>虽然第三方服务有<strong>官方镜像</strong>，但我们要为每一个服务都手动 docker run，并需要记住各种 -p -v -e 参数<ul>
<li><strong>每次启动要敲一堆命令，还容易敲错</strong></li>
</ul>
</li>
<li><strong>多个容器之间怎么互相访问？启动顺序怎么控制？</strong></li>
<li>docker-compose 可以在一个 YAML 文件中定义所有服务，<strong>一条命令启动全部</strong></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     为什么需要 docker-compose？                          │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   你的 C++ 程序                                                          │</span><br><span class="line">│   ┌─────────────┐                                                       │</span><br><span class="line">│   │  my_server  │                                                       │</span><br><span class="line">│   │  (客户端库)  │                                                       │</span><br><span class="line">│   └──────┬──────┘                                                       │</span><br><span class="line">│          │                                                              │</span><br><span class="line">│          │ 需要连接                                                      │</span><br><span class="line">│          ▼                                                              │</span><br><span class="line">│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │</span><br><span class="line">│   │   MySQL     │  │   Redis     │  │   Nginx     │  ...               │</span><br><span class="line">│   │  (服务端)   │  │  (服务端)   │  │  (服务端)   │                     │</span><br><span class="line">│   └─────────────┘  └─────────────┘  └─────────────┘                    │</span><br><span class="line">│         ↑                ↑                ↑                             │</span><br><span class="line">│         │                │                │                             │</span><br><span class="line">│   ┌─────┴────────────────┴────────────────┴─────┐                      │</span><br><span class="line">│   │          每个都要单独运行一个容器              │                      │</span><br><span class="line">│   └─────────────────────────────────────────────┘                      │</span><br><span class="line">│                                                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【没有 docker-compose】要敲一堆命令：                                   │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   $ docker run -d --name mysql -p <span class="number">3306</span>:<span class="number">3306</span> \                           │</span><br><span class="line">│       -e MYSQL_ROOT_PASSWORD=<span class="number">123456</span> \                                   │</span><br><span class="line">│       -v mysql_data:/var/lib/mysql mysql:<span class="number">8.0</span>                            │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   $ docker run -d --name redis -p <span class="number">6379</span>:<span class="number">6379</span> redis:<span class="number">7</span>                     │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   $ docker run -d --name my_server -p <span class="number">8080</span>:<span class="number">8080</span> \                       │</span><br><span class="line">│       --link mysql --link redis my_server:latest                        │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   😵 参数多、容易错、难维护                                               │</span><br><span class="line">│                                                                         │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【有 docker-compose】一条命令搞定：                                     │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   $ docker-compose up -d                                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ✓ 所有服务配置写在 docker-compose.yml                                  │</span><br><span class="line">│   ✓ 自动创建网络，容器间用服务名通信                                      │</span><br><span class="line">│   ✓ 自动处理启动顺序                                                     │</span><br><span class="line">│   ✓ 一键启动/停止全部                                                    │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="3-C-通用-docker-compose-yml-模板"><a href="#3-C-通用-docker-compose-yml-模板" class="headerlink" title="3.C++ 通用 docker-compose.yml 模板"></a>3.C++ 通用 docker-compose.yml 模板</h2><h3 id="（1）详细版（带注释）"><a href="#（1）详细版（带注释）" class="headerlink" title="（1）详细版（带注释）"></a>（1）详细版（带注释）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ╔═══════════════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="comment"># ║                    docker-compose.yml 详细模板                         ║</span></span><br><span class="line"><span class="comment"># ║     场景：C++ 服务器 + MySQL + Redis + Nginx                           ║</span></span><br><span class="line"><span class="comment"># ╚═══════════════════════════════════════════════════════════════════════╝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># version: 指定 docker-compose 文件格式版本</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># &quot;3.8&quot; 是目前常用的稳定版本，支持大多数功能</span></span><br><span class="line">version: <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># services: 定义所有服务（每个服务对应一个容器）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你在规划：我需要哪些服务器？每台服务器装什么？</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务1：你的 C++ 服务器程序</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  my_server:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># build: 使用 Dockerfile 构建镜像</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】告诉 docker-compose：这个服务的镜像要用 Dockerfile 现场构建</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># context: Dockerfile 所在目录（. 表示当前目录）</span></span><br><span class="line">    <span class="comment"># dockerfile: Dockerfile 文件名（默认就是 Dockerfile，可省略）</span></span><br><span class="line">    build:</span><br><span class="line">      context: .</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: 给构建的镜像起个名字</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    image: my_server:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># container_name: 容器名（方便 docker logs 查看）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    container_name: my_server_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># ports: 端口映射</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 格式：宿主机端口:容器端口</span></span><br><span class="line">    <span class="comment"># 【类比】把容器的 8080 端口&quot;暴露&quot;到宿主机的 8080 端口</span></span><br><span class="line">    <span class="comment">#        访问 宿主机:8080 就等于访问 容器:8080</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span>       <span class="comment"># HTTP 端口</span></span><br><span class="line">      - <span class="string">&quot;50051:50051&quot;</span>     <span class="comment"># gRPC 端口</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># volumes: 目录挂载（数据持久化）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 格式：宿主机路径:容器内路径</span></span><br><span class="line">    <span class="comment"># 【类比】把宿主机的文件夹&quot;映射&quot;到容器里</span></span><br><span class="line">    <span class="comment">#        容器删除后，宿主机上的数据还在</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 常见用途：</span></span><br><span class="line">    <span class="comment">#   1. 配置文件：不用重新构建镜像就能改配置</span></span><br><span class="line">    <span class="comment">#   2. 日志文件：方便在宿主机上查看日志</span></span><br><span class="line">    <span class="comment">#   3. 数据文件：数据持久化，容器删了数据还在</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./configs:/app/configs      <span class="comment"># 配置文件</span></span><br><span class="line">      - ./logs:/app/logs            <span class="comment"># 日志目录</span></span><br><span class="line">      <span class="comment"># 只读挂载</span></span><br><span class="line">      - ./config.yaml:/app/config.yaml:ro</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># environment: 环境变量</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】就像在程序启动前 export 一些变量</span></span><br><span class="line">    <span class="comment">#        程序里可以用 getenv(&quot;DB_HOST&quot;) 读取</span></span><br><span class="line">    environment:</span><br><span class="line">      - DB_HOST=mysql               <span class="comment"># 数据库地址（用服务名，不是 IP）</span></span><br><span class="line">      - DB_PORT=3306</span><br><span class="line">      - DB_USER=root</span><br><span class="line">      - DB_PASSWORD=123456</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># depends_on: 依赖关系（启动顺序）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】你的 C++ 程序启动前，MySQL 和 Redis 必须先启动</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 注意：depends_on 只保证容器启动顺序</span></span><br><span class="line">    <span class="comment">#       不保证 MySQL 真的&quot;准备好&quot;了（可能还在初始化）</span></span><br><span class="line">    <span class="comment">#       生产环境建议程序里加重试逻辑</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【升级】使用 condition: service_healthy 可以等待服务真正就绪</span></span><br><span class="line">    <span class="comment">#        需要配合目标服务的 healthcheck 使用</span></span><br><span class="line">    depends_on:</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 MySQL 健康检查通过</span></span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 Redis 健康检查通过</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># networks: 加入哪个网络</span></span><br><span class="line">    <span class="comment"># - 把这个容器加入到名为 &quot;app_network&quot; 的网络中</span></span><br><span class="line">    <span class="comment"># - 在同一个网络中，直接用服务名，如：&quot;mysql&quot; 作为主机名</span></span><br><span class="line">    <span class="comment"># - mysql_real_connect(conn, &quot;mysql&quot;, &quot;root&quot;, &quot;123456&quot;, ...);</span></span><br><span class="line">    <span class="comment">#                               ↑ 服务名，不是 IP        </span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># restart: 重启策略</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># always: 容器退出后总是重启（适合生产环境）</span></span><br><span class="line">    <span class="comment"># unless-stopped: 除非手动停止，否则总是重启</span></span><br><span class="line">    <span class="comment"># on-failure: 只有异常退出才重启</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（my_server）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】定期检查容器内服务是否正常运行</span></span><br><span class="line">    <span class="comment"># 【原理】执行 test 命令，返回 0 表示健康，非 0 表示不健康</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># test: 检查命令</span></span><br><span class="line">    <span class="comment">#   - 方式1：HTTP 接口检查（需要程序提供 /health 接口）</span></span><br><span class="line">    <span class="comment">#   - 方式2：TCP 端口检查（检查端口是否能连通）</span></span><br><span class="line">    <span class="comment">#   - 方式3：自定义脚本</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># interval: 检查间隔（每隔多久检查一次）</span></span><br><span class="line">    <span class="comment"># timeout: 超时时间（命令执行超过这个时间视为失败）</span></span><br><span class="line">    <span class="comment"># retries: 重试次数（连续失败多少次才判定为不健康）</span></span><br><span class="line">    <span class="comment"># start_period: 启动宽限期（容器启动后等待多久再开始检查）</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 40s</span><br><span class="line">      <span class="comment"># 【备选方案】如果没有 /health 接口，可以用 TCP 端口检查：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;nc -z localhost 8080 || exit 1&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务2：MySQL 数据库</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  mysql:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: 直接使用现成的镜像（从 Docker Hub 拉取）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【对比】my_server 用 build 构建，mysql 用 image 拉取现成的</span></span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    </span><br><span class="line">    container_name: mysql_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># MySQL 官方镜像支持的环境变量</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123456    <span class="comment"># root 密码（必须设置）</span></span><br><span class="line">      - MYSQL_DATABASE=mydb           <span class="comment"># 自动创建的数据库名</span></span><br><span class="line">      - MYSQL_USER=myuser             <span class="comment"># 自动创建的用户</span></span><br><span class="line">      - MYSQL_PASSWORD=mypassword     <span class="comment"># 该用户的密码</span></span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3307:3306&quot;</span> <span class="comment"># 宿主机 3307 → 容器 3306： 避免与宿主机上3306运行的mysql发送&quot;端口冲突&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 数据持久化：MySQL 数据存到宿主机</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># /var/lib/mysql 是 MySQL 容器内存放数据的目录</span></span><br><span class="line">    <span class="comment"># /docker-entrypoint-initdb.d 是&quot;初始化脚本目录&quot;：MySQL 容器【首次启动】时，会自动执行这个目录下的脚本</span></span><br><span class="line">    <span class="comment">#   - .sql 文件 → 自动用 mysql 命令执行  .sh  文件 → 自动用 bash 执行  .sql.gz   → 自动解压后执行    </span></span><br><span class="line">    <span class="comment"># 挂载到宿主机后，即使容器删除，数据也不会丢</span></span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># 方式1：命名卷（Docker 管理，你不用管存哪）</span></span><br><span class="line">      - mysql_data:/var/lib/mysql</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 方式2：绑定挂载（你指定宿主机路径）——&gt;有 &quot;./&quot;，这是宿主机当前目录下的 mysql_data 文件夹</span></span><br><span class="line">      <span class="comment"># - 宿主机路径 : 容器内路径 </span></span><br><span class="line">      - ./init.sql:/docker-entrypoint-initdb.d/init.sql  <span class="comment"># 初始化脚本</span></span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（MySQL）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 MySQL 是否真正可以接受连接</span></span><br><span class="line">    <span class="comment"># 【为什么需要】MySQL 容器启动 ≠ MySQL 服务就绪</span></span><br><span class="line">    <span class="comment">#              MySQL 启动后还需要初始化，可能需要 10-30 秒</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># mysqladmin ping: MySQL 自带的健康检查命令</span></span><br><span class="line">    <span class="comment">#   -h localhost: 连接本地</span></span><br><span class="line">    <span class="comment">#   -u root: 使用 root 用户</span></span><br><span class="line">    <span class="comment">#   -p$$MYSQL_ROOT_PASSWORD: 使用环境变量中的密码</span></span><br><span class="line">    <span class="comment">#                            $$ 是 YAML 中转义 $，实际传递 $MYSQL_ROOT_PASSWORD</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># start_period: 30s 是因为 MySQL 首次启动初始化比较慢</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;-u&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;-p$<span class="variable">$MYSQL_ROOT_PASSWORD</span>&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 30s</span><br><span class="line">      <span class="comment"># 【备选方案】更严格的检查（能执行 SQL）：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;mysql&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-p$$MYSQL_ROOT_PASSWORD&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务3：Redis 缓存</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine       <span class="comment"># alpine 版本更小</span></span><br><span class="line">    </span><br><span class="line">    container_name: redis_container</span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># command: 覆盖默认启动命令</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 添加密码认证</span></span><br><span class="line">    <span class="built_in">command</span>: redis-server --requirepass 123456</span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      - redis_data:/data</span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Redis）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Redis 是否可以正常响应命令</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># redis-cli ping: Redis 自带的健康检查命令</span></span><br><span class="line">    <span class="comment">#   -a 123456: 密码认证（因为上面设置了 requirepass）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【返回值】</span></span><br><span class="line">    <span class="comment">#   - 成功返回 &quot;PONG&quot;，退出码 0</span></span><br><span class="line">    <span class="comment">#   - 失败返回错误信息，退出码非 0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Redis 启动很快，所以 start_period 可以短一些</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 5s</span><br><span class="line">      <span class="comment"># 【备选方案】无密码的 Redis：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;redis-cli&quot;, &quot;ping&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务4：Nginx 反向代理（可选）</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    </span><br><span class="line">    container_name: nginx_container</span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx.conf:/etc/nginx/nginx.conf      <span class="comment"># Nginx 配置</span></span><br><span class="line">      - ./certs:/etc/nginx/certs                <span class="comment"># SSL 证书</span></span><br><span class="line">    </span><br><span class="line">    depends_on:</span><br><span class="line">      my_server:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 my_server 健康检查通过</span></span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Nginx）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Nginx 是否正常运行并能响应请求</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># curl -f: 如果 HTTP 状态码不是 2xx/3xx 则失败</span></span><br><span class="line">    <span class="comment"># http://localhost/health: 需要在 nginx.conf 中配置 /health 路由</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【简单方案】直接检查首页</span></span><br><span class="line">    <span class="comment"># 【生产方案】配置专门的 /health 端点</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 10s</span><br><span class="line">      <span class="comment"># 【备选方案】检查 Nginx 进程是否存在：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;nginx -t &amp;&amp; kill -0 $(cat /var/run/nginx.pid)&quot;]</span></span><br><span class="line">      <span class="comment"># 【备选方案】简单检查首页：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost/&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># networks: 定义网络</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】把所有服务放在同一个&quot;局域网&quot;里</span></span><br><span class="line"><span class="comment">#        服务之间可以用服务名互相访问（如 mysql:3306）</span></span><br><span class="line"><span class="comment">#        不需要知道对方的 IP 地址</span></span><br><span class="line">networks:</span><br><span class="line">  app_network:</span><br><span class="line">    driver: bridge              <span class="comment"># 桥接网络（默认）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># volumes: 定义命名卷（数据持久化）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】创建&quot;数据仓库&quot;，由 Docker 管理</span></span><br><span class="line"><span class="comment">#        比直接写宿主机路径更方便（不用关心具体存在哪）</span></span><br><span class="line">volumes:</span><br><span class="line">  mysql_data:                   <span class="comment"># MySQL 数据</span></span><br><span class="line">  redis_data:                   <span class="comment"># Redis 数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="（2）精简版（无注释）"><a href="#（2）精简版（无注释）" class="headerlink" title="（2）精简版（无注释）"></a>（2）精简版（无注释）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  my_server:</span><br><span class="line">    build:</span><br><span class="line">      context: .</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    image: my_server:latest</span><br><span class="line">    container_name: my_server_container</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">      - <span class="string">&quot;50051:50051&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./configs:/app/configs</span><br><span class="line">      - ./logs:/app/logs</span><br><span class="line">      - ./config.yaml:/app/config.yaml:ro</span><br><span class="line">    environment:</span><br><span class="line">      - DB_HOST=mysql</span><br><span class="line">      - DB_PORT=3306</span><br><span class="line">      - DB_USER=root</span><br><span class="line">      - DB_PASSWORD=123456</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">    depends_on:</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 40s</span><br><span class="line"></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    container_name: mysql_container</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123456</span><br><span class="line">      - MYSQL_DATABASE=mydb</span><br><span class="line">      - MYSQL_USER=myuser</span><br><span class="line">      - MYSQL_PASSWORD=mypassword</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3307:3306&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - mysql_data:/var/lib/mysql</span><br><span class="line">      - ./init.sql:/docker-entrypoint-initdb.d/init.sql</span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;-u&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;-p$<span class="variable">$MYSQL_ROOT_PASSWORD</span>&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 30s</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    container_name: redis_container</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="built_in">command</span>: redis-server --requirepass 123456</span><br><span class="line">    volumes:</span><br><span class="line">      - redis_data:/data</span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 5s</span><br><span class="line"></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    container_name: nginx_container</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line">      - ./certs:/etc/nginx/certs</span><br><span class="line">    depends_on:</span><br><span class="line">      my_server:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 10s</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  app_network:</span><br><span class="line">    driver: bridge</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql_data:</span><br><span class="line">  redis_data:</span><br></pre></td></tr></table></figure>

<h3 id="（3）增加kafka、zookeeper-版"><a href="#（3）增加kafka、zookeeper-版" class="headerlink" title="（3）增加kafka、zookeeper 版"></a>（3）增加kafka、zookeeper 版</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ╔═══════════════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="comment"># ║                    docker-compose.yml 详细模板                         ║</span></span><br><span class="line"><span class="comment"># ║     场景：C++ 服务器 + MySQL + Redis + Kafka + Zookeeper + Nginx       ║</span></span><br><span class="line"><span class="comment"># ╚═══════════════════════════════════════════════════════════════════════╝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># version: 指定 docker-compose 文件格式版本</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># &quot;3.8&quot; 是目前常用的稳定版本，支持大多数功能</span></span><br><span class="line">version: <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># services: 定义所有服务（每个服务对应一个容器）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】就像你在规划：我需要哪些服务器？每台服务器装什么？</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务1：你的 C++ 服务器程序</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  my_server:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># build: 使用 Dockerfile 构建镜像</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】告诉 docker-compose：这个服务的镜像要用 Dockerfile 现场构建</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># context: Dockerfile 所在目录（. 表示当前目录）</span></span><br><span class="line">    <span class="comment"># dockerfile: Dockerfile 文件名（默认就是 Dockerfile，可省略）</span></span><br><span class="line">    build:</span><br><span class="line">      context: .</span><br><span class="line">      dockerfile: Dockerfile</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: 给构建的镜像起个名字</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    image: my_server:latest</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># container_name: 容器名（方便 docker logs 查看）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    container_name: my_server_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># ports: 端口映射</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 格式：宿主机端口:容器端口</span></span><br><span class="line">    <span class="comment"># 【类比】把容器的 8080 端口&quot;暴露&quot;到宿主机的 8080 端口</span></span><br><span class="line">    <span class="comment">#        访问 宿主机:8080 就等于访问 容器:8080</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;8080:8080&quot;</span>       <span class="comment"># HTTP 端口</span></span><br><span class="line">      - <span class="string">&quot;50051:50051&quot;</span>     <span class="comment"># gRPC 端口</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># volumes: 目录挂载（数据持久化）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 格式：宿主机路径:容器内路径</span></span><br><span class="line">    <span class="comment"># 【类比】把宿主机的文件夹&quot;映射&quot;到容器里</span></span><br><span class="line">    <span class="comment">#        容器删除后，宿主机上的数据还在</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 常见用途：</span></span><br><span class="line">    <span class="comment">#   1. 配置文件：不用重新构建镜像就能改配置</span></span><br><span class="line">    <span class="comment">#   2. 日志文件：方便在宿主机上查看日志</span></span><br><span class="line">    <span class="comment">#   3. 数据文件：数据持久化，容器删了数据还在</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./configs:/app/configs      <span class="comment"># 配置文件</span></span><br><span class="line">      - ./logs:/app/logs            <span class="comment"># 日志目录</span></span><br><span class="line">      <span class="comment"># 只读挂载</span></span><br><span class="line">      - ./config.yaml:/app/config.yaml:ro</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># environment: 环境变量</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】就像在程序启动前 export 一些变量</span></span><br><span class="line">    <span class="comment">#        程序里可以用 getenv(&quot;DB_HOST&quot;) 读取</span></span><br><span class="line">    environment:</span><br><span class="line">      - DB_HOST=mysql               <span class="comment"># 数据库地址（用服务名，不是 IP）</span></span><br><span class="line">      - DB_PORT=3306</span><br><span class="line">      - DB_USER=root</span><br><span class="line">      - DB_PASSWORD=123456</span><br><span class="line">      - REDIS_HOST=redis</span><br><span class="line">      - REDIS_PORT=6379</span><br><span class="line">      - KAFKA_BROKERS=kafka:9092    <span class="comment"># Kafka 地址（容器内部通信用 9092）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># depends_on: 依赖关系（启动顺序）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【类比】你的 C++ 程序启动前，MySQL 和 Redis 必须先启动</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 注意：depends_on 只保证容器启动顺序</span></span><br><span class="line">    <span class="comment">#       不保证 MySQL 真的&quot;准备好&quot;了（可能还在初始化）</span></span><br><span class="line">    <span class="comment">#       生产环境建议程序里加重试逻辑</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【升级】使用 condition: service_healthy 可以等待服务真正就绪</span></span><br><span class="line">    <span class="comment">#        需要配合目标服务的 healthcheck 使用</span></span><br><span class="line">    depends_on:</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 MySQL 健康检查通过</span></span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 Redis 健康检查通过</span></span><br><span class="line">      kafka:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 Kafka 健康检查通过</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># networks: 加入哪个网络</span></span><br><span class="line">    <span class="comment"># - 把这个容器加入到名为 &quot;app_network&quot; 的网络中</span></span><br><span class="line">    <span class="comment"># - 在同一个网络中，直接用服务名，如：&quot;mysql&quot; 作为主机名</span></span><br><span class="line">    <span class="comment"># - mysql_real_connect(conn, &quot;mysql&quot;, &quot;root&quot;, &quot;123456&quot;, ...);     </span></span><br><span class="line">    <span class="comment">#                               ↑ 服务名，不是 IP        </span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># restart: 重启策略</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># always: 容器退出后总是重启（适合生产环境）</span></span><br><span class="line">    <span class="comment"># unless-stopped: 除非手动停止，否则总是重启</span></span><br><span class="line">    <span class="comment"># on-failure: 只有异常退出才重启</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（my_server）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】定期检查容器内服务是否正常运行</span></span><br><span class="line">    <span class="comment"># 【原理】执行 test 命令，返回 0 表示健康，非 0 表示不健康</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># test: 检查命令</span></span><br><span class="line">    <span class="comment">#   - 方式1：HTTP 接口检查（需要程序提供 /health 接口）</span></span><br><span class="line">    <span class="comment">#   - 方式2：TCP 端口检查（检查端口是否能连通）</span></span><br><span class="line">    <span class="comment">#   - 方式3：自定义脚本</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># interval: 检查间隔（每隔多久检查一次）</span></span><br><span class="line">    <span class="comment"># timeout: 超时时间（命令执行超过这个时间视为失败）</span></span><br><span class="line">    <span class="comment"># retries: 重试次数（连续失败多少次才判定为不健康）</span></span><br><span class="line">    <span class="comment"># start_period: 启动宽限期（容器启动后等待多久再开始检查）</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 40s</span><br><span class="line">      <span class="comment"># 【备选方案】如果没有 /health 接口，可以用 TCP 端口检查：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;nc -z localhost 8080 || exit 1&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务2：MySQL 数据库</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  mysql:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: 直接使用现成的镜像（从 Docker Hub 拉取）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【对比】my_server 用 build 构建，mysql 用 image 拉取现成的</span></span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    </span><br><span class="line">    container_name: mysql_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># MySQL 官方镜像支持的环境变量</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123456    <span class="comment"># root 密码（必须设置）</span></span><br><span class="line">      - MYSQL_DATABASE=mydb           <span class="comment"># 自动创建的数据库名</span></span><br><span class="line">      - MYSQL_USER=myuser             <span class="comment"># 自动创建的用户</span></span><br><span class="line">      - MYSQL_PASSWORD=mypassword     <span class="comment"># 该用户的密码</span></span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3307:3306&quot;</span> <span class="comment"># 宿主机 3307 → 容器 3306： 避免与宿主机上3306运行的mysql发送&quot;端口冲突&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 数据持久化：MySQL 数据存到宿主机</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># /var/lib/mysql 是 MySQL 容器内存放数据的目录</span></span><br><span class="line">    <span class="comment"># /docker-entrypoint-initdb.d 是&quot;初始化脚本目录&quot;：MySQL 容器【首次启动】时，会自动执行这个目录下的脚本</span></span><br><span class="line">    <span class="comment">#   - .sql 文件 → 自动用 mysql 命令执行  .sh  文件 → 自动用 bash 执行  .sql.gz   → 自动解压后执行    </span></span><br><span class="line">    <span class="comment"># 挂载到宿主机后，即使容器删除，数据也不会丢</span></span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># 方式1：命名卷（Docker 管理，你不用管存哪）</span></span><br><span class="line">      - mysql_data:/var/lib/mysql</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 方式2：绑定挂载（你指定宿主机路径）——&gt;有 &quot;./&quot;，这是宿主机当前目录下的 mysql_data 文件夹</span></span><br><span class="line">      <span class="comment"># - 宿主机路径 : 容器内路径 </span></span><br><span class="line">      - ./init.sql:/docker-entrypoint-initdb.d/init.sql  <span class="comment"># 初始化脚本</span></span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（MySQL）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 MySQL 是否真正可以接受连接</span></span><br><span class="line">    <span class="comment"># 【为什么需要】MySQL 容器启动 ≠ MySQL 服务就绪</span></span><br><span class="line">    <span class="comment">#              MySQL 启动后还需要初始化，可能需要 10-30 秒</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># mysqladmin ping: MySQL 自带的健康检查命令</span></span><br><span class="line">    <span class="comment">#   -h localhost: 连接本地</span></span><br><span class="line">    <span class="comment">#   -u root: 使用 root 用户</span></span><br><span class="line">    <span class="comment">#   -p$$MYSQL_ROOT_PASSWORD: 使用环境变量中的密码</span></span><br><span class="line">    <span class="comment">#                            $$ 是 YAML 中转义 $，实际传递 $MYSQL_ROOT_PASSWORD</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># start_period: 30s 是因为 MySQL 首次启动初始化比较慢</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;-u&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;-p$<span class="variable">$MYSQL_ROOT_PASSWORD</span>&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 30s</span><br><span class="line">      <span class="comment"># 【备选方案】更严格的检查（能执行 SQL）：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;mysql&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-p$$MYSQL_ROOT_PASSWORD&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务3：Redis 缓存</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine       <span class="comment"># alpine 版本更小</span></span><br><span class="line">    </span><br><span class="line">    container_name: redis_container</span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># command: 覆盖默认启动命令</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 添加密码认证</span></span><br><span class="line">    <span class="built_in">command</span>: redis-server --requirepass 123456</span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      - redis_data:/data</span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Redis）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Redis 是否可以正常响应命令</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># redis-cli ping: Redis 自带的健康检查命令</span></span><br><span class="line">    <span class="comment">#   -a 123456: 密码认证（因为上面设置了 requirepass）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【返回值】</span></span><br><span class="line">    <span class="comment">#   - 成功返回 &quot;PONG&quot;，退出码 0</span></span><br><span class="line">    <span class="comment">#   - 失败返回错误信息，退出码非 0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Redis 启动很快，所以 start_period 可以短一些</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 5s</span><br><span class="line">      <span class="comment"># 【备选方案】无密码的 Redis：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;redis-cli&quot;, &quot;ping&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务4：Zookeeper（Kafka 依赖）</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  zookeeper:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: Confluent 官方 Zookeeper 镜像</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【为什么需要 Zookeeper】</span></span><br><span class="line">    <span class="comment">#   Kafka 使用 Zookeeper 来：</span></span><br><span class="line">    <span class="comment">#   1. 管理 Broker 集群元数据</span></span><br><span class="line">    <span class="comment">#   2. 选举 Controller</span></span><br><span class="line">    <span class="comment">#   3. 存储 Topic 配置信息</span></span><br><span class="line">    <span class="comment">#   4. 管理消费者组（旧版本）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【镜像选择】</span></span><br><span class="line">    <span class="comment">#   - confluentinc/cp-zookeeper: Confluent 官方，功能完整，推荐</span></span><br><span class="line">    <span class="comment">#   - bitnami/zookeeper: Bitnami 维护，也很流行</span></span><br><span class="line">    <span class="comment">#   - zookeeper: Apache 官方，配置稍复杂</span></span><br><span class="line">    image: confluentinc/cp-zookeeper:7.5.0</span><br><span class="line">    </span><br><span class="line">    container_name: zookeeper_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># Zookeeper 环境变量</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># ZOOKEEPER_CLIENT_PORT: 客户端连接端口（Kafka 连接用）</span></span><br><span class="line">    <span class="comment"># ZOOKEEPER_TICK_TIME: 心跳间隔（毫秒），用于会话超时计算</span></span><br><span class="line">    <span class="comment">#                      最小会话超时 = 2 * tickTime = 4000ms</span></span><br><span class="line">    environment:</span><br><span class="line">      ZOOKEEPER_CLIENT_PORT: 2181</span><br><span class="line">      ZOOKEEPER_TICK_TIME: 2000</span><br><span class="line">      <span class="comment"># 【可选配置】</span></span><br><span class="line">      <span class="comment"># ZOOKEEPER_INIT_LIMIT: 5     # Follower 初始化连接到 Leader 的超时（tickTime 的倍数）</span></span><br><span class="line">      <span class="comment"># ZOOKEEPER_SYNC_LIMIT: 2     # Follower 与 Leader 同步的超时（tickTime 的倍数）</span></span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># Zookeeper 端口说明</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 2181: 客户端连接端口（Kafka、命令行工具连接用）</span></span><br><span class="line">      <span class="comment"># 2888: Follower 连接 Leader 端口（集群内部通信）</span></span><br><span class="line">      <span class="comment"># 3888: Leader 选举端口（集群内部通信）</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># 单机部署只需要暴露 2181</span></span><br><span class="line">      - <span class="string">&quot;2181:2181&quot;</span></span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># Zookeeper 数据持久化</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># /var/lib/zookeeper/data: 存储快照数据</span></span><br><span class="line">      <span class="comment"># /var/lib/zookeeper/log: 存储事务日志</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># 【重要】生产环境必须持久化，否则重启后 Kafka 元数据丢失</span></span><br><span class="line">      - zookeeper_data:/var/lib/zookeeper/data</span><br><span class="line">      - zookeeper_log:/var/lib/zookeeper/log</span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Zookeeper）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Zookeeper 是否正常运行</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 方法1: 使用 nc 发送 &quot;ruok&quot;（are you ok）命令</span></span><br><span class="line">    <span class="comment">#        Zookeeper 回复 &quot;imok&quot; 表示正常</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 方法2: 使用 zkServer.sh status 检查状态</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【Zookeeper 四字命令】</span></span><br><span class="line">    <span class="comment">#   ruok: 检查服务是否运行</span></span><br><span class="line">    <span class="comment">#   stat: 查看服务状态和连接信息</span></span><br><span class="line">    <span class="comment">#   conf: 查看配置信息</span></span><br><span class="line">    <span class="comment">#   mntr: 查看监控指标</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;echo ruok | nc localhost 2181 | grep imok&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 15s</span><br><span class="line">      <span class="comment"># 【备选方案】如果 nc 不可用：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;zkServer.sh status&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务5：Kafka 消息队列</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  kafka:</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># image: Confluent 官方 Kafka 镜像</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【镜像选择】</span></span><br><span class="line">    <span class="comment">#   - confluentinc/cp-kafka: Confluent 官方，功能完整，推荐</span></span><br><span class="line">    <span class="comment">#   - bitnami/kafka: Bitnami 维护，配置简单</span></span><br><span class="line">    <span class="comment">#   - apache/kafka: Apache 官方（3.7+ 支持 KRaft 无 Zookeeper 模式）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【版本对应】</span></span><br><span class="line">    <span class="comment">#   cp-kafka:7.5.0 对应 Kafka 3.5.x</span></span><br><span class="line">    image: confluentinc/cp-kafka:7.5.0</span><br><span class="line">    </span><br><span class="line">    container_name: kafka_container</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># depends_on: Kafka 依赖 Zookeeper</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># Kafka 启动时需要连接 Zookeeper 获取集群元数据</span></span><br><span class="line">    <span class="comment"># 必须等 Zookeeper 就绪后才能启动 Kafka</span></span><br><span class="line">    depends_on:</span><br><span class="line">      zookeeper:</span><br><span class="line">        condition: service_healthy</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># Kafka 环境变量（重要！）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    environment:</span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_BROKER_ID: Broker 唯一标识</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 集群中每个 Broker 必须有唯一 ID</span></span><br><span class="line">      <span class="comment"># 单机部署设为 1 即可</span></span><br><span class="line">      KAFKA_BROKER_ID: 1</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_ZOOKEEPER_CONNECT: Zookeeper 连接地址</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 格式：host:port[,host:port...]</span></span><br><span class="line">      <span class="comment"># 使用 Docker 服务名 &quot;zookeeper&quot;，不是 IP</span></span><br><span class="line">      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_LISTENERS: Kafka 监听的地址（Broker 内部）</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 定义 Broker 在哪些地址/端口监听</span></span><br><span class="line">      <span class="comment"># 格式：LISTENER_NAME://host:port</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># PLAINTEXT: 容器内部通信（其他容器访问 kafka:9092）</span></span><br><span class="line">      <span class="comment"># PLAINTEXT_HOST: 宿主机访问（localhost:29092）</span></span><br><span class="line">      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_ADVERTISED_LISTENERS: 对外公布的地址（客户端使用）</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 【关键配置】客户端连接 Kafka 后，Kafka 返回这个地址给客户端</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># PLAINTEXT://kafka:9092</span></span><br><span class="line">      <span class="comment">#   - 容器内其他服务使用（如 my_server）</span></span><br><span class="line">      <span class="comment">#   - 使用服务名 &quot;kafka&quot;</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># PLAINTEXT_HOST://localhost:29092</span></span><br><span class="line">      <span class="comment">#   - 宿主机上的程序使用（如本地调试）</span></span><br><span class="line">      <span class="comment">#   - 使用 localhost</span></span><br><span class="line">      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 监听器协议映射</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 定义每个 Listener 使用的安全协议</span></span><br><span class="line">      <span class="comment"># PLAINTEXT = 无加密无认证（开发环境）</span></span><br><span class="line">      <span class="comment"># SSL = TLS 加密</span></span><br><span class="line">      <span class="comment"># SASL_PLAINTEXT = SASL 认证无加密</span></span><br><span class="line">      <span class="comment"># SASL_SSL = SASL 认证 + TLS 加密</span></span><br><span class="line">      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_INTER_BROKER_LISTENER_NAME: Broker 间通信使用的 Listener</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 内部 Topic 副本数</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># __consumer_offsets Topic 的副本数</span></span><br><span class="line">      <span class="comment"># 单机部署必须设为 1（因为只有 1 个 Broker）</span></span><br><span class="line">      <span class="comment"># 生产环境建议 3（至少 3 个 Broker）</span></span><br><span class="line">      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1</span><br><span class="line">      </span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 【可选配置】</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># KAFKA_AUTO_CREATE_TOPICS_ENABLE: true     # 自动创建 Topic（生产环境建议 false）</span></span><br><span class="line">      <span class="comment"># KAFKA_NUM_PARTITIONS: 3                   # 默认分区数</span></span><br><span class="line">      <span class="comment"># KAFKA_DEFAULT_REPLICATION_FACTOR: 1       # 默认副本数</span></span><br><span class="line">      <span class="comment"># KAFKA_LOG_RETENTION_HOURS: 168            # 日志保留时间（小时）</span></span><br><span class="line">      <span class="comment"># KAFKA_LOG_RETENTION_BYTES: 1073741824     # 日志保留大小（字节）</span></span><br><span class="line">      KAFKA_AUTO_CREATE_TOPICS_ENABLE: <span class="string">&quot;true&quot;</span></span><br><span class="line">      KAFKA_NUM_PARTITIONS: 3</span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># Kafka 端口说明</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># 9092: 容器内部通信端口（其他容器用 kafka:9092 访问）</span></span><br><span class="line">      <span class="comment"># 29092: 宿主机访问端口（本地调试用 localhost:29092）</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># 【为什么要两个端口？】</span></span><br><span class="line">      <span class="comment">#   Docker 容器内和宿主机是不同的网络环境</span></span><br><span class="line">      <span class="comment">#   容器内用服务名 &quot;kafka&quot;，宿主机用 &quot;localhost&quot;</span></span><br><span class="line">      <span class="comment">#   需要不同的 Listener 来处理</span></span><br><span class="line">      - <span class="string">&quot;9092:9092&quot;</span>       <span class="comment"># 容器内通信（可选暴露，调试用）</span></span><br><span class="line">      - <span class="string">&quot;29092:29092&quot;</span>     <span class="comment"># 宿主机访问</span></span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># Kafka 数据持久化</span></span><br><span class="line">      <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">      <span class="comment"># /var/lib/kafka/data: Kafka 日志数据存储目录</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># 【重要】生产环境必须持久化，否则重启后消息丢失</span></span><br><span class="line">      - kafka_data:/var/lib/kafka/data</span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Kafka）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Kafka Broker 是否正常运行</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 方法1: 使用 kafka-broker-api-versions 命令</span></span><br><span class="line">    <span class="comment">#        这个命令会连接 Broker 并获取 API 版本，成功即表示 Broker 正常</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 方法2: 使用 nc 检查端口（简单但不够准确）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 方法3: 使用 kafka-metadata（KRaft 模式）</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># --bootstrap-server: 要检查的 Broker 地址</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;kafka-broker-api-versions --bootstrap-server localhost:9092&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 30s</span><br><span class="line">      <span class="comment"># 【备选方案】简单端口检查：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;nc -z localhost 9092&quot;]</span></span><br><span class="line">      <span class="comment"># 【备选方案】检查 Topic 列表：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;kafka-topics --bootstrap-server localhost:9092 --list&quot;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  <span class="comment"># 服务6：Nginx 反向代理（可选）</span></span><br><span class="line">  <span class="comment"># ═══════════════════════════════════════════════════════════════════════</span></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    </span><br><span class="line">    container_name: nginx_container</span><br><span class="line">    </span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    </span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx.conf:/etc/nginx/nginx.conf      <span class="comment"># Nginx 配置</span></span><br><span class="line">      - ./certs:/etc/nginx/certs                <span class="comment"># SSL 证书</span></span><br><span class="line">    </span><br><span class="line">    depends_on:</span><br><span class="line">      my_server:</span><br><span class="line">        condition: service_healthy  <span class="comment"># 等待 my_server 健康检查通过</span></span><br><span class="line">    </span><br><span class="line">    networks:</span><br><span class="line">      - app_network</span><br><span class="line">    </span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># healthcheck: 健康检查（Nginx）</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 【作用】检查 Nginx 是否正常运行并能响应请求</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># curl -f: 如果 HTTP 状态码不是 2xx/3xx 则失败</span></span><br><span class="line">    <span class="comment"># http://localhost/health: 需要在 nginx.conf 中配置 /health 路由</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># 【简单方案】直接检查首页</span></span><br><span class="line">    <span class="comment"># 【生产方案】配置专门的 /health 端点</span></span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost/health&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 10s</span><br><span class="line">      <span class="comment"># 【备选方案】检查 Nginx 进程是否存在：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD-SHELL&quot;, &quot;nginx -t &amp;&amp; kill -0 $(cat /var/run/nginx.pid)&quot;]</span></span><br><span class="line">      <span class="comment"># 【备选方案】简单检查首页：</span></span><br><span class="line">      <span class="comment"># test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost/&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># networks: 定义网络</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】把所有服务放在同一个&quot;局域网&quot;里</span></span><br><span class="line"><span class="comment">#        服务之间可以用服务名互相访问（如 mysql:3306）</span></span><br><span class="line"><span class="comment">#        不需要知道对方的 IP 地址</span></span><br><span class="line">networks:</span><br><span class="line">  app_network:</span><br><span class="line">    driver: bridge              <span class="comment"># 桥接网络（默认）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># volumes: 定义命名卷（数据持久化）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 【类比】创建&quot;数据仓库&quot;，由 Docker 管理</span></span><br><span class="line"><span class="comment">#        比直接写宿主机路径更方便（不用关心具体存在哪）</span></span><br><span class="line">volumes:</span><br><span class="line">  mysql_data:                   <span class="comment"># MySQL 数据</span></span><br><span class="line">  redis_data:                   <span class="comment"># Redis 数据</span></span><br><span class="line">  zookeeper_data:               <span class="comment"># Zookeeper 快照数据</span></span><br><span class="line">  zookeeper_log:                <span class="comment"># Zookeeper 事务日志</span></span><br><span class="line">  kafka_data:                   <span class="comment"># Kafka 消息日志</span></span><br></pre></td></tr></table></figure>

<h2 id="4-docker-compose-yml-配置项详解"><a href="#4-docker-compose-yml-配置项详解" class="headerlink" title="4.docker-compose.yml 配置项详解"></a>4.docker-compose.yml 配置项详解</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124004027731.png"></p>
<h3 id="（1）build-vs-image"><a href="#（1）build-vs-image" class="headerlink" title="（1）build vs image"></a>（1）build vs image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：使用 Dockerfile 构建镜像</span></span><br><span class="line">my_server:</span><br><span class="line">  build:</span><br><span class="line">    context: .          <span class="comment"># Dockerfile 所在目录</span></span><br><span class="line">    dockerfile: Dockerfile</span><br><span class="line">    args:               <span class="comment"># 传递 ARG 参数</span></span><br><span class="line">      VERSION: 1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：使用现成镜像</span></span><br><span class="line">mysql:</span><br><span class="line">  image: mysql:8.0      <span class="comment"># 从 Docker Hub 拉取</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────┬──────────────────────────────────────┐</span><br><span class="line">│        build            │            image                     │</span><br><span class="line">├─────────────────────────┼──────────────────────────────────────┤</span><br><span class="line">│  用 Dockerfile 现场构建  │  使用现成镜像（本地或远程）           │</span><br><span class="line">│  适合：自己写的程序       │  适合：MySQL、Redis 等通用服务       │</span><br><span class="line">│  每次 up 可能重新构建     │  直接拉取，速度快                    │</span><br><span class="line">└─────────────────────────┴──────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）ports-端口映射"><a href="#（2）ports-端口映射" class="headerlink" title="（2）ports - 端口映射"></a>（2）ports - 端口映射</h3><ul>
<li>需要注意端口冲突问题：如果宿主机上的mysql在用3306端口，则就不可以将宿主机3306端口映射到容器端口了</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ports:</span><br><span class="line">  - <span class="string">&quot;8080:8080&quot;</span>           <span class="comment"># 宿主机8080 → 容器8080</span></span><br><span class="line">  - <span class="string">&quot;3000:80&quot;</span>             <span class="comment"># 宿主机3000 → 容器80</span></span><br><span class="line">  - <span class="string">&quot;127.0.0.1:3306:3306&quot;</span> <span class="comment"># 只允许本机访问</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      端口映射原理                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   外部访问             宿主机                 容器               │</span><br><span class="line">│   ────────→       ┌──────────┐         ┌──────────┐           │</span><br><span class="line">│   :<span class="number">8080</span>           │  :<span class="number">8080</span>   │ ──────→ │  :<span class="number">8080</span>   │           │</span><br><span class="line">│                   └──────────┘         └──────────┘           │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   <span class="string">&quot;8080:8080&quot;</span> = 访问宿主机的<span class="number">8080</span>，转发到容器的<span class="number">8080</span>               │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（3）volumes-目录挂载"><a href="#（3）volumes-目录挂载" class="headerlink" title="（3）volumes - 目录挂载"></a>（3）volumes - 目录挂载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  <span class="comment"># 方式1：绑定挂载（指定宿主机路径）——&gt; 有 &quot;./&quot; 或 &quot;/&quot;，这是宿主机当前目录下的 mysql_data 文件夹</span></span><br><span class="line">  <span class="comment"># 宿主机路径 : 容器内路径</span></span><br><span class="line">  - ./configs:/app/configs      <span class="comment"># 相对路径</span></span><br><span class="line">  - /data/logs:/app/logs        <span class="comment"># 绝对路径</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 方式2：命名卷（Docker 管理）</span></span><br><span class="line">  - mysql_data:/var/lib/mysql   <span class="comment"># 需要在顶层 volumes 定义</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 方式3：只读挂载（用于我们自己的程序）</span></span><br><span class="line">  - ./config.yaml:/app/config.yaml:ro</span><br></pre></td></tr></table></figure>
<ul>
<li>COPY . . 已经把项目文件（包括配置文件）复制到镜像里了，为什么还要在 docker-compose.yml 里用 volumes 挂载配置文件？</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    两种方式对比                                          │</span><br><span class="line">├──────────────────────────┬──────────────────────────────────────────────┤</span><br><span class="line">│  Dockerfile 的 COPY      │  docker-compose 的 volumes                   │</span><br><span class="line">├──────────────────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│  配置文件<span class="string">&quot;烙印&quot;</span>在镜像里   │  配置文件在宿主机，容器启动时<span class="string">&quot;映射&quot;</span>进去        │</span><br><span class="line">│  改配置 → 要重新 build   │  改配置 → 只需重启容器                        │</span><br><span class="line">│  镜像自包含，到哪都能跑   │  需要宿主机上有配置文件                        │</span><br><span class="line">├──────────────────────────┼──────────────────────────────────────────────┤</span><br><span class="line">│  适合：生产环境部署       │  适合：开发环境、需要频繁改配置的场景          │</span><br><span class="line">└──────────────────────────┴──────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="只用-COPY（不挂载）"><a href="#只用-COPY（不挂载）" class="headerlink" title="&lt;1&gt;只用 COPY（不挂载）"></a>&lt;1&gt;只用 COPY（不挂载）</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123235236543.png"></p>
<h4 id="COPY-volumes-覆盖（推荐）"><a href="#COPY-volumes-覆盖（推荐）" class="headerlink" title="&lt;2&gt;COPY + volumes 覆盖（推荐）"></a>&lt;2&gt;COPY + volumes 覆盖（推荐）</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260123235306432.png"></p>
<h4 id="工作流程对比"><a href="#工作流程对比" class="headerlink" title="&lt;3&gt;工作流程对比"></a>&lt;3&gt;工作流程对比</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  只用 COPY：                                                            │</span><br><span class="line">│  ──────────                                                             │</span><br><span class="line">│  改 config.yaml → docker-compose build → docker-compose up -d          │</span><br><span class="line">│                   └── 重新编译整个项目，可能要几分钟 ──┘                  │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  COPY + volumes 覆盖：                                                  │</span><br><span class="line">│  ────────────────────                                                   │</span><br><span class="line">│  改 config.yaml → docker-compose restart my_server                     │</span><br><span class="line">│                   └── 几秒钟 ──┘                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（4）environment-环境变量"><a href="#（4）environment-环境变量" class="headerlink" title="（4）environment - 环境变量"></a>（4）environment - 环境变量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：直接写</span></span><br><span class="line">environment:</span><br><span class="line">  - DB_HOST=mysql</span><br><span class="line">  - DB_PORT=3306</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：从 .env 文件读取</span></span><br><span class="line">env_file:</span><br><span class="line">  - .<span class="built_in">env</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># .env 文件内容：</span></span><br><span class="line"><span class="comment"># DB_HOST=mysql</span></span><br><span class="line"><span class="comment"># DB_PORT=3306</span></span><br></pre></td></tr></table></figure>

<h3 id="（5）depends-on-依赖关系"><a href="#（5）depends-on-依赖关系" class="headerlink" title="（5）depends_on - 依赖关系"></a>（5）depends_on - 依赖关系</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># depends_on：定义服务启动顺序（依赖关系）</span></span><br><span class="line">my_server:</span><br><span class="line">  depends_on:</span><br><span class="line">    - mysql       <span class="comment"># my_server 启动前，先启动 mysql</span></span><br><span class="line">    - redis       <span class="comment"># my_server 启动前，先启动 redis</span></span><br><span class="line">    <span class="comment"># 启动顺序：mysql → redis → my_server</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    <span class="comment"># ⚠️ 注意：只保证&quot;容器启动&quot;顺序，不保证&quot;服务就绪&quot;</span></span><br><span class="line">    <span class="comment">#    MySQL 容器启动了，但可能还在初始化，此时连接会失败</span></span><br><span class="line">    <span class="comment">#    建议：程序里加连接重试逻辑</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  ⚠️ depends_on 的局限                                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  depends_on 只保证【容器启动顺序】                               │</span><br><span class="line">│  不保证【服务就绪】                                              │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  例：MySQL 容器启动了，但可能还在初始化，此时连接会失败           │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  解决方案：                                                      │</span><br><span class="line">│  <span class="number">1.</span> 程序里加重试逻辑                                             │</span><br><span class="line">│  <span class="number">2.</span> 使用 healthcheck + condition: service_healthy              │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（6）networks-网络配置"><a href="#（6）networks-网络配置" class="headerlink" title="（6）networks - 网络配置"></a>（6）networks - 网络配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># networks：定义服务所属网络（网络隔离）</span></span><br><span class="line">services:</span><br><span class="line">  my_server:</span><br><span class="line">    networks:</span><br><span class="line">      - frontend    <span class="comment"># 加入 frontend 网络（对外，给 Nginx 访问）</span></span><br><span class="line">      - backend     <span class="comment"># 加入 backend 网络（对内，访问数据库）</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># my_server 同时在两个网络，可以：</span></span><br><span class="line">      <span class="comment">#   - 被 frontend 网络的 nginx 访问</span></span><br><span class="line">      <span class="comment">#   - 访问 backend 网络的 mysql</span></span><br><span class="line">  </span><br><span class="line">  mysql:</span><br><span class="line">    networks:</span><br><span class="line">      - backend     <span class="comment"># 只在 backend 网络</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># mysql 只在 backend，意味着：</span></span><br><span class="line">      <span class="comment">#   ✓ my_server 能访问它（都在 backend）</span></span><br><span class="line">      <span class="comment">#   ✗ nginx 不能直接访问它（nginx 只在 frontend）</span></span><br><span class="line">      <span class="comment">#   → 数据库被&quot;隔离&quot;保护起来了</span></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  frontend:         <span class="comment"># 前端网络：nginx ↔ my_server</span></span><br><span class="line">  backend:          <span class="comment"># 后端网络：my_server ↔ mysql/redis</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  服务间通信                                                      │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  在同一网络内的容器，可以用【服务名】互相访问：                    │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  my_server 连接 MySQL：                                         │</span><br><span class="line">│    host = <span class="string">&quot;mysql&quot;</span>    （不是 IP，是服务名）                       │</span><br><span class="line">│    port = <span class="number">3306</span>       （容器内部端口，不是映射端口）               │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  C++ 代码示例：                                                  │</span><br><span class="line">│    <span class="built_in">mysql_real_connect</span>(conn, <span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>,          │</span><br><span class="line">│                       <span class="string">&quot;mydb&quot;</span>, <span class="number">3306</span>, <span class="literal">NULL</span>, <span class="number">0</span>);                   │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>网络隔离示意图</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        网络隔离架构                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   外部请求                                                       │</span><br><span class="line">│      │                                                          │</span><br><span class="line">│      ▼                                                          │</span><br><span class="line">│  ┌────────┐     frontend 网络      ┌─────────────┐              │</span><br><span class="line">│  │ nginx  │ ◄──────────────────► │  my_server  │              │</span><br><span class="line">│  └────────┘                        └─────────────┘              │</span><br><span class="line">│                                          │                      │</span><br><span class="line">│              ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│─ ─ ─ ─ ─ ─           │</span><br><span class="line">│                                          │                      │</span><br><span class="line">│                                    backend 网络                  │</span><br><span class="line">│                                          │                      │</span><br><span class="line">│                           ┌──────────────┼──────────────┐       │</span><br><span class="line">│                           ▼              ▼              ▼       │</span><br><span class="line">│                      ┌────────┐    ┌────────┐    ┌────────┐    │</span><br><span class="line">│                      │ mysql  │    │ redis  │    │  ...   │    │</span><br><span class="line">│                      └────────┘    └────────┘    └────────┘    │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   nginx 无法直接访问 mysql（不在同一网络）                        │</span><br><span class="line">│   my_server 可以访问 mysql（都在 backend）                       │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（7）healthcheck-健康检查"><a href="#（7）healthcheck-健康检查" class="headerlink" title="（7）healthcheck - 健康检查"></a>（7）healthcheck - 健康检查</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># healthcheck：定义容器健康检查策略</span></span><br><span class="line">mysql:</span><br><span class="line">  image: mysql:8.0</span><br><span class="line">  healthcheck:</span><br><span class="line">    <span class="comment"># test: 健康检查命令</span></span><br><span class="line">    <span class="comment">#   - 返回 0 = 健康</span></span><br><span class="line">    <span class="comment">#   - 返回非0 = 不健康</span></span><br><span class="line">    <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    interval: 10s       <span class="comment"># 每隔多久检查一次</span></span><br><span class="line">    <span class="built_in">timeout</span>: 5s         <span class="comment"># 单次检查超时时间</span></span><br><span class="line">    retries: 5          <span class="comment"># 连续失败几次才判定为 unhealthy</span></span><br><span class="line">    start_period: 30s   <span class="comment"># 容器启动后的&quot;宽限期&quot;，这段时间内检查失败不算数</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                   healthcheck 参数详解                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  test         检查命令，有三种写法：                              │</span><br><span class="line">│               - [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;命令&quot;</span>, <span class="string">&quot;参数&quot;</span>]     # 直接执行            │</span><br><span class="line">│               - [<span class="string">&quot;CMD-SHELL&quot;</span>, <span class="string">&quot;shell命令&quot;</span>] # 用 /bin/sh -c 执行  │</span><br><span class="line">│               - <span class="string">&quot;shell命令&quot;</span>                # 简写，同上           │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  interval     检查间隔，默认 <span class="number">30</span>s                                 │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  timeout      单次检查超时，默认 <span class="number">30</span>s                             │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  retries      连续失败次数阈值，默认 <span class="number">3</span>                           │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  start_period 启动宽限期，默认 <span class="number">0</span>s                                │</span><br><span class="line">│               MySQL/ES 等服务启动慢，建议设置 <span class="number">30</span>s~<span class="number">60</span>s            │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h4 id="常见服务的-healthcheck-写法"><a href="#常见服务的-healthcheck-写法" class="headerlink" title="&lt;1&gt; 常见服务的 healthcheck 写法"></a>&lt;1&gt; 常见服务的 healthcheck 写法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">services:</span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># MySQL 健康检查</span></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123456</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>, <span class="string">&quot;-uroot&quot;</span>, <span class="string">&quot;-p$<span class="variable">$MYSQL_ROOT_PASSWORD</span>&quot;</span>]</span><br><span class="line">      <span class="comment">#                                                       ↑ $$ 转义，实际传 $MYSQL_ROOT_PASSWORD</span></span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 5</span><br><span class="line">      start_period: 30s</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># Redis 健康检查</span></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    <span class="built_in">command</span>: redis-server --requirepass 123456</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;123456&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">      <span class="comment"># 无密码版：test: [&quot;CMD&quot;, &quot;redis-cli&quot;, &quot;ping&quot;]</span></span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 5s</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># 自己的 C++ 服务健康检查（需要程序提供 /health 接口）</span></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  my_server:</span><br><span class="line">    build: .</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      <span class="comment"># 或用 wget：test: [&quot;CMD&quot;, &quot;wget&quot;, &quot;-q&quot;, &quot;--spider&quot;, &quot;http://localhost:8080/health&quot;]</span></span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 40s</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># Nginx 健康检查</span></span><br><span class="line">  <span class="comment"># ─────────────────────────────────────────────────────────────────</span></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost/&quot;</span>]</span><br><span class="line">      interval: 30s</span><br><span class="line">      <span class="built_in">timeout</span>: 10s</span><br><span class="line">      retries: 3</span><br><span class="line">      start_period: 10s</span><br></pre></td></tr></table></figure>

<h4 id="healthcheck-与-depends-on-配合使用"><a href="#healthcheck-与-depends-on-配合使用" class="headerlink" title="&lt;2&gt;healthcheck 与 depends_on 配合使用"></a>&lt;2&gt;healthcheck 与 depends_on 配合使用</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 【推荐】使用 condition: service_healthy</span></span><br><span class="line">services:</span><br><span class="line">  my_server:</span><br><span class="line">    depends_on:</span><br><span class="line">      mysql:</span><br><span class="line">        condition: service_healthy    <span class="comment"># 等 mysql 健康才启动</span></span><br><span class="line">      redis:</span><br><span class="line">        condition: service_healthy    <span class="comment"># 等 redis 健康才启动</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│              depends_on 两种写法对比                                     │</span><br><span class="line">├────────────────────────────────┬────────────────────────────────────────┤</span><br><span class="line">│  简单写法                       │  完整写法（推荐）                       │</span><br><span class="line">├────────────────────────────────┼────────────────────────────────────────┤</span><br><span class="line">│  depends_on:                   │  depends_on:                           │</span><br><span class="line">│    - mysql                     │    mysql:                              │</span><br><span class="line">│    - redis                     │      condition: service_healthy        │</span><br><span class="line">│                                │    redis:                              │</span><br><span class="line">│                                │      condition: service_healthy        │</span><br><span class="line">├────────────────────────────────┼────────────────────────────────────────┤</span><br><span class="line">│  只保证【容器启动顺序】         │  等待【服务真正就绪】                   │</span><br><span class="line">│  MySQL 容器启动但可能还在初始化 │  MySQL 通过 healthcheck 才继续         │</span><br><span class="line">│  连接可能失败                   │  连接基本不会失败                      │</span><br><span class="line">└────────────────────────────────┴────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h4 id="容器健康状态"><a href="#容器健康状态" class="headerlink" title="&lt;3&gt; 容器健康状态"></a>&lt;3&gt; 容器健康状态</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    容器健康状态流转                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   容器启动                                                       │</span><br><span class="line">│      │                                                          │</span><br><span class="line">│      ▼                                                          │</span><br><span class="line">│  ┌────────────┐                                                 │</span><br><span class="line">│  │  starting  │  ← start_period 期间，检查失败不算数             │</span><br><span class="line">│  └─────┬──────┘                                                 │</span><br><span class="line">│        │ start_period 结束                                      │</span><br><span class="line">│        ▼                                                        │</span><br><span class="line">│  ┌────────────┐   检查成功    ┌────────────┐                   │</span><br><span class="line">│  │  starting  │ ───────────→ │  healthy   │                   │</span><br><span class="line">│  └─────┬──────┘              └─────┬──────┘                    │</span><br><span class="line">│        │                           │                            │</span><br><span class="line">│        │ 连续 retries 次失败        │ 连续 retries 次失败        │</span><br><span class="line">│        ▼                           ▼                            │</span><br><span class="line">│  ┌────────────┐              ┌────────────┐                    │</span><br><span class="line">│  │ unhealthy  │ ◄─────────── │ unhealthy  │                    │</span><br><span class="line">│  └────────────┘   检查失败    └────────────┘                    │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器健康状态</span></span><br><span class="line">docker ps                          <span class="comment"># STATUS 列显示 (healthy) 或 (unhealthy)</span></span><br><span class="line">docker inspect --format=<span class="string">&#x27;&#123;&#123;.State.Health.Status&#125;&#125;&#x27;</span> mysql_container</span><br></pre></td></tr></table></figure>

<h2 id="5-docker-compose-常用命令"><a href="#5-docker-compose-常用命令" class="headerlink" title="5. docker-compose 常用命令"></a>5. docker-compose 常用命令</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124001233281.png"><br>旧版命令：将 “docker compose” 换为 “docker-compose”即可</p>
<h2 id="6-典型-C-项目结构"><a href="#6-典型-C-项目结构" class="headerlink" title="6. 典型 C++ 项目结构"></a>6. 典型 C++ 项目结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">my_cpp_project/</span><br><span class="line">├── Dockerfile                  <span class="comment"># 镜像构建配方</span></span><br><span class="line">├── docker-compose.yml          <span class="comment"># 多容器编排</span></span><br><span class="line">├── .<span class="built_in">env</span>                        <span class="comment"># 环境变量（不要提交到 Git）</span></span><br><span class="line">├── .dockerignore               <span class="comment"># 构建时忽略的文件</span></span><br><span class="line">│</span><br><span class="line">├── src/                        <span class="comment"># 源代码</span></span><br><span class="line">│   ├── main.cpp</span><br><span class="line">│   └── ...</span><br><span class="line">├── include/                    <span class="comment"># 头文件</span></span><br><span class="line">├── CMakeLists.txt              <span class="comment"># CMake 配置</span></span><br><span class="line">│</span><br><span class="line">├── configs/                    <span class="comment"># 配置文件（挂载到容器）</span></span><br><span class="line">│   └── config.yaml</span><br><span class="line">├── logs/                       <span class="comment"># 日志目录（挂载到容器）</span></span><br><span class="line">│</span><br><span class="line">├── nginx.conf                  <span class="comment"># Nginx 配置（如果用）</span></span><br><span class="line">└── init.sql                    <span class="comment"># 数据库初始化脚本</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      完整开发流程                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  <span class="number">1.</span> 写代码（src/）                                               │</span><br><span class="line">│  <span class="number">2.</span> 写 Dockerfile（定义如何构建镜像）                            │</span><br><span class="line">│  <span class="number">3.</span> 写 docker-compose.yml（定义服务编排）                        │</span><br><span class="line">│  <span class="number">4.</span> docker-compose up -d（一键启动所有服务）                     │</span><br><span class="line">│  <span class="number">5.</span> docker-compose logs -f my_server（查看日志调试）             │</span><br><span class="line">│  <span class="number">6.</span> 修改代码后：docker-compose up -d --build（重新构建启动）     │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="7-第三方服务官方镜像模板获取途径"><a href="#7-第三方服务官方镜像模板获取途径" class="headerlink" title="7.第三方服务官方镜像模板获取途径"></a>7.第三方服务官方镜像模板获取途径</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  📌 选择镜像版本的建议                                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ✓ 生产环境：使用具体版本号 mysql:<span class="number">8.0</span><span class="number">.36</span>                         │</span><br><span class="line">│  ✓ 开发环境：使用主版本号 mysql:<span class="number">8.0</span>                              │</span><br><span class="line">│  ✗ 避免使用：latest（版本不可控）                                │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ✓ 优先选择：alpine 版本（更小） redis:<span class="number">7</span>-alpine                  │</span><br><span class="line">│  ✓ 需要调试：debian 版本（工具全） mysql:<span class="number">8.0</span>-debian              │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h3 id="（1）Docker-Hub（主要途径）"><a href="#（1）Docker-Hub（主要途径）" class="headerlink" title="（1）Docker Hub（主要途径）"></a>（1）Docker Hub（主要途径）</h3><p>官网: <a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                         Docker Hub 使用方法                              │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│  <span class="number">1.</span> 搜索镜像                                                             │</span><br><span class="line">│     https:<span class="comment">//hub.docker.com/search?q=mysql                               │</span></span><br><span class="line">│                                                                         │</span><br><span class="line">│  <span class="number">2.</span> 识别官方镜像                                                         │</span><br><span class="line">│     ┌──────────────────────────────────────────────────────┐            │</span><br><span class="line">│     │  ✓ <span class="string">&quot;Official Image&quot;</span> 标签（蓝色徽章）                  │            │</span><br><span class="line">│     │  ✓ <span class="string">&quot;Verified Publisher&quot;</span> 标签（已认证发布者）          │            │</span><br><span class="line">│     │  ✗ 无标签的个人镜像（谨慎使用）                        │            │</span><br><span class="line">│     └──────────────────────────────────────────────────────┘            │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  <span class="number">3.</span> 查看镜像页面内容                                                     │</span><br><span class="line">│     - Overview: 简介、快速开始                                           │</span><br><span class="line">│     - Tags: 可用版本（<span class="number">8.0</span>, <span class="number">8.0</span><span class="number">.36</span>, latest 等）                          │</span><br><span class="line">│     - 环境变量说明                                                       │</span><br><span class="line">│     - volumes 挂载路径                                                   │</span><br><span class="line">│     - docker-compose 示例                                               │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）常用官方镜像速查表"><a href="#（2）常用官方镜像速查表" class="headerlink" title="（2）常用官方镜像速查表"></a>（2）常用官方镜像速查表</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124002125450.png"></p>
<h3 id="（3）镜像页面关键信息位置"><a href="#（3）镜像页面关键信息位置" class="headerlink" title="（3）镜像页面关键信息位置"></a>（3）镜像页面关键信息位置</h3><p>以 MySQL 为例 (<a target="_blank" rel="noopener" href="https://hub.docker.com/_/mysql)%EF%BC%9A">https://hub.docker.com/_/mysql)：</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Docker Hub - MySQL 页面结构                                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│  📋 Quick reference                                                     │</span><br><span class="line">│     └── 官方文档链接、维护者信息                                          │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  📋 Supported tags                                                      │</span><br><span class="line">│     └── <span class="number">8.0</span><span class="number">.36</span>, <span class="number">8.0</span>, <span class="number">8</span>, latest, <span class="number">8.0</span><span class="number">.36</span>-debian, ...                     │</span><br><span class="line">│         ↑ 选择合适的版本标签                                             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  📋 How to use <span class="keyword">this</span> image  ← ⭐重点看这里                                │</span><br><span class="line">│     ├── Start a mysql server instance                                   │</span><br><span class="line">│     │     docker run --name mysql -e MYSQL_ROOT_PASSWORD=<span class="number">123</span> mysql:<span class="number">8.0</span> │</span><br><span class="line">│     │                                                                   │</span><br><span class="line">│     ├── Environment Variables  ← 所有支持的环境变量                      │</span><br><span class="line">│     │     <span class="built_in">MYSQL_ROOT_PASSWORD</span> (必须)                                    │</span><br><span class="line">│     │     MYSQL_DATABASE                                                │</span><br><span class="line">│     │     MYSQL_USER / MYSQL_PASSWORD                                   │</span><br><span class="line">│     │     ...                                                           │</span><br><span class="line">│     │                                                                   │</span><br><span class="line">│     ├── Where to Store Data  ← 数据挂载路径                              │</span><br><span class="line">│     │     /var/lib/mysql                                                │</span><br><span class="line">│     │                                                                   │</span><br><span class="line">│     └── Initializing a fresh instance  ← 初始化脚本路径                  │</span><br><span class="line">│           /docker-entrypoint-initdb.d/                                  │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（4）从-Docker-Hub-提取-docker-compose-配置"><a href="#（4）从-Docker-Hub-提取-docker-compose-配置" class="headerlink" title="（4）从 Docker Hub 提取 docker-compose 配置"></a>（4）从 Docker Hub 提取 docker-compose 配置</h3><p><strong>MySQL 示例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 Docker Hub 页面提取的关键信息：</span></span><br><span class="line"><span class="comment"># - 镜像: mysql:8.0</span></span><br><span class="line"><span class="comment"># - 必须环境变量: MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="comment"># - 可选环境变量: MYSQL_DATABASE, MYSQL_USER, MYSQL_PASSWORD</span></span><br><span class="line"><span class="comment"># - 数据目录: /var/lib/mysql</span></span><br><span class="line"><span class="comment"># - 初始化脚本: /docker-entrypoint-initdb.d/</span></span><br><span class="line"></span><br><span class="line">mysql:</span><br><span class="line">  image: mysql:8.0</span><br><span class="line">  container_name: mysql</span><br><span class="line">  environment:</span><br><span class="line">    MYSQL_ROOT_PASSWORD: <span class="variable">$&#123;DB_ROOT_PASSWORD:-123456&#125;</span></span><br><span class="line">    MYSQL_DATABASE: <span class="variable">$&#123;DB_NAME:-mydb&#125;</span></span><br><span class="line">    MYSQL_USER: <span class="variable">$&#123;DB_USER:-appuser&#125;</span></span><br><span class="line">    MYSQL_PASSWORD: <span class="variable">$&#123;DB_PASSWORD:-apppass&#125;</span></span><br><span class="line">  volumes:</span><br><span class="line">    - mysql_data:/var/lib/mysql</span><br><span class="line">    - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro</span><br><span class="line">  ports:</span><br><span class="line">    - <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">  healthcheck:</span><br><span class="line">    <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>]</span><br><span class="line">    interval: 10s</span><br><span class="line">    <span class="built_in">timeout</span>: 5s</span><br><span class="line">    retries: 5</span><br></pre></td></tr></table></figure>
<p><strong>Redis 示例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 https://hub.docker.com/_/redis 提取</span></span><br><span class="line"><span class="comment"># - 数据目录: /data</span></span><br><span class="line"><span class="comment"># - 配置文件: /usr/local/etc/redis/redis.conf</span></span><br><span class="line"></span><br><span class="line">redis:</span><br><span class="line">  image: redis:7-alpine</span><br><span class="line">  container_name: redis</span><br><span class="line">  <span class="built_in">command</span>: redis-server --requirepass <span class="variable">$&#123;REDIS_PASSWORD:-123456&#125;</span> --appendonly <span class="built_in">yes</span></span><br><span class="line">  volumes:</span><br><span class="line">    - redis_data:/data</span><br><span class="line">  ports:</span><br><span class="line">    - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">  healthcheck:</span><br><span class="line">    <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;redis-cli&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;<span class="variable">$&#123;REDIS_PASSWORD:-123456&#125;</span>&quot;</span>, <span class="string">&quot;ping&quot;</span>]</span><br><span class="line">    interval: 10s</span><br><span class="line">    <span class="built_in">timeout</span>: 5s</span><br><span class="line">    retries: 5</span><br></pre></td></tr></table></figure>
<p><strong>Kafka (Bitnami) 示例</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 https://hub.docker.com/r/bitnami/kafka 提取</span></span><br><span class="line"></span><br><span class="line">kafka:</span><br><span class="line">  image: bitnami/kafka:latest</span><br><span class="line">  container_name: kafka</span><br><span class="line">  environment:</span><br><span class="line">    - KAFKA_CFG_NODE_ID=0</span><br><span class="line">    - KAFKA_CFG_PROCESS_ROLES=controller,broker</span><br><span class="line">    - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093</span><br><span class="line">    - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT</span><br><span class="line">    - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093</span><br><span class="line">    - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER</span><br><span class="line">  volumes:</span><br><span class="line">    - kafka_data:/bitnami/kafka</span><br><span class="line">  ports:</span><br><span class="line">    - <span class="string">&quot;9092:9092&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="（5）命令行快速查看镜像信息"><a href="#（5）命令行快速查看镜像信息" class="headerlink" title="（5）命令行快速查看镜像信息"></a>（5）命令行快速查看镜像信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索镜像</span></span><br><span class="line">docker search mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像所有标签（需要安装 jq）</span></span><br><span class="line">curl -s <span class="string">&quot;https://hub.docker.com/v2/repositories/library/mysql/tags?page_size=100&quot;</span> | jq -r <span class="string">&#x27;.results[].name&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取镜像</span></span><br><span class="line">docker pull mysql:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像详情</span></span><br><span class="line">docker inspect mysql:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像历史（了解构建过程）</span></span><br><span class="line">docker <span class="built_in">history</span> mysql:8.0</span><br></pre></td></tr></table></figure>

<h1 id="四、-dockerignore-文件在C-中的使用"><a href="#四、-dockerignore-文件在C-中的使用" class="headerlink" title="四、 .dockerignore 文件在C++中的使用"></a>四、 .dockerignore 文件在C++中的使用</h1><h2 id="1-什么是-dockerignore"><a href="#1-什么是-dockerignore" class="headerlink" title="1.什么是 .dockerignore"></a>1.什么是 .dockerignore</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    .dockerignore 是什么？                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【类比】就像 .gitignore 告诉 Git 忽略哪些文件                           │</span><br><span class="line">│          .dockerignore 告诉 Docker 构建镜像时忽略哪些文件                 │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【作用】                                                               │</span><br><span class="line">│     <span class="number">1.</span> 减小构建上下文大小 → 加快 docker build 速度                        │</span><br><span class="line">│     <span class="number">2.</span> 避免敏感文件被复制到镜像中（如 .env、私钥）                         │</span><br><span class="line">│     <span class="number">3.</span> 避免不必要的缓存失效 → 利用 Docker 层缓存                          │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="2-工作原理"><a href="#2-工作原理" class="headerlink" title="2.工作原理"></a>2.工作原理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    构建上下文 (Build Context)                            │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   执行 docker build 时：                                                 │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   $ docker build -t myapp .                                             │</span><br><span class="line">│                          ↑                                              │</span><br><span class="line">│                    这个 <span class="string">&quot;.&quot;</span> 就是构建上下文                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   Docker 会把构建上下文中的【所有文件】打包发送给 Docker 引擎              │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────┐        发送整个目录        ┌─────────────────┐    │</span><br><span class="line">│   │   你的项目目录   │  ───────────────────────→  │  Docker 引擎    │    │</span><br><span class="line">│   │  (构建上下文)    │       可能很大！           │  (执行构建)     │    │</span><br><span class="line">│   └─────────────────┘                            └─────────────────┘    │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【问题】如果目录下有 build/、.git/、node_modules/ 等大目录              │</span><br><span class="line">│          发送时间会很长，而且这些文件根本不需要！                          │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【解决】.dockerignore 指定哪些文件不要发送                              │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="3-基本语法"><a href="#3-基本语法" class="headerlink" title="3.基本语法"></a>3.基本语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># .dockerignore 语法（与 .gitignore 类似）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释以 # 开头</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略具体文件</span></span><br><span class="line">README.md</span><br><span class="line">LICENSE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略具体目录（目录名后加 / 更明确）</span></span><br><span class="line">build/</span><br><span class="line">cmake-build-*/</span><br><span class="line">.git/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通配符 * 匹配任意字符（不含路径分隔符）</span></span><br><span class="line">*.<span class="built_in">log</span></span><br><span class="line">*.tmp</span><br><span class="line">*.swp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通配符 ** 匹配任意路径（包含子目录）</span></span><br><span class="line">**/*.<span class="built_in">log</span>          <span class="comment"># 忽略所有目录下的 .log 文件</span></span><br><span class="line">**/temp/          <span class="comment"># 忽略所有名为 temp 的目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通配符 ? 匹配单个字符</span></span><br><span class="line">file?.txt         <span class="comment"># 匹配 file1.txt, fileA.txt 等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取反 ! 表示不忽略（例外）</span></span><br><span class="line">*.md</span><br><span class="line">!README.md        <span class="comment"># 忽略所有 .md，但保留 README.md</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 忽略根目录下的特定文件（以 / 开头）</span></span><br><span class="line">/config.local.yaml   <span class="comment"># 只忽略根目录的，不忽略子目录的</span></span><br></pre></td></tr></table></figure>

<h2 id="4-C-项目-dockerignore-模板"><a href="#4-C-项目-dockerignore-模板" class="headerlink" title="4.C++ 项目 .dockerignore 模板"></a>4.C++ 项目 .dockerignore 模板</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ╔═══════════════════════════════════════════════════════════════════════╗</span></span><br><span class="line"><span class="comment"># ║              C++ 项目 .dockerignore 模板                               ║</span></span><br><span class="line"><span class="comment"># ╚═══════════════════════════════════════════════════════════════════════╝</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 版本控制</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">.git/</span><br><span class="line">.gitignore</span><br><span class="line">.gitattributes</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 构建产物（镜像内会重新编译，不需要本地的）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">build/</span><br><span class="line">cmake-build-*/</span><br><span class="line">out/</span><br><span class="line">bin/</span><br><span class="line">lib/</span><br><span class="line">*.o</span><br><span class="line">*.a</span><br><span class="line">*.so</span><br><span class="line">*.exe</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># IDE 和编辑器配置</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">.idea/</span><br><span class="line">.vscode/</span><br><span class="line">*.swp</span><br><span class="line">*.swo</span><br><span class="line">*~</span><br><span class="line">.project</span><br><span class="line">.cproject</span><br><span class="line">.settings/</span><br><span class="line">*.code-workspace</span><br><span class="line">CMakeUserPresets.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 文档和说明（构建镜像不需要）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">*.md</span><br><span class="line">docs/</span><br><span class="line">LICENSE</span><br><span class="line">CHANGELOG</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 测试相关</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">tests/</span><br><span class="line"><span class="built_in">test</span>/</span><br><span class="line">*_test.cpp</span><br><span class="line">*_test.cc</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 日志和临时文件</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">logs/</span><br><span class="line">*.<span class="built_in">log</span></span><br><span class="line">tmp/</span><br><span class="line">temp/</span><br><span class="line">*.tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 敏感信息（绝对不能进镜像！）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">.<span class="built_in">env</span></span><br><span class="line">.<span class="built_in">env</span>.*</span><br><span class="line">*.pem</span><br><span class="line">*.key</span><br><span class="line">secrets/</span><br><span class="line">credentials/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># Docker 相关（避免递归）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">Dockerfile*</span><br><span class="line">docker-compose*.yml</span><br><span class="line">.docker/</span><br><span class="line">.dockerignore</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 数据文件（通常很大，应该用 volumes 挂载）</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">data/</span><br><span class="line">*.sql</span><br><span class="line">*.db</span><br><span class="line">*.sqlite</span><br><span class="line"></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line"><span class="comment"># 例外：保留必要的配置文件模板</span></span><br><span class="line"><span class="comment"># ─────────────────────────────────────────────────────────────────────────</span></span><br><span class="line">!config.yaml.example</span><br><span class="line">!.env.example</span><br></pre></td></tr></table></figure>
<p><strong>效果对比</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    有无 .dockerignore 的对比                             │</span><br><span class="line">├───────────────────────────────┬─────────────────────────────────────────┤</span><br><span class="line">│       没有 .dockerignore       │        有 .dockerignore                 │</span><br><span class="line">├───────────────────────────────┼─────────────────────────────────────────┤</span><br><span class="line">│                               │                                         │</span><br><span class="line">│  my_project/     500MB        │  my_project/     50MB                   │</span><br><span class="line">│  ├── .git/       200MB  ✗     │  ├── src/        10MB  ✓               │</span><br><span class="line">│  ├── build/      150MB  ✗     │  ├── include/    5MB   ✓               │</span><br><span class="line">│  ├── src/        10MB   ✓     │  ├── CMakeLists  1KB   ✓               │</span><br><span class="line">│  ├── include/    5MB    ✓     │  └── ...                               │</span><br><span class="line">│  ├── logs/       50MB   ✗     │                                         │</span><br><span class="line">│  └── ...                      │                                         │</span><br><span class="line">│                               │                                         │</span><br><span class="line">│  发送 500MB 到 Docker 引擎     │  只发送 50MB                            │</span><br><span class="line">│  耗时：30秒+                   │  耗时：3秒                              │</span><br><span class="line">│                               │                                         │</span><br><span class="line">└───────────────────────────────┴─────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="5-常见问题"><a href="#5-常见问题" class="headerlink" title="5.常见问题"></a>5.常见问题</h2><h3 id="（1）为什么忽略-Dockerfile？"><a href="#（1）为什么忽略-Dockerfile？" class="headerlink" title="（1）为什么忽略 Dockerfile？"></a>（1）为什么忽略 Dockerfile？</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Q: Dockerfile 不是构建必需的吗？为什么要忽略？                           │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│  A: docker build 命令会单独读取 Dockerfile，不需要通过构建上下文传递      │</span><br><span class="line">│                                                                         │</span><br><span class="line">│     docker build -f Dockerfile -t myapp .                               │</span><br><span class="line">│                  ↑                      ↑                               │</span><br><span class="line">│            单独指定 Dockerfile      构建上下文（不含 Dockerfile）         │</span><br><span class="line">│                                                                         │</span><br><span class="line">│     忽略它可以：                                                         │</span><br><span class="line">│     1. 减小上下文体积                                                    │</span><br><span class="line">│     2. 修改 Dockerfile 不会导致 COPY . . 的缓存失效                      │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）验证-dockerignore-是否生效"><a href="#（2）验证-dockerignore-是否生效" class="headerlink" title="（2）验证 .dockerignore 是否生效"></a>（2）验证 .dockerignore 是否生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方法1：查看构建上下文大小</span></span><br><span class="line">$ docker build -t <span class="built_in">test</span> .</span><br><span class="line">Sending build context to Docker daemon  52.4MB   <span class="comment"># ← 看这个数字</span></span><br><span class="line">                                        ↑</span><br><span class="line">                              应该比项目目录小很多</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2：列出实际会发送的文件（调试用）</span></span><br><span class="line">$ docker build -f /dev/null -t <span class="built_in">test</span> . 2&gt;&amp;1 | <span class="built_in">head</span></span><br><span class="line"><span class="comment"># 或者用这个小技巧</span></span><br><span class="line">$ tar -czf - . | <span class="built_in">wc</span> -c   <span class="comment"># 不忽略的大小</span></span><br><span class="line">$ tar -czf - --exclude-from=.dockerignore . | <span class="built_in">wc</span> -c  <span class="comment"># 忽略后的大小</span></span><br></pre></td></tr></table></figure>

<h2 id="6-文件位置"><a href="#6-文件位置" class="headerlink" title="6.文件位置"></a>6.文件位置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  .dockerignore 必须放在构建上下文的根目录                                 │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│  my_project/                                                            │</span><br><span class="line">│  ├── .dockerignore    ← 放这里！和 Dockerfile 同级                       │</span><br><span class="line">│  ├── Dockerfile                                                         │</span><br><span class="line">│  ├── docker-compose.yml                                                 │</span><br><span class="line">│  ├── src/                                                               │</span><br><span class="line">│  └── ...                                                                │</span><br><span class="line">│                                                                         │</span><br><span class="line">│  执行命令时：                                                            │</span><br><span class="line">│  $ <span class="built_in">cd</span> my_project                                                        │</span><br><span class="line">│  $ docker build -t myapp .                                              │</span><br><span class="line">│                          ↑ 这个 . 目录下必须有 .dockerignore             │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h1 id="五、Docker-辅助开发"><a href="#五、Docker-辅助开发" class="headerlink" title="五、Docker 辅助开发"></a>五、Docker 辅助开发</h1><h2 id="1-Docker的两种使用场景"><a href="#1-Docker的两种使用场景" class="headerlink" title="1.Docker的两种使用场景"></a>1.Docker的两种使用场景</h2><p>Docker 既可以用于部署，也可以用于开发。两种用法都很常见：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Docker 的两种使用场景                                │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   【开发阶段】                        【部署阶段】                        │</span><br><span class="line">│   ───────────                        ───────────                        │</span><br><span class="line">│   ✓ 统一开发环境                      ✓ 快速部署                         │</span><br><span class="line">│   ✓ 新人入职一键搭建                  ✓ 环境一致性                        │</span><br><span class="line">│   ✓ 避免<span class="string">&quot;在我机器上能跑&quot;</span>              ✓ 横向扩展                         │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    开发阶段 vs 部署阶段                                   │</span><br><span class="line">├───────────────────────────┬─────────────────────────────────────────────┤</span><br><span class="line">│        开发阶段            │              部署阶段                        │</span><br><span class="line">├───────────────────────────┼─────────────────────────────────────────────┤</span><br><span class="line">│                           │                                             │</span><br><span class="line">│  docker-compose.dev.yml   │  Dockerfile + docker-compose.yml            │</span><br><span class="line">│  ┌─────────────────────┐  │  ┌─────────────────────────────────────┐    │</span><br><span class="line">│  │ services:           │  │  │ services:                           │    │</span><br><span class="line">│  │   mysql:            │  │  │   my_server:                        │    │</span><br><span class="line">│  │     image: mysql    │  │  │     build: .  ← 用 Dockerfile 构建   │    │</span><br><span class="line">│  │   redis:            │  │  │   mysql:                            │    │</span><br><span class="line">│  │     image: redis    │  │  │     image: mysql                    │    │</span><br><span class="line">│  └─────────────────────┘  │  │   redis:                            │    │</span><br><span class="line">│                           │  │     image: redis                    │    │</span><br><span class="line">│  只启动第三方服务          │  └─────────────────────────────────────┘    │</span><br><span class="line">│  你的程序在宿主机跑        │  所有服务都容器化（包括你的程序）            │</span><br><span class="line">│                           │                                             │</span><br><span class="line">└───────────────────────────┴─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>开发时</strong>：docker-compose 辅助（启动依赖服务）</li>
<li><strong>部署时</strong>：Dockerfile（构建镜像）+ docker-compose（编排所有容器）<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260124100614274.png"></li>
</ul>
<h2 id="2-Docker辅助开发流程"><a href="#2-Docker辅助开发流程" class="headerlink" title="2.Docker辅助开发流程"></a>2.Docker辅助开发流程</h2><h3 id="（1）原理"><a href="#（1）原理" class="headerlink" title="（1）原理"></a>（1）原理</h3><ul>
<li><p>在 docker-compose.dev.yml 中配置好第三方服务的”服务端”</p>
<ul>
<li><strong>端口映射</strong>：<code>宿主机端口:容器端口</code>，让宿主机程序能访问容器服务</li>
<li><strong>网络配置</strong>：容器间可通过”服务名”互相访问（宿主机程序用不到）</li>
</ul>
</li>
<li><p>通过 docker-compose 命令运行，将服务端在容器中启动</p>
</li>
<li><p><strong>宿主机的 C++ 程序连接服务时</strong>：</p>
<ul>
<li><strong>连接地址</strong>：<code>127.0.0.1:映射的宿主机端口</code></li>
<li>宿主机收到请求后，通过<strong>端口映射转发</strong>到容器内的服务</li>
</ul>
</li>
</ul>
<p><strong>Docker 辅助开发的网络流程</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Docker 辅助开发网络原理                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   宿主机                                                                 │</span><br><span class="line">│   ┌───────────────────────────────────────────────────────────────┐    │</span><br><span class="line">│   │                                                               │    │</span><br><span class="line">│   │   你的 C++ 程序                                                │    │</span><br><span class="line">│   │   连接地址：127.0.0.1:3306                                    │    │</span><br><span class="line">│   │             127.0.0.1:6379                                    │    │</span><br><span class="line">│   │                  │                                            │    │</span><br><span class="line">│   └──────────────────┼────────────────────────────────────────────┘    │</span><br><span class="line">│                      │ 端口映射                                         │</span><br><span class="line">│                      ▼                                                  │</span><br><span class="line">│   ┌───────────────────────────────────────────────────────────────┐    │</span><br><span class="line">│   │                    Docker 网络                                 │    │</span><br><span class="line">│   │  ┌─────────────────┐      ┌─────────────────┐                 │    │</span><br><span class="line">│   │  │  MySQL 容器     │      │  Redis 容器     │                 │    │</span><br><span class="line">│   │  │  3306:3306      │      │  6379:6379      │                 │    │</span><br><span class="line">│   │  │  服务名: mysql  │      │  服务名: redis  │                 │    │</span><br><span class="line">│   │  └─────────────────┘      └─────────────────┘                 │    │</span><br><span class="line">│   └───────────────────────────────────────────────────────────────┘    │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   端口映射格式：宿主机端口:容器端口                                        │</span><br><span class="line">│   例：3306:3306 表示宿主机的 3306 转发到容器的 3306                       │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<h3 id="（2）客户端下载“客户端库”"><a href="#（2）客户端下载“客户端库”" class="headerlink" title="（2）客户端下载“客户端库”"></a>（2）客户端下载“客户端库”</h3><p><strong>客户端库仍然需要安装</strong></p>
<ul>
<li>Docker 容器里运行的是”服务端程序”（mysqld、redis-server）</li>
<li>你的 C++ 程序需要”客户端库”（libmysqlclient、hiredis）来连接这些服务</li>
<li>如果在宿主机编译，宿主机需要安装这些客户端库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 宿主机仍然要装客户端库（编译用）</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libmysqlclient-dev   <span class="comment"># MySQL 客户端库</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libhiredis-dev       <span class="comment"># Redis 客户端库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker 只负责运行服务端</span></span><br><span class="line">docker compose up -d   <span class="comment"># 启动 MySQL、Redis 服务端</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      宿主机                                │</span><br><span class="line">│  ┌──────────────────────────────────────────────────────┐ │</span><br><span class="line">│  │  你的 C++ 代码                                        │ │</span><br><span class="line">│  │  <span class="comment">#include &lt;mysql/mysql.h&gt;  ← 需要头文件              │ │</span></span><br><span class="line">│  │  mysql_real_connect(...)   ← 需要链接 libmysqlclient │ │</span><br><span class="line">│  └──────────────────────────────────────────────────────┘ │</span><br><span class="line">│                         │                                  │</span><br><span class="line">│          编译时需要      │      运行时连接                  │</span><br><span class="line">│               ↓          │           ↓                      │</span><br><span class="line">│  ┌──────────────────┐   │   ┌──────────────────┐          │</span><br><span class="line">│  │ libmysqlclient   │   │   │  MySQL 容器      │          │</span><br><span class="line">│  │ (宿主机安装)      │   └──→│  (Docker 运行)   │          │</span><br><span class="line">│  └──────────────────┘       └──────────────────┘          │</span><br><span class="line">└────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（3）docker-compse-dev-yml的编写与使用"><a href="#（3）docker-compse-dev-yml的编写与使用" class="headerlink" title="（3）docker-compse.dev.yml的编写与使用"></a>（3）docker-compse.dev.yml的编写与使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.dev.yml</span></span><br><span class="line"><span class="comment"># 只用 Docker 跑第三方服务，代码在宿主机写和编译</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:8.0</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: 123456</span><br><span class="line">    volumes:</span><br><span class="line">      - mysql_data:/var/lib/mysql</span><br><span class="line">    healthcheck:</span><br><span class="line">      <span class="built_in">test</span>: [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;mysqladmin&quot;</span>, <span class="string">&quot;ping&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="string">&quot;localhost&quot;</span>]</span><br><span class="line">      interval: 10s</span><br><span class="line">      <span class="built_in">timeout</span>: 5s</span><br><span class="line">      retries: 3</span><br><span class="line">    networks:                       <span class="comment"># 指定该服务加入的网络</span></span><br><span class="line">      - dev-network</span><br><span class="line"></span><br><span class="line">  redis:                            <span class="comment"># 示例：添加 Redis 服务</span></span><br><span class="line">    image: redis:7-alpine</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    networks:</span><br><span class="line">      - dev-network</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  mysql_data:</span><br><span class="line"></span><br><span class="line">networks:                           <span class="comment"># 定义网络</span></span><br><span class="line">  dev-network:</span><br><span class="line">    driver: bridge                  <span class="comment"># 默认桥接模式</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 开发阶段：只用 docker-compose 启动第三方服务</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line">docker compose -f docker-compose.dev.yml up -d   <span class="comment"># 启动 MySQL等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 你的代码在宿主机编译运行</span></span><br><span class="line">cmake -B build &amp;&amp; cmake --build build</span><br><span class="line">./build/my_server   <span class="comment"># 连接容器里的 MySQL:3306、Redis:6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 部署阶段：Dockerfile + docker-compose 全部容器化</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line">docker compose up -d --build   <span class="comment"># 用 Dockerfile 构建镜像，启动所有服务</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">     开发阶段                              部署阶段</span><br><span class="line"> ──────────────                        ──────────────</span><br><span class="line"></span><br><span class="line"> 宿主机                                  服务器</span><br><span class="line">┌──────────────┐                      ┌──────────────────────────┐</span><br><span class="line">│ VS Code      │                      │                          │</span><br><span class="line">│ GCC/CMake    │                      │  ┌────────┐  ┌────────┐  │</span><br><span class="line">│ 你的代码     │                      │  │你的程序│  │ MySQL  │  │</span><br><span class="line">└──────┬───────┘                      │  │(容器)  │  │(容器)  │  │</span><br><span class="line">       │                              │  └────────┘  └────────┘  │</span><br><span class="line">       │ 连接                          │  ┌────────┐              │</span><br><span class="line">       ▼                              │  │ Redis  │              │</span><br><span class="line">┌──────────────┐                      │  │(容器)  │              │</span><br><span class="line">│ MySQL(容器)  │                      │  └────────┘              │</span><br><span class="line">│ Redis(容器)  │ ←docker-compose启动   └──────────────────────────┘</span><br><span class="line">└──────────────┘                              ↑</span><br><span class="line">                                       Dockerfile 构建</span><br><span class="line">                                       docker-compose 编排</span><br></pre></td></tr></table></figure>

<h1 id="附录1：C-后端常用客户端库安装"><a href="#附录1：C-后端常用客户端库安装" class="headerlink" title="附录1：C++ 后端常用客户端库安装"></a>附录1：C++ 后端常用客户端库安装</h1><h2 id="1-Ubuntu-Debian-安装命令"><a href="#1-Ubuntu-Debian-安装命令" class="headerlink" title="1.Ubuntu&#x2F;Debian 安装命令"></a>1.Ubuntu&#x2F;Debian 安装命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 数据库类</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libmysqlclient-dev      <span class="comment"># MySQL</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libpq-dev               <span class="comment"># PostgreSQL</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libmongoc-dev           <span class="comment"># MongoDB C Driver</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libsqlite3-dev          <span class="comment"># SQLite</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 缓存/消息队列</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libhiredis-dev          <span class="comment"># Redis</span></span><br><span class="line"><span class="built_in">sudo</span> apt install librdkafka-dev          <span class="comment"># Kafka</span></span><br><span class="line"><span class="built_in">sudo</span> apt install librabbitmq-dev         <span class="comment"># RabbitMQ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 分布式协调</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libzookeeper-mt-dev     <span class="comment"># Zookeeper (多线程版)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 网络/RPC</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libcurl4-openssl-dev    <span class="comment"># cURL (HTTP 客户端)</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libgrpc++-dev           <span class="comment"># gRPC</span></span><br><span class="line"><span class="built_in">sudo</span> apt install protobuf-compiler       <span class="comment"># Protobuf 编译器</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libprotobuf-dev         <span class="comment"># Protobuf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="comment"># 工具类</span></span><br><span class="line"><span class="comment"># ═══════════════════════════════════════════════════════════</span></span><br><span class="line"><span class="built_in">sudo</span> apt install uuid-dev                <span class="comment"># UUID</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libjsoncpp-dev          <span class="comment"># JSON 解析</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libssl-dev              <span class="comment"># OpenSSL</span></span><br><span class="line"><span class="built_in">sudo</span> apt install libboost-all-dev        <span class="comment"># Boost 全家桶</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│  ⚠️  Nginx 说明                                                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  Nginx 是反向代理/Web 服务器，C++ 程序通常不需要 <span class="string">&quot;Nginx 客户端库&quot;</span>            │</span><br><span class="line">│  你的 C++ 程序作为后端服务，被 Nginx 反向代理调用（HTTP 请求）               │</span><br><span class="line">│  如果需要 C++ 发起 HTTP 请求，使用 libcurl 即可                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<h2 id="2-速查表"><a href="#2-速查表" class="headerlink" title="2.速查表"></a>2.速查表</h2><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    C++ 客户端库速查表                                        │</span><br><span class="line">├───────────────┬─────────────────────────┬──────────────────┬────────────────┤</span><br><span class="line">│    服务        │    apt 包名              │    头文件         │    链接库      │</span><br><span class="line">├───────────────┼─────────────────────────┼──────────────────┼────────────────┤</span><br><span class="line">│  MySQL        │  libmysqlclient-dev     │  <span class="attribute">&lt;mysql/mysql.h&gt;</span> │  -lmysqlclient │</span><br><span class="line">│  PostgreSQL   │  libpq-dev              │  <span class="attribute">&lt;libpq-fe.h&gt;</span>    │  -lpq          │</span><br><span class="line">│  Redis        │  libhiredis-dev         │  <span class="attribute">&lt;hiredis/hiredis.h&gt;</span> │ -lhiredis  │</span><br><span class="line">│  Kafka        │  librdkafka-dev         │  <span class="attribute">&lt;librdkafka/rdkafka.h&gt;</span> │ -lrdkafka│</span><br><span class="line">│  Zookeeper    │  libzookeeper-mt-dev    │  <span class="attribute">&lt;zookeeper/zookeeper.h&gt;</span>│-lzookeeper_mt│</span><br><span class="line">│  RabbitMQ     │  librabbitmq-dev        │  <span class="attribute">&lt;amqp.h&gt;</span>        │  -lrabbitmq    │</span><br><span class="line">│  MongoDB      │  libmongoc-dev          │  <span class="attribute">&lt;mongoc/mongoc.h&gt;</span>│ -lmongoc-1.0  │</span><br><span class="line">│  cURL         │  libcurl4-openssl-dev   │  <span class="attribute">&lt;curl/curl.h&gt;</span>   │  -lcurl        │</span><br><span class="line">│  gRPC         │  libgrpc++-dev          │  <span class="attribute">&lt;grpcpp/grpcpp.h&gt;</span>│ -lgrpc++      │</span><br><span class="line">│  Protobuf     │  libprotobuf-dev        │  <span class="attribute">&lt;google/protobuf/...&gt;</span>│ -lprotobuf│</span><br><span class="line">│  UUID         │  uuid-dev               │  <span class="attribute">&lt;uuid/uuid.h&gt;</span>   │  -luuid        │</span><br><span class="line">│  JSON         │  libjsoncpp-dev         │  <span class="attribute">&lt;json/json.h&gt;</span>   │  -ljsoncpp     │</span><br><span class="line">│  SSL          │  libssl-dev             │  <span class="attribute">&lt;openssl/ssl.h&gt;</span> │  -lssl -lcrypto│</span><br><span class="line">└───────────────┴─────────────────────────┴──────────────────┴────────────────┘</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="咸鱼 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="咸鱼 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>咸鱼
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://xianyubuxian-txy.github.io/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/" title="Docker的使用">https://xianyubuxian-txy.github.io/2026/01/22/C++/C++后端开发常用库/Docker的使用/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/" rel="prev" title="protobuf的使用">
                  <i class="fa fa-angle-left"></i> protobuf的使用
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2026/01/23/C++/C++%E7%89%B9%E6%80%A7/C++11%E7%89%B9%E6%80%A7/%E7%BB%A7%E6%89%BF%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-Inheriting-Constructors/" rel="next" title="继承构造函数(using Base::Base)">
                  继承构造函数(using Base::Base) <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">咸鱼</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">229k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">12:44</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xianyubuxian-TXY" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-beta-black.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请文明评论呀","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2026/01/22/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/Docker%E7%9A%84%E4%BD%BF%E7%94%A8/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
