<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"xianyubuxian-txy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一、概述  * Protobuf 是 Google 开发的一种轻量级、高效的结构化数据序列化协议，比 JSON、XML 更紧凑、更快，广泛用于网络通信和数据存储。  1.核心优势  * 高效性：         * 二进制格式，序列化后体积小，解析速度快（比 JSON 快 3-5 倍）          * 跨语言：         * 支持 C++、Java、Python、Go、JavaScri">
<meta property="og:type" content="article">
<meta property="og:title" content="protobuf的使用">
<meta property="og:url" content="https://xianyubuxian-txy.github.io/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Xianyu">
<meta property="og:description" content="一、概述  * Protobuf 是 Google 开发的一种轻量级、高效的结构化数据序列化协议，比 JSON、XML 更紧凑、更快，广泛用于网络通信和数据存储。  1.核心优势  * 高效性：         * 二进制格式，序列化后体积小，解析速度快（比 JSON 快 3-5 倍）          * 跨语言：         * 支持 C++、Java、Python、Go、JavaScri">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119221513229.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222351058.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222225945.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222446609.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222513321.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119223758714.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119230729435.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119230756739.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120090503033.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091029916.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091111812.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091236245.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091314284.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091430492.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120103057891.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120234637423.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100053975.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100154823.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122103313708.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100447091.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122101152562.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120111458667.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122105626627.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153138053.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153119547.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153548149.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153842158.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235923782.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119234919030.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235233461.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235355637.png">
<meta property="article:published_time" content="2026-01-19T14:04:28.000Z">
<meta property="article:modified_time" content="2026-01-22T12:44:39.489Z">
<meta property="article:author" content="咸鱼">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119221513229.png">


<link rel="canonical" href="https://xianyubuxian-txy.github.io/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://xianyubuxian-txy.github.io/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/","path":"2026/01/19/C++/C++后端开发常用库/protobuf的使用/","title":"protobuf的使用"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>protobuf的使用 | Xianyu</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  




<link rel="dns-prefetch" href="https://waline-beta-black.vercel.app">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Xianyu</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A6%82%E8%BF%B0"><span class="nav-text">一、概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A0%B8%E5%BF%83%E4%BC%98%E5%8A%BF"><span class="nav-text">1.核心优势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%A0%B8%E5%BF%83%E6%9C%AF%E8%AF%AD"><span class="nav-text">2.核心术语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Proto%E6%96%87%E4%BB%B6"><span class="nav-text">3.Proto文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">二、数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A0%87%E9%87%8F%E7%B1%BB%E5%9E%8B"><span class="nav-text">1.标量类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89int32-vs-sint32%EF%BC%88%E8%B4%9F%E6%95%B0%E9%97%AE%E9%A2%98%EF%BC%89"><span class="nav-text">（1）int32 vs sint32（负数问题）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89fixed32-vs-int32%EF%BC%88%E5%A4%A7%E6%95%B0%E5%80%BC%EF%BC%89"><span class="nav-text">（2）fixed32 vs int32（大数值）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89string-vs-bytes"><span class="nav-text">（3）string vs bytes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E9%80%89%E5%9E%8B%E5%86%B3%E7%AD%96%E6%A0%91"><span class="nav-text">（4）选型决策树</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B-%E5%AD%97%E6%AE%B5%E8%A7%84%E5%88%99"><span class="nav-text">2.复合类型 &amp; 字段规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89message%EF%BC%88%E6%B6%88%E6%81%AF%EF%BC%89"><span class="nav-text">（1）message（消息）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89enum%EF%BC%88%E6%9E%9A%E4%B8%BE%EF%BC%89"><span class="nav-text">（2）enum（枚举）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-1"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#map%EF%BC%88%E6%98%A0%E5%B0%84%EF%BC%89"><span class="nav-text">&lt;3&gt;map&lt;K, V&gt;（映射）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-2"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-2"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89oneof%EF%BC%88%E4%BA%92%E6%96%A5%E5%AD%97%E6%AE%B5%EF%BC%89"><span class="nav-text">（4）oneof（互斥字段）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-3"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-3"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89Any%EF%BC%88%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="nav-text">（5）Any（动态类型）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-4"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-4"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-4"><span class="nav-text">&lt;3&gt;使用示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Protobuf-Any-%E7%9A%84%E2%80%9D%E5%8A%A8%E6%80%81%E7%B1%BB%E5%9E%8B%E2%80%9D%E8%A7%A3%E6%9E%90"><span class="nav-text">&lt;4&gt;Protobuf Any 的”动态类型”解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Timestamp%EF%BC%88%E6%97%B6%E9%97%B4%E7%82%B9%EF%BC%89"><span class="nav-text">（6）Timestamp（时间点）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-5"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-5"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-5"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89Duration%EF%BC%88%E6%97%B6%E9%97%B4%E6%AE%B5%EF%BC%89"><span class="nav-text">（7）Duration（时间段）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-6"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-6"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-6"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%888%EF%BC%89optional-T%EF%BC%88%E5%8F%AF%E9%80%89%E5%AD%97%E6%AE%B5%EF%BC%89"><span class="nav-text">（8）optional T（可选字段）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-7"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-7"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-7"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%889%EF%BC%89repeated-T%EF%BC%88%E6%95%B0%E7%BB%84%EF%BC%89"><span class="nav-text">（9）repeated T（数组）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-8"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-8"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-8"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E9%80%9A%E7%94%A8-Message-%E5%9F%BA%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="nav-text">3.通用 Message 基类方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89C-%E7%94%9F%E6%88%90%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">（1）C++ 生成伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-text">（2）序列化&#x2F;反序列化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9AWell-Known-Types"><span class="nav-text">补充：Well-Known Types</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Wrapper-Types%EF%BC%88%E5%8C%85%E8%A3%85%E7%B1%BB%E5%9E%8B%EF%BC%89"><span class="nav-text">（1）Wrapper Types（包装类型）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-9"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-9"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-9"><span class="nav-text">&lt;3&gt;使用示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Wrapper-vs-optional-%E5%AF%B9%E6%AF%94"><span class="nav-text">&lt;4&gt;Wrapper vs optional 对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Struct-Value-ListValue%EF%BC%88%E5%8A%A8%E6%80%81-JSON-%E7%BB%93%E6%9E%84%EF%BC%89"><span class="nav-text">（2）Struct &#x2F; Value &#x2F; ListValue（动态 JSON 结构）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-10"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-10"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-10"><span class="nav-text">&lt;3&gt;使用示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Struct-%E4%B8%8E-JSON-%E4%BA%92%E8%BD%AC"><span class="nav-text">&lt;4&gt;Struct 与 JSON 互转</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89Empty%EF%BC%88%E7%A9%BA%E6%B6%88%E6%81%AF%EF%BC%89"><span class="nav-text">（3）Empty（空消息）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-11"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-11"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-11"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89FieldMask%EF%BC%88%E5%AD%97%E6%AE%B5%E6%8E%A9%E7%A0%81%EF%BC%89"><span class="nav-text">（4）FieldMask（字段掩码）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Proto-%E5%AE%9A%E4%B9%89-12"><span class="nav-text">&lt;1&gt;Proto 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%94%9F%E6%88%90%E7%B1%BB%E5%9E%8B%E4%BC%AA%E4%BB%A3%E7%A0%81-12"><span class="nav-text">&lt;2&gt;C++ 生成类型伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-12"><span class="nav-text">&lt;3&gt;使用示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81RPC%EF%BC%88%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%89"><span class="nav-text">三、RPC（远程过程调用）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-RPC%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="nav-text">1.RPC的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-RPC%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%89"><span class="nav-text">2.RPC底层原理（重点！！）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89RPC%E6%A0%B8%E5%BF%83%E6%AD%A5%E9%AA%A4%EF%BC%88%E6%A6%82%E8%BF%B0%EF%BC%89"><span class="nav-text">（1）RPC核心步骤（概述）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89RPC%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">（2）RPC过程详解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-RPC-%E7%9A%84%E6%80%A7%E8%83%BD%E4%B8%8E%E4%BB%B7%E5%80%BC"><span class="nav-text">3.RPC 的性能与价值</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Proto-Service%EF%BC%88%E7%BA%AF-Protobuf-%E5%B1%82%E9%9D%A2%EF%BC%89"><span class="nav-text">四、Proto Service（纯 Protobuf 层面）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="nav-text">1.概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Service%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">2.Service的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">（1）基本语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4"><span class="nav-text">（2）编译命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84-C-%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">（3）生成的 C++ 伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89Stub%E7%B1%BB-%E4%B8%8E-RpcChannel%E7%B1%BB-%E8%A7%A3%E6%9E%90"><span class="nav-text">（4）Stub类 与 RpcChannel类 解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">&lt;1&gt;使用伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Stub%E7%B1%BB-%E4%B8%8E-RpcChannel%E7%B1%BB-%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">&lt;2&gt;Stub类 与 RpcChannel类 的关系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89RpcController%E7%B1%BB-%E4%B8%8E-Closure%E7%B1%BB"><span class="nav-text">（5）RpcController类 与 Closure类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RpcController-%E7%B1%BB"><span class="nav-text">&lt;1&gt; RpcController 类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Closure-%E7%B1%BB"><span class="nav-text">&lt;2&gt; Closure 类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">（6）服务端的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%BD%951%EF%BC%9A%E8%87%AA%E5%AE%9A%E4%B9%89RpcChannel%E7%A4%BA%E4%BE%8B"><span class="nav-text">附录1：自定义RpcChannel示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%84%E5%BD%952%EF%BC%9AClosure-%E5%B8%B8%E7%94%A8%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="nav-text">附录2：Closure 常用构造方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Service%E5%9C%A8RPC%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">3.Service在RPC中的作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Protobuf%E7%9A%84%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6"><span class="nav-text">4.Protobuf的反射机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Protobuf%E7%9A%84%E5%8F%8D%E5%B0%84%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84"><span class="nav-text">（1）Protobuf的反射层次结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89ServiceDescriptor%EF%BC%88%E6%9C%8D%E5%8A%A1%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%89"><span class="nav-text">（2）ServiceDescriptor（服务描述符）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89MethodDescriptor-%EF%BC%88%E6%96%B9%E6%B3%95%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%89"><span class="nav-text">（3）MethodDescriptor （方法描述符）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89DescriptorPool%EF%BC%88%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B1%A0%EF%BC%89"><span class="nav-text">（4）DescriptorPool（描述符池）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89FileDescriptor%EF%BC%88%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%89"><span class="nav-text">（5）FileDescriptor（文件描述符）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89MessageDescriptor%EF%BC%88%E6%B6%88%E6%81%AF%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%89"><span class="nav-text">（6）MessageDescriptor（消息描述符）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%887%EF%BC%89FieldDescriptor%EF%BC%88%E5%AD%97%E6%AE%B5%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%89"><span class="nav-text">（7）FieldDescriptor（字段描述符）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81gRPC-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">五、gRPC 的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-gRPC-%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4"><span class="nav-text">1.gRPC 编译命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%9F%BA%E6%9C%AC%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4"><span class="nav-text">（1）基本编译命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%8C%87%E5%AE%9A%E8%BE%93%E5%87%BA%E7%9B%AE%E5%BD%95"><span class="nav-text">（2）指定输出目录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%9B%9B%E7%A7%8D-RPC-%E6%A8%A1%E5%BC%8F"><span class="nav-text">2.四种 RPC 模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%88%E7%BB%BC%E5%90%88%EF%BC%89"><span class="nav-text">3.使用示例（综合）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89Proto%E5%AE%9A%E4%B9%89"><span class="nav-text">（1）Proto定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84C-%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">（2）生成的C++伪代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%9F%BA%E7%B1%BB%EF%BC%88demo-grpc-pb-h%EF%BC%89"><span class="nav-text">&lt;1&gt;服务端基类（demo.grpc.pb.h）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%B5%81%E6%93%8D%E4%BD%9C%E7%B1%BB%EF%BC%88gRPC-%E5%BA%93%E6%8F%90%E4%BE%9B%EF%BC%89"><span class="nav-text">&lt;2&gt;核心流操作类（gRPC 库提供）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89gRPC-%E6%96%B0%E5%A2%9E%E7%9A%84%E5%85%B3%E9%94%AE%E7%B1%BB%E5%9E%8B%EF%BC%88C-%E4%BC%AA%E4%BB%A3%E7%A0%81%EF%BC%89"><span class="nav-text">（3）gRPC 新增的关键类型（C++ 伪代码）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc-Status"><span class="nav-text">&lt;1&gt;grpc::Status</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">1)内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">2）使用示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc-ClientContext-%E2%80%94-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E7%94%A8%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-text">&lt;2&gt;grpc::ClientContext — 客户端调用上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">1）内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="nav-text">2）使用示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc-ServerContext-%E2%80%94-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%A4%84%E7%90%86%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="nav-text">&lt;3&gt;grpc::ServerContext — 服务端处理上下文</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">1)内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-text">2）使用示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc-Channel"><span class="nav-text">&lt;4&gt;grpc::Channel</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">1）内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="nav-text">2）使用示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#grpc-Server-grpc-ServerBuilder"><span class="nav-text">&lt;5&gt;grpc::Server &amp; grpc::ServerBuilder</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81-2"><span class="nav-text">1）内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-4"><span class="nav-text">2）使用示例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="nav-text">&lt;6&gt;流操作类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1%EF%BC%89%E5%86%85%E9%83%A8%E4%BC%AA%E4%BB%A3%E7%A0%81-3"><span class="nav-text">1）内部伪代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-5"><span class="nav-text">2）使用示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Unary%EF%BC%88%E4%B8%80%E5%85%83%EF%BC%89"><span class="nav-text">4.Unary（一元）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1"><span class="nav-text">（1）功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Proto%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Proto定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84-C-%E5%85%B3%E9%94%AE%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">（3）生成的 C++ 关键伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-text">（4）使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="nav-text">（5）数据流图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Unary%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-text">（6）Unary模式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Server-Streaming%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B5%81%EF%BC%89"><span class="nav-text">5.Server Streaming（服务端流）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1-1"><span class="nav-text">（1）功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Proto%E5%AE%9A%E4%B9%89-1"><span class="nav-text">（2）Proto定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84-C-%E5%85%B3%E9%94%AE%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">（3）生成的 C++ 关键伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="nav-text">（4）使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE-1"><span class="nav-text">（5）数据流图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Server-Streaming-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-text">（6）Server Streaming 模式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Client-Streaming%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%EF%BC%89"><span class="nav-text">6.Client Streaming（客户端流）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1-2"><span class="nav-text">（1）功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Proto-%E5%AE%9A%E4%B9%89"><span class="nav-text">（2）Proto 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84-C-%E5%85%B3%E9%94%AE%E4%BC%AA%E4%BB%A3%E7%A0%81-2"><span class="nav-text">（3）生成的 C++ 关键伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="nav-text">（4）使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE-2"><span class="nav-text">（5）数据流图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Client-Streaming-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-text">（6）Client Streaming 模式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Bidirectional-Streaming%EF%BC%88%E5%8F%8C%E5%90%91%E6%B5%81%EF%BC%89"><span class="nav-text">7.Bidirectional Streaming（双向流）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1-3"><span class="nav-text">（1）功能设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Proto-%E5%AE%9A%E4%B9%89-1"><span class="nav-text">（2）Proto 定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E7%94%9F%E6%88%90%E7%9A%84-C-%E5%85%B3%E9%94%AE%E4%BC%AA%E4%BB%A3%E7%A0%81-3"><span class="nav-text">（3）生成的 C++ 关键伪代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="nav-text">（4）使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE-3"><span class="nav-text">（5）数据流图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%886%EF%BC%89Bidirectional-Streaming-%E6%A8%A1%E5%BC%8F%E6%80%BB%E7%BB%93"><span class="nav-text">（6）Bidirectional Streaming 模式总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-gRPC%E7%9A%84%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8"><span class="nav-text">8.gRPC的异步调用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%880%EF%BC%89%E6%A6%82%E8%BF%B0"><span class="nav-text">（0）概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89CompletionQueue-%E2%80%94-%E6%A0%B8%E5%BF%83%E4%BA%8B%E4%BB%B6%E9%98%9F%E5%88%97"><span class="nav-text">（1）CompletionQueue — 核心事件队列</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="nav-text">&lt;1&gt;伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-13"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89Alarm-%E2%80%94-%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="nav-text">（2）Alarm — 定时器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81-1"><span class="nav-text">&lt;1&gt;伪代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-14"><span class="nav-text">&lt;2&gt;使用示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%BC%82%E6%AD%A5%E7%B1%BB"><span class="nav-text">（3）客户端异步类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientAsyncResponseReader-%E2%80%94-%E5%BC%82%E6%AD%A5-Unary"><span class="nav-text">&lt;1&gt;ClientAsyncResponseReader — 异步 Unary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientAsyncReader-%E2%80%94-%E5%BC%82%E6%AD%A5-Server-Streaming"><span class="nav-text">&lt;2&gt;ClientAsyncReader — 异步 Server Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientAsyncWriter-%E2%80%94-%E5%BC%82%E6%AD%A5-Client-Streaming"><span class="nav-text">&lt;3&gt;ClientAsyncWriter — 异步 Client Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ClientAsyncReaderWriter-%E2%80%94-%E5%BC%82%E6%AD%A5%E5%8F%8C%E5%90%91%E6%B5%81"><span class="nav-text">&lt;4&gt;ClientAsyncReaderWriter — 异步双向流</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%BC%82%E6%AD%A5%E7%B1%BB"><span class="nav-text">（4）服务端异步类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerAsyncResponseWriter-%E2%80%94-%E5%BC%82%E6%AD%A5-Unary"><span class="nav-text">&lt;1&gt;ServerAsyncResponseWriter — 异步 Unary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerAsyncReader-%E2%80%94-%E5%BC%82%E6%AD%A5-Client-Streaming"><span class="nav-text">&lt;2&gt;ServerAsyncReader — 异步 Client Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerAsyncWriter-%E2%80%94-%E5%BC%82%E6%AD%A5-Server-Streaming"><span class="nav-text">&lt;3&gt;ServerAsyncWriter — 异步 Server Streaming</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServerAsyncReaderWriter-%E2%80%94-%E5%BC%82%E6%AD%A5%E5%8F%8C%E5%90%91%E6%B5%81"><span class="nav-text">&lt;4&gt;ServerAsyncReaderWriter — 异步双向流</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%885%EF%BC%89%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="nav-text">（5）异步调用过程详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%BC%82%E6%AD%A5%E7%99%BB%E5%BD%95"><span class="nav-text">&lt;1&gt;示例：异步登录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gRPC-%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E5%85%B3%E9%94%AE%E8%BF%87%E7%A8%8B"><span class="nav-text">&lt;2&gt;gRPC 异步调用关键过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tag-%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">&lt;3&gt;tag 的作用</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95%EF%BC%9AProto%E6%96%87%E4%BB%B6"><span class="nav-text">附录：Proto文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-%E6%A6%82%E8%BF%B0"><span class="nav-text">0.概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%BC%94%E7%A4%BA"><span class="nav-text">&lt;1&gt;简单演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4"><span class="nav-text">&lt;2&gt;编译命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Proto-%E6%96%87%E4%BB%B6%E6%A0%B8%E5%BF%83%E8%AF%AD%E6%B3%95%E8%AF%A6%E8%A7%A3%EF%BC%9Asyntax%E3%80%81package%E3%80%81import%E3%80%81option"><span class="nav-text">1.Proto 文件核心语法详解：syntax、package、import、option</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89syntax%EF%BC%9A%E6%8C%87%E5%AE%9A%E8%AF%AD%E6%B3%95%E7%89%88%E6%9C%AC"><span class="nav-text">（1）syntax：指定语法版本</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8"><span class="nav-text">&lt;1&gt;核心作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F"><span class="nav-text">&lt;2&gt;语法格式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89package%EF%BC%9A%E5%AE%9A%E4%B9%89%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%EF%BC%88C-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E6%98%A0%E5%B0%84%EF%BC%89"><span class="nav-text">（2）package：定义命名空间（C++ 命名空间映射）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8-1"><span class="nav-text">&lt;1&gt;核心作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F-C-%E6%98%A0%E5%B0%84%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;2&gt;语法格式 + C++ 映射示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E5%AE%9E%E6%88%98%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">&lt;3&gt;C++ 实战注意事项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89import%EF%BC%9A%E5%AF%BC%E5%85%A5%E5%85%B6%E4%BB%96-Proto-%E6%96%87%E4%BB%B6%EF%BC%88C-%E7%B1%BB%E5%9E%8B%E5%A4%8D%E7%94%A8%EF%BC%89"><span class="nav-text">（3）import：导入其他 Proto 文件（C++ 类型复用）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8-2"><span class="nav-text">&lt;1&gt;核心作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95-C-%E7%A4%BA%E4%BE%8B"><span class="nav-text">&lt;2&gt;基础语法 + C++ 示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E5%9C%BA%E6%99%AF%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95"><span class="nav-text">&lt;3&gt;C++ 场景高级用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E7%BC%96%E8%AF%91%E5%85%B3%E9%94%AE"><span class="nav-text">&lt;4&gt;C++ 编译关键</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%884%EF%BC%89option%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%BC%96%E8%AF%91%E8%A1%8C%E4%B8%BA%EF%BC%88C-%E4%B8%93%E5%B1%9E%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-text">（4）option：配置编译行为（C++ 专属配置）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E4%BD%9C%E7%94%A8-3"><span class="nav-text">&lt;1&gt;核心作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E5%B8%B8%E7%94%A8%E6%96%87%E4%BB%B6%E7%BA%A7-Option"><span class="nav-text">&lt;2&gt;C++ 常用文件级 Option</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E5%B8%B8%E7%94%A8%E5%B1%80%E9%83%A8-Option"><span class="nav-text">&lt;3&gt;C++ 常用局部 Option</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#C-%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B%EF%BC%88%E5%AE%8C%E6%95%B4-Option-%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-text">&lt;4&gt;C++ 实战示例（完整 Option 配置）</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95%EF%BC%9AProtobuf-%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF%EF%BC%88%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E9%AB%98%E7%BA%A7%EF%BC%89"><span class="nav-text">附录：Protobuf 学习路线（从基础到高级）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="nav-text">第一阶段：基础入门</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%A0%B8%E5%BF%83%E5%BA%94%E7%94%A8"><span class="nav-text">第二阶段：核心应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9A%E8%BF%9B%E9%98%B6%E4%BC%98%E5%8C%96"><span class="nav-text">第三阶段：进阶优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9A%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7"><span class="nav-text">第四阶段：高级特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%B7%A5%E7%A8%8B%E5%AE%9E%E8%B7%B5"><span class="nav-text">第五阶段：工程实践</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96%E8%B7%AF%E7%BA%BF%E5%9B%BE"><span class="nav-text">可视化路线图</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="咸鱼"
      src="/images/xianyu.jpg">
  <p class="site-author-name" itemprop="name">咸鱼</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xianyubuxian-TXY" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xianyubuxian-TXY" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xianyubuxian-txy.github.io/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/xianyu.jpg">
      <meta itemprop="name" content="咸鱼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xianyu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="protobuf的使用 | Xianyu">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          protobuf的使用
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-19 22:04:28" itemprop="dateCreated datePublished" datetime="2026-01-19T22:04:28+08:00">2026-01-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 20:44:39" itemprop="dateModified" datetime="2026-01-22T20:44:39+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">C++后端开发库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/C/C-%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">protobuf的使用</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>25k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:23</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><ul>
<li>Protobuf 是 Google 开发的一种轻量级、高效的结构化数据序列化协议，比 JSON、XML 更紧凑、更快，广泛用于网络通信和数据存储。</li>
</ul>
<h2 id="1-核心优势"><a href="#1-核心优势" class="headerlink" title="1.核心优势"></a>1.核心优势</h2><ul>
<li><p><strong>高效性</strong>：</p>
<ul>
<li><strong>二进制格式</strong>，序列化后体积小，解析速度快（比 JSON 快 3-5 倍）</li>
</ul>
</li>
<li><p><strong>跨语言</strong>：</p>
<ul>
<li>支持 C++、Java、Python、Go、JavaScrip 等几乎所有主流语言</li>
</ul>
</li>
<li><p><strong>向后兼容</strong>：</p>
<ul>
<li>字段可以新增&#x2F;废弃，旧版本程序能兼容新版本数据</li>
</ul>
</li>
<li><p><strong>强类型</strong>：</p>
<ul>
<li>通过 .proto 文件定义数据结构，编译后生成强类型代码，减少类型错误</li>
</ul>
</li>
</ul>
<h2 id="2-核心术语"><a href="#2-核心术语" class="headerlink" title="2.核心术语"></a>2.核心术语</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119221513229.png"></p>
<h2 id="3-Proto文件"><a href="#3-Proto文件" class="headerlink" title="3.Proto文件"></a>3.Proto文件</h2><p>正常来说，应该先讲Proto文件，但感觉这部分很枯燥，就放在了<a href="#Proto">附录：Proto文件</a>中，感兴趣的可以先去看一下。</p>
<h1 id="二、数据类型"><a href="#二、数据类型" class="headerlink" title="二、数据类型"></a>二、数据类型</h1><p>Protobuf 的类型分为两大类：<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222351058.png"></p>
<h2 id="1-标量类型"><a href="#1-标量类型" class="headerlink" title="1.标量类型"></a>1.标量类型</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222225945.png"></p>
<h3 id="（1）int32-vs-sint32（负数问题）"><a href="#（1）int32-vs-sint32（负数问题）" class="headerlink" title="（1）int32 vs sint32（负数问题）"></a>（1）int32 vs sint32（负数问题）</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222446609.png"></p>
<h3 id="（2）fixed32-vs-int32（大数值）"><a href="#（2）fixed32-vs-int32（大数值）" class="headerlink" title="（2）fixed32 vs int32（大数值）"></a>（2）fixed32 vs int32（大数值）</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119222513321.png"></p>
<h3 id="（3）string-vs-bytes"><a href="#（3）string-vs-bytes" class="headerlink" title="（3）string vs bytes"></a>（3）string vs bytes</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string: 会做 UTF-8 校验（某些语言）</span></span><br><span class="line"><span class="comment">// bytes: 纯二进制，无校验</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景区分</span></span><br><span class="line">message File &#123;</span><br><span class="line">    string filename = <span class="number">1</span>;    <span class="comment">// 文件名是文本</span></span><br><span class="line">    bytes content = <span class="number">2</span>;      <span class="comment">// 文件内容是二进制</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（4）选型决策树"><a href="#（4）选型决策树" class="headerlink" title="（4）选型决策树"></a>（4）选型决策树</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">需要存整数？</span><br><span class="line">├─ 纯正数 → uint32 / uint64</span><br><span class="line">├─ 可能有负数？</span><br><span class="line">│   ├─ 是 → sint32 / sint64 ✅</span><br><span class="line">│   └─ 否 → int32 / int64</span><br><span class="line">└─ 值经常很大（&gt;<span class="number">2</span>^<span class="number">28</span>）？</span><br><span class="line">    └─ 是 → fixed32 / fixed64</span><br><span class="line"></span><br><span class="line">需要存字符串？</span><br><span class="line">├─ UTF<span class="number">-8</span> 文本 → string</span><br><span class="line">└─ 二进制数据 → bytes</span><br><span class="line"></span><br><span class="line">需要存小数？</span><br><span class="line">├─ 高精度（金额/坐标）→ <span class="type">double</span></span><br><span class="line">└─ 一般精度 → <span class="type">float</span></span><br></pre></td></tr></table></figure>

<h2 id="2-复合类型-字段规则"><a href="#2-复合类型-字段规则" class="headerlink" title="2.复合类型 &amp; 字段规则"></a>2.复合类型 &amp; 字段规则</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119223758714.png"></p>
<p><a id="message"></a></p>
<h3 id="（1）message（消息）"><a href="#（1）message（消息）" class="headerlink" title="（1）message（消息）"></a>（1）message（消息）</h3><h4 id="Proto-定义"><a href="#Proto-定义" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">message Address &#123;</span><br><span class="line">    string city = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message User &#123;</span><br><span class="line">    int32 id = <span class="number">1</span>;</span><br><span class="line">    string name = <span class="number">2</span>;</span><br><span class="line">    Address address = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码"><a href="#C-生成类型伪代码" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    std::string city_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">city</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(std::string&amp;&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_city</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    <span class="type">int32_t</span> id_;</span><br><span class="line">    std::string name_;</span><br><span class="line">    Address* address_;              <span class="comment">// 指针，延迟分配</span></span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];         <span class="comment">// 位图，跟踪 message 字段是否设置</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">id</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> Address&amp; <span class="title">address</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_id</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_name</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable（获取可修改指针）==========</span></span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_name</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Address* <span class="title">mutable_address</span><span class="params">()</span></span>;        <span class="comment">// 不存在则自动创建</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has（存在性检查）==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_address</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">// 检查 _has_bits_</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear（重置为默认值） ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_id</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_name</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_address</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：嵌套 message 都是指针存储</p>
<h4 id="使用示例"><a href="#使用示例" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建并设置</span></span><br><span class="line">User user;</span><br><span class="line">user.<span class="built_in">set_id</span>(<span class="number">1001</span>);</span><br><span class="line">user.<span class="built_in">set_name</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">user.<span class="built_in">mutable_address</span>()-&gt;<span class="built_in">set_city</span>(<span class="string">&quot;Beijing&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">id</span>() &lt;&lt; std::endl;              <span class="comment">// 1001</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">name</span>() &lt;&lt; std::endl;            <span class="comment">// Alice</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">address</span>().<span class="built_in">city</span>() &lt;&lt; std::endl;  <span class="comment">// Beijing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查嵌套消息</span></span><br><span class="line"><span class="keyword">if</span> (user.<span class="built_in">has_address</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;地址已设置&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化 &amp; 反序列化</span></span><br><span class="line">std::string data = user.<span class="built_in">SerializeAsString</span>();</span><br><span class="line">User user2;</span><br><span class="line">user<span class="number">2.</span><span class="built_in">ParseFromString</span>(data);</span><br></pre></td></tr></table></figure>

<h3 id="（2）enum（枚举）"><a href="#（2）enum（枚举）" class="headerlink" title="（2）enum（枚举）"></a>（2）enum（枚举）</h3><h4 id="Proto-定义-1"><a href="#Proto-定义-1" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Status</span> &#123;</span><br><span class="line">    STATUS_UNKNOWN = <span class="number">0</span>;</span><br><span class="line">    STATUS_ACTIVE = <span class="number">1</span>;</span><br><span class="line">    STATUS_DELETED = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Order &#123;</span><br><span class="line">    Status status = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-1"><a href="#C-生成类型伪代码-1" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== 枚举定义 ==========</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Status</span> : <span class="type">int</span> &#123;</span><br><span class="line">    STATUS_UNKNOWN = <span class="number">0</span>,</span><br><span class="line">    STATUS_ACTIVE = <span class="number">1</span>,</span><br><span class="line">    STATUS_DELETED = <span class="number">2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 枚举辅助函数 ==========</span></span><br><span class="line"><span class="comment">// 1.把枚举值转换为可读的字符串名称</span></span><br><span class="line"><span class="function"><span class="type">const</span> std::string&amp; <span class="title">Status_Name</span><span class="params">(Status value)</span></span>;</span><br><span class="line"><span class="comment">// 2.把字符串解析为枚举值（反向转换）</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Status_Parse</span><span class="params">(<span class="type">const</span> std::string&amp; name, Status* value)</span></span>;</span><br><span class="line"><span class="comment">// 3.检查整数值是否是合法的枚举值</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Status_IsValid</span><span class="params">(<span class="type">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    <span class="type">int</span> status_;                       <span class="comment">// 枚举存储为 int</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function">Status <span class="title">status</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_status</span><span class="params">(Status value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_status</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;order.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置枚举</span></span><br><span class="line">Order order;</span><br><span class="line">order.<span class="built_in">set_status</span>(Status::STATUS_ACTIVE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取并判断</span></span><br><span class="line"><span class="keyword">if</span> (order.<span class="built_in">status</span>() == Status::STATUS_ACTIVE) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;订单激活中&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 枚举 → 字符串</span></span><br><span class="line">std::cout &lt;&lt; <span class="built_in">Status_Name</span>(order.<span class="built_in">status</span>()) &lt;&lt; std::endl;  <span class="comment">// STATUS_ACTIVE</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串 → 枚举</span></span><br><span class="line">Status s;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Status_Parse</span>(<span class="string">&quot;STATUS_DELETED&quot;</span>, &amp;s)) &#123;</span><br><span class="line">    order.<span class="built_in">set_status</span>(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证值是否有效</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Status_IsValid</span>(<span class="number">1</span>)) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;1 是有效的 Status 值&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="map（映射）"><a href="#map（映射）" class="headerlink" title="&lt;3&gt;map&lt;K, V&gt;（映射）"></a>&lt;3&gt;map&lt;K, V&gt;（映射）</h3><h4 id="Proto-定义-2"><a href="#Proto-定义-2" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message Address &#123;</span><br><span class="line">    string city = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Student &#123;</span><br><span class="line">    map&lt;string, int32&gt; scores = <span class="number">1</span>;</span><br><span class="line">    map&lt;int32, Address&gt; addresses = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-2"><a href="#C-生成类型伪代码-2" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    std::string city_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">city</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(std::string&amp;&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_city</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_city</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    google::protobuf::Map&lt;std::string, <span class="type">int32_t</span>&gt; scores_;</span><br><span class="line">    google::protobuf::Map&lt;<span class="type">int32_t</span>, Address&gt; addresses_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter（只读引用）==========</span></span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Map&lt;std::string, <span class="type">int32_t</span>&gt;&amp; <span class="title">scores</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Map&lt;<span class="type">int32_t</span>, Address&gt;&amp; <span class="title">addresses</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable（可修改指针）==========</span></span><br><span class="line">    google::<span class="function">protobuf::Map&lt;std::string, <span class="type">int32_t</span>&gt;* <span class="title">mutable_scores</span><span class="params">()</span></span>;</span><br><span class="line">    google::<span class="function">protobuf::Map&lt;<span class="type">int32_t</span>, Address&gt;* <span class="title">mutable_addresses</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_scores</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_addresses</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== Map 容器类 ==========</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Map</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 内部存储 ==========</span></span><br><span class="line">    std::unordered_map&lt;K, V&gt; elements_;  <span class="comment">// 类似 unordered_map 实现</span></span><br><span class="line">    Arena* arena_;                        <span class="comment">// 可选的内存池</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ----- Access（访问）-----</span></span><br><span class="line">    V&amp; <span class="keyword">operator</span>[](<span class="type">const</span> K&amp; key);</span><br><span class="line">    <span class="function"><span class="type">const</span> V&amp; <span class="title">at</span><span class="params">(<span class="type">const</span> K&amp; key)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Lookup（查找）-----</span></span><br><span class="line">    <span class="function">iterator <span class="title">find</span><span class="params">(<span class="type">const</span> K&amp; key)</span></span>;</span><br><span class="line">    <span class="function">const_iterator <span class="title">find</span><span class="params">(<span class="type">const</span> K&amp; key)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">contains</span><span class="params">(<span class="type">const</span> K&amp; key)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">count</span><span class="params">(<span class="type">const</span> K&amp; key)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Modify（修改）-----</span></span><br><span class="line">    <span class="function">std::pair&lt;iterator, <span class="type">bool</span>&gt; <span class="title">insert</span><span class="params">(<span class="type">const</span> value_type&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">erase</span><span class="params">(<span class="type">const</span> K&amp; key)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Capacity（容量）-----</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Iterate（遍历）-----</span></span><br><span class="line">    <span class="function">iterator <span class="title">begin</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">iterator <span class="title">end</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;student.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Student stu;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入标量 map</span></span><br><span class="line">(*stu.<span class="built_in">mutable_scores</span>())[<span class="string">&quot;math&quot;</span>] = <span class="number">95</span>;</span><br><span class="line">(*stu.<span class="built_in">mutable_scores</span>())[<span class="string">&quot;english&quot;</span>] = <span class="number">88</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入消息 map</span></span><br><span class="line">(*stu.<span class="built_in">mutable_addresses</span>())[<span class="number">1</span>].<span class="built_in">set_city</span>(<span class="string">&quot;Beijing&quot;</span>);</span><br><span class="line">(*stu.<span class="built_in">mutable_addresses</span>())[<span class="number">2</span>].<span class="built_in">set_city</span>(<span class="string">&quot;Shanghai&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; stu.<span class="built_in">scores</span>().<span class="built_in">at</span>(<span class="string">&quot;math&quot;</span>) &lt;&lt; std::endl;       <span class="comment">// 95</span></span><br><span class="line">std::cout &lt;&lt; stu.<span class="built_in">addresses</span>().<span class="built_in">at</span>(<span class="number">1</span>).<span class="built_in">city</span>() &lt;&lt; std::endl;  <span class="comment">// Beijing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [subject, score] : stu.<span class="built_in">scores</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; subject &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; score &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查找</span></span><br><span class="line"><span class="keyword">auto</span> it = stu.<span class="built_in">scores</span>().<span class="built_in">find</span>(<span class="string">&quot;math&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (it != stu.<span class="built_in">scores</span>().<span class="built_in">end</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;找到: &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">stu.<span class="built_in">mutable_scores</span>()-&gt;<span class="built_in">erase</span>(<span class="string">&quot;english&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大小 &amp; 清空</span></span><br><span class="line">std::cout &lt;&lt; stu.<span class="built_in">scores</span>().<span class="built_in">size</span>() &lt;&lt; std::endl;  <span class="comment">// 1</span></span><br><span class="line">stu.<span class="built_in">clear_scores</span>();</span><br></pre></td></tr></table></figure>

<h3 id="（4）oneof（互斥字段）"><a href="#（4）oneof（互斥字段）" class="headerlink" title="（4）oneof（互斥字段）"></a>（4）oneof（互斥字段）</h3><h4 id="Proto-定义-3"><a href="#Proto-定义-3" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message Contact &#123;</span><br><span class="line">    string id = <span class="number">1</span>;</span><br><span class="line">    oneof method &#123;</span><br><span class="line">        string email = <span class="number">2</span>;</span><br><span class="line">        string phone = <span class="number">3</span>;</span><br><span class="line">        string wechat = <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-3"><a href="#C-生成类型伪代码-3" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Contact</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    std::string id_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// oneof 使用 union 存储（节省内存）</span></span><br><span class="line">    <span class="keyword">union</span> <span class="title class_">MethodUnion</span> &#123;</span><br><span class="line">        std::string* email_;</span><br><span class="line">        std::string* phone_;</span><br><span class="line">        std::string* wechat_;</span><br><span class="line">    &#125; method_;</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint32_t</span> _oneof_case_[<span class="number">1</span>];          <span class="comment">// 记录当前设置的是哪个字段</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Oneof Case 枚举 ==========</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">MethodCase</span> &#123;</span><br><span class="line">        kEmail = <span class="number">2</span>,</span><br><span class="line">        kPhone = <span class="number">3</span>,</span><br><span class="line">        kWechat = <span class="number">4</span>,</span><br><span class="line">        METHOD_NOT_SET = <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Case 判断 ==========</span></span><br><span class="line">    <span class="function">MethodCase <span class="title">method_case</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">id</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">email</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">phone</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">wechat</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter（设置一个会清除其他）==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_id</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_email</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_phone</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_wechat</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_id</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_email</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_phone</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_wechat</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has ==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_email</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_phone</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_wechat</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_id</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_method</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-3"><a href="#使用示例-3" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;contact.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Contact c;</span><br><span class="line">c.<span class="built_in">set_id</span>(<span class="string">&quot;user_001&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 email</span></span><br><span class="line">c.<span class="built_in">set_email</span>(<span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">std::cout &lt;&lt; c.<span class="built_in">email</span>() &lt;&lt; std::endl;  <span class="comment">// alice@example.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 phone → 自动清除 email！</span></span><br><span class="line">c.<span class="built_in">set_phone</span>(<span class="string">&quot;13800138000&quot;</span>);</span><br><span class="line">std::cout &lt;&lt; c.<span class="built_in">has_email</span>() &lt;&lt; std::endl;  <span class="comment">// false</span></span><br><span class="line">std::cout &lt;&lt; c.<span class="built_in">phone</span>() &lt;&lt; std::endl;      <span class="comment">// 13800138000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前设置的是哪个</span></span><br><span class="line"><span class="keyword">switch</span> (c.<span class="built_in">method_case</span>()) &#123;</span><br><span class="line">    <span class="keyword">case</span> Contact::kEmail:</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Email: &quot;</span> &lt;&lt; c.<span class="built_in">email</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Contact::kPhone:</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Phone: &quot;</span> &lt;&lt; c.<span class="built_in">phone</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Contact::kWechat:</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;WeChat: &quot;</span> &lt;&lt; c.<span class="built_in">wechat</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Contact::METHOD_NOT_SET:</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;未设置联系方式&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除整个 oneof</span></span><br><span class="line">c.<span class="built_in">clear_method</span>();</span><br><span class="line">std::cout &lt;&lt; (c.<span class="built_in">method_case</span>() == Contact::METHOD_NOT_SET) &lt;&lt; std::endl;  <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="（5）Any（动态类型）"><a href="#（5）Any（动态类型）" class="headerlink" title="（5）Any（动态类型）"></a>（5）Any（动态类型）</h3><h4 id="Proto-定义-4"><a href="#Proto-定义-4" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/any.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    google.protobuf.Any data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-4"><a href="#C-生成类型伪代码-4" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Any</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    std::string type_url_;    <span class="comment">// 类型标识，如 &quot;type.googleapis.com/User&quot;</span></span><br><span class="line">    std::string value_;       <span class="comment">// 序列化后的二进制数据</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Pack（打包）==========</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">PackFrom</span><span class="params">(<span class="type">const</span> T&amp; message)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">PackFrom</span><span class="params">(<span class="type">const</span> T&amp; message, <span class="type">const</span> std::string&amp; type_url_prefix)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Unpack（解包）==========</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span> <span class="title">UnpackTo</span><span class="params">(T* message)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Type Check（类型检查）==========</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">    <span class="type">bool</span> <span class="title">Is</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">type_url</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_type_url</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_value</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    google::protobuf::Any* data_;     <span class="comment">// 指针，延迟分配</span></span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Any&amp; <span class="title">data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    google::<span class="function">protobuf::Any* <span class="title">mutable_data</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has ==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_data</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-4"><a href="#使用示例-4" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/any.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;response.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 打包 User 到 Any</span></span><br><span class="line">User user;</span><br><span class="line">user.<span class="built_in">set_id</span>(<span class="number">1</span>);</span><br><span class="line">user.<span class="built_in">set_name</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line"></span><br><span class="line">Response resp;</span><br><span class="line">resp.<span class="built_in">mutable_data</span>()-&gt;<span class="built_in">PackFrom</span>(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取类型 URL</span></span><br><span class="line">std::cout &lt;&lt; resp.<span class="built_in">data</span>().<span class="built_in">type_url</span>() &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">// 输出: type.googleapis.com/User</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型检查 &amp; 解包</span></span><br><span class="line"><span class="keyword">if</span> (resp.<span class="built_in">data</span>().<span class="built_in">Is</span>&lt;User&gt;()) &#123;</span><br><span class="line">    User u;</span><br><span class="line">    <span class="keyword">if</span> (resp.<span class="built_in">data</span>().<span class="built_in">UnpackTo</span>(&amp;u)) &#123;</span><br><span class="line">        std::cout &lt;&lt; u.<span class="built_in">name</span>() &lt;&lt; std::endl;  <span class="comment">// Alice</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以打包其他类型</span></span><br><span class="line">Order order;</span><br><span class="line">order.<span class="built_in">set_status</span>(Status::STATUS_ACTIVE);</span><br><span class="line">resp.<span class="built_in">mutable_data</span>()-&gt;<span class="built_in">PackFrom</span>(order);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在是 Order 类型</span></span><br><span class="line">std::cout &lt;&lt; resp.<span class="built_in">data</span>().<span class="built_in">Is</span>&lt;User&gt;() &lt;&lt; std::endl;   <span class="comment">// false</span></span><br><span class="line">std::cout &lt;&lt; resp.<span class="built_in">data</span>().<span class="built_in">Is</span>&lt;Order&gt;() &lt;&lt; std::endl;  <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="Protobuf-Any-的”动态类型”解析"><a href="#Protobuf-Any-的”动态类型”解析" class="headerlink" title="&lt;4&gt;Protobuf Any 的”动态类型”解析"></a>&lt;4&gt;Protobuf Any 的”动态类型”解析</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119230729435.png"><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119230756739.png"></p>
<h3 id="（6）Timestamp（时间点）"><a href="#（6）Timestamp（时间点）" class="headerlink" title="（6）Timestamp（时间点）"></a>（6）Timestamp（时间点）</h3><h4 id="Proto-定义-5"><a href="#Proto-定义-5" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/timestamp.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message Event &#123;</span><br><span class="line">    google.protobuf.Timestamp created_at = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-5"><a href="#C-生成类型伪代码-5" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Timestamp</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    <span class="type">int64_t</span> seconds_;    <span class="comment">// Unix 时间戳（秒）</span></span><br><span class="line">    <span class="type">int32_t</span> nanos_;      <span class="comment">// 纳秒部分 [0, 999999999]</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">int64_t</span> <span class="title">seconds</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">nanos</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_seconds</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_nanos</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> util &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeUtil</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Create（创建）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Timestamp <span class="title">GetCurrentTime</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Timestamp <span class="title">SecondsToTimestamp</span><span class="params">(<span class="type">int64_t</span> seconds)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Timestamp <span class="title">MillisecondsToTimestamp</span><span class="params">(<span class="type">int64_t</span> millis)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Convert（转换）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">TimestampToSeconds</span><span class="params">(<span class="type">const</span> Timestamp&amp; ts)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">TimestampToMilliseconds</span><span class="params">(<span class="type">const</span> Timestamp&amp; ts)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">TimestampToMicroseconds</span><span class="params">(<span class="type">const</span> Timestamp&amp; ts)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">TimestampToNanoseconds</span><span class="params">(<span class="type">const</span> Timestamp&amp; ts)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== String（字符串）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> std::string <span class="title">ToString</span><span class="params">(<span class="type">const</span> Timestamp&amp; ts)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">FromString</span><span class="params">(<span class="type">const</span> std::string&amp; str, Timestamp* ts)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;  <span class="comment">// namespace util</span></span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Event</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    google::protobuf::Timestamp* created_at_;</span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Timestamp&amp; <span class="title">created_at</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    google::<span class="function">protobuf::Timestamp* <span class="title">mutable_created_at</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has ==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_created_at</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_created_at</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-5"><a href="#使用示例-5" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/timestamp.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/util/time_util.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;event.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::util::TimeUtil;</span><br><span class="line"></span><br><span class="line">Event event;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1: 设置当前时间</span></span><br><span class="line">*event.<span class="built_in">mutable_created_at</span>() = TimeUtil::<span class="built_in">GetCurrentTime</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2: 手动设置秒和纳秒</span></span><br><span class="line">event.<span class="built_in">mutable_created_at</span>()-&gt;<span class="built_in">set_seconds</span>(<span class="number">1705312200</span>);</span><br><span class="line">event.<span class="built_in">mutable_created_at</span>()-&gt;<span class="built_in">set_nanos</span>(<span class="number">500000000</span>);  <span class="comment">// 0.5秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3: 从毫秒创建</span></span><br><span class="line">*event.<span class="built_in">mutable_created_at</span>() = TimeUtil::<span class="built_in">MillisecondsToTimestamp</span>(<span class="number">1705312200500</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; event.<span class="built_in">created_at</span>().<span class="built_in">seconds</span>() &lt;&lt; std::endl;  <span class="comment">// 1705312200</span></span><br><span class="line">std::cout &lt;&lt; event.<span class="built_in">created_at</span>().<span class="built_in">nanos</span>() &lt;&lt; std::endl;    <span class="comment">// 500000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为毫秒</span></span><br><span class="line"><span class="type">int64_t</span> ms = TimeUtil::<span class="built_in">TimestampToMilliseconds</span>(event.<span class="built_in">created_at</span>());</span><br><span class="line">std::cout &lt;&lt; ms &lt;&lt; std::endl;  <span class="comment">// 1705312200500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为 RFC 3339 字符串</span></span><br><span class="line">std::string time_str = TimeUtil::<span class="built_in">ToString</span>(event.<span class="built_in">created_at</span>());</span><br><span class="line">std::cout &lt;&lt; time_str &lt;&lt; std::endl;  <span class="comment">// 2024-01-15T10:30:00.500Z</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从字符串解析</span></span><br><span class="line">google::protobuf::Timestamp ts;</span><br><span class="line">TimeUtil::<span class="built_in">FromString</span>(<span class="string">&quot;2024-01-15T10:30:00Z&quot;</span>, &amp;ts);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（7）Duration（时间段）"><a href="#（7）Duration（时间段）" class="headerlink" title="（7）Duration（时间段）"></a>（7）Duration（时间段）</h3><h4 id="Proto-定义-6"><a href="#Proto-定义-6" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/duration.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message Task &#123;</span><br><span class="line">    google.protobuf.Duration timeout = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-6"><a href="#C-生成类型伪代码-6" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Duration</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    <span class="type">int64_t</span> seconds_;    <span class="comment">// 秒（可为负）</span></span><br><span class="line">    <span class="type">int32_t</span> nanos_;      <span class="comment">// 纳秒 [-999999999, 999999999]，与 seconds 同号</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">int64_t</span> <span class="title">seconds</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">nanos</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_seconds</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_nanos</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> util &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TimeUtil</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Create（创建）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> Duration <span class="title">SecondsToDuration</span><span class="params">(<span class="type">int64_t</span> seconds)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Duration <span class="title">MillisecondsToDuration</span><span class="params">(<span class="type">int64_t</span> millis)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Duration <span class="title">MicrosecondsToDuration</span><span class="params">(<span class="type">int64_t</span> micros)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> Duration <span class="title">NanosecondsToDuration</span><span class="params">(<span class="type">int64_t</span> nanos)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Convert（转换）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">DurationToSeconds</span><span class="params">(<span class="type">const</span> Duration&amp; d)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">DurationToMilliseconds</span><span class="params">(<span class="type">const</span> Duration&amp; d)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">DurationToMicroseconds</span><span class="params">(<span class="type">const</span> Duration&amp; d)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">DurationToNanoseconds</span><span class="params">(<span class="type">const</span> Duration&amp; d)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== String（字符串）==========</span></span><br><span class="line">    <span class="function"><span class="type">static</span> std::string <span class="title">ToString</span><span class="params">(<span class="type">const</span> Duration&amp; d)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">FromString</span><span class="params">(<span class="type">const</span> std::string&amp; str, Duration* d)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;  <span class="comment">// namespace util</span></span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    google::protobuf::Duration* timeout_;</span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Duration&amp; <span class="title">timeout</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    google::<span class="function">protobuf::Duration* <span class="title">mutable_timeout</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has ==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_timeout</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_timeout</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-6"><a href="#使用示例-6" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/duration.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/util/time_util.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;task.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::util::TimeUtil;</span><br><span class="line"></span><br><span class="line">Task task;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1: 从秒创建</span></span><br><span class="line">*task.<span class="built_in">mutable_timeout</span>() = TimeUtil::<span class="built_in">SecondsToDuration</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2: 从毫秒创建（5.5秒）</span></span><br><span class="line">*task.<span class="built_in">mutable_timeout</span>() = TimeUtil::<span class="built_in">MillisecondsToDuration</span>(<span class="number">5500</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3: 手动设置</span></span><br><span class="line">task.<span class="built_in">mutable_timeout</span>()-&gt;<span class="built_in">set_seconds</span>(<span class="number">10</span>);</span><br><span class="line">task.<span class="built_in">mutable_timeout</span>()-&gt;<span class="built_in">set_nanos</span>(<span class="number">500000000</span>);  <span class="comment">// 10.5秒</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; task.<span class="built_in">timeout</span>().<span class="built_in">seconds</span>() &lt;&lt; std::endl;  <span class="comment">// 10</span></span><br><span class="line">std::cout &lt;&lt; task.<span class="built_in">timeout</span>().<span class="built_in">nanos</span>() &lt;&lt; std::endl;    <span class="comment">// 500000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为毫秒</span></span><br><span class="line"><span class="type">int64_t</span> ms = TimeUtil::<span class="built_in">DurationToMilliseconds</span>(task.<span class="built_in">timeout</span>());</span><br><span class="line">std::cout &lt;&lt; ms &lt;&lt; std::endl;  <span class="comment">// 10500</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为字符串</span></span><br><span class="line">std::string dur_str = TimeUtil::<span class="built_in">ToString</span>(task.<span class="built_in">timeout</span>());</span><br><span class="line">std::cout &lt;&lt; dur_str &lt;&lt; std::endl;  <span class="comment">// 10.500s</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 负数时间段（表示过去）</span></span><br><span class="line">*task.<span class="built_in">mutable_timeout</span>() = TimeUtil::<span class="built_in">SecondsToDuration</span>(<span class="number">-60</span>);</span><br><span class="line">std::cout &lt;&lt; task.<span class="built_in">timeout</span>().<span class="built_in">seconds</span>() &lt;&lt; std::endl;  <span class="comment">// -60</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（8）optional-T（可选字段）"><a href="#（8）optional-T（可选字段）" class="headerlink" title="（8）optional T（可选字段）"></a>（8）optional T（可选字段）</h3><h4 id="Proto-定义-7"><a href="#Proto-定义-7" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">message Profile &#123;</span><br><span class="line">    optional string nickname = <span class="number">1</span>;</span><br><span class="line">    optional int32 age = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-7"><a href="#C-生成类型伪代码-7" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Profile</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    std::string nickname_;</span><br><span class="line">    <span class="type">int32_t</span> age_;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// optional 字段使用位图跟踪是否设置</span></span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];           <span class="comment">// 位图</span></span><br><span class="line">    <span class="comment">// bit 0 → has_nickname</span></span><br><span class="line">    <span class="comment">// bit 1 → has_age</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">nickname</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">age</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_nickname</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_nickname</span><span class="params">(std::string&amp;&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_nickname</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_age</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_nickname</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Has（✅ optional 核心特性）==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_nickname</span><span class="params">()</span> <span class="type">const</span></span>;    <span class="comment">// 检查 _has_bits_[0] &amp; 0x01</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_age</span><span class="params">()</span> <span class="type">const</span></span>;         <span class="comment">// 检查 _has_bits_[0] &amp; 0x02</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_nickname</span><span class="params">()</span></span>;        <span class="comment">// 清除值 + 清除 has 位</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_age</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-7"><a href="#使用示例-7" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;profile.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Profile p;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 核心区别：区分 &quot;未设置&quot; vs &quot;设置为默认值&quot; =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始状态：未设置</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_nickname</span>() &lt;&lt; std::endl;  <span class="comment">// false</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_age</span>() &lt;&lt; std::endl;       <span class="comment">// false</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">nickname</span>() &lt;&lt; std::endl;      <span class="comment">// &quot;&quot;（默认值）</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">age</span>() &lt;&lt; std::endl;           <span class="comment">// 0（默认值）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置值</span></span><br><span class="line">p.<span class="built_in">set_nickname</span>(<span class="string">&quot;Ali&quot;</span>);</span><br><span class="line">p.<span class="built_in">set_age</span>(<span class="number">25</span>);</span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_nickname</span>() &lt;&lt; std::endl;  <span class="comment">// true</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_age</span>() &lt;&lt; std::endl;       <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 关键：设置为空/零 ≠ 未设置 =====</span></span><br><span class="line">p.<span class="built_in">set_nickname</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">p.<span class="built_in">set_age</span>(<span class="number">0</span>);</span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_nickname</span>() &lt;&lt; std::endl;  <span class="comment">// true!（已设置，只是值为空）</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_age</span>() &lt;&lt; std::endl;       <span class="comment">// true!（已设置，只是值为0）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除后才是&quot;未设置&quot;</span></span><br><span class="line">p.<span class="built_in">clear_nickname</span>();</span><br><span class="line">p.<span class="built_in">clear_age</span>();</span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_nickname</span>() &lt;&lt; std::endl;  <span class="comment">// false</span></span><br><span class="line">std::cout &lt;&lt; p.<span class="built_in">has_age</span>() &lt;&lt; std::endl;       <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 实际应用：可选参数处理 =====</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateProfile</span><span class="params">(<span class="type">const</span> Profile&amp; p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p.<span class="built_in">has_nickname</span>()) &#123;</span><br><span class="line">        <span class="comment">// 用户明确提供了昵称（即使是空字符串）</span></span><br><span class="line">        db.<span class="built_in">update</span>(<span class="string">&quot;nickname&quot;</span>, p.<span class="built_in">nickname</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未设置则不更新</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (p.<span class="built_in">has_age</span>()) &#123;</span><br><span class="line">        db.<span class="built_in">update</span>(<span class="string">&quot;age&quot;</span>, p.<span class="built_in">age</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（9）repeated-T（数组）"><a href="#（9）repeated-T（数组）" class="headerlink" title="（9）repeated T（数组）"></a>（9）repeated T（数组）</h3><h4 id="Proto-定义-8"><a href="#Proto-定义-8" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">message Cart &#123;</span><br><span class="line">    repeated string tags = <span class="number">1</span>;</span><br><span class="line">    repeated int32 counts = <span class="number">2</span>;</span><br><span class="line">    repeated Item items = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Item &#123;</span><br><span class="line">    string name = <span class="number">1</span>;</span><br><span class="line">    int32 price = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-8"><a href="#C-生成类型伪代码-8" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Cart</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 存储字段 ==========</span></span><br><span class="line">    google::protobuf::RepeatedPtrField&lt;std::string&gt; tags_;   <span class="comment">// 字符串数组</span></span><br><span class="line">    google::protobuf::RepeatedField&lt;<span class="type">int32_t</span>&gt; counts_;        <span class="comment">// 标量数组</span></span><br><span class="line">    google::protobuf::RepeatedPtrField&lt;Item&gt; items_;         <span class="comment">// 消息数组</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ==================== repeated string ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Size（大小）-----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">tags_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Getter（只读访问）-----</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">tags</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::RepeatedPtrField&lt;std::string&gt;&amp; <span class="title">tags</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Setter（修改指定位置）-----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_tags</span><span class="params">(<span class="type">int</span> index, <span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Add（追加）-----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add_tags</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function">std::string* <span class="title">add_tags</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Mutable（可修改访问）-----</span></span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_tags</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">    google::<span class="function">protobuf::RepeatedPtrField&lt;std::string&gt;* <span class="title">mutable_tags</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Clear（清空）-----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_tags</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== repeated int32 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Size -----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">counts_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Getter -----</span></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">counts</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::RepeatedField&lt;<span class="type">int32_t</span>&gt;&amp; <span class="title">counts</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Setter -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_counts</span><span class="params">(<span class="type">int</span> index, <span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Add -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add_counts</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Mutable -----</span></span><br><span class="line">    google::<span class="function">protobuf::RepeatedField&lt;<span class="type">int32_t</span>&gt;* <span class="title">mutable_counts</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Clear -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_counts</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== repeated message ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Size -----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">items_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Getter -----</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Item&amp; <span class="title">items</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::RepeatedPtrField&lt;Item&gt;&amp; <span class="title">items</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Add（返回新元素指针）-----</span></span><br><span class="line">    <span class="function">Item* <span class="title">add_items</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Mutable -----</span></span><br><span class="line">    <span class="function">Item* <span class="title">mutable_items</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">    google::<span class="function">protobuf::RepeatedPtrField&lt;Item&gt;* <span class="title">mutable_items</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Clear -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_items</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== RepeatedField（标量数组）====================</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RepeatedField</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 内部存储 ==========</span></span><br><span class="line">    T* elements_;           <span class="comment">// 动态数组</span></span><br><span class="line">    <span class="type">int</span> current_size_;      <span class="comment">// 当前元素数</span></span><br><span class="line">    <span class="type">int</span> total_size_;        <span class="comment">// 已分配容量</span></span><br><span class="line">    Arena* arena_;          <span class="comment">// 可选内存池</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ----- Size -----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Access -----</span></span><br><span class="line">    <span class="function">T <span class="title">Get</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    T <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>;</span><br><span class="line">    <span class="function">T <span class="title">at</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Modify -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(<span class="type">int</span> index, T value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(T value)</span></span>;</span><br><span class="line">    <span class="function">T* <span class="title">Add</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Remove -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RemoveLast</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ExtractSubrange</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> num, T* elements)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Truncate</span><span class="params">(<span class="type">int</span> new_size)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Iterate -----</span></span><br><span class="line">    <span class="function">iterator <span class="title">begin</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">iterator <span class="title">end</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Raw Data -----</span></span><br><span class="line">    <span class="function">T* <span class="title">mutable_data</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> T* <span class="title">data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== RepeatedPtrField（消息/字符串数组）====================</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RepeatedPtrField</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ========== 内部存储 ==========</span></span><br><span class="line">    T** elements_;          <span class="comment">// 指针数组</span></span><br><span class="line">    <span class="type">int</span> current_size_;</span><br><span class="line">    <span class="type">int</span> total_size_;</span><br><span class="line">    Arena* arena_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ----- Size -----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Access -----</span></span><br><span class="line">    <span class="function"><span class="type">const</span> T&amp; <span class="title">Get</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="type">const</span> T&amp; <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Mutable Access -----</span></span><br><span class="line">    <span class="function">T* <span class="title">Mutable</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Add -----</span></span><br><span class="line">    <span class="function">T* <span class="title">Add</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(T&amp;&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Remove -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RemoveLast</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">DeleteSubrange</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> num)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Swap -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SwapElements</span><span class="params">(<span class="type">int</span> index1, <span class="type">int</span> index2)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Iterate -----</span></span><br><span class="line">    <span class="function">iterator <span class="title">begin</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">iterator <span class="title">end</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-8"><a href="#使用示例-8" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;cart.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">Cart cart;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== repeated string ====================</span></span><br><span class="line"><span class="comment">// 添加</span></span><br><span class="line">cart.<span class="built_in">add_tags</span>(<span class="string">&quot;electronics&quot;</span>);</span><br><span class="line">cart.<span class="built_in">add_tags</span>(<span class="string">&quot;sale&quot;</span>);</span><br><span class="line">cart.<span class="built_in">add_tags</span>(<span class="string">&quot;hot&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">tags_size</span>() &lt;&lt; std::endl;  <span class="comment">// 3</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">tags</span>(<span class="number">0</span>) &lt;&lt; std::endl;      <span class="comment">// electronics</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; tag : cart.<span class="built_in">tags</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; tag &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改</span></span><br><span class="line">cart.<span class="built_in">set_tags</span>(<span class="number">0</span>, <span class="string">&quot;digital&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空</span></span><br><span class="line">cart.<span class="built_in">clear_tags</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== repeated int32 ====================</span></span><br><span class="line">cart.<span class="built_in">add_counts</span>(<span class="number">10</span>);</span><br><span class="line">cart.<span class="built_in">add_counts</span>(<span class="number">20</span>);</span><br><span class="line">cart.<span class="built_in">add_counts</span>(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">counts</span>(<span class="number">1</span>) &lt;&lt; std::endl;  <span class="comment">// 20</span></span><br><span class="line">cart.<span class="built_in">set_counts</span>(<span class="number">1</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cart.<span class="built_in">counts_size</span>(); i++) &#123;</span><br><span class="line">    std::cout &lt;&lt; cart.<span class="built_in">counts</span>(i) &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== repeated message ====================</span></span><br><span class="line"><span class="comment">// 添加并设置（返回指针）</span></span><br><span class="line">Item* item1 = cart.<span class="built_in">add_items</span>();</span><br><span class="line">item1-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;iPhone&quot;</span>);</span><br><span class="line">item1-&gt;<span class="built_in">set_price</span>(<span class="number">999</span>);</span><br><span class="line"></span><br><span class="line">Item* item2 = cart.<span class="built_in">add_items</span>();</span><br><span class="line">item2-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;AirPods&quot;</span>);</span><br><span class="line">item2-&gt;<span class="built_in">set_price</span>(<span class="number">199</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">items_size</span>() &lt;&lt; std::endl;        <span class="comment">// 2</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">items</span>(<span class="number">0</span>).<span class="built_in">name</span>() &lt;&lt; std::endl;     <span class="comment">// iPhone</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">items</span>(<span class="number">0</span>).<span class="built_in">price</span>() &lt;&lt; std::endl;    <span class="comment">// 999</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; item : cart.<span class="built_in">items</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; item.<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot;: $&quot;</span> &lt;&lt; item.<span class="built_in">price</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改已存在的元素</span></span><br><span class="line">cart.<span class="built_in">mutable_items</span>(<span class="number">0</span>)-&gt;<span class="built_in">set_price</span>(<span class="number">899</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除元素</span></span><br><span class="line">cart.<span class="built_in">mutable_items</span>()-&gt;<span class="built_in">DeleteSubrange</span>(<span class="number">0</span>, <span class="number">1</span>);  <span class="comment">// 删除索引0，删1个</span></span><br><span class="line">std::cout &lt;&lt; cart.<span class="built_in">items_size</span>() &lt;&lt; std::endl;  <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 交换元素位置</span></span><br><span class="line">cart.<span class="built_in">add_items</span>()-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;iPad&quot;</span>);</span><br><span class="line">cart.<span class="built_in">mutable_items</span>()-&gt;<span class="built_in">SwapElements</span>(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除最后一个</span></span><br><span class="line">cart.<span class="built_in">mutable_items</span>()-&gt;<span class="built_in">RemoveLast</span>();</span><br></pre></td></tr></table></figure>

<h2 id="3-通用-Message-基类方法"><a href="#3-通用-Message-基类方法" class="headerlink" title="3.通用 Message 基类方法"></a>3.通用 Message 基类方法</h2><h3 id="（1）C-生成伪代码"><a href="#（1）C-生成伪代码" class="headerlink" title="（1）C++ 生成伪代码"></a>（1）C++ 生成伪代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">int</span> _cached_size_;  <span class="comment">// 缓存序列化后的字节大小，避免重复计算</span></span><br><span class="line">    Arena* _arena_;             <span class="comment">// 内存池指针，用于高效内存管理</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ==================== 序列化（对象 → 二进制）====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">SerializeToString</span><span class="params">(std::string* output)</span> <span class="type">const</span></span>;  <span class="comment">// 序列化到 string，成功返回 true</span></span><br><span class="line">    <span class="function">std::string <span class="title">SerializeAsString</span><span class="params">()</span> <span class="type">const</span></span>;              <span class="comment">// 序列化并返回 string（失败返回空）</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">SerializeToArray</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> size)</span> <span class="type">const</span></span>;  <span class="comment">// 序列化到预分配的 buffer</span></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">ByteSizeLong</span><span class="params">()</span> <span class="type">const</span></span>;                        <span class="comment">// 计算序列化后的字节数</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 反序列化（二进制 → 对象）====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ParseFromString</span><span class="params">(<span class="type">const</span> std::string&amp; data)</span></span>;      <span class="comment">// 从 string 解析，成功返回 true</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ParseFromArray</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">int</span> size)</span></span>;    <span class="comment">// 从 buffer 解析</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 复制 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">CopyFrom</span><span class="params">(<span class="type">const</span> Message&amp; from)</span></span>;   <span class="comment">// 完全覆盖：先 Clear()，再复制</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">MergeFrom</span><span class="params">(<span class="type">const</span> Message&amp; from)</span></span>;  <span class="comment">// 合并：只覆盖 from 中已设置的字段</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 清空 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;  <span class="comment">// 重置所有字段为默认值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ==================== 调试 ====================</span></span><br><span class="line">    </span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 格式化输出（多行，带缩进）</span></span><br><span class="line">    <span class="function">std::string <span class="title">ShortDebugString</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 紧凑输出（单行）</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（2）序列化-反序列化"><a href="#（2）序列化-反序列化" class="headerlink" title="（2）序列化&#x2F;反序列化"></a>（2）序列化&#x2F;反序列化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">User user;</span><br><span class="line">user.<span class="built_in">set_id</span>(<span class="number">42</span>);</span><br><span class="line">user.<span class="built_in">set_name</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化</span></span><br><span class="line">std::string data = user.<span class="built_in">SerializeAsString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化</span></span><br><span class="line">User user2;</span><br><span class="line">user<span class="number">2.</span><span class="built_in">ParseFromString</span>(data);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调试输出</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">DebugString</span>();</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// id: 42</span></span><br><span class="line"><span class="comment">// name: &quot;Alice&quot;</span></span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">ShortDebugString</span>();</span><br><span class="line"><span class="comment">// 输出: id: 42 name: &quot;Alice&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="补充：Well-Known-Types"><a href="#补充：Well-Known-Types" class="headerlink" title="补充：Well-Known Types"></a>补充：Well-Known Types</h2><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120090503033.png"></p>
<h3 id="（1）Wrapper-Types（包装类型）"><a href="#（1）Wrapper-Types（包装类型）" class="headerlink" title="（1）Wrapper Types（包装类型）"></a>（1）Wrapper Types（包装类型）</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091029916.png"><br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091111812.png"></p>
<h4 id="Proto-定义-9"><a href="#Proto-定义-9" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/wrappers.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message User &#123;</span><br><span class="line">    google.protobuf.Int32Value age = <span class="number">1</span>;        <span class="comment">// 可判断是否设置</span></span><br><span class="line">    google.protobuf.StringValue nickname = <span class="number">2</span>;</span><br><span class="line">    google.protobuf.BoolValue is_vip = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-9"><a href="#C-生成类型伪代码-9" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以 Int32Value 为例，其他类似</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Int32Value</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int32_t</span> value_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_value</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    google::protobuf::Int32Value* age_;           <span class="comment">// 指针存储</span></span><br><span class="line">    google::protobuf::StringValue* nickname_;</span><br><span class="line">    google::protobuf::BoolValue* is_vip_;</span><br><span class="line">    <span class="type">uint32_t</span> _has_bits_[<span class="number">1</span>];                       <span class="comment">// 位图跟踪</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Has（核心特性）==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_age</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_nickname</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_is_vip</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="type">const</span> google::<span class="function">protobuf::Int32Value&amp; <span class="title">age</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    google::<span class="function">protobuf::Int32Value* <span class="title">mutable_age</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Clear ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_age</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="使用示例-9"><a href="#使用示例-9" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/wrappers.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">User user;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 核心用法：区分&quot;未设置&quot; vs &quot;设置为0/空&quot; =====</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始状态：未设置</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">has_age</span>() &lt;&lt; std::endl;  <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置值</span></span><br><span class="line">user.<span class="built_in">mutable_age</span>()-&gt;<span class="built_in">set_value</span>(<span class="number">25</span>);</span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">has_age</span>() &lt;&lt; std::endl;      <span class="comment">// true</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">age</span>().<span class="built_in">value</span>() &lt;&lt; std::endl;  <span class="comment">// 25</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 关键：设置为 0 也能检测到 =====</span></span><br><span class="line">user.<span class="built_in">mutable_age</span>()-&gt;<span class="built_in">set_value</span>(<span class="number">0</span>);</span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">has_age</span>() &lt;&lt; std::endl;      <span class="comment">// true! ✅</span></span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">age</span>().<span class="built_in">value</span>() &lt;&lt; std::endl;  <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 清除后才是&quot;未设置&quot;</span></span><br><span class="line">user.<span class="built_in">clear_age</span>();</span><br><span class="line">std::cout &lt;&lt; user.<span class="built_in">has_age</span>() &lt;&lt; std::endl;  <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 实际应用：API 更新接口 =====</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateUser</span><span class="params">(<span class="type">const</span> User&amp; req)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="built_in">has_age</span>()) &#123;</span><br><span class="line">        <span class="comment">// 用户明确传了 age（即使是 0）</span></span><br><span class="line">        db.<span class="built_in">update</span>(<span class="string">&quot;age&quot;</span>, req.<span class="built_in">age</span>().<span class="built_in">value</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 未设置则不更新该字段</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (req.<span class="built_in">has_nickname</span>()) &#123;</span><br><span class="line">        db.<span class="built_in">update</span>(<span class="string">&quot;nickname&quot;</span>, req.<span class="built_in">nickname</span>().<span class="built_in">value</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Wrapper-vs-optional-对比"><a href="#Wrapper-vs-optional-对比" class="headerlink" title="&lt;4&gt;Wrapper vs optional 对比"></a>&lt;4&gt;Wrapper vs optional 对比</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091236245.png"></p>
<h3 id="（2）Struct-Value-ListValue（动态-JSON-结构）"><a href="#（2）Struct-Value-ListValue（动态-JSON-结构）" class="headerlink" title="（2）Struct &#x2F; Value &#x2F; ListValue（动态 JSON 结构）"></a>（2）Struct &#x2F; Value &#x2F; ListValue（动态 JSON 结构）</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091314284.png"><br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120091430492.png"></p>
<h4 id="Proto-定义-10"><a href="#Proto-定义-10" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/struct.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message Config &#123;</span><br><span class="line">    google.protobuf.Struct settings = <span class="number">1</span>;   <span class="comment">// 任意 JSON 对象</span></span><br><span class="line">    google.protobuf.Value metadata = <span class="number">2</span>;    <span class="comment">// 任意 JSON 值</span></span><br><span class="line">    google.protobuf.ListValue items = <span class="number">3</span>;   <span class="comment">// JSON 数组</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-10"><a href="#C-生成类型伪代码-10" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== Value（任意 JSON 值）====================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Value</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">KindCase</span> &#123;</span><br><span class="line">        kNullValue = <span class="number">1</span>,</span><br><span class="line">        kNumberValue = <span class="number">2</span>,</span><br><span class="line">        kStringValue = <span class="number">3</span>,</span><br><span class="line">        kBoolValue = <span class="number">4</span>,</span><br><span class="line">        kStructValue = <span class="number">5</span>,</span><br><span class="line">        kListValue = <span class="number">6</span>,</span><br><span class="line">        KIND_NOT_SET = <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// oneof 存储</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        NullValue null_value_;</span><br><span class="line">        <span class="type">double</span> number_value_;</span><br><span class="line">        std::string* string_value_;</span><br><span class="line">        <span class="type">bool</span> bool_value_;</span><br><span class="line">        Struct* struct_value_;</span><br><span class="line">        ListValue* list_value_;</span><br><span class="line">    &#125;;</span><br><span class="line">    KindCase kind_case_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== Kind 判断 ==========</span></span><br><span class="line">    <span class="function">KindCase <span class="title">kind_case</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Getter ==========</span></span><br><span class="line">    <span class="function">NullValue <span class="title">null_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">number_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">string_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">bool_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> Struct&amp; <span class="title">struct_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> ListValue&amp; <span class="title">list_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Setter ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_null_value</span><span class="params">(NullValue value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_number_value</span><span class="params">(<span class="type">double</span> value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_string_value</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_bool_value</span><span class="params">(<span class="type">bool</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Mutable ==========</span></span><br><span class="line">    <span class="function">Struct* <span class="title">mutable_struct_value</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ListValue* <span class="title">mutable_list_value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== Struct（JSON 对象）====================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Struct</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    google::protobuf::Map&lt;std::string, Value&gt; fields_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== 字段访问 ==========</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Map&lt;std::string, Value&gt;&amp; <span class="title">fields</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Map&lt;std::string, Value&gt;* <span class="title">mutable_fields</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== ListValue（JSON 数组）====================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListValue</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    google::protobuf::RepeatedPtrField&lt;Value&gt; values_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ========== 元素访问 ==========</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">values_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> Value&amp; <span class="title">values</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">Value* <span class="title">add_values</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Value* <span class="title">mutable_values</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> RepeatedPtrField&lt;Value&gt;&amp; <span class="title">values</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">RepeatedPtrField&lt;Value&gt;* <span class="title">mutable_values</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br></pre></td></tr></table></figure>

<h4 id="使用示例-10"><a href="#使用示例-10" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/struct.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;config.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::Struct;</span><br><span class="line"><span class="keyword">using</span> google::protobuf::Value;</span><br><span class="line"><span class="keyword">using</span> google::protobuf::ListValue;</span><br><span class="line"></span><br><span class="line">Config config;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 构建 Struct（JSON 对象）====================</span></span><br><span class="line"><span class="comment">// 目标: &#123; &quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 25, &quot;active&quot;: true &#125;</span></span><br><span class="line"></span><br><span class="line">Struct* settings = config.<span class="built_in">mutable_settings</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 string</span></span><br><span class="line">(*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;name&quot;</span>].<span class="built_in">set_string_value</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 number</span></span><br><span class="line">(*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;age&quot;</span>].<span class="built_in">set_number_value</span>(<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 bool</span></span><br><span class="line">(*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;active&quot;</span>].<span class="built_in">set_bool_value</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 null</span></span><br><span class="line">(*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;deleted_at&quot;</span>].<span class="built_in">set_null_value</span>(</span><br><span class="line">    google::protobuf::NULL_VALUE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 嵌套对象 ====================</span></span><br><span class="line"><span class="comment">// 目标: &#123; &quot;address&quot;: &#123; &quot;city&quot;: &quot;Beijing&quot;, &quot;zip&quot;: &quot;100000&quot; &#125; &#125;</span></span><br><span class="line"></span><br><span class="line">Struct* address = (*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;address&quot;</span>].<span class="built_in">mutable_struct_value</span>();</span><br><span class="line">(*address-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;city&quot;</span>].<span class="built_in">set_string_value</span>(<span class="string">&quot;Beijing&quot;</span>);</span><br><span class="line">(*address-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;zip&quot;</span>].<span class="built_in">set_string_value</span>(<span class="string">&quot;100000&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 数组 ====================</span></span><br><span class="line"><span class="comment">// 目标: &#123; &quot;tags&quot;: [&quot;vip&quot;, &quot;new&quot;, 123] &#125;</span></span><br><span class="line"></span><br><span class="line">ListValue* tags = (*settings-&gt;<span class="built_in">mutable_fields</span>())[<span class="string">&quot;tags&quot;</span>].<span class="built_in">mutable_list_value</span>();</span><br><span class="line">tags-&gt;<span class="built_in">add_values</span>()-&gt;<span class="built_in">set_string_value</span>(<span class="string">&quot;vip&quot;</span>);</span><br><span class="line">tags-&gt;<span class="built_in">add_values</span>()-&gt;<span class="built_in">set_string_value</span>(<span class="string">&quot;new&quot;</span>);</span><br><span class="line">tags-&gt;<span class="built_in">add_values</span>()-&gt;<span class="built_in">set_number_value</span>(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 读取 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取 string</span></span><br><span class="line"><span class="keyword">if</span> (settings-&gt;<span class="built_in">fields</span>().<span class="built_in">contains</span>(<span class="string">&quot;name&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">const</span> Value&amp; v = settings-&gt;<span class="built_in">fields</span>().<span class="built_in">at</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (v.<span class="built_in">kind_case</span>() == Value::kStringValue) &#123;</span><br><span class="line">        std::cout &lt;&lt; v.<span class="built_in">string_value</span>() &lt;&lt; std::endl;  <span class="comment">// Alice</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取 number</span></span><br><span class="line"><span class="type">double</span> age = settings-&gt;<span class="built_in">fields</span>().<span class="built_in">at</span>(<span class="string">&quot;age&quot;</span>).<span class="built_in">number_value</span>();</span><br><span class="line">std::cout &lt;&lt; age &lt;&lt; std::endl;  <span class="comment">// 25</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历所有字段</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; [key, value] : settings-&gt;<span class="built_in">fields</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; key &lt;&lt; <span class="string">&quot;: &quot;</span>;</span><br><span class="line">    <span class="keyword">switch</span> (value.<span class="built_in">kind_case</span>()) &#123;</span><br><span class="line">        <span class="keyword">case</span> Value::kStringValue:</span><br><span class="line">            std::cout &lt;&lt; value.<span class="built_in">string_value</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Value::kNumberValue:</span><br><span class="line">            std::cout &lt;&lt; value.<span class="built_in">number_value</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Value::kBoolValue:</span><br><span class="line">            std::cout &lt;&lt; (value.<span class="built_in">bool_value</span>() ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Value::kNullValue:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;null&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Value::kStructValue:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;&#123;...&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> Value::kListValue:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[...]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取数组</span></span><br><span class="line"><span class="type">const</span> ListValue&amp; tag_list = settings-&gt;<span class="built_in">fields</span>().<span class="built_in">at</span>(<span class="string">&quot;tags&quot;</span>).<span class="built_in">list_value</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; tag_list.<span class="built_in">values_size</span>(); i++) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;tag[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]: &quot;</span>;</span><br><span class="line">    <span class="type">const</span> Value&amp; v = tag_list.<span class="built_in">values</span>(i);</span><br><span class="line">    <span class="keyword">if</span> (v.<span class="built_in">kind_case</span>() == Value::kStringValue) &#123;</span><br><span class="line">        std::cout &lt;&lt; v.<span class="built_in">string_value</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v.<span class="built_in">kind_case</span>() == Value::kNumberValue) &#123;</span><br><span class="line">        std::cout &lt;&lt; v.<span class="built_in">number_value</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Struct-与-JSON-互转"><a href="#Struct-与-JSON-互转" class="headerlink" title="&lt;4&gt;Struct 与 JSON 互转"></a>&lt;4&gt;Struct 与 JSON 互转</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/util/json_util.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::util::JsonStringToMessage;</span><br><span class="line"><span class="keyword">using</span> google::protobuf::util::MessageToJsonString;</span><br><span class="line"></span><br><span class="line"><span class="comment">// JSON → Struct</span></span><br><span class="line">std::string json = <span class="string">R&quot;(&#123;</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Alice&quot;,</span></span><br><span class="line"><span class="string">    &quot;age&quot;: 25,</span></span><br><span class="line"><span class="string">    &quot;tags&quot;: [&quot;vip&quot;, &quot;new&quot;]</span></span><br><span class="line"><span class="string">&#125;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">Struct s;</span><br><span class="line"><span class="keyword">auto</span> status = <span class="built_in">JsonStringToMessage</span>(json, &amp;s);</span><br><span class="line"><span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;解析成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Struct → JSON</span></span><br><span class="line">std::string output;</span><br><span class="line"><span class="built_in">MessageToJsonString</span>(s, &amp;output);</span><br><span class="line">std::cout &lt;&lt; output &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">// &#123;&quot;name&quot;:&quot;Alice&quot;,&quot;age&quot;:25,&quot;tags&quot;:[&quot;vip&quot;,&quot;new&quot;]&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="（3）Empty（空消息）"><a href="#（3）Empty（空消息）" class="headerlink" title="（3）Empty（空消息）"></a>（3）Empty（空消息）</h3><h4 id="Proto-定义-11"><a href="#Proto-定义-11" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">service HealthService &#123;</span><br><span class="line">    <span class="function">rpc <span class="title">Ping</span><span class="params">(google.protobuf.Empty)</span> <span class="title">returns</span> <span class="params">(google.protobuf.Empty)</span></span>;</span><br><span class="line">    <span class="function">rpc <span class="title">DeleteUser</span><span class="params">(DeleteUserRequest)</span> <span class="title">returns</span> <span class="params">(google.protobuf.Empty)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message DeleteUserRequest &#123;</span><br><span class="line">    int32 user_id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-11"><a href="#C-生成类型伪代码-11" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Empty</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 几乎没有方法，就是一个空消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">IsInitialized</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">ByteSizeLong</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 始终返回 0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br></pre></td></tr></table></figure>

<h4 id="使用示例-11"><a href="#使用示例-11" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/empty.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;health_service.grpc.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::Empty;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== gRPC 客户端调用 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ping：无参数，无返回</span></span><br><span class="line">Empty req, resp;</span><br><span class="line">grpc::ClientContext context;</span><br><span class="line">grpc::Status status = stub-&gt;<span class="built_in">Ping</span>(&amp;context, req, &amp;resp);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Ping 成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeleteUser：有参数，无返回</span></span><br><span class="line">DeleteUserRequest del_req;</span><br><span class="line">del_req.<span class="built_in">set_user_id</span>(<span class="number">12345</span>);</span><br><span class="line"></span><br><span class="line">Empty del_resp;</span><br><span class="line">status = stub-&gt;<span class="built_in">DeleteUser</span>(&amp;context, del_req, &amp;del_resp);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== gRPC 服务端实现 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HealthServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> HealthService::Service &#123;</span><br><span class="line">    <span class="function">grpc::Status <span class="title">Ping</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> Empty* request,</span></span></span><br><span class="line"><span class="params"><span class="function">                      Empty* response)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 什么都不用做，直接返回 OK</span></span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">grpc::Status <span class="title">DeleteUser</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> DeleteUserRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">                            Empty* response)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="type">int32_t</span> user_id = request-&gt;<span class="built_in">user_id</span>();</span><br><span class="line">        db.<span class="built_in">deleteUser</span>(user_id);</span><br><span class="line">        <span class="comment">// 不需要填充 response</span></span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（4）FieldMask（字段掩码）"><a href="#（4）FieldMask（字段掩码）" class="headerlink" title="（4）FieldMask（字段掩码）"></a>（4）FieldMask（字段掩码）</h3><h4 id="Proto-定义-12"><a href="#Proto-定义-12" class="headerlink" title="&lt;1&gt;Proto 定义"></a>&lt;1&gt;Proto 定义</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/field_mask.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">message User &#123;</span><br><span class="line">    int32 id = <span class="number">1</span>;</span><br><span class="line">    string name = <span class="number">2</span>;</span><br><span class="line">    string email = <span class="number">3</span>;</span><br><span class="line">    string phone = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message UpdateUserRequest &#123;</span><br><span class="line">    User user = <span class="number">1</span>;</span><br><span class="line">    google.protobuf.FieldMask update_mask = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="C-生成类型伪代码-12"><a href="#C-生成类型伪代码-12" class="headerlink" title="&lt;2&gt;C++ 生成类型伪代码"></a>&lt;2&gt;C++ 生成类型伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> google::protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FieldMask</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    google::protobuf::RepeatedPtrField&lt;std::string&gt; paths_;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ----- Size -----</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">paths_size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Getter -----</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">paths</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> RepeatedPtrField&lt;std::string&gt;&amp; <span class="title">paths</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Add -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add_paths</span><span class="params">(<span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    <span class="function">std::string* <span class="title">add_paths</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Mutable -----</span></span><br><span class="line">    <span class="function">std::string* <span class="title">mutable_paths</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">    <span class="function">RepeatedPtrField&lt;std::string&gt;* <span class="title">mutable_paths</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ----- Clear -----</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">clear_paths</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  <span class="comment">// namespace google::protobuf</span></span><br></pre></td></tr></table></figure>

<h4 id="使用示例-12"><a href="#使用示例-12" class="headerlink" title="&lt;3&gt;使用示例"></a>&lt;3&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/field_mask.pb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/util/field_mask_util.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> google::protobuf::FieldMask;</span><br><span class="line"><span class="keyword">using</span> google::protobuf::util::FieldMaskUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 客户端：构建部分更新请求 ====================</span></span><br><span class="line"></span><br><span class="line">UpdateUserRequest req;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只更新 name 和 email</span></span><br><span class="line">req.<span class="built_in">mutable_user</span>()-&gt;<span class="built_in">set_id</span>(<span class="number">12345</span>);</span><br><span class="line">req.<span class="built_in">mutable_user</span>()-&gt;<span class="built_in">set_name</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">req.<span class="built_in">mutable_user</span>()-&gt;<span class="built_in">set_email</span>(<span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指定要更新的字段</span></span><br><span class="line">req.<span class="built_in">mutable_update_mask</span>()-&gt;<span class="built_in">add_paths</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">req.<span class="built_in">mutable_update_mask</span>()-&gt;<span class="built_in">add_paths</span>(<span class="string">&quot;email&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 服务端：根据 FieldMask 处理 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleUpdateUser</span><span class="params">(<span class="type">const</span> UpdateUserRequest&amp; req)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> User&amp; user = req.<span class="built_in">user</span>();</span><br><span class="line">    <span class="type">const</span> FieldMask&amp; mask = req.<span class="built_in">update_mask</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 方式1：手动遍历</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; path : mask.<span class="built_in">paths</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (path == <span class="string">&quot;name&quot;</span>) &#123;</span><br><span class="line">            db.<span class="built_in">update</span>(user.<span class="built_in">id</span>(), <span class="string">&quot;name&quot;</span>, user.<span class="built_in">name</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path == <span class="string">&quot;email&quot;</span>) &#123;</span><br><span class="line">            db.<span class="built_in">update</span>(user.<span class="built_in">id</span>(), <span class="string">&quot;email&quot;</span>, user.<span class="built_in">email</span>());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path == <span class="string">&quot;phone&quot;</span>) &#123;</span><br><span class="line">            db.<span class="built_in">update</span>(user.<span class="built_in">id</span>(), <span class="string">&quot;phone&quot;</span>, user.<span class="built_in">phone</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 方式2：使用 FieldMaskUtil 合并</span></span><br><span class="line">    User existing_user = db.<span class="built_in">getUser</span>(user.<span class="built_in">id</span>());</span><br><span class="line">    FieldMaskUtil::<span class="built_in">MergeMessageTo</span>(user, mask, &amp;existing_user);</span><br><span class="line">    db.<span class="built_in">saveUser</span>(existing_user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== FieldMaskUtil 工具函数 ====================</span></span><br><span class="line"></span><br><span class="line">User src, dst;</span><br><span class="line">src.<span class="built_in">set_name</span>(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">src.<span class="built_in">set_email</span>(<span class="string">&quot;alice@example.com&quot;</span>);</span><br><span class="line">src.<span class="built_in">set_phone</span>(<span class="string">&quot;13800138000&quot;</span>);</span><br><span class="line"></span><br><span class="line">dst.<span class="built_in">set_id</span>(<span class="number">1</span>);</span><br><span class="line">dst.<span class="built_in">set_name</span>(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line">dst.<span class="built_in">set_email</span>(<span class="string">&quot;bob@example.com&quot;</span>);</span><br><span class="line"></span><br><span class="line">FieldMask mask;</span><br><span class="line">mask.<span class="built_in">add_paths</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">mask.<span class="built_in">add_paths</span>(<span class="string">&quot;email&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只合并 mask 指定的字段</span></span><br><span class="line">FieldMaskUtil::<span class="built_in">MergeMessageTo</span>(src, mask, &amp;dst);</span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; dst.<span class="built_in">id</span>() &lt;&lt; std::endl;     <span class="comment">// 1（未被覆盖）</span></span><br><span class="line">std::cout &lt;&lt; dst.<span class="built_in">name</span>() &lt;&lt; std::endl;   <span class="comment">// Alice（被覆盖）</span></span><br><span class="line">std::cout &lt;&lt; dst.<span class="built_in">email</span>() &lt;&lt; std::endl;  <span class="comment">// alice@example.com（被覆盖）</span></span><br><span class="line">std::cout &lt;&lt; dst.<span class="built_in">phone</span>() &lt;&lt; std::endl;  <span class="comment">// &quot;&quot;（未被覆盖，dst 原本没有）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 其他工具函数 ====================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查 path 是否在 mask 中</span></span><br><span class="line"><span class="type">bool</span> has_name = FieldMaskUtil::<span class="built_in">IsPathInFieldMask</span>(<span class="string">&quot;name&quot;</span>, mask);  <span class="comment">// true</span></span><br><span class="line"><span class="type">bool</span> has_phone = FieldMaskUtil::<span class="built_in">IsPathInFieldMask</span>(<span class="string">&quot;phone&quot;</span>, mask); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为字符串</span></span><br><span class="line">std::string mask_str = FieldMaskUtil::<span class="built_in">ToString</span>(mask);  <span class="comment">// &quot;name,email&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从字符串解析</span></span><br><span class="line">FieldMask mask2;</span><br><span class="line">FieldMaskUtil::<span class="built_in">FromString</span>(<span class="string">&quot;name,phone&quot;</span>, &amp;mask2);</span><br></pre></td></tr></table></figure>

<h1 id="三、RPC（远程过程调用）"><a href="#三、RPC（远程过程调用）" class="headerlink" title="三、RPC（远程过程调用）"></a>三、RPC（远程过程调用）</h1><h2 id="1-RPC的功能"><a href="#1-RPC的功能" class="headerlink" title="1.RPC的功能"></a>1.RPC的功能</h2><ul>
<li><strong>远程过程调用（Remote Procedure Call）</strong> 的核心目标是：<ul>
<li>让使用者在<strong>一台服务器上调用另一台服务器上的函数</strong>时，感觉<strong>就像调用本地函数</strong>一样简单。</li>
</ul>
</li>
<li>举个例子，假设你在服务器 A 上写代码，想获取服务器 B 上的用户信息：</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用者视角：看起来就像调用本地函数</span></span><br><span class="line">UserResponse resp = userService.<span class="built_in">GetUser</span>(request);</span><br><span class="line"><span class="comment">// 实际上，这个请求通过网络发送到了服务器 B，服务器 B 执行后把结果返回</span></span><br></pre></td></tr></table></figure>
<p>从代码层面看，你完全 <strong>“感知不到”中间经历了网络传输、序列化、反序列化等复杂过程</strong>，这就是 RPC 的魅力所在。</p>
<p><a id="RPC（2）"></a></p>
<h2 id="2-RPC底层原理（重点！！）"><a href="#2-RPC底层原理（重点！！）" class="headerlink" title="2.RPC底层原理（重点！！）"></a>2.RPC底层原理（重点！！）</h2><h3 id="（1）RPC核心步骤（概述）"><a href="#（1）RPC核心步骤（概述）" class="headerlink" title="（1）RPC核心步骤（概述）"></a>（1）RPC核心步骤（概述）</h3><ul>
<li><strong>“双方定义一模一样的API”</strong> + <strong>“服务端注册方法”</strong> + <strong>“序列化”（序列化客户端发送的请求）</strong> + <strong>“网络通信”</strong> + <strong>“反序列化”（反序列化客户端发送的请求）</strong>+ <strong>“路由”（获取具体的方法进行执行）</strong></li>
</ul>
<h3 id="（2）RPC过程详解"><a href="#（2）RPC过程详解" class="headerlink" title="（2）RPC过程详解"></a>（2）RPC过程详解</h3><p>RPC 是如何实现”像调用本地函数一样”的效果呢？我们以客户端、服务端为例，服务端不同服务可能有同名的方法，所以我们以 <strong>（服务名,方法名）二元组</strong> 来定位一个“具体方法”</p>
<ul>
<li><strong>第一步：在客户端与服务端上定义好“一模一样”的API</strong><ul>
<li>客户端和服务端必须事先约定好接口的定义——<strong>服务名</strong>是什么、<strong>方法名</strong>叫什么、<strong>参数</strong>是什么类型、<strong>返回值</strong>是什么类型 ——&gt; 只有双方的”契约”一致，才能正确地互相理解。</li>
</ul>
</li>
<li><strong>第二步：服务端“注册方法”</strong><ul>
<li>如通过 <strong>std::map&lt;服务名:方法名,具体方法&gt;</strong> 来进行映射存储    ——&gt;这样就可以通过（服务名，方法名）来定位“具体方法”（<strong>具体方法&#x3D;map[服务名:方法名]</strong>）</li>
</ul>
</li>
<li><strong>第三步：客户端调用时，将”服务名+方法名 + 参数”进行“序列化”，再通过“网络发送”到目标服务端</strong><ul>
<li>当客户端执行User服务的GetUser(request)方法 时，RPC 框架会在背后做这些事情：<ul>
<li>1.把服务名（如 “User”）、方法名（如 “GetUser”）、参数（如 request 对象）<strong>序列化</strong>成二进制数据</li>
<li>2.通过网络把这些数据发送到服务端</li>
</ul>
</li>
</ul>
</li>
<li><strong>第四步：到达服务端后，进行“路由”后得到“具体方法”，进而执行对应方法</strong><ul>
<li>服务端收到数据后：<ul>
<li>1.<strong>反序列化</strong>得到“服务名”、“方法名”、“参数”</li>
<li>2.<strong>具体方法 &#x3D; map[服务名:方法名]</strong>，再用反序列化出的参数调用它</li>
<li>3.得到返回值后，再将返回值<strong>序列化</strong>，通过网络传回给客户端</li>
<li><strong>路由</strong>：就是指找到对应的“具体方法”进行执行</li>
</ul>
</li>
</ul>
</li>
<li><strong>第五步：客户端收到返回值，继续执行</strong><ul>
<li>客户端收到返回的二进制数据后，反序列化得到返回值，然后就像普通函数调用一样继续往下执行。</li>
</ul>
</li>
</ul>
<p><strong>关键点总结</strong>：</p>
<ul>
<li>RPC 的核心就是<strong>封装了中间网络通信的全部细节</strong>（序列化、网络传输、反序列化、路由），让开发者只需要关注”调用什么函数、传什么参数、拿什么返回值”，从而达到”像调用本地 API 一样”的使用体验。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                           RPC 调用完整流程                               │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   调用端服务器 (A)                              目标服务器 (B)            │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌──────────────┐                            ┌──────────────┐          │</span><br><span class="line">│   │  业务代码     │                            │  相同的 API   │          │</span><br><span class="line">│   │              │                            │              │          │</span><br><span class="line">│   │ <span class="built_in">GetUser</span>(req) │                            │ <span class="built_in">GetUser</span>(req) │          │</span><br><span class="line">│   └──────┬───────┘                            └──────▲───────┘          │</span><br><span class="line">│          │ ①调用                                     │ ④执行            │</span><br><span class="line">│          ▼                                           │                  │</span><br><span class="line">│   ┌──────────────┐                            ┌──────┴───────┐          │</span><br><span class="line">│   │  RPC 框架     │                            │  RPC 框架     │          │</span><br><span class="line">│   │              │                            │              │          │</span><br><span class="line">│   │ ②序列化       │     ═══════════════════    │ ③反序列化     │          │</span><br><span class="line">│   │ 方法名+参数   │────►   网络传输请求   ────►│ 方法名+参数   │          │</span><br><span class="line">│   │              │                            │              │          │</span><br><span class="line">│   │ ⑥反序列化    │◄────   网络传输响应   ◄────│ ⑤序列化      │          │</span><br><span class="line">│   │ 返回值       │     ═══════════════════    │ 返回值       │          │</span><br><span class="line">│   └──────┬───────┘                            └──────────────┘          │</span><br><span class="line">│          │ ⑦返回                                                        │</span><br><span class="line">│          ▼                                                              │</span><br><span class="line">│   ┌──────────────┐                                                      │</span><br><span class="line">│   │  业务代码     │                                                      │</span><br><span class="line">│   │ 拿到返回值    │                                                      │</span><br><span class="line">│   │ 继续执行...   │                                                      │</span><br><span class="line">│   └──────────────┘                                                      │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="3-RPC-的性能与价值"><a href="#3-RPC-的性能与价值" class="headerlink" title="3.RPC 的性能与价值"></a>3.RPC 的性能与价值</h2><ul>
<li><strong>性能方面</strong>：<ul>
<li>由于 RPC 调用中间<strong>增加了序列化、网络传输、反序列化等步骤</strong>，其<strong>性能必然“低于”直接调用本地函数</strong>。</li>
<li>一次本地函数调用可能只需要几纳秒，而一次 RPC 调用即使在同一局域网内，也至少需要几百微秒到几毫秒。</li>
</ul>
</li>
<li><strong>那为什么还要用 RPC？</strong><ul>
<li>因为在现代软件系统中，<strong>单台服务器的能力是有限的</strong>：<ul>
<li><strong>资源有限</strong>：一台机器的 CPU、内存、磁盘都是有上限的</li>
<li><strong>负载能力有限</strong>：单机能承受的并发请求量有限</li>
<li><strong>容错能力差</strong>：单机故障会导致整个服务不可用</li>
<li><strong>扩展困难</strong>：业务增长时，单机很难快速扩容</li>
</ul>
</li>
<li>要解决这些问题，必须采用<strong>分布式架构</strong>——把服务拆分到多台机器上运行。而<strong>机器之间的通信，就需要 RPC 来完成</strong>。</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     为什么需要 RPC？                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│   单机困境                              分布式解决方案            │</span><br><span class="line">│   ──────────                            ──────────────          │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   资源有限                    ──────►   多机水平扩展             │</span><br><span class="line">│   (CPU/内存/磁盘)                       (加机器就能加资源)        │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   负载能力差                  ──────►   负载均衡                 │</span><br><span class="line">│   (单机扛不住高并发)                    (请求分散到多台机器)      │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   单点故障                    ──────►   容错冗余                 │</span><br><span class="line">│   (一台挂了全挂)                        (一台挂了其他顶上)        │</span><br><span class="line">│                                                                 │</span><br><span class="line">│   扩展困难                    ──────►   弹性伸缩                 │</span><br><span class="line">│   (业务增长难应对)                      (按需增减机器)           │</span><br><span class="line">│                                                                 │</span><br><span class="line">│                                                                 │</span><br><span class="line">│            ┌─────────────────────────────────────┐              │</span><br><span class="line">│            │  RPC 是分布式系统的<span class="string">&quot;神经网络&quot;</span>        │              │</span><br><span class="line">│            │  让多台机器能像一台机器一样协同工作   │              │</span><br><span class="line">│            └─────────────────────────────────────┘              │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>


<h1 id="四、Proto-Service（纯-Protobuf-层面）"><a href="#四、Proto-Service（纯-Protobuf-层面）" class="headerlink" title="四、Proto Service（纯 Protobuf 层面）"></a>四、Proto Service（纯 Protobuf 层面）</h1><ul>
<li>前面提到，RPC 要求调用端和被调用端有”<strong>一模一样的 API</strong>“。那这个 API 谁来定义？手写容易出错、跨语言还得写多份，非常麻烦 ——&gt; <strong>Proto Service 就是来解决这个问题的</strong></li>
<li>通过protoc编译后，Proto中的Service就会<strong>自动生成</strong> C++ 对应的抽象类和 Stub（客户端桩），也就不用我们自己去定义“<strong>一模一样的API</strong>”</li>
<li>除了自动生成代码，Proto Service 还<strong>自带了 Protobuf 的序列化、反序列化能力</strong> ——&gt; 消息的序列化和反序列化都由生成的代码自动处理，你不需要关心数据在网络上是怎么传输的。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌───────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Proto Service 的价值                           │</span><br><span class="line">├───────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                   │</span><br><span class="line">│   传统方式（手写）                  Proto Service 方式             │</span><br><span class="line">│                                                                   │</span><br><span class="line">│   ┌─────────────────┐              ┌─────────────────┐            │</span><br><span class="line">│   │ 服务端手写 API   │              │  .proto 文件     │            │</span><br><span class="line">│   │ (C++ 版本)      │              │  定义一次        │            │</span><br><span class="line">│   └─────────────────┘              └────────┬────────┘            │</span><br><span class="line">│            +                                │                     │</span><br><span class="line">│   ┌─────────────────┐                       │ protoc 编译         │</span><br><span class="line">│   │ 客户端手写 API   │                       ▼                     │</span><br><span class="line">│   │ (C++ 版本)      │              ┌────────┴────────┐            │</span><br><span class="line">│   └─────────────────┘              │                 │            │</span><br><span class="line">│            +                       ▼                 ▼            │</span><br><span class="line">│   ┌─────────────────┐      ┌─────────────┐   ┌─────────────┐     │</span><br><span class="line">│   │ 其他语言再写一遍  │      │ 服务端基类   │   │ 客户端 Stub │     │</span><br><span class="line">│   │ (Java/Go/...)   │      │ (自动生成)   │   │ (自动生成)  │     │</span><br><span class="line">│   └─────────────────┘      └─────────────┘   └─────────────┘     │</span><br><span class="line">│                                                                   │</span><br><span class="line">│   ❌ 繁琐、易出错、难维护    ✅ 一次定义、多端生成、“序列化、反序列化”   │</span><br><span class="line">│                                                                   │</span><br><span class="line">└───────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1.概述"></a>1.概述</h2><p><strong>注意</strong>：本节聚焦于 <strong>Protobuf 原生 Service 机制</strong>，与 gRPC 框架无关。Protobuf 的 Service 只是一个「接口描述层」，<strong>需要自己实现 RPC 通信层</strong>。</p>
<ul>
<li>在Protobuf中，message描述 <strong>数据结构</strong>，service描述 <strong>RPC接口</strong></li>
<li>在 .proto 文件里 <strong>“定义服务的方法名、参数、返回值”</strong> ，通过 protoc 编译后，会<strong>自动生成</strong> C++ 对应的 <strong>抽象基类（服务端实现）</strong> 和 <strong>Stub 类（客户端桩）</strong></li>
<li>需要注意的是：原生的Proto Service <strong>本身不包含网络传输逻辑</strong>，它只是<strong>定义”接口长什么样”</strong>。<ul>
<li>要实现真正的远程调用，通常需要搭配 <strong>RPC 框架</strong>（如 <strong>gRPC</strong>，这是目前最主流的选择）来处理底层的网络通信。（或者<strong>自己实现网络层</strong>）<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120103057891.png"></li>
</ul>
</li>
</ul>
<p><a id="proto_service"></a></p>
<h2 id="2-Service的使用"><a href="#2-Service的使用" class="headerlink" title="2.Service的使用"></a>2.Service的使用</h2><h3 id="（1）基本语法"><a href="#（1）基本语法" class="headerlink" title="（1）基本语法"></a>（1）基本语法</h3><p><strong>以EchoService为例</strong>：客户端发送消息给服务端，服务端原封不动</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line">package myservice;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于 C++ 代码生成优化</span></span><br><span class="line">option cc_generic_services = <span class="literal">true</span>;  <span class="comment">// 【关键】必须开启才会生成 Service 代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义请求消息</span></span><br><span class="line">message EchoRequest &#123;</span><br><span class="line">  string message = <span class="number">1</span>;    <span class="comment">//客户端消息</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义响应消息</span></span><br><span class="line">message EchoResponse &#123;</span><br><span class="line">  string reply = <span class="number">1</span>;        <span class="comment">//服务端回复</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义服务</span></span><br><span class="line">service EchoService &#123;</span><br><span class="line">  <span class="comment">// RPC 方法定义</span></span><br><span class="line">  <span class="function">rpc <span class="title">Echo</span><span class="params">(EchoRequest)</span> <span class="title">returns</span> <span class="params">(EchoResponse)</span></span>;</span><br><span class="line">  <span class="function">rpc <span class="title">Ping</span><span class="params">(EchoRequest)</span> <span class="title">returns</span> <span class="params">(EchoResponse)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 补充：支持流式 RPC（Protobuf 原生支持，无需额外扩展）</span></span><br><span class="line">  <span class="comment">// rpc ListUsers(GetUserRequest) returns (stream GetUserResponse);  // 服务端流式</span></span><br><span class="line">  <span class="comment">// rpc BatchUpdateUser(stream GetUserRequest) returns (GetUserResponse);  // 客户端流式</span></span><br><span class="line">  <span class="comment">// rpc BidirectionalTalk(stream GetUserRequest) returns (stream GetUserResponse);  // 双向流式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>⚠️ 重要</strong>：cc_generic_services &#x3D; true 是使用 Protobuf 原生 Service 的前提！</p>
<h3 id="（2）编译命令"><a href="#（2）编译命令" class="headerlink" title="（2）编译命令"></a>（2）编译命令</h3><ol>
<li><strong>基本编译</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只生成消息类和 Service 类</span></span><br><span class="line">protoc --cpp_out=./generated echo.proto</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>生成文件</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">├── echo.pb.h      <span class="comment"># 头文件（消息类 + Service 类）</span></span><br><span class="line">└── echo.pb.cc     <span class="comment"># 实现文件</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>编译参数详解</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protoc \</span><br><span class="line">  --cpp_out=OUT_DIR \          <span class="comment"># 指定输出目录</span></span><br><span class="line">  --proto_path=IMPORT_PATH \   <span class="comment"># 指定 .proto 文件搜索路径（可多次使用）</span></span><br><span class="line">  echo.proto                    <span class="comment"># 输入文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：多路径</span></span><br><span class="line">protoc \</span><br><span class="line">  --cpp_out=./generated \</span><br><span class="line">  --proto_path=./protos \</span><br><span class="line">  --proto_path=./third_party \</span><br><span class="line">  echo.proto</span><br></pre></td></tr></table></figure>

<h3 id="（3）生成的-C-伪代码"><a href="#（3）生成的-C-伪代码" class="headerlink" title="（3）生成的 C++ 伪代码"></a>（3）生成的 C++ 伪代码</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120234637423.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="comment">// echo.pb.h - 生成的头文件</span></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/service.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/descriptor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/stubs/callback.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> myservice &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="comment">// 消息类（略，与普通 message 相同）</span></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoRequest</span> : <span class="keyword">public</span> ::google::protobuf::Message &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoResponse</span> : <span class="keyword">public</span> ::google::protobuf::Message &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="comment">// Service 抽象基类 - 服务端需要继承实现</span></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoService</span> : <span class="keyword">public</span> ::google::protobuf::Service &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 禁止直接构造，必须继承</span></span><br><span class="line">    <span class="built_in">EchoService</span>() = <span class="keyword">default</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">EchoService</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// 禁止拷贝</span></span><br><span class="line">    <span class="built_in">EchoService</span>(<span class="type">const</span> EchoService&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    EchoService&amp; <span class="keyword">operator</span>=(<span class="type">const</span> EchoService&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类型别名（方便使用）</span></span><br><span class="line">    <span class="keyword">typedef</span> EchoService_Stub Stub;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================== 【核心】纯虚方法 - 需要子类实现的业务逻辑 =====================</span></span><br><span class="line">    <span class="comment">// 由 rpc Echo(EchoRequest) returns (EchoResponse) 生成</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Echo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,    <span class="comment">//RPC 控制器（用于设置/获取错误信息、取消等）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> EchoRequest* request,                        <span class="comment">//请求消息类（由框架反序列化后传入）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        EchoResponse* response,                            <span class="comment">//响应消息类（子类填充后由框架序列化）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done                 <span class="comment">//完成回调（异步场景使用，调用 done-&gt;Run() 表示完成）</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 由 rpc Ping(EchoRequest) returns (EchoResponse) 生成</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Ping</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> EchoRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">        EchoResponse* response,</span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 【核心】通用调用入口 - 根据方法描述符分发到具体方法</span></span><br><span class="line">    <span class="comment">// 框架层调用此方法，由它路由到 Echo() 或 Ping()</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">CallMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method, <span class="comment">// 方法描述符（包含服务名、方法名、索引等元信息）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,        <span class="comment">// 控制器（用于取消、超时、错误处理）	</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::Message* request,            <span class="comment">// 请求消息（已序列化或待序列化）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Message* response,                <span class="comment">// 响应消息（调用完成后由框架填充）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done                    <span class="comment">//完成回调 :</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>&#123;                                                        <span class="comment">// - 异步调用：传回调对象，CallMethod 立即返回</span></span><br><span class="line">                                                            <span class="comment">// - 同步调用：传 nullptr，CallMethod 阻塞直到完成</span></span><br><span class="line">        <span class="comment">// 1. 断言：确保传入的方法确实属于本服务</span></span><br><span class="line">        <span class="built_in">GOOGLE_DCHECK_EQ</span>(method-&gt;<span class="built_in">service</span>(), EchoService::<span class="built_in">descriptor</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 根据方法索引进行路由分发</span></span><br><span class="line">        <span class="keyword">switch</span> (method-&gt;<span class="built_in">index</span>()) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:  <span class="comment">// 索引 0 对应 Echo 方法（proto 文件中定义的第一个 rpc）</span></span><br><span class="line">                <span class="built_in">Echo</span>(</span><br><span class="line">                    controller,</span><br><span class="line">                    <span class="comment">// 向下转型：从通用 Message* 转为具体的 EchoRequest*</span></span><br><span class="line">                    ::google::protobuf::<span class="built_in">down_cast</span>&lt;<span class="type">const</span> EchoRequest*&gt;(request),</span><br><span class="line">                    <span class="comment">// 向下转型：从通用 Message* 转为具体的 EchoResponse*</span></span><br><span class="line">                    ::google::protobuf::<span class="built_in">down_cast</span>&lt;EchoResponse*&gt;(response),</span><br><span class="line">                    done</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:  <span class="comment">// 索引 1 对应 Ping 方法（proto 文件中定义的第二个 rpc）</span></span><br><span class="line">                <span class="built_in">Ping</span>(</span><br><span class="line">                    controller,</span><br><span class="line">                    ::google::protobuf::<span class="built_in">down_cast</span>&lt;<span class="type">const</span> EchoRequest*&gt;(request),</span><br><span class="line">                    ::google::protobuf::<span class="built_in">down_cast</span>&lt;EchoResponse*&gt;(response),</span><br><span class="line">                    done</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">// 非法索引，致命错误</span></span><br><span class="line">                <span class="built_in">GOOGLE_LOG</span>(FATAL) &lt;&lt; <span class="string">&quot;Bad method index: &quot;</span> &lt;&lt; method-&gt;<span class="built_in">index</span>() </span><br><span class="line">                                  &lt;&lt; <span class="string">&quot;. This method doesn&#x27;t belong to this service.&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; 		</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 静态方法：获取服务描述符</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> ::google::<span class="function">protobuf::ServiceDescriptor* <span class="title">descriptor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取服务描述符（实例方法）</span></span><br><span class="line">    <span class="type">const</span> ::google::<span class="function">protobuf::ServiceDescriptor* <span class="title">GetDescriptor</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取请求/响应消息的原型（用于创建消息实例）</span></span><br><span class="line">    <span class="type">const</span> ::google::<span class="function">protobuf::Message&amp; <span class="title">GetRequestPrototype</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">const</span> ::google::<span class="function">protobuf::Message&amp; <span class="title">GetResponsePrototype</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="comment">// Stub 类 - 客户端桩，用于发起 RPC 调用</span></span><br><span class="line"><span class="comment">// =====================================================</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoService_Stub</span> : <span class="keyword">public</span> EchoService &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    </span><br><span class="line">    EchoService_Stub::<span class="built_in">EchoService_Stub</span>(::google::protobuf::RpcChannel* channel)</span><br><span class="line">        : <span class="built_in">channel_</span>(channel), <span class="built_in">owns_channel_</span>(<span class="literal">false</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EchoService_Stub::<span class="built_in">EchoService_Stub</span>(</span><br><span class="line">        ::google::protobuf::RpcChannel* channel,</span><br><span class="line">        ::google::protobuf::Service::ChannelOwnership ownership)</span><br><span class="line">        : <span class="built_in">channel_</span>(channel),</span><br><span class="line">          <span class="built_in">owns_channel_</span>(ownership == ::google::protobuf::Service::STUB_OWNS_CHANNEL) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    EchoService_Stub::~<span class="built_in">EchoService_Stub</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (owns_channel_) &#123;</span><br><span class="line">            <span class="keyword">delete</span> channel_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 Channel</span></span><br><span class="line">    <span class="keyword">inline</span> ::google::<span class="function">protobuf::RpcChannel* <span class="title">channel</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> channel_; &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Echo 方法： rpc Echo(EchoRequest) returns (EchoResponse)</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">EchoService_Stub::Echo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> EchoRequest* request,						<span class="comment">// 请求：EchoRequest</span></span></span></span><br><span class="line"><span class="params"><span class="function">        EchoResponse* response,							<span class="comment">// 响应：EchoResponse</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 获取方法描述符</span></span><br><span class="line">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method =</span><br><span class="line">            EchoService::<span class="built_in">descriptor</span>()-&gt;<span class="built_in">method</span>(<span class="number">0</span>);	<span class="comment">// 获取索引为 0 的方法（即 Echo）</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 直接委托给 channel 的 CallMethod</span></span><br><span class="line">        <span class="comment">//    所有序列化、网络传输、反序列化都由 channel 负责</span></span><br><span class="line">        channel_-&gt;<span class="built_in">CallMethod</span>(</span><br><span class="line">            method,      <span class="comment">// 方法描述符（携带服务名、方法名等元信息）</span></span><br><span class="line">            controller,  <span class="comment">// 控制器（透传）</span></span><br><span class="line">            request,     <span class="comment">// 请求消息（透传）</span></span><br><span class="line">            response,    <span class="comment">// 响应消息（透传）</span></span><br><span class="line">            done         <span class="comment">// 完成回调（透传）</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Ping 方法： rpc Ping(EchoRequest) returns (EchoResponse);</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Ping</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> EchoRequest* request,                        <span class="comment">// 请求：EchoRequest</span></span></span></span><br><span class="line"><span class="params"><span class="function">        EchoResponse* response,                            <span class="comment">// 响应：EchoResponse</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 获取方法描述符（索引 1 = Ping）</span></span><br><span class="line">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method =</span><br><span class="line">            EchoService::<span class="built_in">descriptor</span>()-&gt;<span class="built_in">method</span>(<span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 委托给 channel</span></span><br><span class="line">        channel_-&gt;<span class="built_in">CallMethod</span>(</span><br><span class="line">            method,</span><br><span class="line">            controller,</span><br><span class="line">            request,</span><br><span class="line">            response,</span><br><span class="line">            done</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ::google::protobuf::RpcChannel* channel_;      <span class="comment">// RPC 通道</span></span><br><span class="line">    <span class="type">bool</span> owns_channel_;                             <span class="comment">// 是否拥有所有权</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC 通道抽象基类 ——&gt; 客户端通过它发送请求到服务端（网络传输层抽象）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RpcChannel</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">RpcChannel</span>() = <span class="keyword">default</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 【核心】发起 RPC 调用</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">CallMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 方法描述符（包含服务名、方法名、索引等元信息）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::MethodDescriptor* method,        </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 控制器（用于取消、超时、错误处理）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::RpcController* controller,        </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 请求消息（已序列化或待序列化）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> ::google::protobuf::Message* request,        </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">// 响应消息（调用完成后由框架填充）</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Message* response,            </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="comment">/*完成回调</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">            - 同步调用：传 nullptr，CallMethod 阻塞直到完成	</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">            - 异步调用：传回调对象，CallMethod 立即返回</span></span></span></span><br><span class="line"><span class="comment"><span class="params"><span class="function">        */</span></span></span></span><br><span class="line"><span class="params"><span class="function">        ::google::protobuf::Closure* done                    </span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>= <span class="number">0</span>;                                    </span><br><span class="line">&#125;;     </span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace myservice</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/service.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/descriptor.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;google/protobuf/stubs/callback.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> google &#123;</span><br><span class="line"><span class="keyword">namespace</span> protobuf &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC 控制器抽象基类 ——&gt; 用于控制单次 RPC 调用的行为（取消、超时、错误处理等）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RpcController</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">RpcController</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================== 客户端侧方法 ==============================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重置控制器状态（复用控制器时调用）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Reset</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查调用是否失败</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">Failed</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取错误信息（Failed() 为 true 时有效）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> std::string <span class="title">ErrorText</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发起取消请求（通知服务端停止处理）</span></span><br><span class="line">    <span class="comment">// 注意：服务端可能忽略，调用后 done 回调仍会被执行</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">StartCancel</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="comment">// ============================== 服务端侧方法 ==============================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置失败状态和错误信息</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetFailed</span><span class="params">(<span class="type">const</span> std::string&amp; reason)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查客户端是否已请求取消</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsCanceled</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册取消回调（当客户端取消时被调用）</span></span><br><span class="line">    <span class="comment">// @param callback: 取消时执行的回调，传 nullptr 取消注册</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">NotifyOnCancel</span><span class="params">(Closure* callback)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC 回调函数抽象基类 ——&gt; 用于“异步操作”完成时的通知机制</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Closure</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Closure</span>() = <span class="keyword">default</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 执行回调（调用后对象可能被删除，取决于实现）</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================== Closure 工厂函数 ==============================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一次性 Closure（Run() 后自动 delete this）</span></span><br><span class="line"><span class="comment">// @param function: 无参函数指针</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> Closure* <span class="title">NewCallback</span><span class="params">(<span class="type">void</span> (*function)())</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 内部实现：返回一个调用 function() 后自删除的 Closure</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* 实现细节 */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一次性 Closure（带对象方法）</span></span><br><span class="line"><span class="comment">// @param object: 对象指针</span></span><br><span class="line"><span class="comment">// @param method: 成员函数指针</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Class&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> Closure* <span class="title">NewCallback</span><span class="params">(Class* object, <span class="type">void</span> (Class::*method)())</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 内部实现：返回一个调用 object-&gt;method() 后自删除的 Closure</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* 实现细节 */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一次性 Closure（带参数）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Class, <span class="keyword">typename</span> Arg1&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> Closure* <span class="title">NewCallback</span><span class="params">(Class* object, <span class="type">void</span> (Class::*method)(Arg1), Arg1 arg1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* 实现细节 */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建永久 Closure（Run() 后不自动删除，可重复使用）</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> Closure* <span class="title">NewPermanentCallback</span><span class="params">(<span class="type">void</span> (*function)())</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* 实现细节 */</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Class&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> Closure* <span class="title">NewPermanentCallback</span><span class="params">(Class* object, <span class="type">void</span> (Class::*method)())</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">/* 实现细节 */</span>;</span><br><span class="line">&#125;        </span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace protobuf</span></span><br><span class="line">&#125; <span class="comment">// namespace google</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）Stub类-与-RpcChannel类-解析"><a href="#（4）Stub类-与-RpcChannel类-解析" class="headerlink" title="（4）Stub类 与 RpcChannel类 解析"></a>（4）Stub类 与 RpcChannel类 解析</h3><h4 id="使用伪代码"><a href="#使用伪代码" class="headerlink" title="&lt;1&gt;使用伪代码"></a>&lt;1&gt;使用伪代码</h4><p><a href="#channel">自定义RpcChannel示例</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== 客户端使用 ====================</span></span><br><span class="line">   <span class="comment">// 1. 创建 Channel（注入网络实现）</span></span><br><span class="line">   <span class="function">MyRpcChannel <span class="title">channel</span><span class="params">(<span class="string">&quot;127.0.0.1:8080&quot;</span>)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 2. 创建 Stub（绑定 Channel）</span></span><br><span class="line">   <span class="function">UserService_Stub <span class="title">stub</span><span class="params">(&amp;channel)</span></span>;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 3. 创建 Controller</span></span><br><span class="line">   MyRpcController controller;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 4. 准备请求和响应参数</span></span><br><span class="line">   GetUserRequest request;</span><br><span class="line">   request.<span class="built_in">set_user_id</span>(<span class="number">12345</span>);</span><br><span class="line">   </span><br><span class="line">   GetUserResponse response;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 5. 调用！</span></span><br><span class="line">   stub.<span class="built_in">GetUser</span>(&amp;controller, &amp;request, &amp;response, <span class="literal">nullptr</span>);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 6. 检查结果</span></span><br><span class="line">   <span class="keyword">if</span> (controller.<span class="built_in">Failed</span>()) &#123;</span><br><span class="line">       std::cerr &lt;&lt; <span class="string">&quot;RPC failed: &quot;</span> &lt;&lt; controller.<span class="built_in">ErrorText</span>() &lt;&lt; std::endl;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       std::cout &lt;&lt; <span class="string">&quot;User name: &quot;</span> &lt;&lt; response.<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h4 id="Stub类-与-RpcChannel类-的关系"><a href="#Stub类-与-RpcChannel类-的关系" class="headerlink" title="&lt;2&gt;Stub类 与 RpcChannel类 的关系"></a>&lt;2&gt;Stub类 与 RpcChannel类 的关系</h4><ul>
<li>在上一节”<strong>生成的C++伪代码</strong>“中可以看到，每一个定义在 proto 中的服务（如：service UserService）都会生成对应的 XXX_Stub 类，这正是”<strong>服务在客户端的句柄</strong>“，客户端用它来发起 RPC 调用<ul>
<li>如：<strong>stub.GetUser(&amp;controller, &amp;request, &amp;response, nullptr);</strong></li>
</ul>
</li>
<li>Stub类：<ul>
<li>作为服务在客户端的句柄，内部包含该服务的<strong>所有 RPC 方法调用接口</strong></li>
<li>持有一个 RpcChannel* 数据成员，在构造时注入<ul>
<li>如： <strong>UserService_Stub stub(&amp;channel);</strong></li>
</ul>
</li>
<li>内部的 RPC 方法实现非常简单：<strong>封装并调用 channel_-&gt;CallMethod(…)</strong></li>
</ul>
</li>
<li>RpcChannel类：<ul>
<li>理解它需要“<a href="#reflect">反射机制</a>”的基础</li>
<li><strong>核心作用</strong>：网络连接、序列化、反序列化</li>
<li><strong>工作流程</strong>：<ul>
<li>1.通过 Stub 传入的 MethodDescriptor* 提取”服务名、方法名”</li>
<li>2.将”服务名、方法名、request”序列化后通过网络发送到服务端</li>
<li>3.接收响应并反序列化为 response</li>
</ul>
</li>
<li>这正好对应”RPC 底层原理”中所说：客户端通过 <strong>（服务名, 方法）二元名组</strong> 定位具体方法</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      客户端 RPC 调用完整流程                                  │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                             │</span><br><span class="line">│   用户代码                                                                   │</span><br><span class="line">│   ┌─────────────────────────────────────────┐                               │</span><br><span class="line">│   │ stub.<span class="built_in">GetUser</span>(&amp;ctrl, &amp;req, &amp;resp, done)  │                               │</span><br><span class="line">│   └─────────────────┬───────────────────────┘                               │</span><br><span class="line">│                     │                                                       │</span><br><span class="line">│                     ▼                                                       │</span><br><span class="line">│   Stub 类（Proto 生成）                                                      │</span><br><span class="line">│   ┌─────────────────────────────────────────┐                               │</span><br><span class="line">│   │ <span class="number">1.</span> 获取 MethodDescriptor（方法元信息）   │                               │</span><br><span class="line">│   │ <span class="number">2.</span> 调用 channel_-&gt;<span class="built_in">CallMethod</span>(...)       │                               │</span><br><span class="line">│   └─────────────────┬───────────────────────┘                               │</span><br><span class="line">│                     │                                                       │</span><br><span class="line">│                     ▼                                                       │</span><br><span class="line">│   RpcChannel（用户实现）                                                     │</span><br><span class="line">│   ┌─────────────────────────────────────────┐                               │</span><br><span class="line">│   │ <span class="number">1.</span> 从 MethodDescriptor 提取服务名、方法名│                               │</span><br><span class="line">│   │ <span class="number">2.</span> 序列化 request                       │                               │</span><br><span class="line">│   │ <span class="number">3.</span> 构建协议包 [服务名][方法名][数据]      │                               │</span><br><span class="line">│   │ <span class="number">4.</span> 通过 socket 发送到服务端              │                               │</span><br><span class="line">│   │ <span class="number">5.</span> 接收响应数据                          │                               │</span><br><span class="line">│   │ <span class="number">6.</span> 反序列化到 response                  │                               │</span><br><span class="line">│   └─────────────────────────────────────────┘                               │</span><br><span class="line">│                     │                                                       │</span><br><span class="line">│                     ▼                                                       │</span><br><span class="line">│   ┌─────────────────────────────────────────┐                               │</span><br><span class="line">│   │ 用户拿到 response，继续业务逻辑          │                               │</span><br><span class="line">│   └─────────────────────────────────────────┘                               │</span><br><span class="line">│                                                                             │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          工厂类比                                         │</span><br><span class="line">├──────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                          │</span><br><span class="line">│   你（用户）                                                              │</span><br><span class="line">│     │                                                                    │</span><br><span class="line">│     │ 带着原材料（request）                                               │</span><br><span class="line">│     │ 指定产品交付处（response）                                          │</span><br><span class="line">│     ▼                                                                    │</span><br><span class="line">│   ┌────────────────┐                                                     │</span><br><span class="line">│   │   门  户        │  ◄─── Stub 类                                      │</span><br><span class="line">│   │   (Stub)       │       • 接收原材料                                  │</span><br><span class="line">│   │                │       • 登记加工需求（获取 MethodDescriptor）         │</span><br><span class="line">│   └───────┬────────┘       • 转交给内部员工                              │</span><br><span class="line">│           │                                                              │</span><br><span class="line">│           ▼                                                              │</span><br><span class="line">│   ┌────────────────┐                                                     │</span><br><span class="line">│   │  内部员工       │  ◄─── RpcChannel                                   │</span><br><span class="line">│   │  (RpcChannel)  │       • 打包原材料（序列化）                         │</span><br><span class="line">│   │                │       • 运送到加工车间（网络传输）                    │</span><br><span class="line">│   │                │       • 带回成品（接收响应）                         │</span><br><span class="line">│   │                │       • 拆包（反序列化）                             │</span><br><span class="line">│   └───────┬────────┘                                                     │</span><br><span class="line">│           │                                                              │</span><br><span class="line">│           │  ════════════════════════════════                            │</span><br><span class="line">│           │        网络（运输通道）                                        │</span><br><span class="line">│           │  ════════════════════════════════                            │</span><br><span class="line">│           ▼                                                              │</span><br><span class="line">│   ┌────────────────┐                                                     │</span><br><span class="line">│   │  加工车间       │  ◄─── 服务端                                        │</span><br><span class="line">│   │  (Server)      │       • 根据订单（服务名+方法名）找到机器             │</span><br><span class="line">│   │                │       • 加工原材料                                   │</span><br><span class="line">│   │                │       • 产出成品                                     │</span><br><span class="line">│   └────────────────┘                                                     │</span><br><span class="line">│                                                                          │</span><br><span class="line">└──────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（5）RpcController类-与-Closure类"><a href="#（5）RpcController类-与-Closure类" class="headerlink" title="（5）RpcController类 与 Closure类"></a>（5）RpcController类 与 Closure类</h3><h4 id="RpcController-类"><a href="#RpcController-类" class="headerlink" title="&lt;1&gt; RpcController 类"></a>&lt;1&gt; RpcController 类</h4><p><strong>核心功能</strong>：<br>	- 控制单次 RPC 调用的行为（取消、超时、错误处理等）<br><strong>设计原因</strong>：<br>	- CallMethod 方法的返回值是 void，调用结果（成功&#x2F;失败&#x2F;错误信息）无法通过返回值告知用户<br>	- 因此通过”<strong>出参</strong>“的形式将 RpcController 传入，<strong>内部信息填充后，用户即可获取调用状态</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line">MyRpcController controller;</span><br><span class="line">stub.<span class="built_in">GetUser</span>(&amp;controller, &amp;request, &amp;response, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 controller 获取调用状态</span></span><br><span class="line"><span class="keyword">if</span> (controller.<span class="built_in">Failed</span>()) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Error: &quot;</span> &lt;&lt; controller.<span class="built_in">ErrorText</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Closure-类"><a href="#Closure-类" class="headerlink" title="&lt;2&gt; Closure 类"></a>&lt;2&gt; Closure 类</h4><p><a href="#Closure">Closure 常用构造方法</a><br><strong>核心功能</strong>：决定是”同步操作”还是”异步操作”</p>
<ul>
<li><strong>同步</strong>：即阻塞，用户在通过Stub调用函数时，会一直阻塞，直到函数处理结束后将响应填入“reponse出参”，用户再处理reponse</li>
<li><strong>异步</strong>：即非阻塞，用户事先将reponse的处理逻辑封装到Clouser中（回调函数），并在通过Stub调用函数时一同传入，然后函数就直接返回，用户可以直接去做其它业务，因为响应到来时，直接交给Clouser中封装好的处理逻辑去处理即可<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100053975.png"></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== 统一的 response 处理函数 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HandleResponse</span><span class="params">(GetUserResponse* response)</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;User name: &quot;</span> &lt;&lt; response-&gt;<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;User age: &quot;</span> &lt;&lt; response-&gt;<span class="built_in">age</span>() &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// ... 其他业务逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 同步调用 ==========</span></span><br><span class="line">stub.<span class="built_in">GetUser</span>(&amp;controller, &amp;request, &amp;response, <span class="literal">nullptr</span>);  <span class="comment">// 阻塞等待</span></span><br><span class="line"><span class="built_in">HandleResponse</span>(&amp;response);  <span class="comment">// 响应就绪后，手动调用处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 异步调用 ==========</span></span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewCallback</span>(&amp;HandleResponse, &amp;response);     <span class="comment">// 将处理函数封装为 Closure</span></span><br><span class="line">stub.<span class="built_in">GetUser</span>(&amp;controller, &amp;request, &amp;response, done);     <span class="comment">// 立即返回</span></span><br><span class="line"><span class="comment">// 继续做其他事情...</span></span><br><span class="line"><span class="comment">// 响应到来时，框架自动执行 HandleResponse(&amp;response)</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100154823.png"></p>
<h3 id="（6）服务端的使用"><a href="#（6）服务端的使用" class="headerlink" title="（6）服务端的使用"></a>（6）服务端的使用</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122103313708.png"></p>
<ul>
<li>从“生成的C++伪代码”中我们可以看到，proto中定义的service，会生成一个同名的Service类（如：service EchoService ——&gt;class EchoService）</li>
<li>Service类中的方法（如Echo、Ping）都是纯虚函数，需要服务端自己继承并实现（毕竟要实现的是自己的业务嘛）</li>
<li>服务端会对每一个服务进行注册，如：<strong>std::map(服务名，Service)</strong><ul>
<li>为什么不注册方法？因为Protobuf的“<strong>反射机制</strong>”在获取去Service后，可以通过“方法名”获取“<strong>方法描述符MethodDescriptor</strong>” ——&gt; 结合起来，正好对应（服务名，方法名）二元组定位具体方法</li>
</ul>
</li>
<li><strong>CallMethod方法</strong>：<ul>
<li>会传入“方法描述符MethodDescriptor”，在内部根据“<strong>方法索引</strong>”找到具体方法进行执行</li>
</ul>
</li>
</ul>
<p><strong>用户实现服务</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== 用户继承并实现业务逻辑 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoServiceImpl</span> : <span class="keyword">public</span> EchoService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Status <span class="title">Echo</span><span class="params">(ServerContext* ctx, <span class="type">const</span> EchoRequest* req, EchoResponse* resp)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        resp-&gt;<span class="built_in">set_message</span>(<span class="string">&quot;Echo: &quot;</span> + req-&gt;<span class="built_in">message</span>());  <span class="comment">// 业务逻辑</span></span><br><span class="line">        <span class="keyword">return</span> Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">Status <span class="title">Ping</span><span class="params">(ServerContext* ctx, <span class="type">const</span> PingRequest* req, PingResponse* resp)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        resp-&gt;<span class="built_in">set_pong</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>服务注册（服务端框架）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== gRPC 服务端内部注册表 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceRegistry</span> &#123;</span><br><span class="line">    <span class="comment">// 只注册服务，不注册方法！</span></span><br><span class="line">    std::map&lt;std::string, google::protobuf::Service*&gt; services_;</span><br><span class="line">    <span class="comment">//        服务名（如 &quot;EchoService&quot;）    服务实例</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">RegisterService</span><span class="params">(google::protobuf::Service* service)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过反射获取服务名</span></span><br><span class="line">        <span class="type">const</span> std::string&amp; name = service-&gt;<span class="built_in">GetDescriptor</span>()-&gt;<span class="built_in">name</span>();</span><br><span class="line">        services_[name] = service;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    google::<span class="function">protobuf::Service* <span class="title">FindService</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> services_[name];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>请求分发流程</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== 收到 RPC 请求时的处理 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HandleRpcRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; service_name,   <span class="comment">// 如 &quot;EchoService&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; method_name,    <span class="comment">// 如 &quot;Echo&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; request_data    <span class="comment">// 序列化的请求</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Step 1: 根据服务名找到服务实例</span></span><br><span class="line">    <span class="keyword">auto</span>* service = registry_.<span class="built_in">FindService</span>(service_name);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 2: 通过反射，根据方法名获取方法描述符</span></span><br><span class="line">    <span class="type">const</span> ServiceDescriptor* service_desc = service-&gt;<span class="built_in">GetDescriptor</span>();</span><br><span class="line">    <span class="type">const</span> MethodDescriptor* method_desc = service_desc-&gt;<span class="built_in">FindMethodByName</span>(method_name);</span><br><span class="line">    <span class="comment">//                                    ↑ 【反射机制】方法名 → 方法描述符</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3: 通过反射创建请求/响应对象</span></span><br><span class="line">    Message* request = service-&gt;<span class="built_in">GetRequestPrototype</span>(method_desc).<span class="built_in">New</span>();</span><br><span class="line">    Message* response = service-&gt;<span class="built_in">GetResponsePrototype</span>(method_desc).<span class="built_in">New</span>();</span><br><span class="line">    request-&gt;<span class="built_in">ParseFromString</span>(request_data);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 4: 调用 CallMethod，内部根据方法索引分发到具体实现</span></span><br><span class="line">    service-&gt;<span class="built_in">CallMethod</span>(method_desc, controller, request, response, done);</span><br><span class="line">    <span class="comment">//                  ↑ 传入方法描述符，CallMethod 内部用 method-&gt;index() 分发</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>流程图</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">客户端请求: &#123; service: <span class="string">&quot;EchoService&quot;</span>, method: <span class="string">&quot;Echo&quot;</span>, data: ... &#125;</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Step <span class="number">1</span>: 服务名 → 服务实例                                    │</span><br><span class="line">│          registry_[<span class="string">&quot;EchoService&quot;</span>] → EchoServiceImpl*         │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Step <span class="number">2</span>: 方法名 → 方法描述符（反射）                           │</span><br><span class="line">│          service_desc-&gt;<span class="built_in">FindMethodByName</span>(<span class="string">&quot;Echo&quot;</span>)              │</span><br><span class="line">│          → MethodDescriptor &#123; index=<span class="number">0</span>, name=<span class="string">&quot;Echo&quot;</span>, ... &#125;    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│  Step <span class="number">3</span>: CallMethod 根据 method-&gt;<span class="built_in">index</span>() 分发                │</span><br><span class="line">│          <span class="keyword">switch</span>(<span class="number">0</span>) → <span class="built_in">Echo</span>(ctx, req, resp)                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                            │</span><br><span class="line">                            ▼</span><br><span class="line">                    EchoServiceImpl::<span class="built_in">Echo</span>() 执行</span><br></pre></td></tr></table></figure>


<p><a id="channel"></a></p>
<h3 id="附录1：自定义RpcChannel示例"><a href="#附录1：自定义RpcChannel示例" class="headerlink" title="附录1：自定义RpcChannel示例"></a>附录1：自定义RpcChannel示例</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义 RpcChannel</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyRpcChannel</span> : <span class="keyword">public</span> ::google::protobuf::RpcChannel &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">   <span class="built_in">MyRpcChannel</span>(<span class="type">const</span> std::string&amp; addr) : <span class="built_in">server_addr_</span>(addr) &#123;</span><br><span class="line">       socket_fd_ = <span class="built_in">connectToServer</span>(addr);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   ~<span class="built_in">MyRpcChannel</span>() &#123;</span><br><span class="line">       <span class="built_in">close</span>(socket_fd_);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">CallMethod</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">       <span class="type">const</span> ::google::protobuf::MethodDescriptor* method,</span></span></span><br><span class="line"><span class="params"><span class="function">       ::google::protobuf::RpcController* controller,</span></span></span><br><span class="line"><span class="params"><span class="function">       <span class="type">const</span> ::google::protobuf::Message* request,</span></span></span><br><span class="line"><span class="params"><span class="function">       ::google::protobuf::Message* response,</span></span></span><br><span class="line"><span class="params"><span class="function">       ::google::protobuf::Closure* done)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="comment">// ========== 1. 序列化请求 ==========</span></span><br><span class="line">       std::string request_data = request-&gt;<span class="built_in">SerializeAsString</span>();</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// ========== 2. 构建协议包 ==========</span></span><br><span class="line">       <span class="comment">// 协议：[服务名长度][服务名][方法名长度][方法名][数据长度][数据]</span></span><br><span class="line">       std::string service_name = method-&gt;<span class="built_in">service</span>()-&gt;<span class="built_in">full_name</span>();  <span class="comment">// &quot;package.UserService&quot;</span></span><br><span class="line">       std::string method_name = method-&gt;<span class="built_in">name</span>();                    <span class="comment">// &quot;GetUser&quot;</span></span><br><span class="line">       </span><br><span class="line">       <span class="type">uint32_t</span> service_len = service_name.<span class="built_in">size</span>();</span><br><span class="line">       <span class="type">uint32_t</span> method_len = method_name.<span class="built_in">size</span>();</span><br><span class="line">       <span class="type">uint32_t</span> data_len = request_data.<span class="built_in">size</span>();</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// ========== 3. 发送请求 ==========</span></span><br><span class="line">       <span class="comment">// 服务名</span></span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, &amp;service_len, <span class="built_in">sizeof</span>(service_len), <span class="number">0</span>);</span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, service_name.<span class="built_in">data</span>(), service_len, <span class="number">0</span>);</span><br><span class="line">       <span class="comment">// 方法名</span></span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, &amp;method_len, <span class="built_in">sizeof</span>(method_len), <span class="number">0</span>);</span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, method_name.<span class="built_in">data</span>(), method_len, <span class="number">0</span>);</span><br><span class="line">       <span class="comment">// 数据</span></span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, &amp;data_len, <span class="built_in">sizeof</span>(data_len), <span class="number">0</span>);</span><br><span class="line">       <span class="built_in">send</span>(socket_fd_, request_data.<span class="built_in">data</span>(), data_len, <span class="number">0</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// ========== 4. 接收响应 ==========</span></span><br><span class="line">       <span class="type">uint32_t</span> resp_len;</span><br><span class="line">       <span class="built_in">recv</span>(socket_fd_, &amp;resp_len, <span class="built_in">sizeof</span>(resp_len), <span class="number">0</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="function">std::vector&lt;<span class="type">char</span>&gt; <span class="title">resp_data</span><span class="params">(resp_len)</span></span>;</span><br><span class="line">       <span class="built_in">recv</span>(socket_fd_, resp_data.<span class="built_in">data</span>(), resp_len, <span class="number">0</span>);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// ========== 5. 反序列化响应 ==========</span></span><br><span class="line">       <span class="keyword">if</span> (!response-&gt;<span class="built_in">ParseFromArray</span>(resp_data.<span class="built_in">data</span>(), resp_len)) &#123;</span><br><span class="line">           controller-&gt;<span class="built_in">SetFailed</span>(<span class="string">&quot;Failed to parse response&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// ========== 6. 回调 ==========</span></span><br><span class="line">       <span class="keyword">if</span> (done != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">           done-&gt;<span class="built_in">Run</span>();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// ==================== 辅助函数：建立连接 ====================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">connectToServer</span><span class="params">(<span class="type">const</span> std::string&amp; addr)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 解析地址 &quot;127.0.0.1:8080&quot;</span></span><br><span class="line">       <span class="type">size_t</span> pos = addr.<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">       std::string ip = addr.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">       <span class="type">int</span> port = std::<span class="built_in">stoi</span>(addr.<span class="built_in">substr</span>(pos + <span class="number">1</span>));</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 创建 socket</span></span><br><span class="line">       <span class="type">int</span> fd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">       <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to create socket&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 设置服务器地址</span></span><br><span class="line">       <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server_addr;</span><br><span class="line">       <span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="built_in">sizeof</span>(server_addr));</span><br><span class="line">       server_addr.sin_family = AF_INET;</span><br><span class="line">       server_addr.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">       <span class="built_in">inet_pton</span>(AF_INET, ip.<span class="built_in">c_str</span>(), &amp;server_addr.sin_addr);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// 连接</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">connect</span>(fd, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr, <span class="built_in">sizeof</span>(server_addr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="built_in">close</span>(fd);</span><br><span class="line">           <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">&quot;Failed to connect to server&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> fd;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">   std::string server_addr_;</span><br><span class="line">   <span class="type">int</span> socket_fd_;</span><br></pre></td></tr></table></figure>

<p><strong>协议格式图示</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                          自定义 RPC 协议包格式                          │</span><br><span class="line">├────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                        │</span><br><span class="line">│   字节偏移:  <span class="number">0</span>        <span class="number">4</span>        <span class="number">4</span>+S      <span class="number">8</span>+S      <span class="number">8</span>+S+M    <span class="number">12</span>+S+M       │</span><br><span class="line">│            ┌────────┬────────┬────────┬────────┬────────┬────────────┐ │</span><br><span class="line">│            │服务名   │ 服务名  │方法名   │ 方法名  │数据     │   数据     │ │</span><br><span class="line">│            │长度(<span class="number">4</span>B)│ (S字节) │长度(<span class="number">4</span>B)│ (M字节) │长度(<span class="number">4</span>B)│  (D字节)   │ │</span><br><span class="line">│            └────────┴────────┴────────┴────────┴────────┴────────────┘ │</span><br><span class="line">│                                                                        │</span><br><span class="line">│   示例：                                                                │</span><br><span class="line">│   ┌────┬─────────────────────┬────┬─────────┬────┬──────────────────┐  │</span><br><span class="line">│   │ <span class="number">19</span> │ <span class="string">&quot;package.UserService&quot;</span>│  <span class="number">7</span> │<span class="string">&quot;GetUser&quot;</span>│ <span class="number">12</span> │ &lt;protobuf数据&gt;   │  │</span><br><span class="line">│   └────┴─────────────────────┴────┴─────────┴────┴──────────────────┘  │</span><br><span class="line">│                                                                        │</span><br><span class="line">└────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><a id="Closure"></a></p>
<h3 id="附录2：Closure-常用构造方法"><a href="#附录2：Closure-常用构造方法" class="headerlink" title="附录2：Closure 常用构造方法"></a>附录2：Closure 常用构造方法</h3><p>Google Protobuf 提供了 NewCallback 系列<strong>工厂函数</strong>来创建 Closure：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ========== 1. 普通函数 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HandleResponse</span><span class="params">(GetUserResponse* response)</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewCallback</span>(&amp;HandleResponse, &amp;response);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 2. 成员函数（需要对象指针）==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">OnDone</span><span class="params">(GetUserResponse* response)</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MyHandler handler;</span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewCallback</span>(&amp;handler, &amp;MyHandler::OnDone, &amp;response);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 3. 无参回调 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnComplete</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewCallback</span>(&amp;OnComplete);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 4. 多参数回调 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ProcessResult</span><span class="params">(<span class="type">int</span> code, GetUserResponse* response)</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewCallback</span>(&amp;ProcessResult, <span class="number">200</span>, &amp;response);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 5. 永久回调（可重复执行，不会自动删除）==========</span></span><br><span class="line"><span class="keyword">auto</span>* done = <span class="built_in">NewPermanentCallback</span>(&amp;HandleResponse, &amp;response);</span><br><span class="line"><span class="comment">// 注意：需要手动 delete</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122100447091.png"></p>
<h2 id="3-Service在RPC中的作用"><a href="#3-Service在RPC中的作用" class="headerlink" title="3.Service在RPC中的作用"></a>3.Service在RPC中的作用</h2><p><a href="#RPC%EF%BC%882%EF%BC%89">RPC底层原理</a><br>通过proto的service生成的C++伪代码，已经满足了RPC的如下条件</p>
<ul>
<li>1.双方定义一模一样的API<ul>
<li>通过上述C++伪代码可以看到，服务端（EchoService）与客户端（EchoService_Stub）拥有相同的“核心API”<ul>
<li>如：Echo、Ping、CallMethod（其中客户端通过RpcChannel间接拥有CallMethod）</li>
</ul>
</li>
</ul>
</li>
<li>2.“序列化”、“反序列化”能力<ul>
<li>proto中的message自带“序列化”、“反序列化”能力</li>
</ul>
</li>
<li><strong>欠缺</strong>：<ul>
<li><strong>服务端注册方法</strong>：<ul>
<li>这需要服务端借助 “<strong>反射机制</strong>” 获取 “服务名、方法名”</li>
</ul>
</li>
<li><strong>网络通信</strong>：<ul>
<li>这需要自己实现（或使用已有框架）</li>
</ul>
</li>
<li><strong>路由</strong>：<ul>
<li>这也需要服务端借助 “<strong>反射机制</strong>” 获取 “服务名、方法名”</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>PRC在proto中的调用链路</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                            完整 RPC 调用链路                                     │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                                 │</span><br><span class="line">│  客户端                                              服务端                      │</span><br><span class="line">│  ──────                                              ──────                      │</span><br><span class="line">│                                                                                 │</span><br><span class="line">│  ① 业务代码调用                                                                  │</span><br><span class="line">│     stub-&gt;<span class="built_in">Echo</span>(controller, &amp;req, &amp;resp, done)                                   │</span><br><span class="line">│         │                                                                       │</span><br><span class="line">│         ▼                                                                       │</span><br><span class="line">│  ② Stub::<span class="built_in">Echo</span>() 转发给 Channel                                                  │</span><br><span class="line">│     channel_-&gt;<span class="built_in">CallMethod</span>(<span class="built_in">descriptor</span>()-&gt;<span class="built_in">method</span>(<span class="number">0</span>), ...)                          │</span><br><span class="line">│         │                                                                       │</span><br><span class="line">│         ▼                                                                       │</span><br><span class="line">│  ③ RpcChannel::<span class="built_in">CallMethod</span>() 序列化 + 发送                                       │</span><br><span class="line">│     • 序列化 request → bytes                                                    │</span><br><span class="line">│     • 构造包头：service=<span class="string">&quot;EchoService&quot;</span>, method=<span class="string">&quot;Echo&quot;</span>, index=<span class="number">0</span>                   │</span><br><span class="line">│     • 发送到网络                                                                │</span><br><span class="line">│         │                                                                       │</span><br><span class="line">│         │ ═══════════════════ 网络传输 ═══════════════════                      │</span><br><span class="line">│         ▼                                                                       │</span><br><span class="line">│  ④ 服务端框架接收                                              ┌──────────────┐ │</span><br><span class="line">│     • 解析包头，找到 ServiceDescriptor                          │  RPC Server  │ │</span><br><span class="line">│     • 根据 method_index 获取 MethodDescriptor                  │              │ │</span><br><span class="line">│     • 创建 request/response 实例（通过反射）                     │  接收数据    │ │</span><br><span class="line">│     • 反序列化 request                                          │  解析路由    │ │</span><br><span class="line">│         │                                                      └──────┬───────┘ │</span><br><span class="line">│         ▼                                                             │         │</span><br><span class="line">│  ⑤ 调用 Service::<span class="built_in">CallMethod</span>()                                         │         │</span><br><span class="line">│     service-&gt;<span class="built_in">CallMethod</span>(method, controller, request, response, done)  │         │</span><br><span class="line">│         │                                                             │         │</span><br><span class="line">│         ▼                                                             │         │</span><br><span class="line">│  ⑥ CallMethod 路由到具体方法                                                     │</span><br><span class="line">│     <span class="keyword">switch</span> (method-&gt;<span class="built_in">index</span>())                                                    │</span><br><span class="line">│         <span class="keyword">case</span> <span class="number">0</span>: <span class="built_in">Echo</span>(...)  ←── 你实现的业务逻辑                                  │</span><br><span class="line">│         │                                                                       │</span><br><span class="line">│         ▼                                                                       │</span><br><span class="line">│  ⑦ 业务处理完成，response 已填充                                                 │</span><br><span class="line">│     done-&gt;<span class="built_in">Run</span>()  <span class="comment">// 触发响应发送                                                │</span></span><br><span class="line">│         │                                                                       │</span><br><span class="line">│         │ ═══════════════════ 网络传输 ═══════════════════                      │</span><br><span class="line">│         ▼                                                                       │</span><br><span class="line">│  ⑧ 客户端接收响应                                                                │</span><br><span class="line">│     • 反序列化 response                                                         │</span><br><span class="line">│     • 调用 done-&gt;<span class="built_in">Run</span>()（异步）或直接返回（同步）                                  │</span><br><span class="line">│                                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><a id="reflect"></a></p>
<h2 id="4-Protobuf的反射机制"><a href="#4-Protobuf的反射机制" class="headerlink" title="4.Protobuf的反射机制"></a>4.Protobuf的反射机制</h2><p><a href="#RPC%EF%BC%882%EF%BC%89">RPC底层原理</a></p>
<ul>
<li>什么是“反射机制”？说实话，我自己现在也不是很明白，但我们只需要知道以下几点即可<ul>
<li>通过反射机制，我们可以获取 <strong>ServiceDescriptor、MethodDescriptor</strong>，进而可以获取“服务名”、“方法名”、“请求消息类型描述符”、“响应消息类型描述符”等</li>
<li>获得“服务名”、“方法名”等，客户端就可以封装到“请求中”，二服务端就可以实现“服务的注册”、“路由”等功能。</li>
</ul>
</li>
</ul>
<h3 id="（1）Protobuf的反射层次结构"><a href="#（1）Protobuf的反射层次结构" class="headerlink" title="（1）Protobuf的反射层次结构"></a>（1）Protobuf的反射层次结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Protobuf 反射层次结构                                      │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                                 │</span><br><span class="line">│  DescriptorPool（描述符池）                                                       │</span><br><span class="line">│       │   • 全局唯一的描述符管理器                                                 │</span><br><span class="line">│       │   • 存储所有已加载的 .proto 文件描述信息                                    │</span><br><span class="line">│       │   • 提供按名称查找描述符的能力                                             │</span><br><span class="line">│       │   • <span class="built_in">generated_pool</span>() 获取编译期生成的描述符池                              │</span><br><span class="line">│       │                                                                         │</span><br><span class="line">│       ▼                                                                         │</span><br><span class="line">│  FileDescriptor（文件描述符）                                                     │</span><br><span class="line">│       │   • 对应一个 .proto 文件                                                  │</span><br><span class="line">│       │   • 包含文件名、包名、依赖关系等元信息                                       │</span><br><span class="line">│       │   • <span class="built_in">name</span>()        → <span class="string">&quot;echo.proto&quot;</span>                                        │</span><br><span class="line">│       │   • <span class="built_in">package</span>()     → <span class="string">&quot;myservice&quot;</span>                                         │</span><br><span class="line">│       │   • <span class="built_in">dependency</span>()  → 导入的其他 .proto 文件                                │</span><br><span class="line">│       │                                                                         │</span><br><span class="line">│       │                                                                         │</span><br><span class="line">│       ├──▶ MessageDescriptor[]（消息描述符数组）                                  │</span><br><span class="line">│       │         │   • 对应一个 message 定义                                       │</span><br><span class="line">│       │         │   • <span class="built_in">name</span>()         → <span class="string">&quot;EchoRequest&quot;</span>                            │</span><br><span class="line">│       │         │   • <span class="built_in">full_name</span>()    → <span class="string">&quot;myservice.EchoRequest&quot;</span>                  │</span><br><span class="line">│       │         │   • <span class="built_in">field_count</span>()  → 字段数量                                  │</span><br><span class="line">│       │         │   • <span class="built_in">nested_type</span>()  → 嵌套的 message                            │</span><br><span class="line">│       │         │                                                               │</span><br><span class="line">│       │         ├──▶ FieldDescriptor[]（字段描述符数组）                          │</span><br><span class="line">│       │         │         • 对应 message 中的每个字段                             │</span><br><span class="line">│       │         │         • <span class="built_in">name</span>()         → <span class="string">&quot;message&quot;</span>                          │</span><br><span class="line">│       │         │         • <span class="built_in">number</span>()       → <span class="number">1</span>（字段编号）                        │</span><br><span class="line">│       │         │         • <span class="built_in">type</span>()         → TYPE_STRING / TYPE_INT32 / ...     │</span><br><span class="line">│       │         │         • <span class="built_in">is_repeated</span>()  → 是否为 repeated                     │</span><br><span class="line">│       │         │         • <span class="built_in">is_optional</span>()  → 是否为 optional                     │</span><br><span class="line">│       │         │         • <span class="built_in">default_value_string</span>() → 默认值                      │</span><br><span class="line">│       │         │         • <span class="built_in">message_type</span>() → 如果是嵌套消息，返回其描述符          │</span><br><span class="line">│       │         │                                                               │</span><br><span class="line">│       │         └──▶ EnumDescriptor[]（枚举描述符数组）                           │</span><br><span class="line">│       │                   • 对应 <span class="keyword">enum</span> 定义                                       │</span><br><span class="line">│       │                   • <span class="built_in">name</span>()         → <span class="string">&quot;Status&quot;</span>                           │</span><br><span class="line">│       │                   • <span class="built_in">value_count</span>()  → 枚举值数量                          │</span><br><span class="line">│       │                   └──▶ EnumValueDescriptor[]                            │</span><br><span class="line">│       │                             • <span class="built_in">name</span>()   → <span class="string">&quot;OK&quot;</span>                           │</span><br><span class="line">│       │                             • <span class="built_in">number</span>() → <span class="number">0</span>                              │</span><br><span class="line">│       │                                                                         │</span><br><span class="line">│       │                                                                         │</span><br><span class="line">│       └──▶ ServiceDescriptor[]（服务描述符数组）                                  │</span><br><span class="line">│                 │   • 对应一个 service 定义                                       │</span><br><span class="line">│                 │   • <span class="built_in">name</span>()         → <span class="string">&quot;EchoService&quot;</span>                            │</span><br><span class="line">│                 │   • <span class="built_in">full_name</span>()    → <span class="string">&quot;myservice.EchoService&quot;</span>                  │</span><br><span class="line">│                 │   • <span class="built_in">method_count</span>() → RPC 方法数量                              │</span><br><span class="line">│                 │                                                               │</span><br><span class="line">│                 └──▶ MethodDescriptor[]（方法描述符数组）                         │</span><br><span class="line">│                           • 对应 service 中的每个 rpc 方法                        │</span><br><span class="line">│                           • <span class="built_in">name</span>()          → <span class="string">&quot;Echo&quot;</span>                            │</span><br><span class="line">│                           • <span class="built_in">full_name</span>()     → <span class="string">&quot;myservice.EchoService.Echo&quot;</span>      │</span><br><span class="line">│                           • <span class="built_in">index</span>()         → 方法在 service 中的索引             │</span><br><span class="line">│                           • <span class="built_in">input_type</span>()    → 请求消息的 MessageDescriptor       │</span><br><span class="line">│                           • <span class="built_in">output_type</span>()   → 响应消息的 MessageDescriptor       │</span><br><span class="line">│                           • <span class="built_in">client_streaming</span>() → 客户端是否流式                   │</span><br><span class="line">│                           • <span class="built_in">server_streaming</span>() → 服务端是否流式                   │</span><br><span class="line">│                                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（2）ServiceDescriptor（服务描述符）"><a href="#（2）ServiceDescriptor（服务描述符）" class="headerlink" title="（2）ServiceDescriptor（服务描述符）"></a>（2）ServiceDescriptor（服务描述符）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceDescriptor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;            		<span class="comment">// 服务名称（如 &quot;EchoService&quot;）</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">full_name</span><span class="params">()</span> <span class="type">const</span></span>;        		<span class="comment">// 完整名称（如 &quot;myservice.EchoService&quot;）</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">index</span><span class="params">()</span> <span class="type">const</span></span>;                            		<span class="comment">// 在文件中的索引</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">file</span><span class="params">()</span> <span class="type">const</span></span>;            		<span class="comment">// 所属文件</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">method_count</span><span class="params">()</span> <span class="type">const</span></span>;                    		<span class="comment">// 方法数量</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 按索引获取方法描述符：O(log n)</span></span><br><span class="line">    <span class="function"><span class="type">const</span> MethodDescriptor* <span class="title">method</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span> </span>&#123;    </span><br><span class="line">        <span class="comment">// 边界检查</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(methods_.<span class="built_in">size</span>())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> methods_[index];</span><br><span class="line">    &#125;        </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 按名称查找方法描述符O()</span></span><br><span class="line">    <span class="function"><span class="type">const</span> MethodDescriptor* <span class="title">FindMethodByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> it = methods_by_name_.<span class="built_in">find</span>(name);</span><br><span class="line">        <span class="keyword">if</span> (it == methods_by_name_.<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> ServiceOptions&amp; <span class="title">options</span><span class="params">()</span> <span class="type">const</span></span>;                <span class="comment">// 选项</span></span><br><span class="line">    </span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 调试</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string name_;                                    <span class="comment">// 服务名</span></span><br><span class="line">    std::vector&lt;<span class="type">const</span> MethodDescriptor*&gt; methods_;        <span class="comment">// 方法列表（按定义顺序）</span></span><br><span class="line">    std::map&lt;std::string, <span class="type">const</span> MethodDescriptor*&gt; methods_by_name_;  <span class="comment">// 名称索引</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（3）MethodDescriptor-（方法描述符）"><a href="#（3）MethodDescriptor-（方法描述符）" class="headerlink" title="（3）MethodDescriptor （方法描述符）"></a>（3）MethodDescriptor （方法描述符）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MethodDescriptor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;            <span class="comment">// 方法名称（如 &quot;Echo&quot;）</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">full_name</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 完整名称（如 &quot;myservice.EchoService.Echo&quot;）</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">index</span><span class="params">()</span> <span class="type">const</span></span>;                            <span class="comment">// 方法在服务中的索引</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> ServiceDescriptor* <span class="title">service</span><span class="params">()</span> <span class="type">const</span></span>;   <span class="comment">// 所属服务描述符</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">file</span><span class="params">()</span> <span class="type">const</span></span>;            <span class="comment">// 所属文件描述符</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">input_type</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 请求消息类型描述符</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">output_type</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 响应消息类型描述符</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流式标记（Proto3 支持）</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">client_streaming</span><span class="params">()</span> <span class="type">const</span></span>;                <span class="comment">// 客户端是否为流式</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">server_streaming</span><span class="params">()</span> <span class="type">const</span></span>;                <span class="comment">// 服务端是否为流式</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选项</span></span><br><span class="line">    <span class="function"><span class="type">const</span> MethodOptions&amp; <span class="title">options</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调试</span></span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h3 id="（4）DescriptorPool（描述符池）"><a href="#（4）DescriptorPool（描述符池）" class="headerlink" title="（4）DescriptorPool（描述符池）"></a>（4）DescriptorPool（描述符池）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DescriptorPool</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 单例访问</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取编译期生成的全局描述符池（包含所有 .pb.cc 注册的类型）</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">const</span> DescriptorPool* <span class="title">generated_pool</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 构造/析构</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建空的描述符池</span></span><br><span class="line">    <span class="built_in">DescriptorPool</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建带回退池的描述符池（找不到时从 fallback_pool 查找）</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">DescriptorPool</span><span class="params">(<span class="type">const</span> DescriptorPool* fallback_pool)</span></span>;</span><br><span class="line">    </span><br><span class="line">    ~<span class="built_in">DescriptorPool</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找方法（如 &quot;myservice.EchoService.Echo&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> MethodDescriptor* <span class="title">FindMethodByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找服务（如 &quot;myservice.EchoService&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> ServiceDescriptor* <span class="title">FindServiceByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找文件描述符（如 &quot;echo.proto&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">FindFileByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找消息类型（如 &quot;myservice.EchoRequest&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">FindMessageTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找字段（全局扩展字段）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindFieldByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找扩展字段（按编号）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindExtensionByNumber</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> Descriptor* extendee, </span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> number</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找枚举类型（如 &quot;myservice.Status&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">FindEnumTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 查找枚举值（如 &quot;myservice.Status.OK&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumValueDescriptor* <span class="title">FindEnumValueByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 动态构建（运行时加载 .proto）</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从 FileDescriptorProto 构建（proto 的自描述格式）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">BuildFile</span><span class="params">(<span class="type">const</span> FileDescriptorProto&amp; proto)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带错误收集器的构建</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">BuildFileCollectingErrors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> FileDescriptorProto&amp; proto,</span></span></span><br><span class="line"><span class="params"><span class="function">        ErrorCollector* error_collector</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 禁止拷贝</span></span><br><span class="line">    <span class="built_in">DescriptorPool</span>(<span class="type">const</span> DescriptorPool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    DescriptorPool&amp; <span class="keyword">operator</span>=(<span class="type">const</span> DescriptorPool&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（5）FileDescriptor（文件描述符）"><a href="#（5）FileDescriptor（文件描述符）" class="headerlink" title="（5）FileDescriptor（文件描述符）"></a>（5）FileDescriptor（文件描述符）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileDescriptor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 文件名（如 &quot;echo.proto&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">package</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 包名（如 &quot;myservice&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> DescriptorPool* <span class="title">pool</span><span class="params">()</span> <span class="type">const</span></span>;     <span class="comment">// 所属的描述符池</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Syntax</span> &#123;                            <span class="comment">// 语法版本</span></span><br><span class="line">        SYNTAX_UNKNOWN = <span class="number">0</span>,</span><br><span class="line">        SYNTAX_PROTO2 = <span class="number">2</span>,</span><br><span class="line">        SYNTAX_PROTO3 = <span class="number">3</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function">Syntax <span class="title">syntax</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 获取语法版本</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">dependency_count</span><span class="params">()</span> <span class="type">const</span></span>;            <span class="comment">// 直接依赖的文件数量</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========================================= 文件描述符相关 =========================================</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">dependency</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;            <span class="comment">// 获取第 i 个依赖文件</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">public_dependency_count</span><span class="params">()</span> <span class="type">const</span></span>;                        <span class="comment">// public import 的数量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">public_dependency</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;   <span class="comment">// 获取第 i 个 public 依赖</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">weak_dependency_count</span><span class="params">()</span> <span class="type">const</span></span>;                            <span class="comment">// weak import 的数量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">weak_dependency</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;        <span class="comment">// 获取第 i 个 weak 依赖</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========================================= message相关 =========================================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">message_type_count</span><span class="params">()</span> <span class="type">const</span></span>;                                <span class="comment">// 顶层 message 数量</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">message_type</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;            <span class="comment">// 获取第 i 个 message 描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">FindMessageTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找 message（只在当前文件查找）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========================================= enum相关 =========================================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">enum_type_count</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 顶层 enum 数量</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">enum_type</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;        <span class="comment">// 获取第 i 个 enum 描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">FindEnumTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找 enum</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumValueDescriptor* <span class="title">FindEnumValueByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找 enum 值</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========================================= service相关 =========================================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">service_count</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// service 数量</span></span><br><span class="line">    <span class="function"><span class="type">const</span> ServiceDescriptor* <span class="title">service</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;    <span class="comment">// 获取第 i 个 service 描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> ServiceDescriptor* <span class="title">FindServiceByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找 service</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========================================= 扩展相关 =========================================    </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">extension_count</span><span class="params">()</span> <span class="type">const</span></span>;    <span class="comment">// 顶层扩展字段数量</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">extension</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;    <span class="comment">// 获取第 i 个扩展字段</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindExtensionByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找扩展</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindExtensionByLowercaseName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按被扩展类型和编号查找</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选项</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileOptions&amp; <span class="title">options</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========================================= 调试 =========================================</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 输出 .proto 格式的字符串表示</span></span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 输出带源码位置信息的字符串</span></span><br><span class="line">    <span class="function">std::string <span class="title">DebugStringWithOptions</span><span class="params">(<span class="type">const</span> DebugStringOptions&amp; options)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（6）MessageDescriptor（消息描述符）"><a href="#（6）MessageDescriptor（消息描述符）" class="headerlink" title="（6）MessageDescriptor（消息描述符）"></a>（6）MessageDescriptor（消息描述符）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Descriptor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:    </span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;                	<span class="comment">// 消息名称（如 &quot;EchoRequest&quot;）</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">full_name</span><span class="params">()</span> <span class="type">const</span></span>;            	<span class="comment">// 完整名称（如 &quot;myservice.EchoRequest&quot;）    </span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">index</span><span class="params">()</span> <span class="type">const</span></span>;                                	<span class="comment">// 在父容器中的索引</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">file</span><span class="params">()</span> <span class="type">const</span></span>;               	 	<span class="comment">// 所属文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">containing_type</span><span class="params">()</span> <span class="type">const</span></span>;        	<span class="comment">// 父消息（如果是嵌套定义） </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===================================== 字段 =====================================</span></span><br><span class="line">    <span class="comment">// 字段数量（不含扩展）</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">field_count</span><span class="params">()</span> <span class="type">const</span></span>;                            </span><br><span class="line">    <span class="comment">// 获取第 i 个字段</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">field</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按名称查找字段</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindFieldByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按字段编号查找</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindFieldByNumber</span><span class="params">(<span class="type">int</span> number)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按小写名称查找（用于 JSON 映射）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindFieldByLowercaseName</span><span class="params">(<span class="type">const</span> std::string&amp; lowercase_name)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按驼峰名称查找</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindFieldByCamelcaseName</span><span class="params">(<span class="type">const</span> std::string&amp; camelcase_name)</span> <span class="type">const</span></span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// ===================================== oneof（联合字段） =====================================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">oneof_decl_count</span><span class="params">()</span> <span class="type">const</span></span>;    <span class="comment">// oneof 数量</span></span><br><span class="line">    <span class="function"><span class="type">const</span> OneofDescriptor* <span class="title">oneof_decl</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;    <span class="comment">// 获取第 i 个 oneof</span></span><br><span class="line">    <span class="function"><span class="type">const</span> OneofDescriptor* <span class="title">FindOneofByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;    <span class="comment">// 按名称查找 oneof</span></span><br><span class="line">    <span class="comment">// 真实 oneof 数量（不含 synthetic oneof，即 optional 的内部实现）</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">real_oneof_decl_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===================================== 嵌套类型 =====================================</span></span><br><span class="line">    <span class="comment">// 嵌套 message 数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">nested_type_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 获取第 i 个嵌套 message</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">nested_type</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按名称查找嵌套 message</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">FindNestedTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================================== 嵌套枚举 =====================================</span></span><br><span class="line">    <span class="comment">// 嵌套 enum 数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">enum_type_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 获取第 i 个嵌套 enum</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">enum_type</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按名称查找嵌套 enum</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">FindEnumTypeByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 按值名称查找 enum value</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumValueDescriptor* <span class="title">FindEnumValueByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===================================== 扩展范围=====================================</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ExtensionRange</span> &#123;</span><br><span class="line">        <span class="type">int</span> start;  <span class="comment">// 起始编号（含）</span></span><br><span class="line">        <span class="type">int</span> end;    <span class="comment">// 结束编号（不含）</span></span><br><span class="line">        <span class="type">const</span> ExtensionRangeOptions* options;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 扩展范围数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">extension_range_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 获取第 i 个扩展范围</span></span><br><span class="line">    <span class="function"><span class="type">const</span> ExtensionRange* <span class="title">extension_range</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 检查编号是否在扩展范围内</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">IsExtensionNumber</span><span class="params">(<span class="type">int</span> number)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================================== 扩展字段=====================================</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">extension_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">extension</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">FindExtensionByName</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================================== 保留字段（reserved）=====================================</span></span><br><span class="line">    <span class="comment">// 保留的编号范围数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reserved_range_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ReservedRange</span> &#123;</span><br><span class="line">        <span class="type">int</span> start;  <span class="comment">// 起始编号（含）</span></span><br><span class="line">        <span class="type">int</span> end;    <span class="comment">// 结束编号（含）</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="type">const</span> ReservedRange* <span class="title">reserved_range</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 保留的名称数量</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">reserved_name_count</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 获取第 i 个保留名称</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">reserved_name</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===================================== 特性检查 =====================================   </span></span><br><span class="line">    <span class="comment">// 是否是 map entry（map&lt;K,V&gt; 内部生成的消息）</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">map_key</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">map_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="comment">// 获取 map 的 key/value 字段描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">map_key</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> FieldDescriptor* <span class="title">map_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选项</span></span><br><span class="line">    <span class="function"><span class="type">const</span> MessageOptions&amp; <span class="title">options</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调试</span></span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="（7）FieldDescriptor（字段描述符）"><a href="#（7）FieldDescriptor（字段描述符）" class="headerlink" title="（7）FieldDescriptor（字段描述符）"></a>（7）FieldDescriptor（字段描述符）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FieldDescriptor</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 字段类型枚举</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Type</span> &#123;</span><br><span class="line">        TYPE_DOUBLE         = <span class="number">1</span>,</span><br><span class="line">        TYPE_FLOAT          = <span class="number">2</span>,</span><br><span class="line">        TYPE_INT64          = <span class="number">3</span>,</span><br><span class="line">        TYPE_UINT64         = <span class="number">4</span>,</span><br><span class="line">        TYPE_INT32          = <span class="number">5</span>,</span><br><span class="line">        TYPE_FIXED64        = <span class="number">6</span>,</span><br><span class="line">        TYPE_FIXED32        = <span class="number">7</span>,</span><br><span class="line">        TYPE_BOOL           = <span class="number">8</span>,</span><br><span class="line">        TYPE_STRING         = <span class="number">9</span>,</span><br><span class="line">        TYPE_GROUP          = <span class="number">10</span>,  <span class="comment">// 已废弃</span></span><br><span class="line">        TYPE_MESSAGE        = <span class="number">11</span>,  <span class="comment">// 嵌套消息</span></span><br><span class="line">        TYPE_BYTES          = <span class="number">12</span>,</span><br><span class="line">        TYPE_UINT32         = <span class="number">13</span>,</span><br><span class="line">        TYPE_ENUM           = <span class="number">14</span>,</span><br><span class="line">        TYPE_SFIXED32       = <span class="number">15</span>,</span><br><span class="line">        TYPE_SFIXED64       = <span class="number">16</span>,</span><br><span class="line">        TYPE_SINT32         = <span class="number">17</span>,</span><br><span class="line">        TYPE_SINT64         = <span class="number">18</span>,</span><br><span class="line">        MAX_TYPE            = <span class="number">18</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// C++ 类型枚举（用于代码生成）</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">CppType</span> &#123;</span><br><span class="line">        CPPTYPE_INT32       = <span class="number">1</span>,</span><br><span class="line">        CPPTYPE_INT64       = <span class="number">2</span>,</span><br><span class="line">        CPPTYPE_UINT32      = <span class="number">3</span>,</span><br><span class="line">        CPPTYPE_UINT64      = <span class="number">4</span>,</span><br><span class="line">        CPPTYPE_DOUBLE      = <span class="number">5</span>,</span><br><span class="line">        CPPTYPE_FLOAT       = <span class="number">6</span>,</span><br><span class="line">        CPPTYPE_BOOL        = <span class="number">7</span>,</span><br><span class="line">        CPPTYPE_ENUM        = <span class="number">8</span>,</span><br><span class="line">        CPPTYPE_STRING      = <span class="number">9</span>,</span><br><span class="line">        CPPTYPE_MESSAGE     = <span class="number">10</span>,</span><br><span class="line">        MAX_CPPTYPE         = <span class="number">10</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标签（proto2）</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Label</span> &#123;</span><br><span class="line">        LABEL_OPTIONAL      = <span class="number">1</span>,</span><br><span class="line">        LABEL_REQUIRED      = <span class="number">2</span>,  <span class="comment">// proto2 only</span></span><br><span class="line">        LABEL_REPEATED      = <span class="number">3</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 基本信息</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 字段名称（如 &quot;message&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完整名称（如 &quot;myservice.EchoRequest.message&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">full_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 字段编号</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">number</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在消息中的索引</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">index</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 类型信息</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Proto 类型</span></span><br><span class="line">    <span class="function">Type <span class="title">type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 类型名称字符串（如 &quot;string&quot;, &quot;int32&quot;）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">type_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// C++ 类型</span></span><br><span class="line">    <span class="function">CppType <span class="title">cpp_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// C++ 类型名称字符串</span></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* <span class="title">CppTypeName</span><span class="params">(CppType cpp_type)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标签</span></span><br><span class="line">    <span class="function">Label <span class="title">label</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 类型判断</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为 repeated</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_repeated</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为 optional（proto3 显式 optional 或 proto2 optional）</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_optional</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为 required（proto2）</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_required</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为 map 类型</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_map</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为 packed 编码</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_packed</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否为扩展字段</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">is_extension</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 所属关系</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 所属文件</span></span><br><span class="line">    <span class="function"><span class="type">const</span> FileDescriptor* <span class="title">file</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 所属消息（普通字段）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">containing_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 被扩展的消息（扩展字段）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">extension_scope</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 所属 oneof（如果有）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> OneofDescriptor* <span class="title">containing_oneof</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 真实 oneof 索引（-1 表示不属于 oneof）</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">index_in_oneof</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 嵌套类型信息</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是 TYPE_MESSAGE 或 TYPE_GROUP，返回消息描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Descriptor* <span class="title">message_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果是 TYPE_ENUM，返回枚举描述符</span></span><br><span class="line">    <span class="function"><span class="type">const</span> EnumDescriptor* <span class="title">enum_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 默认值</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否有显式设置默认值</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">has_default_value</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 各类型的默认值获取</span></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">default_value_int32</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">int64_t</span> <span class="title">default_value_int64</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">uint32_t</span> <span class="title">default_value_uint32</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">uint64_t</span> <span class="title">default_value_uint64</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">float</span> <span class="title">default_value_float</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">default_value_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">default_value_bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">default_value_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> EnumValueDescriptor* <span class="title">default_value_enum</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// JSON 相关</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// JSON 字段名（默认用驼峰命名）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">json_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 小写名称（下划线）</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">lowercase_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 驼峰名称</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::string&amp; <span class="title">camelcase_name</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 选项</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">const</span> FieldOptions&amp; <span class="title">options</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    <span class="comment">// 调试</span></span><br><span class="line">    <span class="comment">// --------------------------------------------------</span></span><br><span class="line">    </span><br><span class="line">    <span class="function">std::string <span class="title">DebugString</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="五、gRPC-的使用"><a href="#五、gRPC-的使用" class="headerlink" title="五、gRPC 的使用"></a>五、gRPC 的使用</h1><h2 id="1-gRPC-编译命令"><a href="#1-gRPC-编译命令" class="headerlink" title="1.gRPC 编译命令"></a>1.gRPC 编译命令</h2><h3 id="（1）基本编译命令"><a href="#（1）基本编译命令" class="headerlink" title="（1）基本编译命令"></a>（1）基本编译命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 C++ 代码（同时生成 protobuf 和 grpc 代码）</span></span><br><span class="line">protoc --cpp_out=. --grpc_out=. --plugin=protoc-gen-grpc=`<span class="built_in">which</span> grpc_cpp_plugin` your_service.proto</span><br></pre></td></tr></table></figure>
<p>生成文件：</p>
<ul>
<li>your_service.pb.h &#x2F; your_service.pb.cc — Protobuf 消息类</li>
<li>your_service.grpc.pb.h &#x2F; your_service.grpc.pb.cc — gRPC 服务类（Stub 等）</li>
</ul>
<h3 id="（2）指定输出目录"><a href="#（2）指定输出目录" class="headerlink" title="（2）指定输出目录"></a>（2）指定输出目录</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=./proto \</span><br><span class="line">       --cpp_out=./generated \</span><br><span class="line">       --grpc_out=./generated \</span><br><span class="line">       --plugin=protoc-gen-grpc=`which grpc_cpp_plugin` \</span><br><span class="line">       ./proto/your_service.proto</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122101152562.png"></p>
<h2 id="2-四种-RPC-模式"><a href="#2-四种-RPC-模式" class="headerlink" title="2.四种 RPC 模式"></a>2.四种 RPC 模式</h2><p>Proto 定义了 4 种标准 RPC 模式，核心区别是「<strong>请求&#x2F;响应是否为流式</strong>」，每种模式对应 C++ 编译后不同的函数签名和调用方式<br><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260120111458667.png"></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        四种 RPC 模式                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  Unary:            Client ──Req──▶ Server ──Resp──▶ Client     │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  Server Stream:    Client ──Req──▶ Server ══Resp══▶            │</span><br><span class="line">│                                           ══Resp══▶            │</span><br><span class="line">│                                           ══Resp══▶ Client     │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  Client Stream:    Client ══Req══▶                              │</span><br><span class="line">│                           ══Req══▶                              │</span><br><span class="line">│                           ══Req══▶ Server ──Resp──▶ Client     │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  Bidirectional:    Client ══Req══▶ Server                       │</span><br><span class="line">│                           ◀══Resp══                             │</span><br><span class="line">│                           ══Req══▶                              │</span><br><span class="line">│                           ◀══Resp══  (实时双向)                  │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br><span class="line"></span><br><span class="line">图例: ── 单条消息   ══ 流式消息</span><br></pre></td></tr></table></figure>

<h2 id="3-使用示例（综合）"><a href="#3-使用示例（综合）" class="headerlink" title="3.使用示例（综合）"></a>3.使用示例（综合）</h2><h3 id="（1）Proto定义"><a href="#（1）Proto定义" class="headerlink" title="（1）Proto定义"></a>（1）Proto定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package demo;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求和响应消息定义</span></span><br><span class="line">message Request &#123;</span><br><span class="line">    string data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Response &#123;</span><br><span class="line">    string result = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义四种RPC模式的服务</span></span><br><span class="line">service DemoService &#123;</span><br><span class="line">    <span class="comment">// 1. Unary（一元RPC）：单请求-单响应</span></span><br><span class="line">    <span class="function">rpc <span class="title">UnaryCall</span><span class="params">(Request)</span> <span class="title">returns</span> <span class="params">(Response)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Server Streaming（服务端流）：单请求-多响应流</span></span><br><span class="line">    <span class="function">rpc <span class="title">ServerStreamingCall</span><span class="params">(Request)</span> <span class="title">returns</span> <span class="params">(stream Response)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. Client Streaming（客户端流）：多请求流-单响应</span></span><br><span class="line">    <span class="function">rpc <span class="title">ClientStreamingCall</span><span class="params">(stream Request)</span> <span class="title">returns</span> <span class="params">(Response)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. Bidirectional Streaming（双向流）：多请求流-多响应流</span></span><br><span class="line">    <span class="function">rpc <span class="title">BidirectionalStreamingCall</span><span class="params">(stream Request)</span> <span class="title">returns</span> <span class="params">(stream Response)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）生成的C-伪代码"><a href="#（2）生成的C-伪代码" class="headerlink" title="（2）生成的C++伪代码"></a>（2）生成的C++伪代码</h3><p>运行 protoc –grpc_out&#x3D;. –cpp_out&#x3D;. demo.proto 后生成</p>
<h4 id="服务端基类（demo-grpc-pb-h）"><a href="#服务端基类（demo-grpc-pb-h）" class="headerlink" title="&lt;1&gt;服务端基类（demo.grpc.pb.h）"></a>&lt;1&gt;服务端基类（demo.grpc.pb.h）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> demo &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">service_full_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;im.ChatService&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 同步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Service</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Service</span>();</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">Service</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> grpc::Status <span class="title">Chat</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerReaderWriter&lt;ChatMessage, ChatMessage&gt;* stream</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 【关键】异步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">AsyncService</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">AsyncService</span>();</span><br><span class="line">        ~<span class="built_in">AsyncService</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 请求处理一个 Chat 调用</span></span><br><span class="line">        <span class="comment">// 当有新的 Chat 请求到达时，通过 cq 通知</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">RequestChat</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerAsyncReaderWriter&lt;ChatMessage, ChatMessage&gt;* stream,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">//                            ↑ 写出          ↑ 读入</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::CompletionQueue* new_call_cq,  <span class="comment">// 用于新调用通知</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerCompletionQueue* notification_cq,  <span class="comment">// 用于完成通知</span></span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">void</span>* tag  <span class="comment">// 完成时的标识</span></span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Stub 类（完整版） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">final</span> : <span class="keyword">public</span> StubInterface &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Stub</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;grpc::ChannelInterface&gt;&amp; channel)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 同步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; </span><br><span class="line">        <span class="built_in">Chat</span>(grpc::ClientContext* context);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 异步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; </span><br><span class="line">        <span class="built_in">AsyncChat</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            grpc::CompletionQueue* cq,</span><br><span class="line">            <span class="type">void</span>* tag</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// PrepareAsync 版本（延迟启动）</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; </span><br><span class="line">        <span class="built_in">PrepareAsyncChat</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            grpc::CompletionQueue* cq</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::shared_ptr&lt;grpc::ChannelInterface&gt; channel_;</span><br><span class="line">        <span class="type">const</span> grpc::internal::RpcMethod rpcmethod_Chat_;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> std::unique_ptr&lt;Stub&gt; <span class="title">NewStub</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::shared_ptr&lt;grpc::Channel&gt;&amp; channel,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> grpc::StubOptions&amp; options = grpc::StubOptions()</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="comment">// namespace demo</span></span><br></pre></td></tr></table></figure>
<h4 id="核心流操作类（gRPC-库提供）"><a href="#核心流操作类（gRPC-库提供）" class="headerlink" title="&lt;2&gt;核心流操作类（gRPC 库提供）"></a>&lt;2&gt;核心流操作类（gRPC 库提供）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 服务端使用 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端写入流（Server Streaming 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;                    <span class="comment">// 发送一个响应</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, WriteOptions opts)</span></span>; <span class="comment">// 带选项写入</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端读取流（Client Streaming 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;  <span class="comment">// 读取一个请求，返回 false 表示流结束</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端双向流（Bidirectional 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReaderWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;         <span class="comment">// 读取客户端请求</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;  <span class="comment">// 发送响应给客户端</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 客户端使用 ==========</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端读取流（Server Streaming 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientReader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;        <span class="comment">// 读取服务端响应</span></span><br><span class="line">    <span class="function">grpc::Status <span class="title">Finish</span><span class="params">()</span></span>;    <span class="comment">// 结束并获取状态</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端写入流（Client Streaming 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;  <span class="comment">// 发送请求</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WritesDone</span><span class="params">()</span></span>;         <span class="comment">// 标记发送完成</span></span><br><span class="line">    <span class="function">grpc::Status <span class="title">Finish</span><span class="params">()</span></span>;     <span class="comment">// 等待服务端响应并获取状态</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端双向流（Bidirectional 用）</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientReaderWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;  <span class="comment">// 发送请求</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;         <span class="comment">// 读取响应</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WritesDone</span><span class="params">()</span></span>;         <span class="comment">// 标记发送完成</span></span><br><span class="line">    <span class="function">grpc::Status <span class="title">Finish</span><span class="params">()</span></span>;     <span class="comment">// 获取最终状态</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h3 id="（3）gRPC-新增的关键类型（C-伪代码）"><a href="#（3）gRPC-新增的关键类型（C-伪代码）" class="headerlink" title="（3）gRPC 新增的关键类型（C++ 伪代码）"></a>（3）gRPC 新增的关键类型（C++ 伪代码）</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122105626627.png"></p>
<h4 id="grpc-Status"><a href="#grpc-Status" class="headerlink" title="&lt;1&gt;grpc::Status"></a>&lt;1&gt;grpc::Status</h4><ul>
<li>在原生Proto的Service中，是通过Context返回“执行状态”（成功&#x2F;失败&#x2F;错误码&#x2F;错误信息），grpc框架直接将其抽取出来实现了grpc::Status专门存储“执行状态”。</li>
</ul>
<h5 id="1-内部伪代码"><a href="#1-内部伪代码" class="headerlink" title="1)内部伪代码"></a>1)内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Status</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 构造</span></span><br><span class="line">    <span class="built_in">Status</span>();  <span class="comment">// 默认 OK</span></span><br><span class="line">    <span class="built_in">Status</span>(StatusCode code, <span class="type">const</span> std::string&amp; error_message);</span><br><span class="line">    <span class="built_in">Status</span>(StatusCode code, <span class="type">const</span> std::string&amp; error_message, <span class="type">const</span> std::string&amp; error_details);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 状态判断</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ok</span><span class="params">()</span> <span class="type">const</span></span>;                      <span class="comment">// 是否成功</span></span><br><span class="line">    <span class="function">StatusCode <span class="title">error_code</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">// 错误码</span></span><br><span class="line">    <span class="function">std::string <span class="title">error_message</span><span class="params">()</span> <span class="type">const</span></span>;    <span class="comment">// 错误信息</span></span><br><span class="line">    <span class="function">std::string <span class="title">error_details</span><span class="params">()</span> <span class="type">const</span></span>;    <span class="comment">// 详细信息</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 预定义状态</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> Status&amp; OK;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> Status&amp; CANCELLED;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态码枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">StatusCode</span> &#123;</span><br><span class="line">    OK = <span class="number">0</span>,</span><br><span class="line">    CANCELLED = <span class="number">1</span>,</span><br><span class="line">    UNKNOWN = <span class="number">2</span>,</span><br><span class="line">    INVALID_ARGUMENT = <span class="number">3</span>,</span><br><span class="line">    DEADLINE_EXCEEDED = <span class="number">4</span>,</span><br><span class="line">    NOT_FOUND = <span class="number">5</span>,</span><br><span class="line">    ALREADY_EXISTS = <span class="number">6</span>,</span><br><span class="line">    PERMISSION_DENIED = <span class="number">7</span>,</span><br><span class="line">    RESOURCE_EXHAUSTED = <span class="number">8</span>,</span><br><span class="line">    FAILED_PRECONDITION = <span class="number">9</span>,</span><br><span class="line">    ABORTED = <span class="number">10</span>,</span><br><span class="line">    OUT_OF_RANGE = <span class="number">11</span>,</span><br><span class="line">    UNIMPLEMENTED = <span class="number">12</span>,</span><br><span class="line">    INTERNAL = <span class="number">13</span>,</span><br><span class="line">    UNAVAILABLE = <span class="number">14</span>,</span><br><span class="line">    DATA_LOSS = <span class="number">15</span>,</span><br><span class="line">    UNAUTHENTICATED = <span class="number">16</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h5 id="2）使用示例"><a href="#2）使用示例" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 作用：告诉调用者&quot;这次 RPC 成功了吗？失败原因是什么？&quot;</span></span><br><span class="line"></span><br><span class="line">grpc::Status status = stub-&gt;<span class="built_in">Echo</span>(&amp;context, request, &amp;response);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="comment">// 成功，使用 response</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 失败</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;错误码: &quot;</span> &lt;&lt; status.<span class="built_in">error_code</span>() &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;错误信息: &quot;</span> &lt;&lt; status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="grpc-ClientContext-—-客户端调用上下文"><a href="#grpc-ClientContext-—-客户端调用上下文" class="headerlink" title="&lt;2&gt;grpc::ClientContext — 客户端调用上下文"></a>&lt;2&gt;grpc::ClientContext — 客户端调用上下文</h4><ul>
<li>在原生Proto的Service中，是通过Context在设置“超时、取消”，这部分功能现在也被抽取出来封装在grpc::ClinetContext中，方便客户端使用</li>
<li>相比与原生Proto的Context，<strong>新增了“元数据、认证”等功能</strong><ul>
<li><strong>元数据</strong>：元数据是附加在 RPC 调用上的<strong>键值对信息</strong>，类似于 HTTP Headers，用于传递额外的键值对信息</li>
<li><strong>认证功能</strong>：用于身份验证，如 Token、证书等</li>
</ul>
</li>
</ul>
<h5 id="1）内部伪代码"><a href="#1）内部伪代码" class="headerlink" title="1）内部伪代码"></a>1）内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientContext</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ClientContext</span>();</span><br><span class="line">    ~<span class="built_in">ClientContext</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 元数据 (Metadata) ==========</span></span><br><span class="line">    <span class="comment">// 发送给服务端的元数据（调用前设置）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddMetadata</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取服务端返回的初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::multimap&lt;grpc::string_ref, grpc::string_ref&gt;&amp; <span class="title">GetServerInitialMetadata</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取服务端返回的尾部元数据</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::multimap&lt;grpc::string_ref, grpc::string_ref&gt;&amp; <span class="title">GetServerTrailingMetadata</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 超时控制 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_deadline</span><span class="params">(<span class="type">const</span> std::chrono::system_clock::time_point&amp; deadline)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_deadline</span><span class="params">(<span class="type">const</span> gpr_timespec&amp; deadline)</span></span>;</span><br><span class="line">    std::chrono::<span class="function">system_clock::time_point <span class="title">deadline</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 取消调用 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">TryCancel</span><span class="params">()</span></span>;               <span class="comment">// 尝试取消本次 RPC</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 认证 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_credentials</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;CallCredentials&gt;&amp; creds)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;<span class="type">const</span> AuthContext&gt; <span class="title">auth_context</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 压缩 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_compression_algorithm</span><span class="params">(grpc_compression_algorithm algorithm)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 其他 ==========</span></span><br><span class="line">    <span class="function">std::string <span class="title">peer</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 获取对端地址</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_wait_for_ready</span><span class="params">(<span class="type">bool</span> wait)</span></span>;  <span class="comment">// 等待 channel ready</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ⚠️ 不可复制，每次调用需要新建</span></span><br><span class="line">    <span class="built_in">ClientContext</span>(<span class="type">const</span> ClientContext&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    ClientContext&amp; <span class="keyword">operator</span>=(<span class="type">const</span> ClientContext&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h5 id="2）使用示例-1"><a href="#2）使用示例-1" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作用：配置本次 RPC 调用的超时、元数据、认证等参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ⚠️ 每次 RPC 调用都必须新建 ClientContext，不可复用！</span></span><br><span class="line">grpc::ClientContext context;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 设置超时 ==========</span></span><br><span class="line"><span class="comment">// 5秒后超时</span></span><br><span class="line">context.<span class="built_in">set_deadline</span>(std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">5</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 添加元数据（类似 HTTP Header） ==========</span></span><br><span class="line">context.<span class="built_in">AddMetadata</span>(<span class="string">&quot;x-request-id&quot;</span>, <span class="string">&quot;uuid-12345&quot;</span>);      <span class="comment">// 请求追踪</span></span><br><span class="line">context.<span class="built_in">AddMetadata</span>(<span class="string">&quot;authorization&quot;</span>, <span class="string">&quot;Bearer my-token&quot;</span>); <span class="comment">// 自定义认证</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 设置认证凭证 ==========</span></span><br><span class="line"><span class="keyword">auto</span> call_creds = grpc::<span class="built_in">AccessTokenCredentials</span>(<span class="string">&quot;jwt-token&quot;</span>);</span><br><span class="line">context.<span class="built_in">set_credentials</span>(call_creds);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 发起调用 ==========</span></span><br><span class="line">grpc::Status status = stub-&gt;<span class="built_in">Echo</span>(&amp;context, request, &amp;response);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 获取服务端返回的元数据 ==========</span></span><br><span class="line"><span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span>&amp; metadata = context.<span class="built_in">GetServerTrailingMetadata</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = metadata.<span class="built_in">find</span>(<span class="string">&quot;x-server-time&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != metadata.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;服务端时间: &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 取消调用（通常在另一个线程） ==========</span></span><br><span class="line"><span class="comment">// context.TryCancel();</span></span><br></pre></td></tr></table></figure>

<h4 id="grpc-ServerContext-—-服务端处理上下文"><a href="#grpc-ServerContext-—-服务端处理上下文" class="headerlink" title="&lt;3&gt;grpc::ServerContext — 服务端处理上下文"></a>&lt;3&gt;grpc::ServerContext — 服务端处理上下文</h4><ul>
<li>与 ClientContext 对应，服务端用于获取客户端信息和设置响应元数据</li>
<li>可以检测客户端是否取消了请求、获取客户端设置的超时时间</li>
<li>可以获取客户端的认证信息和地址</li>
</ul>
<h5 id="1-内部伪代码-1"><a href="#1-内部伪代码-1" class="headerlink" title="1)内部伪代码"></a>1)内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerContext</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ServerContext</span>();</span><br><span class="line">    ~<span class="built_in">ServerContext</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 元数据 (Metadata) ==========</span></span><br><span class="line">    <span class="comment">// 获取客户端发来的元数据</span></span><br><span class="line">    <span class="function"><span class="type">const</span> std::multimap&lt;grpc::string_ref, grpc::string_ref&gt;&amp; <span class="title">client_metadata</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送初始元数据给客户端（在第一个响应之前）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddInitialMetadata</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送尾部元数据给客户端（在 RPC 结束时）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddTrailingMetadata</span><span class="params">(<span class="type">const</span> std::string&amp; key, <span class="type">const</span> std::string&amp; value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 取消/超时检测 ==========</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">IsCancelled</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 客户端是否取消了请求</span></span><br><span class="line">    std::chrono::<span class="function">system_clock::time_point <span class="title">deadline</span><span class="params">()</span> <span class="type">const</span></span>;  <span class="comment">// 客户端设置的 deadline</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 认证信息 ==========</span></span><br><span class="line">    <span class="function">std::shared_ptr&lt;<span class="type">const</span> AuthContext&gt; <span class="title">auth_context</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">peer</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 客户端地址（如 &quot;ipv4:127.0.0.1:12345&quot;）</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 压缩 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_compression_level</span><span class="params">(grpc_compression_level level)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">set_compression_algorithm</span><span class="params">(grpc_compression_algorithm algorithm)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 异步通知 ==========</span></span><br><span class="line">    <span class="comment">// 当 RPC 被取消时触发回调</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AsyncNotifyWhenDone</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h5 id="2）使用示例-2"><a href="#2）使用示例-2" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作用：在服务端处理方法中，获取客户端信息、设置响应元数据</span></span><br><span class="line"></span><br><span class="line"><span class="function">grpc::Status <span class="title">MyServiceImpl::Echo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    grpc::ServerContext* context,    <span class="comment">// 框架自动传入，无需手动创建</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> EchoRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">    EchoResponse* response)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ========== 获取客户端元数据 ==========</span></span><br><span class="line">    <span class="keyword">auto</span>&amp; metadata = context-&gt;<span class="built_in">client_metadata</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = metadata.<span class="built_in">find</span>(<span class="string">&quot;x-request-id&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != metadata.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="function">std::string <span class="title">request_id</span><span class="params">(it-&gt;second.data(), it-&gt;second.size())</span></span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;请求ID: &quot;</span> &lt;&lt; request_id &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 获取客户端地址 ==========</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;客户端地址: &quot;</span> &lt;&lt; context-&gt;<span class="built_in">peer</span>() &lt;&lt; std::endl;  <span class="comment">// 如 &quot;ipv4:192.168.1.100:54321&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 检测是否超时/取消 ==========</span></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::CANCELLED, <span class="string">&quot;客户端已取消请求&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 长时间处理时定期检查 ==========</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::CANCELLED, <span class="string">&quot;处理中被取消&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理逻辑...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 设置响应元数据 ==========</span></span><br><span class="line">    context-&gt;<span class="built_in">AddInitialMetadata</span>(<span class="string">&quot;x-server-version&quot;</span>, <span class="string">&quot;1.0.0&quot;</span>);   <span class="comment">// 初始元数据</span></span><br><span class="line">    context-&gt;<span class="built_in">AddTrailingMetadata</span>(<span class="string">&quot;x-process-time-ms&quot;</span>, <span class="string">&quot;42&quot;</span>);    <span class="comment">// 尾部元数据</span></span><br><span class="line"></span><br><span class="line">    response-&gt;<span class="built_in">set_message</span>(request-&gt;<span class="built_in">message</span>());</span><br><span class="line">    <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="grpc-Channel"><a href="#grpc-Channel" class="headerlink" title="&lt;4&gt;grpc::Channel"></a>&lt;4&gt;grpc::Channel</h4><ul>
<li>原生 Proto 中需要自己实现 RpcChannel（纯虚类），gRPC 直接提供了<strong>内置 HTTP&#x2F;2 实现</strong></li>
<li>Channel 代表客户端到服务端的逻辑连接，<strong>可被多个 Stub 共享</strong></li>
<li>内置<strong>连接池、重连、负载均衡</strong>等功能</li>
</ul>
<h5 id="1）内部伪代码-1"><a href="#1）内部伪代码-1" class="headerlink" title="1）内部伪代码"></a>1）内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Channel</span> : <span class="keyword">public</span> ChannelInterface &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 获取连接状态</span></span><br><span class="line">    <span class="function">grpc_connectivity_state <span class="title">GetState</span><span class="params">(<span class="type">bool</span> try_to_connect)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待状态变化</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WaitForStateChange</span><span class="params">(grpc_connectivity_state last_observed,</span></span></span><br><span class="line"><span class="params"><span class="function">                            std::chrono::system_clock::time_point deadline)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待连接就绪</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WaitForConnected</span><span class="params">(std::chrono::system_clock::time_point deadline)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接状态枚举</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">grpc_connectivity_state</span> &#123;</span><br><span class="line">    GRPC_CHANNEL_IDLE,              <span class="comment">// 空闲</span></span><br><span class="line">    GRPC_CHANNEL_CONNECTING,        <span class="comment">// 连接中</span></span><br><span class="line">    GRPC_CHANNEL_READY,             <span class="comment">// 就绪</span></span><br><span class="line">    GRPC_CHANNEL_TRANSIENT_FAILURE, <span class="comment">// 暂时失败（会重试）</span></span><br><span class="line">    GRPC_CHANNEL_SHUTDOWN,          <span class="comment">// 已关闭</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== Channel 创建函数 ==========</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;Channel&gt; <span class="title">CreateChannel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::string&amp; target,                      <span class="comment">// 地址，如 &quot;localhost:50051&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;ChannelCredentials&gt;&amp; creds</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建凭证</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;ChannelCredentials&gt; <span class="title">InsecureChannelCredentials</span><span class="params">()</span></span>;  <span class="comment">// 不加密</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;ChannelCredentials&gt; <span class="title">SslCredentials</span><span class="params">(<span class="type">const</span> SslCredentialsOptions&amp; options)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h5 id="2）使用示例-3"><a href="#2）使用示例-3" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作用：建立到服务端的连接，创建 Stub 时使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 创建不加密的 Channel（开发测试用） ==========</span></span><br><span class="line"><span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(</span><br><span class="line">    <span class="string">&quot;localhost:50051&quot;</span>, </span><br><span class="line">    grpc::<span class="built_in">InsecureChannelCredentials</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 创建 TLS 加密的 Channel（生产环境） ==========</span></span><br><span class="line">grpc::SslCredentialsOptions ssl_opts;</span><br><span class="line">ssl_opts.pem_root_certs = <span class="built_in">ReadFile</span>(<span class="string">&quot;ca.crt&quot;</span>);  <span class="comment">// CA 证书</span></span><br><span class="line"><span class="keyword">auto</span> secure_channel = grpc::<span class="built_in">CreateChannel</span>(</span><br><span class="line">    <span class="string">&quot;server.example.com:443&quot;</span>,</span><br><span class="line">    grpc::<span class="built_in">SslCredentials</span>(ssl_opts)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 使用 Channel 创建 Stub ==========</span></span><br><span class="line"><span class="keyword">auto</span> stub = MyService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 检查连接状态 ==========</span></span><br><span class="line"><span class="keyword">auto</span> state = channel-&gt;<span class="built_in">GetState</span>(<span class="literal">true</span>);  <span class="comment">// true = 尝试连接</span></span><br><span class="line"><span class="keyword">switch</span> (state) &#123;</span><br><span class="line">    <span class="keyword">case</span> GRPC_CHANNEL_IDLE:       std::cout &lt;&lt; <span class="string">&quot;空闲&quot;</span> &lt;&lt; std::endl; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GRPC_CHANNEL_CONNECTING: std::cout &lt;&lt; <span class="string">&quot;连接中&quot;</span> &lt;&lt; std::endl; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GRPC_CHANNEL_READY:      std::cout &lt;&lt; <span class="string">&quot;已就绪&quot;</span> &lt;&lt; std::endl; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GRPC_CHANNEL_TRANSIENT_FAILURE: std::cout &lt;&lt; <span class="string">&quot;暂时失败&quot;</span> &lt;&lt; std::endl; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> GRPC_CHANNEL_SHUTDOWN:   std::cout &lt;&lt; <span class="string">&quot;已关闭&quot;</span> &lt;&lt; std::endl; <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 等待连接就绪（带超时） ==========</span></span><br><span class="line"><span class="type">bool</span> connected = channel-&gt;<span class="built_in">WaitForConnected</span>(</span><br><span class="line">    std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!connected) &#123;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;连接超时！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 多个 Stub 共享同一个 Channel（推荐） ==========</span></span><br><span class="line"><span class="keyword">auto</span> stub1 = MyService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line"><span class="keyword">auto</span> stub2 = MyService::<span class="built_in">NewStub</span>(channel);  <span class="comment">// 复用连接</span></span><br></pre></td></tr></table></figure>

<h4 id="grpc-Server-grpc-ServerBuilder"><a href="#grpc-Server-grpc-ServerBuilder" class="headerlink" title="&lt;5&gt;grpc::Server &amp; grpc::ServerBuilder"></a>&lt;5&gt;grpc::Server &amp; grpc::ServerBuilder</h4><ul>
<li>原生 Proto 没有提供服务端框架，需要自己处理网络监听、线程管理等</li>
<li>gRPC 通过 ServerBuilder（建造者模式） 简化服务器配置和启动、<strong>服务注册</strong>等</li>
<li>Server 提供阻塞等待和优雅关闭功能</li>
</ul>
<h5 id="1）内部伪代码-2"><a href="#1）内部伪代码-2" class="headerlink" title="1）内部伪代码"></a>1）内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== ServerBuilder - 构建服务器 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerBuilder</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ServerBuilder</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加监听地址</span></span><br><span class="line">    <span class="function">ServerBuilder&amp; <span class="title">AddListeningPort</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::string&amp; addr,                    <span class="comment">// 如 &quot;0.0.0.0:50051&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">        std::shared_ptr&lt;ServerCredentials&gt; creds,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span>* selected_port = <span class="literal">nullptr</span>                <span class="comment">// 输出实际端口</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册服务实现</span></span><br><span class="line">    <span class="function">ServerBuilder&amp; <span class="title">RegisterService</span><span class="params">(Service* service)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置线程池</span></span><br><span class="line">    <span class="function">ServerBuilder&amp; <span class="title">SetSyncServerOption</span><span class="params">(SyncServerOption option, <span class="type">int</span> value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置最大消息大小</span></span><br><span class="line">    <span class="function">ServerBuilder&amp; <span class="title">SetMaxReceiveMessageSize</span><span class="params">(<span class="type">int</span> max_size)</span></span>;</span><br><span class="line">    <span class="function">ServerBuilder&amp; <span class="title">SetMaxSendMessageSize</span><span class="params">(<span class="type">int</span> max_size)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建并启动</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;Server&gt; <span class="title">BuildAndStart</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== Server - 服务器实例 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 阻塞等待服务关闭</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Wait</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关闭服务</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">(<span class="type">const</span> std::chrono::system_clock::time_point&amp; deadline)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端凭证</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;ServerCredentials&gt; <span class="title">InsecureServerCredentials</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">std::shared_ptr&lt;ServerCredentials&gt; <span class="title">SslServerCredentials</span><span class="params">(<span class="type">const</span> SslServerCredentialsOptions&amp; options)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>
<h5 id="2）使用示例-4"><a href="#2）使用示例-4" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作用：配置、启动、管理 gRPC 服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 1. 创建服务实现 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> MyService::Service &#123;</span><br><span class="line">    <span class="function">grpc::Status <span class="title">Echo</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> EchoRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">                      EchoResponse* response)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        response-&gt;<span class="built_in">set_message</span>(<span class="string">&quot;Echo: &quot;</span> + request-&gt;<span class="built_in">message</span>());</span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 2. 使用 ServerBuilder 构建服务器 ==========</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">RunServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">server_address</span><span class="params">(<span class="string">&quot;0.0.0.0:50051&quot;</span>)</span></span>;</span><br><span class="line">    MyServiceImpl service;</span><br><span class="line"></span><br><span class="line">    grpc::ServerBuilder builder;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加监听端口（不加密）</span></span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>(server_address, grpc::<span class="built_in">InsecureServerCredentials</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 添加监听端口（TLS 加密）</span></span><br><span class="line">    <span class="comment">// grpc::SslServerCredentialsOptions ssl_opts;</span></span><br><span class="line">    <span class="comment">// ssl_opts.pem_key_cert_pairs.push_back(&#123;ReadFile(&quot;server.key&quot;), ReadFile(&quot;server.crt&quot;)&#125;);</span></span><br><span class="line">    <span class="comment">// builder.AddListeningPort(&quot;0.0.0.0:443&quot;, grpc::SslServerCredentials(ssl_opts));</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册服务</span></span><br><span class="line">    builder.<span class="built_in">RegisterService</span>(&amp;service);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置参数</span></span><br><span class="line">    builder.<span class="built_in">SetMaxReceiveMessageSize</span>(<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>);  <span class="comment">// 10MB</span></span><br><span class="line">    builder.<span class="built_in">SetMaxSendMessageSize</span>(<span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 构建并启动</span></span><br><span class="line">    std::unique_ptr&lt;grpc::Server&gt; server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;服务器启动: &quot;</span> &lt;&lt; server_address &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 3. 阻塞等待 ==========</span></span><br><span class="line">    server-&gt;<span class="built_in">Wait</span>();  <span class="comment">// 阻塞直到 Shutdown 被调用</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 4. 优雅关闭（通常在信号处理中） ==========</span></span><br><span class="line">std::unique_ptr&lt;grpc::Server&gt; g_server;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SignalHandler</span><span class="params">(<span class="type">int</span> signal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_server) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;正在关闭服务器...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// 优雅关闭：等待现有请求完成</span></span><br><span class="line">        g_server-&gt;<span class="built_in">Shutdown</span>(std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="流操作类"><a href="#流操作类" class="headerlink" title="&lt;6&gt;流操作类"></a>&lt;6&gt;流操作类</h4><ul>
<li>原生 Proto 不支持流式传输，gRPC 新增了<strong>四种流模式</strong>的支持</li>
<li>服务端使用 ServerWriter&#x2F;Reader&#x2F;ReaderWriter</li>
<li>客户端使用 ClientWriter&#x2F;Reader&#x2F;ReaderWriter</li>
</ul>
<h5 id="1）内部伪代码-3"><a href="#1）内部伪代码-3" class="headerlink" title="1）内部伪代码"></a>1）内部伪代码</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 服务端流类 ==========</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerWriter</span> &#123;                    <span class="comment">// Server Streaming 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, WriteOptions options)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReader</span> &#123;                    <span class="comment">// Client Streaming 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerReaderWriter</span> &#123;              <span class="comment">// Bidirectional 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 客户端流类 ==========</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientReader</span> &#123;                    <span class="comment">// Server Streaming 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;</span><br><span class="line">    <span class="function">Status <span class="title">Finish</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientWriter</span> &#123;                    <span class="comment">// Client Streaming 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WritesDone</span><span class="params">()</span></span>;                  <span class="comment">// 标记写入完成</span></span><br><span class="line">    <span class="function">Status <span class="title">Finish</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientReaderWriter</span> &#123;              <span class="comment">// Bidirectional 用</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Read</span><span class="params">(R* msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">WritesDone</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Status <span class="title">Finish</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 写入选项 ==========</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WriteOptions</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">WriteOptions&amp; <span class="title">set_buffer_hint</span><span class="params">()</span></span>;    <span class="comment">// 提示可缓冲</span></span><br><span class="line">    <span class="function">WriteOptions&amp; <span class="title">set_last_message</span><span class="params">()</span></span>;   <span class="comment">// 标记最后一条</span></span><br><span class="line">    <span class="function">WriteOptions&amp; <span class="title">clear_buffer_hint</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h5 id="2）使用示例-5"><a href="#2）使用示例-5" class="headerlink" title="2）使用示例"></a>2）使用示例</h5><p><strong>Server Streaming（服务端流）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：客户端发一个请求，服务端返回多个响应（如分页数据、实时推送）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 服务端实现 =====</span></span><br><span class="line"><span class="function">grpc::Status <span class="title">ListItems</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> ListRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">                       grpc::ServerWriter&lt;Item&gt;* writer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) <span class="keyword">break</span>;  <span class="comment">// 检查取消</span></span><br><span class="line">        </span><br><span class="line">        Item item;</span><br><span class="line">        item.<span class="built_in">set_id</span>(i);</span><br><span class="line">        item.<span class="built_in">set_name</span>(<span class="string">&quot;Item &quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!writer-&gt;<span class="built_in">Write</span>(item)) <span class="keyword">break</span>;  <span class="comment">// 写入失败则退出</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 客户端调用 =====</span></span><br><span class="line">grpc::ClientContext context;</span><br><span class="line">ListRequest request;</span><br><span class="line"><span class="keyword">auto</span> reader = stub-&gt;<span class="built_in">ListItems</span>(&amp;context, request);</span><br><span class="line"></span><br><span class="line">Item item;</span><br><span class="line"><span class="keyword">while</span> (reader-&gt;<span class="built_in">Read</span>(&amp;item)) &#123;  <span class="comment">// 循环读取</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;收到: &quot;</span> &lt;&lt; item.<span class="built_in">name</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grpc::Status status = reader-&gt;<span class="built_in">Finish</span>();  <span class="comment">// 获取最终状态</span></span><br></pre></td></tr></table></figure>

<p><strong>Client Streaming（客户端流）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：客户端发多个请求，服务端返回一个响应（如上传文件、批量提交）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 服务端实现 =====</span></span><br><span class="line"><span class="function">grpc::Status <span class="title">UploadFile</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                        grpc::ServerReader&lt;FileChunk&gt;* reader,</span></span></span><br><span class="line"><span class="params"><span class="function">                        UploadResult* result)</span> </span>&#123;</span><br><span class="line">    FileChunk chunk;</span><br><span class="line">    <span class="type">int</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (reader-&gt;<span class="built_in">Read</span>(&amp;chunk)) &#123;  <span class="comment">// 循环读取客户端发来的数据块</span></span><br><span class="line">        total_bytes += chunk.<span class="built_in">data</span>().<span class="built_in">size</span>();</span><br><span class="line">        <span class="comment">// 处理数据块...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result-&gt;<span class="built_in">set_total_bytes</span>(total_bytes);</span><br><span class="line">    result-&gt;<span class="built_in">set_success</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 客户端调用 =====</span></span><br><span class="line">grpc::ClientContext context;</span><br><span class="line">UploadResult result;</span><br><span class="line"><span class="keyword">auto</span> writer = stub-&gt;<span class="built_in">UploadFile</span>(&amp;context, &amp;result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    FileChunk chunk;</span><br><span class="line">    chunk.<span class="built_in">set_data</span>(<span class="string">&quot;chunk data &quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!writer-&gt;<span class="built_in">Write</span>(chunk)) <span class="keyword">break</span>;  <span class="comment">// 写入失败则退出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">writer-&gt;<span class="built_in">WritesDone</span>();  <span class="comment">// ⚠️ 必须调用！告诉服务端发送完毕</span></span><br><span class="line">grpc::Status status = writer-&gt;<span class="built_in">Finish</span>();  <span class="comment">// 等待服务端响应</span></span><br><span class="line"></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;上传完成，共 &quot;</span> &lt;&lt; result.<span class="built_in">total_bytes</span>() &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>

<p><strong>Bidirectional Streaming（双向流）</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：客户端和服务端同时发送多个消息（如聊天、实时协作）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 服务端实现 =====</span></span><br><span class="line"><span class="function">grpc::Status <span class="title">Chat</span><span class="params">(grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">                  grpc::ServerReaderWriter&lt;ChatMessage, ChatMessage&gt;* stream)</span> </span>&#123;</span><br><span class="line">    ChatMessage msg;</span><br><span class="line">    <span class="keyword">while</span> (stream-&gt;<span class="built_in">Read</span>(&amp;msg)) &#123;  <span class="comment">// 读取客户端消息</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;收到: &quot;</span> &lt;&lt; msg.<span class="built_in">content</span>() &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 回复</span></span><br><span class="line">        ChatMessage reply;</span><br><span class="line">        reply.<span class="built_in">set_content</span>(<span class="string">&quot;服务端回复: &quot;</span> + msg.<span class="built_in">content</span>());</span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(reply);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ===== 客户端调用 =====</span></span><br><span class="line">grpc::ClientContext context;</span><br><span class="line"><span class="keyword">auto</span> stream = stub-&gt;<span class="built_in">Chat</span>(&amp;context);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动读取线程</span></span><br><span class="line"><span class="function">std::thread <span class="title">reader_thread</span><span class="params">([&amp;stream]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    ChatMessage msg;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">while</span> (stream-&gt;Read(&amp;msg)) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        std::cout &lt;&lt; <span class="string">&quot;收到: &quot;</span> &lt;&lt; msg.content() &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主线程发送</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    ChatMessage msg;</span><br><span class="line">    msg.<span class="built_in">set_content</span>(<span class="string">&quot;消息 &quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">    stream-&gt;<span class="built_in">Write</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream-&gt;<span class="built_in">WritesDone</span>();  <span class="comment">// 发送完毕</span></span><br><span class="line">reader_thread.<span class="built_in">join</span>();  <span class="comment">// 等待读取完成</span></span><br><span class="line"></span><br><span class="line">grpc::Status status = stream-&gt;<span class="built_in">Finish</span>();</span><br></pre></td></tr></table></figure>

<h2 id="4-Unary（一元）"><a href="#4-Unary（一元）" class="headerlink" title="4.Unary（一元）"></a>4.Unary（一元）</h2><h3 id="（1）功能设计"><a href="#（1）功能设计" class="headerlink" title="（1）功能设计"></a>（1）功能设计</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">场景：用户登录验证</span><br><span class="line"></span><br><span class="line">┌─────────────┐         LoginRequest          ┌─────────────┐</span><br><span class="line">│   客户端     │ ──────────────────────────→   │   服务端     │</span><br><span class="line">│             │      (username, password)     │             │</span><br><span class="line">│             │                               │             │</span><br><span class="line">│             │ ←──────────────────────────   │             │</span><br><span class="line">└─────────────┘        LoginResponse          └─────────────┘</span><br><span class="line">                  (success, token, message)</span><br><span class="line"></span><br><span class="line">特点：一问一答，最简单的 RPC 模式</span><br></pre></td></tr></table></figure>
<h3 id="（2）Proto定义"><a href="#（2）Proto定义" class="headerlink" title="（2）Proto定义"></a>（2）Proto定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// login.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package auth;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录请求</span></span><br><span class="line">message LoginRequest &#123;</span><br><span class="line">    string username = <span class="number">1</span>;</span><br><span class="line">    string password = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录响应</span></span><br><span class="line">message LoginResponse &#123;</span><br><span class="line">    <span class="type">bool</span> success = <span class="number">1</span>;</span><br><span class="line">    string token = <span class="number">2</span>;</span><br><span class="line">    string message = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录服务</span></span><br><span class="line">service AuthService &#123;</span><br><span class="line">    <span class="comment">// Unary：无 stream 关键字</span></span><br><span class="line">    <span class="function">rpc <span class="title">Login</span><span class="params">(LoginRequest)</span> <span class="title">returns</span> <span class="params">(LoginResponse)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）生成的-C-关键伪代码"><a href="#（3）生成的-C-关键伪代码" class="headerlink" title="（3）生成的 C++ 关键伪代码"></a>（3）生成的 C++ 关键伪代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== auth.grpc.pb.h ====================</span></span><br><span class="line"><span class="keyword">namespace</span> auth &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthService</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">service_full_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;auth.AuthService&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 同步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Service</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Service</span>();</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">Service</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> grpc::Status <span class="title">Login</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> LoginRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">            LoginResponse* response</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 异步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">AsyncService</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">AsyncService</span>();</span><br><span class="line">        ~<span class="built_in">AsyncService</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 请求处理一个 Login 调用</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">RequestLogin</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            LoginRequest* request,                        <span class="comment">// 请求会被填充到这里</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerAsyncResponseWriter&lt;LoginResponse&gt;* writer,  <span class="comment">// 异步响应写入器</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::CompletionQueue* new_call_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerCompletionQueue* notification_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">void</span>* tag</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Stub 类（完整版） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">final</span> : <span class="keyword">public</span> StubInterface &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Stub</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;grpc::ChannelInterface&gt;&amp; channel)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 同步接口 ----------</span></span><br><span class="line">        <span class="function">grpc::Status <span class="title">Login</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ClientContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> LoginRequest&amp; request,</span></span></span><br><span class="line"><span class="params"><span class="function">            LoginResponse* response</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 异步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncResponseReader&lt;LoginResponse&gt;&gt; </span><br><span class="line">        <span class="built_in">AsyncLogin</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            <span class="type">const</span> LoginRequest&amp; request,</span><br><span class="line">            grpc::CompletionQueue* cq</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// PrepareAsync 版本（延迟启动，需手动调用 StartCall）</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncResponseReader&lt;LoginResponse&gt;&gt; </span><br><span class="line">        <span class="built_in">PrepareAsyncLogin</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            <span class="type">const</span> LoginRequest&amp; request,</span><br><span class="line">            grpc::CompletionQueue* cq</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::shared_ptr&lt;grpc::ChannelInterface&gt; channel_;</span><br><span class="line">        <span class="type">const</span> grpc::internal::RpcMethod rpcmethod_Login_;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> std::unique_ptr&lt;Stub&gt; <span class="title">NewStub</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::shared_ptr&lt;grpc::Channel&gt;&amp; channel,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> grpc::StubOptions&amp; options = grpc::StubOptions()</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace auth</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== auth.grpc.pb.cc（实现伪代码） ====================</span></span><br><span class="line"><span class="keyword">namespace</span> auth &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stub 同步调用实现</span></span><br><span class="line">grpc::Status AuthService::Stub::<span class="built_in">Login</span>(</span><br><span class="line">    grpc::ClientContext* context,</span><br><span class="line">    <span class="type">const</span> LoginRequest&amp; request,</span><br><span class="line">    LoginResponse* response) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 序列化请求</span></span><br><span class="line">    grpc::ByteBuffer request_buf;</span><br><span class="line">    SerializationTraits&lt;LoginRequest&gt;::<span class="built_in">Serialize</span>(request, &amp;request_buf);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 通过 Channel 发送请求并等待响应</span></span><br><span class="line">    grpc::ByteBuffer response_buf;</span><br><span class="line">    grpc::Status status = channel_-&gt;<span class="built_in">SyncUnaryCall</span>(</span><br><span class="line">        <span class="string">&quot;/auth.AuthService/Login&quot;</span>,  <span class="comment">// 方法路径</span></span><br><span class="line">        context,</span><br><span class="line">        request_buf,</span><br><span class="line">        &amp;response_buf</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 反序列化响应</span></span><br><span class="line">    <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        SerializationTraits&lt;LoginResponse&gt;::<span class="built_in">Deserialize</span>(response_buf, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service 默认实现（返回未实现）</span></span><br><span class="line">grpc::Status AuthService::Service::<span class="built_in">Login</span>(</span><br><span class="line">    grpc::ServerContext* context,</span><br><span class="line">    <span class="type">const</span> LoginRequest* request,</span><br><span class="line">    LoginResponse* response) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::UNIMPLEMENTED, <span class="string">&quot;Method not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace auth</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）使用示例"><a href="#（4）使用示例" class="headerlink" title="（4）使用示例"></a>（4）使用示例</h3><p><strong>服务端实现</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== server.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth.grpc.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承生成的 Service 基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> auth::AuthService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">grpc::Status <span class="title">Login</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> auth::LoginRequest* request,</span></span></span><br><span class="line"><span class="params"><span class="function">        auth::LoginResponse* response)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 获取客户端信息</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;客户端地址: &quot;</span> &lt;&lt; context-&gt;<span class="built_in">peer</span>() &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查是否被取消</span></span><br><span class="line">        <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::CANCELLED, <span class="string">&quot;请求被取消&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 业务逻辑：验证用户</span></span><br><span class="line">        <span class="keyword">if</span> (request-&gt;<span class="built_in">username</span>() == <span class="string">&quot;admin&quot;</span> &amp;&amp; request-&gt;<span class="built_in">password</span>() == <span class="string">&quot;123456&quot;</span>) &#123;</span><br><span class="line">            response-&gt;<span class="built_in">set_success</span>(<span class="literal">true</span>);</span><br><span class="line">            response-&gt;<span class="built_in">set_token</span>(<span class="string">&quot;jwt-token-xxxxx&quot;</span>);</span><br><span class="line">            response-&gt;<span class="built_in">set_message</span>(<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response-&gt;<span class="built_in">set_success</span>(<span class="literal">false</span>);</span><br><span class="line">            response-&gt;<span class="built_in">set_message</span>(<span class="string">&quot;用户名或密码错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">server_address</span><span class="params">(<span class="string">&quot;0.0.0.0:50051&quot;</span>)</span></span>;</span><br><span class="line">    AuthServiceImpl service;</span><br><span class="line">    </span><br><span class="line">    grpc::ServerBuilder builder;</span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>(server_address, grpc::<span class="built_in">InsecureServerCredentials</span>());</span><br><span class="line">    builder.<span class="built_in">RegisterService</span>(&amp;service);</span><br><span class="line">    </span><br><span class="line">    std::unique_ptr&lt;grpc::Server&gt; server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;服务器启动: &quot;</span> &lt;&lt; server_address &lt;&lt; std::endl;</span><br><span class="line">    </span><br><span class="line">    server-&gt;<span class="built_in">Wait</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端调用</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== client.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth.grpc.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 创建 Channel</span></span><br><span class="line">    <span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(</span><br><span class="line">        <span class="string">&quot;localhost:50051&quot;</span>,</span><br><span class="line">        grpc::<span class="built_in">InsecureChannelCredentials</span>()</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 创建 Stub</span></span><br><span class="line">    <span class="keyword">auto</span> stub = auth::AuthService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 准备请求</span></span><br><span class="line">    auth::LoginRequest request;</span><br><span class="line">    request.<span class="built_in">set_username</span>(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    request.<span class="built_in">set_password</span>(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 创建 Context（每次调用必须新建！）</span></span><br><span class="line">    grpc::ClientContext context;</span><br><span class="line">    context.<span class="built_in">set_deadline</span>(</span><br><span class="line">        std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">5</span>)</span><br><span class="line">    );</span><br><span class="line">    context.<span class="built_in">AddMetadata</span>(<span class="string">&quot;client-version&quot;</span>, <span class="string">&quot;1.0.0&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. 调用 RPC</span></span><br><span class="line">    auth::LoginResponse response;</span><br><span class="line">    grpc::Status status = stub-&gt;<span class="built_in">Login</span>(&amp;context, request, &amp;response);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 6. 处理结果</span></span><br><span class="line">    <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.<span class="built_in">success</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;✓ 登录成功！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;  Token: &quot;</span> &lt;&lt; response.<span class="built_in">token</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;✗ 登录失败: &quot;</span> &lt;&lt; response.<span class="built_in">message</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✗ RPC 错误: &quot;</span> &lt;&lt; status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  错误码: &quot;</span> &lt;&lt; status.<span class="built_in">error_code</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（5）数据流图"><a href="#（5）数据流图" class="headerlink" title="（5）数据流图"></a>（5）数据流图</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        Unary 调用流程                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   客户端                                              服务端             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   LoginRequest req;                                                     │</span><br><span class="line">│   req.<span class="built_in">set_username</span>(<span class="string">&quot;admin&quot;</span>);                                           │</span><br><span class="line">│   req.<span class="built_in">set_password</span>(<span class="string">&quot;123456&quot;</span>);                                          │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   stub-&gt;<span class="built_in">Login</span>(&amp;ctx, req, &amp;resp);                                       │</span><br><span class="line">│         │                                                               │</span><br><span class="line">│         │  ┌──────────────────┐                                        │</span><br><span class="line">│         └─→│  HTTP/<span class="number">2</span> POST     │                                        │</span><br><span class="line">│            │  /auth.AuthService/Login                                   │</span><br><span class="line">│            │  Body: [序列化的 LoginRequest]                             │</span><br><span class="line">│            └────────────────────────────────────────→ 收到请求          │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│                                                      ▼                  │</span><br><span class="line">│                                              <span class="built_in">Login</span>(ctx, req, resp)     │</span><br><span class="line">│                                              验证用户名密码              │</span><br><span class="line">│                                              填充 resp                  │</span><br><span class="line">│                                              <span class="keyword">return</span> Status::OK         │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│            ┌────────────────────────────────────────←┘                  │</span><br><span class="line">│            │  HTTP/<span class="number">2</span> Response                                          │</span><br><span class="line">│            │  Body: [序列化的 LoginResponse]                            │</span><br><span class="line">│            │  Trailers: grpc-status=<span class="number">0</span>                                   │</span><br><span class="line">│         ←──┘                                                            │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   status.<span class="built_in">ok</span>() == <span class="literal">true</span>                                                   │</span><br><span class="line">│   resp.<span class="built_in">success</span>() == <span class="literal">true</span>                                               │</span><br><span class="line">│   resp.<span class="built_in">token</span>() == <span class="string">&quot;jwt-token-xxxxx&quot;</span>                                    │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（6）Unary模式总结"><a href="#（6）Unary模式总结" class="headerlink" title="（6）Unary模式总结"></a>（6）Unary模式总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153138053.png"></p>
<h2 id="5-Server-Streaming（服务端流）"><a href="#5-Server-Streaming（服务端流）" class="headerlink" title="5.Server Streaming（服务端流）"></a>5.Server Streaming（服务端流）</h2><h3 id="（1）功能设计-1"><a href="#（1）功能设计-1" class="headerlink" title="（1）功能设计"></a>（1）功能设计</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">场景：查询订单列表（分批返回）</span><br><span class="line"></span><br><span class="line">┌─────────────┐       OrderQuery              ┌─────────────┐</span><br><span class="line">│   客户端     │ ──────────────────────────→   │   服务端     │</span><br><span class="line">│             │      (user_id, status)        │             │</span><br><span class="line">│             │                               │             │</span><br><span class="line">│             │ ←─────── Order <span class="number">1</span> ─────────    │             │</span><br><span class="line">│             │ ←─────── Order <span class="number">2</span> ─────────    │             │</span><br><span class="line">│             │ ←─────── Order <span class="number">3</span> ─────────    │             │</span><br><span class="line">│             │ ←─────── ...     ─────────    │             │</span><br><span class="line">└─────────────┘                               └─────────────┘</span><br><span class="line"></span><br><span class="line">特点：一个请求，多个响应（服务端推送）</span><br></pre></td></tr></table></figure>

<h3 id="（2）Proto定义-1"><a href="#（2）Proto定义-1" class="headerlink" title="（2）Proto定义"></a>（2）Proto定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// order.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package shop;</span><br><span class="line"></span><br><span class="line">message OrderQuery &#123;</span><br><span class="line">    string user_id = <span class="number">1</span>;</span><br><span class="line">    string status = <span class="number">2</span>;  <span class="comment">// &quot;pending&quot;, &quot;completed&quot;, &quot;all&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Order &#123;</span><br><span class="line">    string order_id = <span class="number">1</span>;</span><br><span class="line">    string product_name = <span class="number">2</span>;</span><br><span class="line">    <span class="type">double</span> price = <span class="number">3</span>;</span><br><span class="line">    string status = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service OrderService &#123;</span><br><span class="line">    <span class="comment">// Server Streaming：返回值加 stream</span></span><br><span class="line">    <span class="function">rpc <span class="title">ListOrders</span><span class="params">(OrderQuery)</span> <span class="title">returns</span> <span class="params">(stream Order)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）生成的-C-关键伪代码-1"><a href="#（3）生成的-C-关键伪代码-1" class="headerlink" title="（3）生成的 C++ 关键伪代码"></a>（3）生成的 C++ 关键伪代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== order.grpc.pb.h ====================</span></span><br><span class="line"><span class="keyword">namespace</span> shop &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">service_full_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;shop.OrderService&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 同步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Service</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Service</span>();</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">Service</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> grpc::Status <span class="title">ListOrders</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> OrderQuery* request,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerWriter&lt;Order&gt;* writer</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 异步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">AsyncService</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">AsyncService</span>();</span><br><span class="line">        ~<span class="built_in">AsyncService</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 请求处理一个 ListOrders 调用</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">RequestListOrders</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            OrderQuery* request,                    <span class="comment">// 请求会被填充到这里</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerAsyncWriter&lt;Order&gt;* writer, <span class="comment">// 异步写入器</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::CompletionQueue* new_call_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerCompletionQueue* notification_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">void</span>* tag</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Stub 类（完整版） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">final</span> : <span class="keyword">public</span> StubInterface &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Stub</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;grpc::ChannelInterface&gt;&amp; channel)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 同步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientReader&lt;Order&gt;&gt; <span class="built_in">ListOrders</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            <span class="type">const</span> OrderQuery&amp; request</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 异步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncReader&lt;Order&gt;&gt; <span class="built_in">AsyncListOrders</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            <span class="type">const</span> OrderQuery&amp; request,</span><br><span class="line">            grpc::CompletionQueue* cq,</span><br><span class="line">            <span class="type">void</span>* tag</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// PrepareAsync 版本（延迟启动，需手动调用 StartCall）</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncReader&lt;Order&gt;&gt; <span class="built_in">PrepareAsyncListOrders</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            <span class="type">const</span> OrderQuery&amp; request,</span><br><span class="line">            grpc::CompletionQueue* cq</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::shared_ptr&lt;grpc::ChannelInterface&gt; channel_;</span><br><span class="line">        <span class="type">const</span> grpc::internal::RpcMethod rpcmethod_ListOrders_;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> std::unique_ptr&lt;Stub&gt; <span class="title">NewStub</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::shared_ptr&lt;grpc::Channel&gt;&amp; channel,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> grpc::StubOptions&amp; options = grpc::StubOptions()</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace shop</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== order.grpc.pb.cc（实现伪代码） ====================</span></span><br><span class="line"><span class="keyword">namespace</span> shop &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stub 实现</span></span><br><span class="line">std::unique_ptr&lt;grpc::ClientReader&lt;Order&gt;&gt; OrderService::Stub::<span class="built_in">ListOrders</span>(</span><br><span class="line">    grpc::ClientContext* context,</span><br><span class="line">    <span class="type">const</span> OrderQuery&amp; request) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 创建调用</span></span><br><span class="line">    <span class="keyword">auto</span> call = channel_-&gt;<span class="built_in">CreateCall</span>(<span class="string">&quot;/shop.OrderService/ListOrders&quot;</span>, context);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 发送请求（只发一次）</span></span><br><span class="line">    grpc::ByteBuffer request_buf;</span><br><span class="line">    SerializationTraits&lt;OrderQuery&gt;::<span class="built_in">Serialize</span>(request, &amp;request_buf);</span><br><span class="line">    call.<span class="built_in">Write</span>(request_buf);</span><br><span class="line">    call.<span class="built_in">WritesDone</span>();  <span class="comment">// 客户端发送完成</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 返回 Reader，让调用者循环读取</span></span><br><span class="line">    <span class="keyword">return</span> std::make_unique&lt;grpc::ClientReader&lt;Order&gt;&gt;(std::<span class="built_in">move</span>(call), context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service 默认实现</span></span><br><span class="line">grpc::Status OrderService::Service::<span class="built_in">ListOrders</span>(</span><br><span class="line">    grpc::ServerContext* context,</span><br><span class="line">    <span class="type">const</span> OrderQuery* request,</span><br><span class="line">    grpc::ServerWriter&lt;Order&gt;* writer) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::UNIMPLEMENTED, <span class="string">&quot;Method not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace shop</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）使用示例-1"><a href="#（4）使用示例-1" class="headerlink" title="（4）使用示例"></a>（4）使用示例</h3><p><strong>服务端实现</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== server.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;order.grpc.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> shop::OrderService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">grpc::Status <span class="title">ListOrders</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> shop::OrderQuery* request,</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerWriter&lt;shop::Order&gt;* writer)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;查询用户订单: &quot;</span> &lt;&lt; request-&gt;<span class="built_in">user_id</span>() &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 模拟从数据库查询订单</span></span><br><span class="line">        std::vector&lt;std::pair&lt;std::string, <span class="type">double</span>&gt;&gt; orders = &#123;</span><br><span class="line">            &#123;<span class="string">&quot;iPhone 15&quot;</span>, <span class="number">7999.0</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;MacBook Pro&quot;</span>, <span class="number">14999.0</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;AirPods Pro&quot;</span>, <span class="number">1899.0</span>&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; orders.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">            <span class="comment">// 检查客户端是否取消</span></span><br><span class="line">            <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::CANCELLED, <span class="string">&quot;客户端取消请求&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 构造响应</span></span><br><span class="line">            shop::Order order;</span><br><span class="line">            order.<span class="built_in">set_order_id</span>(<span class="string">&quot;ORD-&quot;</span> + std::<span class="built_in">to_string</span>(i + <span class="number">1</span>));</span><br><span class="line">            order.<span class="built_in">set_product_name</span>(orders[i].first);</span><br><span class="line">            order.<span class="built_in">set_price</span>(orders[i].second);</span><br><span class="line">            order.<span class="built_in">set_status</span>(<span class="string">&quot;completed&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入流</span></span><br><span class="line">            <span class="keyword">if</span> (!writer-&gt;<span class="built_in">Write</span>(order)) &#123;</span><br><span class="line">                <span class="comment">// 写入失败（可能客户端断开）</span></span><br><span class="line">                <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::UNKNOWN, <span class="string">&quot;写入失败&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 模拟延迟</span></span><br><span class="line">            std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">500</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">server_address</span><span class="params">(<span class="string">&quot;0.0.0.0:50051&quot;</span>)</span></span>;</span><br><span class="line">    OrderServiceImpl service;</span><br><span class="line">    </span><br><span class="line">    grpc::ServerBuilder builder;</span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>(server_address, grpc::<span class="built_in">InsecureServerCredentials</span>());</span><br><span class="line">    builder.<span class="built_in">RegisterService</span>(&amp;service);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;服务器启动: &quot;</span> &lt;&lt; server_address &lt;&lt; std::endl;</span><br><span class="line">    server-&gt;<span class="built_in">Wait</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>客户端调用</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== client.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;order.grpc.pb.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(<span class="string">&quot;localhost:50051&quot;</span>, </span><br><span class="line">                                       grpc::<span class="built_in">InsecureChannelCredentials</span>());</span><br><span class="line">    <span class="keyword">auto</span> stub = shop::OrderService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 准备请求</span></span><br><span class="line">    shop::OrderQuery query;</span><br><span class="line">    query.<span class="built_in">set_user_id</span>(<span class="string">&quot;user-123&quot;</span>);</span><br><span class="line">    query.<span class="built_in">set_status</span>(<span class="string">&quot;all&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 Context</span></span><br><span class="line">    grpc::ClientContext context;</span><br><span class="line">    context.<span class="built_in">set_deadline</span>(</span><br><span class="line">        std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">30</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用 RPC，获取 Reader</span></span><br><span class="line">    <span class="keyword">auto</span> reader = stub-&gt;<span class="built_in">ListOrders</span>(&amp;context, query);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环读取响应</span></span><br><span class="line">    shop::Order order;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (reader-&gt;<span class="built_in">Read</span>(&amp;order)) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;订单 &quot;</span> &lt;&lt; ++count &lt;&lt; <span class="string">&quot;: &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  ID: &quot;</span> &lt;&lt; order.<span class="built_in">order_id</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  商品: &quot;</span> &lt;&lt; order.<span class="built_in">product_name</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  价格: ¥&quot;</span> &lt;&lt; order.<span class="built_in">price</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取最终状态</span></span><br><span class="line">    grpc::Status status = reader-&gt;<span class="built_in">Finish</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✓ 共收到 &quot;</span> &lt;&lt; count &lt;&lt; <span class="string">&quot; 个订单&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✗ 错误: &quot;</span> &lt;&lt; status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（5）数据流图-1"><a href="#（5）数据流图-1" class="headerlink" title="（5）数据流图"></a>（5）数据流图</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Server Streaming 调用流程                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   客户端                                              服务端             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   <span class="keyword">auto</span> reader = stub-&gt;<span class="built_in">ListOrders</span>(&amp;ctx, query);                         │</span><br><span class="line">│         │                                                               │</span><br><span class="line">│         │  ┌──────────────────┐                                        │</span><br><span class="line">│         └─→│  POST /shop.OrderService/ListOrders                       │</span><br><span class="line">│            │  Body: [OrderQuery]                                       │</span><br><span class="line">│            └────────────────────────────────────────→ 收到请求          │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│                                                      ▼                  │</span><br><span class="line">│                                             <span class="keyword">for</span> each order:            │</span><br><span class="line">│                                               writer-&gt;<span class="built_in">Write</span>(order)     │</span><br><span class="line">│            ┌────────────────────────────────────────←┐                  │</span><br><span class="line">│            │  DATA frame: [Order <span class="number">1</span>]                  │                  │</span><br><span class="line">│   reader-&gt;<span class="built_in">Read</span>(&amp;order) ←─┘                           │                  │</span><br><span class="line">│   处理 Order <span class="number">1</span>                                       │                  │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│            ┌────────────────────────────────────────←┤                  │</span><br><span class="line">│            │  DATA frame: [Order <span class="number">2</span>]                  │                  │</span><br><span class="line">│   reader-&gt;<span class="built_in">Read</span>(&amp;order) ←─┘                           │                  │</span><br><span class="line">│   处理 Order <span class="number">2</span>                                       │                  │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│            ┌────────────────────────────────────────←┤                  │</span><br><span class="line">│            │  DATA frame: [Order <span class="number">3</span>]                  │                  │</span><br><span class="line">│   reader-&gt;<span class="built_in">Read</span>(&amp;order) ←─┘                           │                  │</span><br><span class="line">│   处理 Order <span class="number">3</span>                                       │                  │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│                                             <span class="keyword">return</span> Status::OK          │</span><br><span class="line">│            ┌────────────────────────────────────────←┘                  │</span><br><span class="line">│            │  HEADERS: grpc-status=<span class="number">0</span> (Trailers)                        │</span><br><span class="line">│   reader-&gt;<span class="built_in">Read</span>() 返回 <span class="literal">false</span> ←─┘                                        │</span><br><span class="line">│   status = reader-&gt;<span class="built_in">Finish</span>()                                            │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（6）Server-Streaming-模式总结"><a href="#（6）Server-Streaming-模式总结" class="headerlink" title="（6）Server Streaming 模式总结"></a>（6）Server Streaming 模式总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153119547.png"></p>
<h2 id="6-Client-Streaming（客户端流）"><a href="#6-Client-Streaming（客户端流）" class="headerlink" title="6.Client Streaming（客户端流）"></a>6.Client Streaming（客户端流）</h2><h3 id="（1）功能设计-2"><a href="#（1）功能设计-2" class="headerlink" title="（1）功能设计"></a>（1）功能设计</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">场景：上传文件（分块传输）</span><br><span class="line"></span><br><span class="line">┌─────────────┐       FileChunk <span class="number">1</span>             ┌─────────────┐</span><br><span class="line">│   客户端     │ ──────────────────────────→   │   服务端     │</span><br><span class="line">│             │       FileChunk <span class="number">2</span>             │             │</span><br><span class="line">│             │ ──────────────────────────→   │             │</span><br><span class="line">│             │       FileChunk <span class="number">3</span>             │             │</span><br><span class="line">│             │ ──────────────────────────→   │             │</span><br><span class="line">│             │       ...                     │             │</span><br><span class="line">│             │                               │             │</span><br><span class="line">│             │ ←──────────────────────────   │             │</span><br><span class="line">└─────────────┘      UploadResult             └─────────────┘</span><br><span class="line"></span><br><span class="line">特点：多个请求，一个响应（批量提交）</span><br></pre></td></tr></table></figure>

<h3 id="（2）Proto-定义"><a href="#（2）Proto-定义" class="headerlink" title="（2）Proto 定义"></a>（2）Proto 定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package storage;</span><br><span class="line"></span><br><span class="line">message FileChunk &#123;</span><br><span class="line">    string filename = <span class="number">1</span>;</span><br><span class="line">    bytes data = <span class="number">2</span>;</span><br><span class="line">    int32 chunk_index = <span class="number">3</span>;</span><br><span class="line">    <span class="type">bool</span> is_last = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message UploadResult &#123;</span><br><span class="line">    <span class="type">bool</span> success = <span class="number">1</span>;</span><br><span class="line">    string file_id = <span class="number">2</span>;</span><br><span class="line">    int64 total_bytes = <span class="number">3</span>;</span><br><span class="line">    string message = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service FileService &#123;</span><br><span class="line">    <span class="comment">// Client Streaming：请求加 stream</span></span><br><span class="line">    <span class="function">rpc <span class="title">UploadFile</span><span class="params">(stream FileChunk)</span> <span class="title">returns</span> <span class="params">(UploadResult)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）生成的-C-关键伪代码-2"><a href="#（3）生成的-C-关键伪代码-2" class="headerlink" title="（3）生成的 C++ 关键伪代码"></a>（3）生成的 C++ 关键伪代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== file.grpc.pb.h ====================</span></span><br><span class="line"><span class="keyword">namespace</span> storage &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileService</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">char</span> <span class="type">const</span>* <span class="title">service_full_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;storage.FileService&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 同步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Service</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">Service</span>();</span><br><span class="line">        <span class="keyword">virtual</span> ~<span class="built_in">Service</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> grpc::Status <span class="title">UploadFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerReader&lt;FileChunk&gt;* reader,</span></span></span><br><span class="line"><span class="params"><span class="function">            UploadResult* response</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 异步 Service 基类 ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">AsyncService</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">AsyncService</span>();</span><br><span class="line">        ~<span class="built_in">AsyncService</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 请求处理一个 UploadFile 调用</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">RequestUploadFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerAsyncReader&lt;UploadResult, FileChunk&gt;* reader,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">//                      ↑ 响应类型      ↑ 请求类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::CompletionQueue* new_call_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerCompletionQueue* notification_cq,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">void</span>* tag</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Stub 类（完整版） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">final</span> : <span class="keyword">public</span> StubInterface &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Stub</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;grpc::ChannelInterface&gt;&amp; channel)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 同步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientWriter&lt;FileChunk&gt;&gt; <span class="built_in">UploadFile</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            UploadResult* response</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ---------- 异步接口 ----------</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncWriter&lt;FileChunk&gt;&gt; <span class="built_in">AsyncUploadFile</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            UploadResult* response,</span><br><span class="line">            grpc::CompletionQueue* cq,</span><br><span class="line">            <span class="type">void</span>* tag</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// PrepareAsync 版本（延迟启动，需手动调用 StartCall）</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncWriter&lt;FileChunk&gt;&gt; <span class="built_in">PrepareAsyncUploadFile</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            UploadResult* response,</span><br><span class="line">            grpc::CompletionQueue* cq</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::shared_ptr&lt;grpc::ChannelInterface&gt; channel_;</span><br><span class="line">        <span class="type">const</span> grpc::internal::RpcMethod rpcmethod_UploadFile_;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> std::unique_ptr&lt;Stub&gt; <span class="title">NewStub</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::shared_ptr&lt;grpc::Channel&gt;&amp; channel,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> grpc::StubOptions&amp; options = grpc::StubOptions()</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace storage</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== file.grpc.pb.cc（实现伪代码） ====================</span></span><br><span class="line"><span class="keyword">namespace</span> storage &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stub 实现</span></span><br><span class="line">std::unique_ptr&lt;grpc::ClientWriter&lt;FileChunk&gt;&gt; FileService::Stub::<span class="built_in">UploadFile</span>(</span><br><span class="line">    grpc::ClientContext* context,</span><br><span class="line">    UploadResult* response) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. 创建调用</span></span><br><span class="line">    <span class="keyword">auto</span> call = channel_-&gt;<span class="built_in">CreateCall</span>(<span class="string">&quot;/storage.FileService/UploadFile&quot;</span>, context);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 返回 Writer，让调用者循环写入</span></span><br><span class="line">    <span class="comment">// 响应指针保存，在 Finish() 时填充</span></span><br><span class="line">    <span class="keyword">return</span> std::make_unique&lt;grpc::ClientWriter&lt;FileChunk&gt;&gt;(</span><br><span class="line">        std::<span class="built_in">move</span>(call), context, response</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service 默认实现</span></span><br><span class="line">grpc::Status FileService::Service::<span class="built_in">UploadFile</span>(</span><br><span class="line">    grpc::ServerContext* context,</span><br><span class="line">    grpc::ServerReader&lt;FileChunk&gt;* reader,</span><br><span class="line">    UploadResult* response) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::UNIMPLEMENTED, <span class="string">&quot;Method not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace storage</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）使用示例-2"><a href="#（4）使用示例-2" class="headerlink" title="（4）使用示例"></a>（4）使用示例</h3><p><strong>服务端实现</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== server.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;file.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> storage::FileService::Service &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">grpc::Status <span class="title">UploadFile</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerReader&lt;storage::FileChunk&gt;* reader,</span></span></span><br><span class="line"><span class="params"><span class="function">        storage::UploadResult* response)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        storage::FileChunk chunk;</span><br><span class="line">        std::string filename;</span><br><span class="line">        std::ofstream file;</span><br><span class="line">        <span class="type">int64_t</span> total_bytes = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 循环读取客户端发来的数据块</span></span><br><span class="line">        <span class="keyword">while</span> (reader-&gt;<span class="built_in">Read</span>(&amp;chunk)) &#123;</span><br><span class="line">            <span class="comment">// 检查取消</span></span><br><span class="line">            <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::CANCELLED, <span class="string">&quot;上传被取消&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 第一个块时创建文件</span></span><br><span class="line">            <span class="keyword">if</span> (filename.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                filename = <span class="string">&quot;/tmp/&quot;</span> + chunk.<span class="built_in">filename</span>();</span><br><span class="line">                file.<span class="built_in">open</span>(filename, std::ios::binary);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;开始接收文件: &quot;</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 写入数据</span></span><br><span class="line">            file.<span class="built_in">write</span>(chunk.<span class="built_in">data</span>().<span class="built_in">data</span>(), chunk.<span class="built_in">data</span>().<span class="built_in">size</span>());</span><br><span class="line">            total_bytes += chunk.<span class="built_in">data</span>().<span class="built_in">size</span>();</span><br><span class="line">            </span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;  收到块 &quot;</span> &lt;&lt; chunk.<span class="built_in">chunk_index</span>() </span><br><span class="line">                      &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; chunk.<span class="built_in">data</span>().<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        file.<span class="built_in">close</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 填充响应</span></span><br><span class="line">        response-&gt;<span class="built_in">set_success</span>(<span class="literal">true</span>);</span><br><span class="line">        response-&gt;<span class="built_in">set_file_id</span>(<span class="string">&quot;FILE-&quot;</span> + std::<span class="built_in">to_string</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>)));</span><br><span class="line">        response-&gt;<span class="built_in">set_total_bytes</span>(total_bytes);</span><br><span class="line">        response-&gt;<span class="built_in">set_message</span>(<span class="string">&quot;上传完成: &quot;</span> + filename);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">server_address</span><span class="params">(<span class="string">&quot;0.0.0.0:50051&quot;</span>)</span></span>;</span><br><span class="line">    FileServiceImpl service;</span><br><span class="line">    </span><br><span class="line">    grpc::ServerBuilder builder;</span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>(server_address, grpc::<span class="built_in">InsecureServerCredentials</span>());</span><br><span class="line">    builder.<span class="built_in">RegisterService</span>(&amp;service);</span><br><span class="line">    builder.<span class="built_in">SetMaxReceiveMessageSize</span>(<span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>);  <span class="comment">// 100MB</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;服务器启动: &quot;</span> &lt;&lt; server_address &lt;&lt; std::endl;</span><br><span class="line">    server-&gt;<span class="built_in">Wait</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>客户端调用</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== client.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;file.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(<span class="string">&quot;localhost:50051&quot;</span>, </span><br><span class="line">                                       grpc::<span class="built_in">InsecureChannelCredentials</span>());</span><br><span class="line">    <span class="keyword">auto</span> stub = storage::FileService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 Context</span></span><br><span class="line">    grpc::ClientContext context;</span><br><span class="line">    context.<span class="built_in">set_deadline</span>(</span><br><span class="line">        std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">minutes</span>(<span class="number">5</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 准备响应对象（Finish 后填充）</span></span><br><span class="line">    storage::UploadResult result;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取 Writer</span></span><br><span class="line">    <span class="keyword">auto</span> writer = stub-&gt;<span class="built_in">UploadFile</span>(&amp;context, &amp;result);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取本地文件并分块上传</span></span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(<span class="string">&quot;test.txt&quot;</span>, std::ios::binary)</span></span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">size_t</span> CHUNK_SIZE = <span class="number">64</span> * <span class="number">1024</span>;  <span class="comment">// 64KB 每块</span></span><br><span class="line">    <span class="type">char</span> buffer[CHUNK_SIZE];</span><br><span class="line">    <span class="type">int</span> chunk_index = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (file.<span class="built_in">read</span>(buffer, CHUNK_SIZE) || file.<span class="built_in">gcount</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        storage::FileChunk chunk;</span><br><span class="line">        chunk.<span class="built_in">set_filename</span>(<span class="string">&quot;test.txt&quot;</span>);</span><br><span class="line">        chunk.<span class="built_in">set_data</span>(buffer, file.<span class="built_in">gcount</span>());</span><br><span class="line">        chunk.<span class="built_in">set_chunk_index</span>(chunk_index++);</span><br><span class="line">        chunk.<span class="built_in">set_is_last</span>(file.<span class="built_in">eof</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!writer-&gt;<span class="built_in">Write</span>(chunk)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;写入失败！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;发送块 &quot;</span> &lt;&lt; chunk_index &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ⚠️ 必须调用！告诉服务端发送完毕</span></span><br><span class="line">    writer-&gt;<span class="built_in">WritesDone</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待响应并获取状态</span></span><br><span class="line">    grpc::Status status = writer-&gt;<span class="built_in">Finish</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✓ 上传成功！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  文件ID: &quot;</span> &lt;&lt; result.<span class="built_in">file_id</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;  总大小: &quot;</span> &lt;&lt; result.<span class="built_in">total_bytes</span>() &lt;&lt; <span class="string">&quot; 字节&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✗ 上传失败: &quot;</span> &lt;&lt; status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（5）数据流图-2"><a href="#（5）数据流图-2" class="headerlink" title="（5）数据流图"></a>（5）数据流图</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Client Streaming 调用流程                             │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   客户端                                              服务端             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   <span class="keyword">auto</span> writer = stub-&gt;<span class="built_in">UploadFile</span>(&amp;ctx, &amp;result);                       │</span><br><span class="line">│         │                                                               │</span><br><span class="line">│         │  ┌──────────────────┐                                        │</span><br><span class="line">│         └─→│  POST /storage.FileService/UploadFile                     │</span><br><span class="line">│            └────────────────────────────────────────→ 开始接收          │</span><br><span class="line">│                                                      │                  │</span><br><span class="line">│   writer-&gt;<span class="built_in">Write</span>(chunk1);                             │                  │</span><br><span class="line">│         │  ┌──────────────────┐                      │                  │</span><br><span class="line">│         └─→│  DATA: [FileChunk <span class="number">1</span>]                    │                  │</span><br><span class="line">│            └───────────────────────────────────────→ reader-&gt;<span class="built_in">Read</span>()    │</span><br><span class="line">│                                                      保存数据            │</span><br><span class="line">│   writer-&gt;<span class="built_in">Write</span>(chunk2);                             │                  │</span><br><span class="line">│         │  ┌──────────────────┐                      │                  │</span><br><span class="line">│         └─→│  DATA: [FileChunk <span class="number">2</span>]                    │                  │</span><br><span class="line">│            └───────────────────────────────────────→ reader-&gt;<span class="built_in">Read</span>()    │</span><br><span class="line">│                                                      保存数据            │</span><br><span class="line">│   writer-&gt;<span class="built_in">Write</span>(chunk3);                             │                  │</span><br><span class="line">│         │  ┌──────────────────┐                      │                  │</span><br><span class="line">│         └─→│  DATA: [FileChunk <span class="number">3</span>]                    │                  │</span><br><span class="line">│            └───────────────────────────────────────→ reader-&gt;<span class="built_in">Read</span>()    │</span><br><span class="line">│                                                      保存数据            │</span><br><span class="line">│   writer-&gt;<span class="built_in">WritesDone</span>();                              │                  │</span><br><span class="line">│         │  ┌──────────────────┐                      │                  │</span><br><span class="line">│         └─→│  END_STREAM flag                        │                  │</span><br><span class="line">│            └───────────────────────────────────────→ <span class="built_in">Read</span>() 返回 <span class="literal">false</span> │</span><br><span class="line">│                                                      填充 response      │</span><br><span class="line">│                                                      <span class="keyword">return</span> Status::OK │</span><br><span class="line">│            ┌────────────────────────────────────────←┘                  │</span><br><span class="line">│            │  DATA: [UploadResult]                                     │</span><br><span class="line">│            │  HEADERS: grpc-status=<span class="number">0</span>                                   │</span><br><span class="line">│   writer-&gt;<span class="built_in">Finish</span>() ←─┘                                                 │</span><br><span class="line">│   result 已填充                                                         │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（6）Client-Streaming-模式总结"><a href="#（6）Client-Streaming-模式总结" class="headerlink" title="（6）Client Streaming 模式总结"></a>（6）Client Streaming 模式总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153548149.png"></p>
<h2 id="7-Bidirectional-Streaming（双向流）"><a href="#7-Bidirectional-Streaming（双向流）" class="headerlink" title="7.Bidirectional Streaming（双向流）"></a>7.Bidirectional Streaming（双向流）</h2><h3 id="（1）功能设计-3"><a href="#（1）功能设计-3" class="headerlink" title="（1）功能设计"></a>（1）功能设计</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">场景：实时聊天室</span><br><span class="line"></span><br><span class="line">┌─────────────┐       ChatMessage             ┌─────────────┐</span><br><span class="line">│   客户端     │ ←──────────────────────────→  │   服务端     │</span><br><span class="line">│             │       ChatMessage             │             │</span><br><span class="line">│             │ ←──────────────────────────→  │             │</span><br><span class="line">│             │       ChatMessage             │             │</span><br><span class="line">│             │ ←──────────────────────────→  │             │</span><br><span class="line">│             │       ...                     │             │</span><br><span class="line">└─────────────┘   （双向独立，可同时读写）      └─────────────┘</span><br><span class="line"></span><br><span class="line">特点：多个请求，多个响应，全双工通信</span><br></pre></td></tr></table></figure>

<h3 id="（2）Proto-定义-1"><a href="#（2）Proto-定义-1" class="headerlink" title="（2）Proto 定义"></a>（2）Proto 定义</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// chat.proto</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line">package im;</span><br><span class="line"></span><br><span class="line">message ChatMessage &#123;</span><br><span class="line">    string sender = <span class="number">1</span>;</span><br><span class="line">    string content = <span class="number">2</span>;</span><br><span class="line">    int64 timestamp = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service ChatService &#123;</span><br><span class="line">    <span class="comment">// Bidirectional Streaming：请求和响应都加 stream</span></span><br><span class="line">    <span class="function">rpc <span class="title">Chat</span><span class="params">(stream ChatMessage)</span> <span class="title">returns</span> <span class="params">(stream ChatMessage)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（3）生成的-C-关键伪代码-3"><a href="#（3）生成的-C-关键伪代码-3" class="headerlink" title="（3）生成的 C++ 关键伪代码"></a>（3）生成的 C++ 关键伪代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== chat.grpc.pb.h ====================</span></span><br><span class="line"><span class="keyword">namespace</span> im &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatService</span> <span class="keyword">final</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Service 基类（服务端继承） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Service</span> : <span class="keyword">public</span> grpc::Service &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// 服务端用 ServerReaderWriter 同时读写</span></span><br><span class="line">        <span class="function"><span class="keyword">virtual</span> grpc::Status <span class="title">Chat</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">            grpc::ServerReaderWriter&lt;ChatMessage, ChatMessage&gt;* stream</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="comment">//                       ↑ 写出类型    ↑ 读入类型</span></span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== Stub 类（客户端使用） ==========</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Stub</span> <span class="keyword">final</span> : <span class="keyword">public</span> StubInterface &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">explicit</span> <span class="title">Stub</span><span class="params">(<span class="type">const</span> std::shared_ptr&lt;grpc::ChannelInterface&gt;&amp; channel)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回 ClientReaderWriter，可同时读写</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; <span class="built_in">Chat</span>(</span><br><span class="line">            grpc::ClientContext* context</span><br><span class="line">            <span class="comment">//                    ↑ 写出类型       ↑ 读入类型</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 异步版本</span></span><br><span class="line">        std::unique_ptr&lt;grpc::ClientAsyncReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; </span><br><span class="line">        <span class="built_in">AsyncChat</span>(</span><br><span class="line">            grpc::ClientContext* context,</span><br><span class="line">            grpc::CompletionQueue* cq,</span><br><span class="line">            <span class="type">void</span>* tag</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        std::shared_ptr&lt;grpc::ChannelInterface&gt; channel_;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">static</span> std::unique_ptr&lt;Stub&gt; <span class="title">NewStub</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">const</span> std::shared_ptr&lt;grpc::Channel&gt;&amp; channel</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace im</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== chat.grpc.pb.cc（实现伪代码） ====================</span></span><br><span class="line"><span class="keyword">namespace</span> im &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stub 实现</span></span><br><span class="line">std::unique_ptr&lt;grpc::ClientReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt; </span><br><span class="line">ChatService::Stub::<span class="built_in">Chat</span>(grpc::ClientContext* context) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 创建调用并返回双向流对象</span></span><br><span class="line">    <span class="keyword">auto</span> call = channel_-&gt;<span class="built_in">CreateCall</span>(<span class="string">&quot;/im.ChatService/Chat&quot;</span>, context);</span><br><span class="line">    <span class="keyword">return</span> std::make_unique&lt;grpc::ClientReaderWriter&lt;ChatMessage, ChatMessage&gt;&gt;(</span><br><span class="line">        std::<span class="built_in">move</span>(call), context</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Service 默认实现</span></span><br><span class="line">grpc::Status ChatService::Service::<span class="built_in">Chat</span>(</span><br><span class="line">    grpc::ServerContext* context,</span><br><span class="line">    grpc::ServerReaderWriter&lt;ChatMessage, ChatMessage&gt;* stream) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> grpc::<span class="built_in">Status</span>(grpc::UNIMPLEMENTED, <span class="string">&quot;Method not implemented&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace im</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）使用示例-3"><a href="#（4）使用示例-3" class="headerlink" title="（4）使用示例"></a>（4）使用示例</h3><p><strong>服务端实现</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== server.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chat.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatServiceImpl</span> <span class="keyword">final</span> : <span class="keyword">public</span> im::ChatService::Service &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 存储所有活跃的流（简化版，实际需要更复杂的管理）</span></span><br><span class="line">    std::mutex streams_mutex_;</span><br><span class="line">    std::vector&lt;grpc::ServerReaderWriter&lt;im::ChatMessage, im::ChatMessage&gt;*&gt; streams_;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">grpc::Status <span class="title">Chat</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerContext* context,</span></span></span><br><span class="line"><span class="params"><span class="function">        grpc::ServerReaderWriter&lt;im::ChatMessage, im::ChatMessage&gt;* stream)</span> <span class="keyword">override</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 注册这个流</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(streams_mutex_)</span></span>;</span><br><span class="line">            streams_.<span class="built_in">push_back</span>(stream);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;新用户连接: &quot;</span> &lt;&lt; context-&gt;<span class="built_in">peer</span>() &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        im::ChatMessage msg;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 循环读取客户端消息</span></span><br><span class="line">        <span class="keyword">while</span> (stream-&gt;<span class="built_in">Read</span>(&amp;msg)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (context-&gt;<span class="built_in">IsCancelled</span>()) <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; msg.<span class="built_in">sender</span>() &lt;&lt; <span class="string">&quot;]: &quot;</span> &lt;&lt; msg.<span class="built_in">content</span>() &lt;&lt; std::endl;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 广播给所有客户端（包括发送者）</span></span><br><span class="line">            im::ChatMessage broadcast;</span><br><span class="line">            broadcast.<span class="built_in">set_sender</span>(msg.<span class="built_in">sender</span>());</span><br><span class="line">            broadcast.<span class="built_in">set_content</span>(msg.<span class="built_in">content</span>());</span><br><span class="line">            broadcast.<span class="built_in">set_timestamp</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(streams_mutex_)</span></span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span>* s : streams_) &#123;</span><br><span class="line">                s-&gt;<span class="built_in">Write</span>(broadcast);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移除这个流</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(streams_mutex_)</span></span>;</span><br><span class="line">            streams_.<span class="built_in">erase</span>(</span><br><span class="line">                std::<span class="built_in">remove</span>(streams_.<span class="built_in">begin</span>(), streams_.<span class="built_in">end</span>(), stream),</span><br><span class="line">                streams_.<span class="built_in">end</span>()</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;用户断开: &quot;</span> &lt;&lt; context-&gt;<span class="built_in">peer</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> grpc::Status::OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">server_address</span><span class="params">(<span class="string">&quot;0.0.0.0:50051&quot;</span>)</span></span>;</span><br><span class="line">    ChatServiceImpl service;</span><br><span class="line">    </span><br><span class="line">    grpc::ServerBuilder builder;</span><br><span class="line">    builder.<span class="built_in">AddListeningPort</span>(server_address, grpc::<span class="built_in">InsecureServerCredentials</span>());</span><br><span class="line">    builder.<span class="built_in">RegisterService</span>(&amp;service);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> server = builder.<span class="built_in">BuildAndStart</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;聊天服务器启动: &quot;</span> &lt;&lt; server_address &lt;&lt; std::endl;</span><br><span class="line">    server-&gt;<span class="built_in">Wait</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>客户端调用</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ==================== client.cpp ====================</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;chat.grpc.pb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(<span class="string">&quot;localhost:50051&quot;</span>, </span><br><span class="line">                                       grpc::<span class="built_in">InsecureChannelCredentials</span>());</span><br><span class="line">    <span class="keyword">auto</span> stub = im::ChatService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 Context</span></span><br><span class="line">    grpc::ClientContext context;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取双向流</span></span><br><span class="line">    <span class="keyword">auto</span> stream = stub-&gt;<span class="built_in">Chat</span>(&amp;context);</span><br><span class="line">    </span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; running&#123;<span class="literal">true</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===== 读取线程：接收服务端消息 =====</span></span><br><span class="line">    <span class="function">std::thread <span class="title">reader_thread</span><span class="params">([&amp;stream, &amp;running]() &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        im::ChatMessage msg;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">while</span> (stream-&gt;Read(&amp;msg)) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::cout &lt;&lt; <span class="string">&quot;\r[&quot;</span> &lt;&lt; msg.sender() &lt;&lt; <span class="string">&quot;]: &quot;</span> </span></span></span><br><span class="line"><span class="params"><span class="function">                      &lt;&lt; msg.content() &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">            std::cout &lt;&lt; <span class="string">&quot;&gt; &quot;</span> &lt;&lt; std::flush;  <span class="comment">// 重新显示输入提示</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        running = <span class="literal">false</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">        std::cout &lt;&lt; <span class="string">&quot;连接已断开&quot;</span> &lt;&lt; std::endl;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===== 主线程：发送用户输入 =====</span></span><br><span class="line">    std::string username;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;请输入用户名: &quot;</span>;</span><br><span class="line">    std::<span class="built_in">getline</span>(std::cin, username);</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;开始聊天（输入 &#x27;quit&#x27; 退出）&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">    </span><br><span class="line">    std::string line;</span><br><span class="line">    <span class="keyword">while</span> (running &amp;&amp; std::<span class="built_in">getline</span>(std::cin, line)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (line == <span class="string">&quot;quit&quot;</span>) <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> (line.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        im::ChatMessage msg;</span><br><span class="line">        msg.<span class="built_in">set_sender</span>(username);</span><br><span class="line">        msg.<span class="built_in">set_content</span>(line);</span><br><span class="line">        msg.<span class="built_in">set_timestamp</span>(<span class="built_in">time</span>(<span class="literal">nullptr</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!stream-&gt;<span class="built_in">Write</span>(msg)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;发送失败！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;&gt; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标记写入完成</span></span><br><span class="line">    stream-&gt;<span class="built_in">WritesDone</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待读取线程结束</span></span><br><span class="line">    reader_thread.<span class="built_in">join</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取最终状态</span></span><br><span class="line">    grpc::Status status = stream-&gt;<span class="built_in">Finish</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;正常退出&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;错误: &quot;</span> &lt;&lt; status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（5）数据流图-3"><a href="#（5）数据流图-3" class="headerlink" title="（5）数据流图"></a>（5）数据流图</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                  Bidirectional Streaming 调用流程                        │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   客户端                                              服务端             │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   <span class="keyword">auto</span> stream = stub-&gt;<span class="built_in">Chat</span>(&amp;ctx);                                      │</span><br><span class="line">│         │                                                               │</span><br><span class="line">│         │  ┌──────────────────┐                                        │</span><br><span class="line">│         └─→│  POST /im.ChatService/Chat                                │</span><br><span class="line">│            └────────────────────────────────────────→ 连接建立          │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │         双向独立通信（全双工）                                     │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │   stream-&gt;<span class="built_in">Write</span>(msg1);                                          │   │</span><br><span class="line">│   │         ─────────── [ChatMessage] ───────────→ stream-&gt;<span class="built_in">Read</span>()   │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │                                                 stream-&gt;<span class="built_in">Write</span>()  │   │</span><br><span class="line">│   │   stream-&gt;<span class="built_in">Read</span>() ←─────────── [ChatMessage] ───────────          │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │   stream-&gt;<span class="built_in">Write</span>(msg2);                                          │   │</span><br><span class="line">│   │         ─────────── [ChatMessage] ───────────→ stream-&gt;<span class="built_in">Read</span>()   │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │                                                 stream-&gt;<span class="built_in">Write</span>()  │   │</span><br><span class="line">│   │   stream-&gt;<span class="built_in">Read</span>() ←─────────── [ChatMessage] ───────────          │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │   （读和写可以同时进行，互不阻塞）                                  │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   stream-&gt;<span class="built_in">WritesDone</span>();                                                 │</span><br><span class="line">│         ─────────── END_STREAM ───────────→ <span class="built_in">Read</span>() 返回 <span class="literal">false</span>          │</span><br><span class="line">│                                            <span class="keyword">return</span> Status::OK           │</span><br><span class="line">│         ←─────────── grpc-status=<span class="number">0</span> ───────────                         │</span><br><span class="line">│   stream-&gt;<span class="built_in">Finish</span>();                                                    │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（6）Bidirectional-Streaming-模式总结"><a href="#（6）Bidirectional-Streaming-模式总结" class="headerlink" title="（6）Bidirectional Streaming 模式总结"></a>（6）Bidirectional Streaming 模式总结</h3><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260122153842158.png"></p>
<h2 id="8-gRPC的异步调用"><a href="#8-gRPC的异步调用" class="headerlink" title="8.gRPC的异步调用"></a>8.gRPC的异步调用</h2><h3 id="（0）概述"><a href="#（0）概述" class="headerlink" title="（0）概述"></a>（0）概述</h3><p>gRPC C++的异步调用主要涉及：</p>
<ul>
<li><p>CompletionQueue - 核心事件队列</p>
</li>
<li><p>ClientAsyncResponseReader - 异步Unary客户端</p>
</li>
<li><p>ClientAsyncReader - 异步Server Streaming客户端</p>
</li>
<li><p>ClientAsyncWriter - 异步Client Streaming客户端</p>
</li>
<li><p>ClientAsyncReaderWriter - 异步双向流客户端</p>
</li>
<li><p>ServerAsyncResponseWriter - 异步Unary服务端</p>
</li>
<li><p>ServerAsyncReader - 异步Client Streaming服务端</p>
</li>
<li><p>ServerAsyncWriter - 异步Server Streaming服务端</p>
</li>
<li><p>ServerAsyncReaderWriter - 异步双向流服务端</p>
</li>
<li><p>Alarm - 定时</p>
</li>
</ul>
<p><strong>异步 vs 同步</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        同步 vs 异步                                      │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   同步调用（阻塞）                                                        │</span><br><span class="line">│   ┌─────────┐                                                           │</span><br><span class="line">│   │ Thread  │──<span class="built_in">Call</span>()──→ [等待...等待...等待...] ──→ 返回结果           │</span><br><span class="line">│   └─────────┘            （线程被阻塞）                                   │</span><br><span class="line">│                                                                         │</span><br><span class="line">│   异步调用（非阻塞）                                                      │</span><br><span class="line">│   ┌─────────┐                                                           │</span><br><span class="line">│   │ Thread  │──<span class="built_in">AsyncCall</span>()──→ 立即返回，继续做其他事                     │</span><br><span class="line">│   └─────────┘                    │                                      │</span><br><span class="line">│        │                         ▼                                      │</span><br><span class="line">│        │              ┌──────────────────┐                              │</span><br><span class="line">│        └──轮询────────→│ CompletionQueue │←── 结果就绪时通知             │</span><br><span class="line">│                       └──────────────────┘                              │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>核心类总览</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     gRPC 异步核心类                                      │</span><br><span class="line">├─────────────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                         │</span><br><span class="line">│   ┌─────────────────────────────────────────────────────────────────┐   │</span><br><span class="line">│   │                    CompletionQueue                               │   │</span><br><span class="line">│   │                   （核心事件队列）                                 │   │</span><br><span class="line">│   │                                                                  │   │</span><br><span class="line">│   │   所有异步操作完成后，都会向 CQ 投递事件                           │   │</span><br><span class="line">│   └─────────────────────────────────────────────────────────────────┘   │</span><br><span class="line">│                          ▲                                              │</span><br><span class="line">│          ┌───────────────┼───────────────┐                              │</span><br><span class="line">│          │               │               │                              │</span><br><span class="line">│   ┌──────┴──────┐ ┌──────┴──────┐ ┌──────┴──────┐                       │</span><br><span class="line">│   │   客户端     │ │   服务端     │ │   工具类    │                       │</span><br><span class="line">│   ├─────────────┤ ├─────────────┤ ├─────────────┤                       │</span><br><span class="line">│   │AsyncResp..  │ │AsyncResp..  │ │   Alarm     │                       │</span><br><span class="line">│   │AsyncReader  │ │AsyncReader  │ │  (定时器)   │                       │</span><br><span class="line">│   │AsyncWriter  │ │AsyncWriter  │ │             │                       │</span><br><span class="line">│   │AsyncRW      │ │AsyncRW      │ │             │                       │</span><br><span class="line">│   └─────────────┘ └─────────────┘ └─────────────┘                       │</span><br><span class="line">│                                                                         │</span><br><span class="line">└─────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="（1）CompletionQueue-—-核心事件队列"><a href="#（1）CompletionQueue-—-核心事件队列" class="headerlink" title="（1）CompletionQueue — 核心事件队列"></a>（1）CompletionQueue — 核心事件队列</h3><h4 id="伪代码"><a href="#伪代码" class="headerlink" title="&lt;1&gt;伪代码"></a>&lt;1&gt;伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CompletionQueue</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CompletionQueue</span>();</span><br><span class="line">    ~<span class="built_in">CompletionQueue</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 事件获取 ==========</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 阻塞等待，直到有事件或队列关闭</span></span><br><span class="line">    <span class="comment">// 返回值：GOT_EVENT / SHUTDOWN / TIMEOUT</span></span><br><span class="line">    <span class="function">NextStatus <span class="title">Next</span><span class="params">(<span class="type">void</span>** tag, <span class="type">bool</span>* ok)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带超时的等待</span></span><br><span class="line">    <span class="function">NextStatus <span class="title">AsyncNext</span><span class="params">(<span class="type">void</span>** tag, <span class="type">bool</span>* ok, </span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">const</span> std::chrono::system_clock::time_point&amp; deadline)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== 关闭队列 ==========</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Shutdown</span><span class="params">()</span></span>;  <span class="comment">// 关闭后，Next() 返回 SHUTDOWN</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 返回状态枚举 ==========</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">NextStatus</span> &#123;</span><br><span class="line">        GOT_EVENT,   <span class="comment">// 成功获取到事件</span></span><br><span class="line">        SHUTDOWN,    <span class="comment">// 队列已关闭</span></span><br><span class="line">        TIMEOUT      <span class="comment">// 超时（仅 AsyncNext）</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端专用（支持请求注册）</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerCompletionQueue</span> : <span class="keyword">public</span> CompletionQueue &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 服务端专用功能...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>
<h4 id="使用示例-13"><a href="#使用示例-13" class="headerlink" title="&lt;2&gt;使用示例"></a>&lt;2&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">grpc::CompletionQueue cq;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件循环</span></span><br><span class="line"><span class="type">void</span>* tag;</span><br><span class="line"><span class="type">bool</span> ok;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// 阻塞等待事件</span></span><br><span class="line">    grpc::CompletionQueue::NextStatus status = cq.<span class="built_in">Next</span>(&amp;tag, &amp;ok);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status == grpc::CompletionQueue::SHUTDOWN) &#123;</span><br><span class="line">        <span class="keyword">break</span>;  <span class="comment">// 队列关闭</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status == grpc::CompletionQueue::GOT_EVENT) &#123;</span><br><span class="line">        <span class="comment">// tag: 用户自定义指针，用于识别是哪个操作完成</span></span><br><span class="line">        <span class="comment">// ok:  操作是否成功</span></span><br><span class="line">        <span class="comment">//      - true: 操作成功完成</span></span><br><span class="line">        <span class="comment">//      - false: 操作失败（如连接断开、取消等）</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">ProcessEvent</span>(tag, ok);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="（2）Alarm-—-定时器"><a href="#（2）Alarm-—-定时器" class="headerlink" title="（2）Alarm — 定时器"></a>（2）Alarm — 定时器</h3><h4 id="伪代码-1"><a href="#伪代码-1" class="headerlink" title="&lt;1&gt;伪代码"></a>&lt;1&gt;伪代码</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Alarm</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Alarm</span>();</span><br><span class="line">    ~<span class="built_in">Alarm</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置定时器：到期后 tag 被投递到 cq</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Set</span><span class="params">(CompletionQueue* cq, </span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">const</span> std::chrono::system_clock::time_point&amp; deadline,</span></span></span><br><span class="line"><span class="params"><span class="function">             <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取消定时器</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Cancel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="使用示例-14"><a href="#使用示例-14" class="headerlink" title="&lt;2&gt;使用示例"></a>&lt;2&gt;使用示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">grpc::Alarm alarm;</span><br><span class="line">grpc::CompletionQueue cq;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5秒后触发</span></span><br><span class="line">alarm.<span class="built_in">Set</span>(&amp;cq, </span><br><span class="line">          std::chrono::system_clock::<span class="built_in">now</span>() + std::chrono::<span class="built_in">seconds</span>(<span class="number">5</span>),</span><br><span class="line">          (<span class="type">void</span>*)<span class="string">&quot;timer_tag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* tag;</span><br><span class="line"><span class="type">bool</span> ok;</span><br><span class="line">cq.<span class="built_in">Next</span>(&amp;tag, &amp;ok);  <span class="comment">// 5秒后返回</span></span><br><span class="line"><span class="comment">// tag == &quot;timer_tag&quot;</span></span><br><span class="line"><span class="comment">// ok == true (正常触发) 或 false (被取消)</span></span><br></pre></td></tr></table></figure>

<h3 id="（3）客户端异步类"><a href="#（3）客户端异步类" class="headerlink" title="（3）客户端异步类"></a>（3）客户端异步类</h3><h4 id="ClientAsyncResponseReader-—-异步-Unary"><a href="#ClientAsyncResponseReader-—-异步-Unary" class="headerlink" title="&lt;1&gt;ClientAsyncResponseReader — 异步 Unary"></a>&lt;1&gt;ClientAsyncResponseReader — 异步 Unary</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;  <span class="comment">// R = 响应类型 (LoginResponse)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientAsyncResponseReader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 启动调用（PrepareAsync 版本需要手动调用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">StartCall</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取服务端发送的初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ReadInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完成调用，获取响应和状态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(R* msg, grpc::Status* status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ClientAsyncReader-—-异步-Server-Streaming"><a href="#ClientAsyncReader-—-异步-Server-Streaming" class="headerlink" title="&lt;2&gt;ClientAsyncReader — 异步 Server Streaming"></a>&lt;2&gt;ClientAsyncReader — 异步 Server Streaming</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 客户端异步读取器 ====================</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">R</span>&gt;  <span class="comment">// R = 读取类型 (Order)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientAsyncReader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 启动调用（PrepareAsync 版本需要手动调用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">StartCall</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取服务端发送的初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ReadInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步读取一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">(R* msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完成调用，获取最终状态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(grpc::Status* status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ClientAsyncWriter-—-异步-Client-Streaming"><a href="#ClientAsyncWriter-—-异步-Client-Streaming" class="headerlink" title="&lt;3&gt;ClientAsyncWriter — 异步 Client Streaming"></a>&lt;3&gt;ClientAsyncWriter — 异步 Client Streaming</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;  <span class="comment">// W = 写入类型 (FileChunk)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientAsyncWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 启动调用（PrepareAsync 版本需要手动调用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">StartCall</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步写入一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带选项的写入</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, grpc::WriteOptions options, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写完所有消息后调用（告诉服务器不再写了）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WritesDone</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完成调用，获取响应和状态</span></span><br><span class="line">    <span class="comment">// response 在创建 Writer 时已经传入，Finish 后会被填充</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(grpc::Status* status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取服务端发送的初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ReadInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ClientAsyncReaderWriter-—-异步双向流"><a href="#ClientAsyncReaderWriter-—-异步双向流" class="headerlink" title="&lt;4&gt;ClientAsyncReaderWriter — 异步双向流"></a>&lt;4&gt;ClientAsyncReaderWriter — 异步双向流</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ClientAsyncReaderWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 异步读取一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">(R* msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步写入一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带 WriteOptions 的写入</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, grpc::WriteOptions options, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写完所有消息后调用（半关闭）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WritesDone</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 完成调用，获取最终状态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(grpc::Status* status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读写同时进行</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ReadInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h3 id="（4）服务端异步类"><a href="#（4）服务端异步类" class="headerlink" title="（4）服务端异步类"></a>（4）服务端异步类</h3><h4 id="ServerAsyncResponseWriter-—-异步-Unary"><a href="#ServerAsyncResponseWriter-—-异步-Unary" class="headerlink" title="&lt;1&gt;ServerAsyncResponseWriter — 异步 Unary"></a>&lt;1&gt;ServerAsyncResponseWriter — 异步 Unary</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 服务端异步响应写入器 ====================</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;  <span class="comment">// W = 响应类型 (LoginResponse)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerAsyncResponseWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 发送初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送响应并结束调用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束调用但不发送响应（出错时使用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">FinishWithError</span><span class="params">(<span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ServerAsyncReader-—-异步-Client-Streaming"><a href="#ServerAsyncReader-—-异步-Client-Streaming" class="headerlink" title="&lt;2&gt;ServerAsyncReader — 异步 Client Streaming"></a>&lt;2&gt;ServerAsyncReader — 异步 Client Streaming</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 服务端异步读取器 ====================</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;  <span class="comment">// W = 响应类型, R = 请求类型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerAsyncReader</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 发送初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步读取一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">(R* msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束调用并发送响应</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束调用但不发送响应（出错时使用）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">FinishWithError</span><span class="params">(<span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ServerAsyncWriter-—-异步-Server-Streaming"><a href="#ServerAsyncWriter-—-异步-Server-Streaming" class="headerlink" title="&lt;3&gt;ServerAsyncWriter — 异步 Server Streaming"></a>&lt;3&gt;ServerAsyncWriter — 异步 Server Streaming</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==================== 服务端异步写入器 ====================</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>&gt;  <span class="comment">// W = 写入类型 (Order)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerAsyncWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 发送初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步写入一条消息</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 带选项的写入</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, grpc::WriteOptions options, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束调用（发送状态码）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(<span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 写入最后一条消息并结束（合并操作，更高效）</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WriteAndFinish</span><span class="params">(<span class="type">const</span> W&amp; msg, grpc::WriteOptions options,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h4 id="ServerAsyncReaderWriter-—-异步双向流"><a href="#ServerAsyncReaderWriter-—-异步双向流" class="headerlink" title="&lt;4&gt;ServerAsyncReaderWriter — 异步双向流"></a>&lt;4&gt;ServerAsyncReaderWriter — 异步双向流</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> grpc &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">W</span>, <span class="keyword">class</span> <span class="title class_">R</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServerAsyncReaderWriter</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 异步读取</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Read</span><span class="params">(R* msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步写入</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Write</span><span class="params">(<span class="type">const</span> W&amp; msg, grpc::WriteOptions options, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 结束调用</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Finish</span><span class="params">(<span class="type">const</span> grpc::Status&amp; status, <span class="type">void</span>* tag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送初始元数据</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SendInitialMetadata</span><span class="params">(<span class="type">void</span>* tag)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// namespace grpc</span></span><br></pre></td></tr></table></figure>

<h3 id="（5）异步调用过程详解"><a href="#（5）异步调用过程详解" class="headerlink" title="（5）异步调用过程详解"></a>（5）异步调用过程详解</h3><h4 id="示例：异步登录"><a href="#示例：异步登录" class="headerlink" title="&lt;1&gt;示例：异步登录"></a>&lt;1&gt;示例：异步登录</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;grpcpp/grpcpp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;auth.grpc.pb.h&quot;</span>  <span class="comment">// protoc 生成的头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="comment">// CallData 结构体：封装一次 RPC 调用的所有状态</span></span><br><span class="line"><span class="comment">// 每个异步请求都需要独立的状态，因为多个请求可能同时进行</span></span><br><span class="line"><span class="comment">// ============================================================</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">CallData</span> &#123;</span><br><span class="line">    auth::LoginRequest request;     <span class="comment">// 请求消息</span></span><br><span class="line">    auth::LoginResponse response;   <span class="comment">// 响应消息（Finish 后被填充）</span></span><br><span class="line">    grpc::ClientContext context;    <span class="comment">// 调用上下文（超时、元数据等）</span></span><br><span class="line">    grpc::Status status;            <span class="comment">// RPC 状态（Finish 后被填充）</span></span><br><span class="line">    std::unique_ptr&lt;grpc::ClientAsyncResponseReader&lt;auth::LoginResponse&gt;&gt; reader;  <span class="comment">// 异步读取器</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="comment">// 1. 创建 Channel 和 Stub</span></span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="comment">// Channel：到服务端的连接（可复用）</span></span><br><span class="line">    <span class="keyword">auto</span> channel = grpc::<span class="built_in">CreateChannel</span>(<span class="string">&quot;localhost:50051&quot;</span>, </span><br><span class="line">                                       grpc::<span class="built_in">InsecureChannelCredentials</span>());</span><br><span class="line">    <span class="comment">// Stub：RPC 调用的代理对象</span></span><br><span class="line">    <span class="keyword">auto</span> stub = auth::AuthService::<span class="built_in">NewStub</span>(channel);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CompletionQueue：异步操作完成通知的队列</span></span><br><span class="line">    <span class="comment">// 所有异步操作完成后都会往这里投递事件</span></span><br><span class="line">    grpc::CompletionQueue cq;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="comment">// 2. 发起多个异步请求（非阻塞，立即返回）</span></span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 为每个请求分配独立的状态（堆上分配，生命周期跨越异步操作）</span></span><br><span class="line">        CallData* call = <span class="keyword">new</span> <span class="built_in">CallData</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 填充请求数据</span></span><br><span class="line">        call-&gt;request.<span class="built_in">set_username</span>(<span class="string">&quot;user&quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">        call-&gt;request.<span class="built_in">set_password</span>(<span class="string">&quot;pass&quot;</span> + std::<span class="built_in">to_string</span>(i));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// AsyncLogin()：发起异步 RPC，立即返回</span></span><br><span class="line">        <span class="comment">// - 请求已发送到服务端</span></span><br><span class="line">        <span class="comment">// - 返回 ClientAsyncResponseReader 用于后续操作</span></span><br><span class="line">        call-&gt;reader = stub-&gt;<span class="built_in">AsyncLogin</span>(&amp;call-&gt;context, call-&gt;request, &amp;cq);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Finish()：注册&quot;完成回调&quot;</span></span><br><span class="line">        <span class="comment">// - 告诉 gRPC：当响应到达时，把结果填入 response 和 status</span></span><br><span class="line">        <span class="comment">// - tag 参数：完成时用于识别是哪个请求（这里传 call 指针）</span></span><br><span class="line">        <span class="comment">// - 此时请求还没完成，只是注册了回调</span></span><br><span class="line">        call-&gt;reader-&gt;<span class="built_in">Finish</span>(&amp;call-&gt;response, &amp;call-&gt;status, (<span class="type">void</span>*)call);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注意：循环立即继续，不等待响应</span></span><br><span class="line">        <span class="comment">// 3 个请求几乎同时发出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="comment">// 3. 事件循环：等待并处理完成事件</span></span><br><span class="line">    <span class="comment">// ============================================================</span></span><br><span class="line">    <span class="type">void</span>* tag;   <span class="comment">// 完成事件的标识（就是 Finish 时传入的 call 指针）</span></span><br><span class="line">    <span class="type">bool</span> ok;     <span class="comment">// 操作是否成功</span></span><br><span class="line">    <span class="type">int</span> completed = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cq.Next()：阻塞等待下一个完成事件</span></span><br><span class="line">    <span class="comment">// 返回 false 表示队列已关闭</span></span><br><span class="line">    <span class="keyword">while</span> (completed &lt; <span class="number">3</span> &amp;&amp; cq.<span class="built_in">Next</span>(&amp;tag, &amp;ok)) &#123;</span><br><span class="line">        <span class="comment">// 从 tag 恢复出 CallData 指针</span></span><br><span class="line">        CallData* call = <span class="built_in">static_cast</span>&lt;CallData*&gt;(tag);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检查结果</span></span><br><span class="line">        <span class="keyword">if</span> (ok &amp;&amp; call-&gt;status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">            <span class="comment">// ok=true：gRPC 层面操作成功</span></span><br><span class="line">            <span class="comment">// status.ok()：业务层面 RPC 成功</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;成功: &quot;</span> &lt;&lt; call-&gt;response.<span class="built_in">token</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 失败原因可能：网络错误、服务端错误等</span></span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;失败: &quot;</span> &lt;&lt; call-&gt;status.<span class="built_in">error_message</span>() &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 释放堆内存</span></span><br><span class="line">        <span class="keyword">delete</span> call;</span><br><span class="line">        completed++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>执行流程图</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">时间线 ─────────────────────────────────────────────────────────────────►</span><br><span class="line"></span><br><span class="line">主线程:</span><br><span class="line">    │</span><br><span class="line">    ├─ <span class="built_in">AsyncLogin</span>(user0) ──► 请求<span class="number">0</span>发出 ─────────────┐</span><br><span class="line">    ├─ <span class="built_in">AsyncLogin</span>(user1) ──► 请求<span class="number">1</span>发出 ────────┐    │</span><br><span class="line">    ├─ <span class="built_in">AsyncLogin</span>(user2) ──► 请求<span class="number">2</span>发出 ───┐    │    │</span><br><span class="line">    │                                     │    │    │</span><br><span class="line">    ├─ cq.<span class="built_in">Next</span>() [阻塞等待]               │    │    │</span><br><span class="line">    │      ◄────────────────────────────────────────┘ 响应<span class="number">0</span>到达</span><br><span class="line">    ├─ 处理 user0 结果                    │    │</span><br><span class="line">    │                                     │    │</span><br><span class="line">    ├─ cq.<span class="built_in">Next</span>() [阻塞等待]               │    │</span><br><span class="line">    │      ◄─────────────────────────────────────┘ 响应<span class="number">1</span>到达  </span><br><span class="line">    ├─ 处理 user1 结果                    │</span><br><span class="line">    │                                     │</span><br><span class="line">    ├─ cq.<span class="built_in">Next</span>() [阻塞等待]               │</span><br><span class="line">    │      ◄──────────────────────────────┘ 响应<span class="number">2</span>到达</span><br><span class="line">    ├─ 处理 user2 结果</span><br><span class="line">    │</span><br><span class="line">    └─ 退出</span><br><span class="line"></span><br><span class="line">注意：响应到达顺序可能与发送顺序不同！</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="gRPC-异步调用关键过程"><a href="#gRPC-异步调用关键过程" class="headerlink" title="&lt;2&gt;gRPC 异步调用关键过程"></a>&lt;2&gt;gRPC 异步调用关键过程</h4><ul>
<li><strong>调用 AsyncLogin() 时</strong>：<ul>
<li>传入事件队列 cq，内部通过 Channel 的网络连接将序列化后的请求发送到服务端，并返回一个 ClientAsyncResponseReader 对象。此时请求已发出，但还没注册”完成通知”。</li>
</ul>
</li>
<li><strong>调用 Finish(response, status, tag) 时</strong>：<br>  告诉框架”当响应回来时，把结果写入 response 和 status，然后把 tag 放入事件队列通知我”。此时 tag 被绑定到这次调用。</li>
<li><strong>网络层收到响应时（由 gRPC 内部的 I&#x2F;O 线程处理）</strong>：<ul>
<li>框架将响应反序列化后写入用户提供的 response，将状态写入 status，然后把 (tag, ok) 放入事件队列。</li>
</ul>
</li>
<li><strong>如果网络层响应先到达（Finish 还没调用）</strong>：<ul>
<li>gRPC 内部的 I&#x2F;O 线程会把响应数据暂存在内部缓冲区（绑定在 grpc_call 结构中），不会入队，也不会丢弃，只是静静等待。</li>
<li><strong>调用 Finish(response, status, tag) 时</strong>：框架检查内部缓冲区，发现响应已经到了，于是立即将数据写入 response 和 status，然后把 (tag, ok) 放入事件队列。（如果响应还没到，则注册回调等待）</li>
</ul>
</li>
<li><strong>用户调用 cq.Next(&amp;tag, &amp;ok) 时</strong>：<ul>
<li>从事件队列中取出完成的事件，<strong>通过 tag 找到对应的调用上下文</strong>，处理结果。</li>
</ul>
</li>
</ul>
<h4 id="tag-的作用"><a href="#tag-的作用" class="headerlink" title="&lt;3&gt;tag 的作用"></a>&lt;3&gt;tag 的作用</h4><p>响应确实已经写入 response 和 status 了。那 tag 的作用是什么？	<br><strong>🎯 核心问题</strong>：你怎么知道哪个调用完成了？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设你同时发起了 100 个异步调用</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    CallData* call = <span class="keyword">new</span> <span class="built_in">CallData</span>();</span><br><span class="line">    call-&gt;id = i;</span><br><span class="line">    call-&gt;reader = stub-&gt;<span class="built_in">AsyncLogin</span>(&amp;call-&gt;context, call-&gt;request, &amp;cq);</span><br><span class="line">    call-&gt;reader-&gt;<span class="built_in">Finish</span>(&amp;call-&gt;response, &amp;call-&gt;status, (<span class="type">void</span>*)call);  <span class="comment">// tag = call</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件循环</span></span><br><span class="line"><span class="type">void</span>* tag;</span><br><span class="line"><span class="type">bool</span> ok;</span><br><span class="line"><span class="keyword">while</span> (cq.<span class="built_in">Next</span>(&amp;tag, &amp;ok)) &#123;</span><br><span class="line">    <span class="comment">// 问题来了：这是哪个调用完成了？？</span></span><br><span class="line">    <span class="comment">// response 在哪？status 在哪？</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 答案：通过 tag 找回来！</span></span><br><span class="line">    CallData* call = <span class="built_in">static_cast</span>&lt;CallData*&gt;(tag);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 现在你知道了：</span></span><br><span class="line">    <span class="comment">// - 这是第 call-&gt;id 个调用</span></span><br><span class="line">    <span class="comment">// - 响应在 call-&gt;response 里</span></span><br><span class="line">    <span class="comment">// - 状态在 call-&gt;status 里</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>tag 不是用来传递数据的，而是用来”认领”的</strong>——当事件队列告诉你”有个调用完成了”，你需要通过 tag 知道”是哪个调用完成了”，从而找到对应的 response 和 status。</li>
<li>如果只有一个调用，tag 确实显得多余。但异步模型的意义就在于并发多个调用，tag 是区分它们的唯一标识。</li>
</ul>
<p><a id="Proto"></a></p>
<h1 id="附录：Proto文件"><a href="#附录：Proto文件" class="headerlink" title="附录：Proto文件"></a>附录：Proto文件</h1><h2 id="0-概述"><a href="#0-概述" class="headerlink" title="0.概述"></a>0.概述</h2><h3 id="简单演示"><a href="#简单演示" class="headerlink" title="&lt;1&gt;简单演示"></a>&lt;1&gt;简单演示</h3><p><strong>初学先了解以下几个部分即可，其它的遇到时再看</strong></p>
<figure class="highlight plaintext"><figcaption><span>Streaming（服务端流）</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;; // 1. 语法版本声明（必须在第一行非注释处）</span><br><span class="line"></span><br><span class="line">// 2. 包名声明（可选，防止命名冲突）</span><br><span class="line">package user;</span><br><span class="line"></span><br><span class="line">// 3. 导入其他 proto 文件</span><br><span class="line">import &quot;google/protobuf/timestamp.proto&quot;;</span><br><span class="line">import &quot;other/message.proto&quot;;</span><br><span class="line">import public &quot;shared/common.proto&quot;;  // 传递导入</span><br><span class="line"></span><br><span class="line">// 4. 消息、枚举、服务定义</span><br><span class="line">message User &#123; ... &#125;</span><br><span class="line">enum Status &#123; ... &#125;</span><br><span class="line">service UserService &#123; ... &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="编译命令"><a href="#编译命令" class="headerlink" title="&lt;2&gt;编译命令"></a>&lt;2&gt;编译命令</h3><p>通过protoc命令进行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本编译</span></span><br><span class="line">protoc --cpp_out=./output user.proto</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定搜索路径</span></span><br><span class="line">protoc -I=./protos --cpp_out=./output user.proto</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 gRPC 代码</span></span><br><span class="line">protoc --cpp_out=. --grpc_out=. --plugin=protoc-gen-grpc=`<span class="built_in">which</span> grpc_cpp_plugin` user.proto</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235923782.png"></p>
<h2 id="1-Proto-文件核心语法详解：syntax、package、import、option"><a href="#1-Proto-文件核心语法详解：syntax、package、import、option" class="headerlink" title="1.Proto 文件核心语法详解：syntax、package、import、option"></a>1.Proto 文件核心语法详解：syntax、package、import、option</h2><h3 id="（1）syntax：指定语法版本"><a href="#（1）syntax：指定语法版本" class="headerlink" title="（1）syntax：指定语法版本"></a>（1）syntax：指定语法版本</h3><h4 id="核心作用"><a href="#核心作用" class="headerlink" title="&lt;1&gt;核心作用"></a>&lt;1&gt;核心作用</h4><p>声明 .proto 文件的语法版本，是文件<strong>第一行必须写</strong>的内容，直接决定编译器生成的 C++ 代码结构、字段访问方式和默认行为</p>
<h4 id="语法格式"><a href="#语法格式" class="headerlink" title="&lt;2&gt;语法格式"></a>&lt;2&gt;语法格式</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>; <span class="comment">// 推荐使用 proto3</span></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">syntax = <span class="string">&quot;proto2&quot;</span>; <span class="comment">// 旧版，不推荐新项目使用</span></span><br></pre></td></tr></table></figure>

<h3 id="（2）package：定义命名空间（C-命名空间映射）"><a href="#（2）package：定义命名空间（C-命名空间映射）" class="headerlink" title="（2）package：定义命名空间（C++ 命名空间映射）"></a>（2）package：定义命名空间（C++ 命名空间映射）</h3><h4 id="核心作用-1"><a href="#核心作用-1" class="headerlink" title="&lt;1&gt;核心作用"></a>&lt;1&gt;核心作用</h4><p>避免不同 .proto 文件的类型重名，<strong>直接映射为 C++ 的命名空间</strong>，是 C++ 中隔离类型的核心方式。</p>
<h4 id="语法格式-C-映射示例"><a href="#语法格式-C-映射示例" class="headerlink" title="&lt;2&gt;语法格式 + C++ 映射示例"></a>&lt;2&gt;语法格式 + C++ 映射示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .proto 文件</span></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line">package com.example.chat; <span class="comment">// 多层级包名</span></span><br><span class="line"></span><br><span class="line">message ChatMsg &#123;</span><br><span class="line">  string content = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译后生成的 C++ 代码结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动生成命名空间，与 package 完全一致</span></span><br><span class="line"><span class="keyword">namespace</span> com &#123;</span><br><span class="line"><span class="keyword">namespace</span> example &#123;</span><br><span class="line"><span class="keyword">namespace</span> chat &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">ChatMsg</span> : <span class="keyword">public</span> ::google::protobuf::Message &#123;</span><br><span class="line">    <span class="comment">// ... 成员方法（get_content()、set_content() 等）</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="comment">// namespace chat</span></span><br><span class="line">&#125; <span class="comment">// namespace example</span></span><br><span class="line">&#125; <span class="comment">// namespace com</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// C++ 代码中使用</span></span><br><span class="line">com::example::chat::ChatMsg msg;</span><br><span class="line">msg.<span class="built_in">set_content</span>(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="C-实战注意事项"><a href="#C-实战注意事项" class="headerlink" title="&lt;3&gt;C++ 实战注意事项"></a>&lt;3&gt;C++ 实战注意事项</h4><ul>
<li>package 命名建议与 C++ 项目的命名空间规范一致（如 company.module.feature），避免冲突；</li>
<li>若多个 .proto 文件使用同一 package，编译后会合并到同一个 C++ 命名空间下；</li>
<li>禁止在 package 中使用 C++ 关键字（如 class、namespace），否则生成代码会编译报错。</li>
</ul>
<h3 id="（3）import：导入其他-Proto-文件（C-类型复用）"><a href="#（3）import：导入其他-Proto-文件（C-类型复用）" class="headerlink" title="（3）import：导入其他 Proto 文件（C++ 类型复用）"></a>（3）import：导入其他 Proto 文件（C++ 类型复用）</h3><h4 id="核心作用-2"><a href="#核心作用-2" class="headerlink" title="&lt;1&gt;核心作用"></a>&lt;1&gt;核心作用</h4><p>复用其他 .proto 文件定义的 message&#x2F;enum&#x2F;service，C++ 中可直接使用导入的类型，无需重复定义。</p>
<h4 id="基础语法-C-示例"><a href="#基础语法-C-示例" class="headerlink" title="&lt;2&gt;基础语法 + C++ 示例"></a>&lt;2&gt;基础语法 + C++ 示例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 基础导入（导入自定义 proto）</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;common/error_code.proto&quot;</span>; </span><br><span class="line"><span class="comment">// 2. 导入官方 Well-Known Type（C++ 常用，如时间戳）</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/timestamp.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line">package com.example.chat;</span><br><span class="line"></span><br><span class="line">message ChatMsg &#123;</span><br><span class="line">  string content = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 使用导入的枚举（来自 error_code.proto）</span></span><br><span class="line">  com.example.common.ErrorCode code = <span class="number">2</span>;</span><br><span class="line">  <span class="comment">// 使用官方 Timestamp 类型（C++ 映射为 google::protobuf::Timestamp）</span></span><br><span class="line">  google::protobuf::Timestamp send_time = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="C-场景高级用法"><a href="#C-场景高级用法" class="headerlink" title="&lt;3&gt;C++ 场景高级用法"></a>&lt;3&gt;C++ 场景高级用法</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119234919030.png"></p>
<h4 id="C-编译关键"><a href="#C-编译关键" class="headerlink" title="&lt;4&gt;C++ 编译关键"></a>&lt;4&gt;C++ 编译关键</h4><p>编译时需通过 -I（或 –proto_path）指定 Proto 文件的搜索根目录，否则编译器找不到导入的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：指定根目录为 proto/，编译 chat.proto 生成 C++ 代码</span></span><br><span class="line">protoc -I=proto/ --cpp_out=src/ proto/com/example/chat.proto</span><br></pre></td></tr></table></figure>

<h3 id="（4）option：配置编译行为（C-专属配置）"><a href="#（4）option：配置编译行为（C-专属配置）" class="headerlink" title="（4）option：配置编译行为（C++ 专属配置）"></a>（4）option：配置编译行为（C++ 专属配置）</h3><h4 id="核心作用-3"><a href="#核心作用-3" class="headerlink" title="&lt;1&gt;核心作用"></a>&lt;1&gt;核心作用</h4><p>设置 Protobuf 编译器生成 C++ 代码的规则、命名、优化策略等，分为「文件级 option」（全局）和「局部 option」（字段&#x2F;枚举）。</p>
<h4 id="C-常用文件级-Option"><a href="#C-常用文件级-Option" class="headerlink" title="&lt;2&gt;C++ 常用文件级 Option"></a>&lt;2&gt;C++ 常用文件级 Option</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235233461.png"></p>
<h4 id="C-常用局部-Option"><a href="#C-常用局部-Option" class="headerlink" title="&lt;3&gt;C++ 常用局部 Option"></a>&lt;3&gt;C++ 常用局部 Option</h4><p><img src="https://cdn.jsdelivr.net/gh/xianyubuxian-TXY/hexo-images/images/20260119235355637.png"></p>
<h4 id="C-实战示例（完整-Option-配置）"><a href="#C-实战示例（完整-Option-配置）" class="headerlink" title="&lt;4&gt;C++ 实战示例（完整 Option 配置）"></a>&lt;4&gt;C++ 实战示例（完整 Option 配置）</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line">package com.example.chat;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C++ 专属全局配置</span></span><br><span class="line">option cc_namespace = <span class="string">&quot;chat::v1&quot;</span>; <span class="comment">// 覆盖默认命名空间</span></span><br><span class="line">option optimize_for = SPEED;      <span class="comment">// 优先执行速度</span></span><br><span class="line">option cc_enable_arenas = <span class="literal">true</span>;   <span class="comment">// 启用 Arena 内存分配</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">MsgType</span> &#123;</span><br><span class="line">  option allow_alias = <span class="literal">true</span>; <span class="comment">// 允许枚举别名</span></span><br><span class="line">  TEXT = <span class="number">0</span>;</span><br><span class="line">  TEXT_MSG = <span class="number">0</span>; <span class="comment">// 别名（C++ 中可混用）</span></span><br><span class="line">  VOICE = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ChatMsg &#123;</span><br><span class="line">  string content = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 废弃字段（C++ 使用时会报警告）</span></span><br><span class="line">  string old_content = <span class="number">2</span> [deprecated = <span class="literal">true</span>];</span><br><span class="line">  <span class="comment">// 自定义 C++ 类型（默认 int32_t → 改为 uint32_t）</span></span><br><span class="line">  int32 msg_id = <span class="number">3</span> [cc_type = <span class="string">&quot;uint32_t&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="附录：Protobuf-学习路线（从基础到高级）"><a href="#附录：Protobuf-学习路线（从基础到高级）" class="headerlink" title="附录：Protobuf 学习路线（从基础到高级）"></a>附录：Protobuf 学习路线（从基础到高级）</h1><hr>
<h2 id="第一阶段：基础入门"><a href="#第一阶段：基础入门" class="headerlink" title="第一阶段：基础入门"></a>第一阶段：基础入门</h2><table>
<thead>
<tr>
<th>序号</th>
<th>知识点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Proto 文件语法</td>
<td><code>syntax</code>、<code>package</code>、<code>import</code>、<code>option</code></td>
</tr>
<tr>
<td>2</td>
<td>标量类型</td>
<td>int32&#x2F;sint32&#x2F;fixed32、string&#x2F;bytes、bool、float&#x2F;double</td>
</tr>
<tr>
<td>3</td>
<td>复合类型</td>
<td>message、enum、嵌套定义</td>
</tr>
<tr>
<td>4</td>
<td>字段规则</td>
<td>singular、<code>optional</code>、<code>repeated</code>、<code>map</code></td>
</tr>
<tr>
<td>5</td>
<td>字段编号</td>
<td>1-15 优化、reserved、编号不可复用</td>
</tr>
<tr>
<td>6</td>
<td>编译与生成</td>
<td><code>protoc</code> 命令、生成的 C++ 类结构</td>
</tr>
<tr>
<td>7</td>
<td>序列化&#x2F;反序列化</td>
<td><code>SerializeToString</code>、<code>ParseFromString</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="第二阶段：核心应用"><a href="#第二阶段：核心应用" class="headerlink" title="第二阶段：核心应用"></a>第二阶段：核心应用</h2><table>
<thead>
<tr>
<th>序号</th>
<th>知识点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>8</td>
<td>默认值机制</td>
<td>Proto3 默认值、optional 与 has_xxx()</td>
</tr>
<tr>
<td>9</td>
<td>oneof</td>
<td>互斥字段、union 存储原理</td>
</tr>
<tr>
<td>10</td>
<td>Well-Known Types</td>
<td><code>Any</code>、<code>Timestamp</code>、<code>Duration</code>、<code>Wrapper</code>、<code>Struct</code></td>
</tr>
<tr>
<td>11</td>
<td><strong>Service 定义</strong></td>
<td>RPC 接口定义、生成的 Stub 类</td>
</tr>
<tr>
<td>12</td>
<td><strong>gRPC 集成</strong></td>
<td>同步&#x2F;异步调用、四种 RPC 模式（Unary&#x2F;Stream）</td>
</tr>
<tr>
<td>13</td>
<td>错误处理</td>
<td>Status、错误码、metadata</td>
</tr>
</tbody></table>
<hr>
<h2 id="第三阶段：进阶优化"><a href="#第三阶段：进阶优化" class="headerlink" title="第三阶段：进阶优化"></a>第三阶段：进阶优化</h2><table>
<thead>
<tr>
<th>序号</th>
<th>知识点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>14</td>
<td><strong>编码原理</strong></td>
<td>Varint、ZigZag、Wire Type、Tag-Length-Value</td>
</tr>
<tr>
<td>15</td>
<td>性能优化</td>
<td>Arena 内存池、对象复用、预分配</td>
</tr>
<tr>
<td>16</td>
<td>大消息处理</td>
<td>分块传输、流式 RPC、CodedInputStream</td>
</tr>
<tr>
<td>17</td>
<td>Proto2 vs Proto3</td>
<td>差异对比、迁移注意事项</td>
</tr>
<tr>
<td>18</td>
<td>版本兼容</td>
<td>字段新增&#x2F;删除&#x2F;修改的兼容性规则</td>
</tr>
</tbody></table>
<hr>
<h2 id="第四阶段：高级特性"><a href="#第四阶段：高级特性" class="headerlink" title="第四阶段：高级特性"></a>第四阶段：高级特性</h2><table>
<thead>
<tr>
<th>序号</th>
<th>知识点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>19</td>
<td><strong>反射机制</strong></td>
<td>Descriptor、FieldDescriptor、Reflection</td>
</tr>
<tr>
<td>20</td>
<td><strong>动态消息</strong></td>
<td>DynamicMessage、运行时构造消息</td>
</tr>
<tr>
<td>21</td>
<td>自定义 Option</td>
<td>extend、自定义注解、代码生成器读取</td>
</tr>
<tr>
<td>22</td>
<td>插件开发</td>
<td><code>protoc</code> 插件机制、CodeGenerator 接口</td>
</tr>
<tr>
<td>23</td>
<td>JSON 互转</td>
<td><code>util::JsonStringToMessage</code>、JsonPrintOptions</td>
</tr>
</tbody></table>
<hr>
<h2 id="第五阶段：工程实践"><a href="#第五阶段：工程实践" class="headerlink" title="第五阶段：工程实践"></a>第五阶段：工程实践</h2><table>
<thead>
<tr>
<th>序号</th>
<th>知识点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>24</td>
<td>项目组织</td>
<td>proto 文件管理、包结构设计、CI&#x2F;CD 集成</td>
</tr>
<tr>
<td>25</td>
<td>API 设计规范</td>
<td>Google API 设计指南、命名规范、版本管理</td>
</tr>
<tr>
<td>26</td>
<td>安全考虑</td>
<td>大小限制、递归深度、未知字段处理</td>
</tr>
<tr>
<td>27</td>
<td>调试工具</td>
<td><code>protoc --decode</code>、grpcurl、Wireshark 插件</td>
</tr>
<tr>
<td>28</td>
<td>与其他序列化对比</td>
<td>vs JSON、vs FlatBuffers、vs MessagePack</td>
</tr>
</tbody></table>
<hr>
<h2 id="可视化路线图"><a href="#可视化路线图" class="headerlink" title="可视化路线图"></a>可视化路线图</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">基础 ──────────────────────────────────────────────► 高级</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[语法]</span> → <span class="selector-attr">[类型]</span> → <span class="selector-attr">[序列化]</span> → <span class="selector-attr">[Service/gRPC]</span> → <span class="selector-attr">[编码原理]</span></span><br><span class="line">                                    │</span><br><span class="line">                                    ▼</span><br><span class="line">                            <span class="selector-attr">[Arena 优化]</span></span><br><span class="line">                                    │</span><br><span class="line">                                    ▼</span><br><span class="line">                    <span class="selector-attr">[反射]</span> → <span class="selector-attr">[动态消息]</span> → <span class="selector-attr">[插件开发]</span></span><br><span class="line">                                    │</span><br><span class="line">                                    ▼</span><br><span class="line">                            <span class="selector-attr">[工程实践/规范]</span></span><br></pre></td></tr></table></figure>



    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="咸鱼 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="咸鱼 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>咸鱼
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://xianyubuxian-txy.github.io/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/" title="protobuf的使用">https://xianyubuxian-txy.github.io/2026/01/19/C++/C++后端开发常用库/protobuf的使用/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2026/01/19/C++/C++%E7%89%B9%E6%80%A7/C++23%E7%89%B9%E6%80%A7/excepted/" rel="prev" title="std::expected&lt;T, E&gt;">
                  <i class="fa fa-angle-left"></i> std::expected<T, E>
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">咸鱼</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">177k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:49</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xianyubuxian-TXY" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-beta-black.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请文明评论呀","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":[],"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","el":"#waline","comment":true,"path":"/2026/01/19/C++/C++%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%B8%B8%E7%94%A8%E5%BA%93/protobuf%E7%9A%84%E4%BD%BF%E7%94%A8/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
